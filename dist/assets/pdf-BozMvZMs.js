const isNodeJS=typeof process=="object"&&process+""=="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser"),FONT_IDENTITY_MATRIX=[.001,0,0,.001,0,0],LINE_FACTOR=1.35,RenderingIntentFlag={ANY:1,DISPLAY:2,PRINT:4,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},AnnotationMode={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},AnnotationEditorPrefix="pdfjs_internal_editor_",AnnotationEditorType={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,SIGNATURE:101},AnnotationEditorParamsType={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_DEFAULT_COLOR:32,HIGHLIGHT_THICKNESS:33,HIGHLIGHT_FREE:34,HIGHLIGHT_SHOW_ALL:35,DRAW_STEP:41},PermissionFlag={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},TextRenderingMode={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},util_ImageKind={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},AnnotationType={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26},AnnotationBorderStyleType={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5},VerbosityLevel={ERRORS:0,WARNINGS:1,INFOS:5},OPS={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94},DrawOPS={moveTo:0,lineTo:1,curveTo:2,closePath:3},PasswordResponses={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let verbosity=VerbosityLevel.WARNINGS;function setVerbosityLevel(level){Number.isInteger(level)&&(verbosity=level)}function getVerbosityLevel(){return verbosity}function info(msg){verbosity>=VerbosityLevel.INFOS&&console.log(`Info: ${msg}`)}function warn(msg){verbosity>=VerbosityLevel.WARNINGS&&console.log(`Warning: ${msg}`)}function unreachable(msg){throw new Error(msg)}function assert(cond,msg){cond||unreachable(msg)}function _isValidProtocol(url){switch(url?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function createValidAbsoluteUrl(url,baseUrl=null,options=null){if(!url)return null;if(options&&typeof url=="string"&&(options.addDefaultProtocol&&url.startsWith("www.")&&url.match(/\./g)?.length>=2&&(url=`http://${url}`),options.tryConvertEncoding))try{url=stringToUTF8String(url)}catch{}const absoluteUrl=baseUrl?URL.parse(url,baseUrl):URL.parse(url);return _isValidProtocol(absoluteUrl)?absoluteUrl:null}function updateUrlHash(url,hash,allowRel=!1){const res=URL.parse(url);return res?(res.hash=hash,res.href):allowRel&&createValidAbsoluteUrl(url,"http://example.com")?url.split("#",1)[0]+`${hash?`#${hash}`:""}`:""}function shadow(obj,prop,value,nonSerializable=!1){return Object.defineProperty(obj,prop,{value,enumerable:!nonSerializable,configurable:!0,writable:!1}),value}const BaseException=function(){function BaseException2(message,name){this.message=message,this.name=name}return BaseException2.prototype=new Error,BaseException2.constructor=BaseException2,BaseException2}();class PasswordException extends BaseException{constructor(msg,code){super(msg,"PasswordException"),this.code=code}}class UnknownErrorException extends BaseException{constructor(msg,details){super(msg,"UnknownErrorException"),this.details=details}}class InvalidPDFException extends BaseException{constructor(msg){super(msg,"InvalidPDFException")}}class ResponseException extends BaseException{constructor(msg,status,missing){super(msg,"ResponseException"),this.status=status,this.missing=missing}}class FormatError extends BaseException{constructor(msg){super(msg,"FormatError")}}class AbortException extends BaseException{constructor(msg){super(msg,"AbortException")}}function bytesToString(bytes){(typeof bytes!="object"||bytes?.length===void 0)&&unreachable("Invalid argument for bytesToString");const length=bytes.length,MAX_ARGUMENT_COUNT=8192;if(length<MAX_ARGUMENT_COUNT)return String.fromCharCode.apply(null,bytes);const strBuf=[];for(let i=0;i<length;i+=MAX_ARGUMENT_COUNT){const chunkEnd=Math.min(i+MAX_ARGUMENT_COUNT,length),chunk=bytes.subarray(i,chunkEnd);strBuf.push(String.fromCharCode.apply(null,chunk))}return strBuf.join("")}function stringToBytes(str){typeof str!="string"&&unreachable("Invalid argument for stringToBytes");const length=str.length,bytes=new Uint8Array(length);for(let i=0;i<length;++i)bytes[i]=str.charCodeAt(i)&255;return bytes}function string32(value){return String.fromCharCode(value>>24&255,value>>16&255,value>>8&255,value&255)}function isLittleEndian(){const buffer8=new Uint8Array(4);return buffer8[0]=1,new Uint32Array(buffer8.buffer,0,1)[0]===1}function isEvalSupported(){try{return new Function(""),!0}catch{return!1}}class util_FeatureTest{static get isLittleEndian(){return shadow(this,"isLittleEndian",isLittleEndian())}static get isEvalSupported(){return shadow(this,"isEvalSupported",isEvalSupported())}static get isOffscreenCanvasSupported(){return shadow(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas<"u")}static get isImageDecoderSupported(){return shadow(this,"isImageDecoderSupported",typeof ImageDecoder<"u")}static get platform(){const{platform,userAgent}=navigator;return shadow(this,"platform",{isAndroid:userAgent.includes("Android"),isLinux:platform.includes("Linux"),isMac:platform.includes("Mac"),isWindows:platform.includes("Win"),isFirefox:userAgent.includes("Firefox")})}static get isCSSRoundSupported(){return shadow(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const hexNumbers=Array.from(Array(256).keys(),n=>n.toString(16).padStart(2,"0"));class Util{static makeHexColor(r,g,b){return`#${hexNumbers[r]}${hexNumbers[g]}${hexNumbers[b]}`}static scaleMinMax(transform,minMax){let temp;transform[0]?(transform[0]<0&&(temp=minMax[0],minMax[0]=minMax[2],minMax[2]=temp),minMax[0]*=transform[0],minMax[2]*=transform[0],transform[3]<0&&(temp=minMax[1],minMax[1]=minMax[3],minMax[3]=temp),minMax[1]*=transform[3],minMax[3]*=transform[3]):(temp=minMax[0],minMax[0]=minMax[1],minMax[1]=temp,temp=minMax[2],minMax[2]=minMax[3],minMax[3]=temp,transform[1]<0&&(temp=minMax[1],minMax[1]=minMax[3],minMax[3]=temp),minMax[1]*=transform[1],minMax[3]*=transform[1],transform[2]<0&&(temp=minMax[0],minMax[0]=minMax[2],minMax[2]=temp),minMax[0]*=transform[2],minMax[2]*=transform[2]),minMax[0]+=transform[4],minMax[1]+=transform[5],minMax[2]+=transform[4],minMax[3]+=transform[5]}static transform(m1,m2){return[m1[0]*m2[0]+m1[2]*m2[1],m1[1]*m2[0]+m1[3]*m2[1],m1[0]*m2[2]+m1[2]*m2[3],m1[1]*m2[2]+m1[3]*m2[3],m1[0]*m2[4]+m1[2]*m2[5]+m1[4],m1[1]*m2[4]+m1[3]*m2[5]+m1[5]]}static applyTransform(p,m,pos=0){const p0=p[pos],p1=p[pos+1];p[pos]=p0*m[0]+p1*m[2]+m[4],p[pos+1]=p0*m[1]+p1*m[3]+m[5]}static applyTransformToBezier(p,transform,pos=0){const m0=transform[0],m1=transform[1],m2=transform[2],m3=transform[3],m4=transform[4],m5=transform[5];for(let i=0;i<6;i+=2){const pI=p[pos+i],pI1=p[pos+i+1];p[pos+i]=pI*m0+pI1*m2+m4,p[pos+i+1]=pI*m1+pI1*m3+m5}}static applyInverseTransform(p,m){const p0=p[0],p1=p[1],d=m[0]*m[3]-m[1]*m[2];p[0]=(p0*m[3]-p1*m[2]+m[2]*m[5]-m[4]*m[3])/d,p[1]=(-p0*m[1]+p1*m[0]+m[4]*m[1]-m[5]*m[0])/d}static axialAlignedBoundingBox(rect,transform,output){const m0=transform[0],m1=transform[1],m2=transform[2],m3=transform[3],m4=transform[4],m5=transform[5],r0=rect[0],r1=rect[1],r2=rect[2],r3=rect[3];let a0=m0*r0+m4,a2=a0,a1=m0*r2+m4,a3=a1,b0=m3*r1+m5,b2=b0,b1=m3*r3+m5,b3=b1;if(m1!==0||m2!==0){const m1r0=m1*r0,m1r2=m1*r2,m2r1=m2*r1,m2r3=m2*r3;a0+=m2r1,a3+=m2r1,a1+=m2r3,a2+=m2r3,b0+=m1r0,b3+=m1r0,b1+=m1r2,b2+=m1r2}output[0]=Math.min(output[0],a0,a1,a2,a3),output[1]=Math.min(output[1],b0,b1,b2,b3),output[2]=Math.max(output[2],a0,a1,a2,a3),output[3]=Math.max(output[3],b0,b1,b2,b3)}static inverseTransform(m){const d=m[0]*m[3]-m[1]*m[2];return[m[3]/d,-m[1]/d,-m[2]/d,m[0]/d,(m[2]*m[5]-m[4]*m[3])/d,(m[4]*m[1]-m[5]*m[0])/d]}static singularValueDecompose2dScale(matrix,output){const m0=matrix[0],m1=matrix[1],m2=matrix[2],m3=matrix[3],a=m0**2+m1**2,b=m0*m2+m1*m3,c=m2**2+m3**2,first=(a+c)/2,second=Math.sqrt(first**2-(a*c-b**2));output[0]=Math.sqrt(first+second||1),output[1]=Math.sqrt(first-second||1)}static normalizeRect(rect){const r=rect.slice(0);return rect[0]>rect[2]&&(r[0]=rect[2],r[2]=rect[0]),rect[1]>rect[3]&&(r[1]=rect[3],r[3]=rect[1]),r}static intersect(rect1,rect2){const xLow=Math.max(Math.min(rect1[0],rect1[2]),Math.min(rect2[0],rect2[2])),xHigh=Math.min(Math.max(rect1[0],rect1[2]),Math.max(rect2[0],rect2[2]));if(xLow>xHigh)return null;const yLow=Math.max(Math.min(rect1[1],rect1[3]),Math.min(rect2[1],rect2[3])),yHigh=Math.min(Math.max(rect1[1],rect1[3]),Math.max(rect2[1],rect2[3]));return yLow>yHigh?null:[xLow,yLow,xHigh,yHigh]}static pointBoundingBox(x,y,minMax){minMax[0]=Math.min(minMax[0],x),minMax[1]=Math.min(minMax[1],y),minMax[2]=Math.max(minMax[2],x),minMax[3]=Math.max(minMax[3],y)}static rectBoundingBox(x0,y0,x1,y1,minMax){minMax[0]=Math.min(minMax[0],x0,x1),minMax[1]=Math.min(minMax[1],y0,y1),minMax[2]=Math.max(minMax[2],x0,x1),minMax[3]=Math.max(minMax[3],y0,y1)}static#getExtremumOnCurve(x0,x1,x2,x3,y0,y1,y2,y3,t,minMax){if(t<=0||t>=1)return;const mt=1-t,tt=t*t,ttt=tt*t,x=mt*(mt*(mt*x0+3*t*x1)+3*tt*x2)+ttt*x3,y=mt*(mt*(mt*y0+3*t*y1)+3*tt*y2)+ttt*y3;minMax[0]=Math.min(minMax[0],x),minMax[1]=Math.min(minMax[1],y),minMax[2]=Math.max(minMax[2],x),minMax[3]=Math.max(minMax[3],y)}static#getExtremum(x0,x1,x2,x3,y0,y1,y2,y3,a,b,c,minMax){if(Math.abs(a)<1e-12){Math.abs(b)>=1e-12&&this.#getExtremumOnCurve(x0,x1,x2,x3,y0,y1,y2,y3,-c/b,minMax);return}const delta=b**2-4*c*a;if(delta<0)return;const sqrtDelta=Math.sqrt(delta),a2=2*a;this.#getExtremumOnCurve(x0,x1,x2,x3,y0,y1,y2,y3,(-b+sqrtDelta)/a2,minMax),this.#getExtremumOnCurve(x0,x1,x2,x3,y0,y1,y2,y3,(-b-sqrtDelta)/a2,minMax)}static bezierBoundingBox(x0,y0,x1,y1,x2,y2,x3,y3,minMax){minMax[0]=Math.min(minMax[0],x0,x3),minMax[1]=Math.min(minMax[1],y0,y3),minMax[2]=Math.max(minMax[2],x0,x3),minMax[3]=Math.max(minMax[3],y0,y3),this.#getExtremum(x0,x1,x2,x3,y0,y1,y2,y3,3*(-x0+3*(x1-x2)+x3),6*(x0-2*x1+x2),3*(x1-x0),minMax),this.#getExtremum(x0,x1,x2,x3,y0,y1,y2,y3,3*(-y0+3*(y1-y2)+y3),6*(y0-2*y1+y2),3*(y1-y0),minMax)}}function stringToUTF8String(str){return decodeURIComponent(escape(str))}let NormalizeRegex=null,NormalizationMap=null;function normalizeUnicode(str){return NormalizeRegex||(NormalizeRegex=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,NormalizationMap=new Map([["ﬅ","ſt"]])),str.replaceAll(NormalizeRegex,(_,p1,p2)=>p1?p1.normalize("NFKC"):NormalizationMap.get(p2))}function getUuid(){if(typeof crypto.randomUUID=="function")return crypto.randomUUID();const buf=new Uint8Array(32);return crypto.getRandomValues(buf),bytesToString(buf)}const AnnotationPrefix="pdfjs_internal_id_";function _isValidExplicitDest(validRef,validName,dest){if(!Array.isArray(dest)||dest.length<2)return!1;const[page,zoom,...args]=dest;if(!validRef(page)&&!Number.isInteger(page)||!validName(zoom))return!1;const argsLen=args.length;let allowNull=!0;switch(zoom.name){case"XYZ":if(argsLen<2||argsLen>3)return!1;break;case"Fit":case"FitB":return argsLen===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(argsLen>1)return!1;break;case"FitR":if(argsLen!==4)return!1;allowNull=!1;break;default:return!1}for(const arg of args)if(!(typeof arg=="number"||allowNull&&arg===null))return!1;return!0}function MathClamp(v,min,max){return Math.min(Math.max(v,min),max)}function toBase64Util(arr){return Uint8Array.prototype.toBase64?arr.toBase64():btoa(bytesToString(arr))}function fromBase64Util(str){return Uint8Array.fromBase64?Uint8Array.fromBase64(str):stringToBytes(atob(str))}typeof Promise.try!="function"&&(Promise.try=function(fn,...args){return new Promise(resolve=>{resolve(fn(...args))})});typeof Math.sumPrecise!="function"&&(Math.sumPrecise=function(numbers){return numbers.reduce((a,b)=>a+b,0)});const SVG_NS="http://www.w3.org/2000/svg";class PixelsPerInch{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}async function fetchData(url,type="text"){if(isValidFetchUrl(url,document.baseURI)){const response=await fetch(url);if(!response.ok)throw new Error(response.statusText);switch(type){case"arraybuffer":return response.arrayBuffer();case"blob":return response.blob();case"json":return response.json()}return response.text()}return new Promise((resolve,reject)=>{const request=new XMLHttpRequest;request.open("GET",url,!0),request.responseType=type,request.onreadystatechange=()=>{if(request.readyState===XMLHttpRequest.DONE){if(request.status===200||request.status===0){switch(type){case"arraybuffer":case"blob":case"json":resolve(request.response);return}resolve(request.responseText);return}reject(new Error(request.statusText))}},request.send(null)})}class PageViewport{constructor({viewBox,userUnit,scale,rotation,offsetX=0,offsetY=0,dontFlip=!1}){this.viewBox=viewBox,this.userUnit=userUnit,this.scale=scale,this.rotation=rotation,this.offsetX=offsetX,this.offsetY=offsetY,scale*=userUnit;const centerX=(viewBox[2]+viewBox[0])/2,centerY=(viewBox[3]+viewBox[1])/2;let rotateA,rotateB,rotateC,rotateD;switch(rotation%=360,rotation<0&&(rotation+=360),rotation){case 180:rotateA=-1,rotateB=0,rotateC=0,rotateD=1;break;case 90:rotateA=0,rotateB=1,rotateC=1,rotateD=0;break;case 270:rotateA=0,rotateB=-1,rotateC=-1,rotateD=0;break;case 0:rotateA=1,rotateB=0,rotateC=0,rotateD=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}dontFlip&&(rotateC=-rotateC,rotateD=-rotateD);let offsetCanvasX,offsetCanvasY,width,height;rotateA===0?(offsetCanvasX=Math.abs(centerY-viewBox[1])*scale+offsetX,offsetCanvasY=Math.abs(centerX-viewBox[0])*scale+offsetY,width=(viewBox[3]-viewBox[1])*scale,height=(viewBox[2]-viewBox[0])*scale):(offsetCanvasX=Math.abs(centerX-viewBox[0])*scale+offsetX,offsetCanvasY=Math.abs(centerY-viewBox[1])*scale+offsetY,width=(viewBox[2]-viewBox[0])*scale,height=(viewBox[3]-viewBox[1])*scale),this.transform=[rotateA*scale,rotateB*scale,rotateC*scale,rotateD*scale,offsetCanvasX-rotateA*scale*centerX-rotateC*scale*centerY,offsetCanvasY-rotateB*scale*centerX-rotateD*scale*centerY],this.width=width,this.height=height}get rawDims(){const dims=this.viewBox;return shadow(this,"rawDims",{pageWidth:dims[2]-dims[0],pageHeight:dims[3]-dims[1],pageX:dims[0],pageY:dims[1]})}clone({scale=this.scale,rotation=this.rotation,offsetX=this.offsetX,offsetY=this.offsetY,dontFlip=!1}={}){return new PageViewport({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale,rotation,offsetX,offsetY,dontFlip})}convertToViewportPoint(x,y){const p=[x,y];return Util.applyTransform(p,this.transform),p}convertToViewportRectangle(rect){const topLeft=[rect[0],rect[1]];Util.applyTransform(topLeft,this.transform);const bottomRight=[rect[2],rect[3]];return Util.applyTransform(bottomRight,this.transform),[topLeft[0],topLeft[1],bottomRight[0],bottomRight[1]]}convertToPdfPoint(x,y){const p=[x,y];return Util.applyInverseTransform(p,this.transform),p}}class RenderingCancelledException extends BaseException{constructor(msg,extraDelay=0){super(msg,"RenderingCancelledException"),this.extraDelay=extraDelay}}function isDataScheme(url){const ii=url.length;let i=0;for(;i<ii&&url[i].trim()==="";)i++;return url.substring(i,i+5).toLowerCase()==="data:"}function isPdfFile(filename){return typeof filename=="string"&&/\.pdf$/i.test(filename)}function getFilenameFromUrl(url){return[url]=url.split(/[#?]/,1),url.substring(url.lastIndexOf("/")+1)}function getPdfFilenameFromUrl(url,defaultFilename="document.pdf"){if(typeof url!="string")return defaultFilename;if(isDataScheme(url))return warn('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),defaultFilename;const newURL=(urlString=>{try{return new URL(urlString)}catch{try{return new URL(decodeURIComponent(urlString))}catch{try{return new URL(urlString,"https://foo.bar")}catch{try{return new URL(decodeURIComponent(urlString),"https://foo.bar")}catch{return null}}}}})(url);if(!newURL)return defaultFilename;const decode=name=>{try{let decoded=decodeURIComponent(name);return decoded.includes("/")?(decoded=decoded.split("/").at(-1),decoded.test(/^\.pdf$/i)?decoded:name):decoded}catch{return name}},pdfRegex=/\.pdf$/i,filename=newURL.pathname.split("/").at(-1);if(pdfRegex.test(filename))return decode(filename);if(newURL.searchParams.size>0){const values=Array.from(newURL.searchParams.values()).reverse();for(const value of values)if(pdfRegex.test(value))return decode(value);const keys=Array.from(newURL.searchParams.keys()).reverse();for(const key of keys)if(pdfRegex.test(key))return decode(key)}if(newURL.hash){const hashFilename=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i.exec(newURL.hash);if(hashFilename)return decode(hashFilename[0])}return defaultFilename}class StatTimer{started=Object.create(null);times=[];time(name){name in this.started&&warn(`Timer is already running for ${name}`),this.started[name]=Date.now()}timeEnd(name){name in this.started||warn(`Timer has not been started for ${name}`),this.times.push({name,start:this.started[name],end:Date.now()}),delete this.started[name]}toString(){const outBuf=[];let longest=0;for(const{name}of this.times)longest=Math.max(name.length,longest);for(const{name,start,end}of this.times)outBuf.push(`${name.padEnd(longest)} ${end-start}ms
`);return outBuf.join("")}}function isValidFetchUrl(url,baseUrl){const res=baseUrl?URL.parse(url,baseUrl):URL.parse(url);return res?.protocol==="http:"||res?.protocol==="https:"}function noContextMenu(e){e.preventDefault()}function stopEvent(e){e.preventDefault(),e.stopPropagation()}function deprecated(details){console.log("Deprecated API usage: "+details)}class PDFDateString{static#regex;static toDateObject(input){if(!input||typeof input!="string")return null;this.#regex||=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?");const matches=this.#regex.exec(input);if(!matches)return null;const year=parseInt(matches[1],10);let month=parseInt(matches[2],10);month=month>=1&&month<=12?month-1:0;let day=parseInt(matches[3],10);day=day>=1&&day<=31?day:1;let hour=parseInt(matches[4],10);hour=hour>=0&&hour<=23?hour:0;let minute=parseInt(matches[5],10);minute=minute>=0&&minute<=59?minute:0;let second=parseInt(matches[6],10);second=second>=0&&second<=59?second:0;const universalTimeRelation=matches[7]||"Z";let offsetHour=parseInt(matches[8],10);offsetHour=offsetHour>=0&&offsetHour<=23?offsetHour:0;let offsetMinute=parseInt(matches[9],10)||0;return offsetMinute=offsetMinute>=0&&offsetMinute<=59?offsetMinute:0,universalTimeRelation==="-"?(hour+=offsetHour,minute+=offsetMinute):universalTimeRelation==="+"&&(hour-=offsetHour,minute-=offsetMinute),new Date(Date.UTC(year,month,day,hour,minute,second))}}function getXfaPageViewport(xfaPage,{scale=1,rotation=0}){const{width,height}=xfaPage.attributes.style,viewBox=[0,0,parseInt(width),parseInt(height)];return new PageViewport({viewBox,userUnit:1,scale,rotation})}function getRGB(color){if(color.startsWith("#")){const colorRGB=parseInt(color.slice(1),16);return[(colorRGB&16711680)>>16,(colorRGB&65280)>>8,colorRGB&255]}return color.startsWith("rgb(")?color.slice(4,-1).split(",").map(x=>parseInt(x)):color.startsWith("rgba(")?color.slice(5,-1).split(",").map(x=>parseInt(x)).slice(0,3):(warn(`Not a valid color format: "${color}"`),[0,0,0])}function getColorValues(colors){const span=document.createElement("span");span.style.visibility="hidden",span.style.colorScheme="only light",document.body.append(span);for(const name of colors.keys()){span.style.color=name;const computedColor=window.getComputedStyle(span).color;colors.set(name,getRGB(computedColor))}span.remove()}function getCurrentTransform(ctx){const{a,b,c,d,e,f}=ctx.getTransform();return[a,b,c,d,e,f]}function getCurrentTransformInverse(ctx){const{a,b,c,d,e,f}=ctx.getTransform().invertSelf();return[a,b,c,d,e,f]}function setLayerDimensions(div,viewport,mustFlip=!1,mustRotate=!0){if(viewport instanceof PageViewport){const{pageWidth,pageHeight}=viewport.rawDims,{style}=div,useRound=util_FeatureTest.isCSSRoundSupported,w=`var(--total-scale-factor) * ${pageWidth}px`,h=`var(--total-scale-factor) * ${pageHeight}px`,widthStr=useRound?`round(down, ${w}, var(--scale-round-x))`:`calc(${w})`,heightStr=useRound?`round(down, ${h}, var(--scale-round-y))`:`calc(${h})`;!mustFlip||viewport.rotation%180===0?(style.width=widthStr,style.height=heightStr):(style.width=heightStr,style.height=widthStr)}mustRotate&&div.setAttribute("data-main-rotation",viewport.rotation)}class OutputScale{constructor(){const{pixelRatio}=OutputScale;this.sx=pixelRatio,this.sy=pixelRatio}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}limitCanvas(width,height,maxPixels,maxDim,capAreaFactor=-1){let maxAreaScale=1/0,maxWidthScale=1/0,maxHeightScale=1/0;maxPixels=OutputScale.capPixels(maxPixels,capAreaFactor),maxPixels>0&&(maxAreaScale=Math.sqrt(maxPixels/(width*height))),maxDim!==-1&&(maxWidthScale=maxDim/width,maxHeightScale=maxDim/height);const maxScale=Math.min(maxAreaScale,maxWidthScale,maxHeightScale);return this.sx>maxScale||this.sy>maxScale?(this.sx=maxScale,this.sy=maxScale,!0):!1}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(maxPixels,capAreaFactor){if(capAreaFactor>=0){const winPixels=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+capAreaFactor/100));return maxPixels>0?Math.min(maxPixels,winPixels):winPixels}return maxPixels}}const SupportedImageMimeTypes=["image/apng","image/avif","image/bmp","image/gif","image/jpeg","image/png","image/svg+xml","image/webp","image/x-icon"];class EditorToolbar{#toolbar=null;#colorPicker=null;#editor;#buttons=null;#altText=null;#signatureDescriptionButton=null;static#l10nRemove=null;constructor(editor){this.#editor=editor,EditorToolbar.#l10nRemove||=Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button",signature:"pdfjs-editor-remove-signature-button"})}render(){const editToolbar=this.#toolbar=document.createElement("div");editToolbar.classList.add("editToolbar","hidden"),editToolbar.setAttribute("role","toolbar");const signal=this.#editor._uiManager._signal;editToolbar.addEventListener("contextmenu",noContextMenu,{signal}),editToolbar.addEventListener("pointerdown",EditorToolbar.#pointerDown,{signal});const buttons=this.#buttons=document.createElement("div");buttons.className="buttons",editToolbar.append(buttons);const position=this.#editor.toolbarPosition;if(position){const{style}=editToolbar,x=this.#editor._uiManager.direction==="ltr"?1-position[0]:position[0];style.insetInlineEnd=`${100*x}%`,style.top=`calc(${100*position[1]}% + var(--editor-toolbar-vert-offset))`}return editToolbar}get div(){return this.#toolbar}static#pointerDown(e){e.stopPropagation()}#focusIn(e){this.#editor._focusEventsAllowed=!1,stopEvent(e)}#focusOut(e){this.#editor._focusEventsAllowed=!0,stopEvent(e)}#addListenersToElement(element){const signal=this.#editor._uiManager._signal;element.addEventListener("focusin",this.#focusIn.bind(this),{capture:!0,signal}),element.addEventListener("focusout",this.#focusOut.bind(this),{capture:!0,signal}),element.addEventListener("contextmenu",noContextMenu,{signal})}hide(){this.#toolbar.classList.add("hidden"),this.#colorPicker?.hideDropdown()}show(){this.#toolbar.classList.remove("hidden"),this.#altText?.shown()}addDeleteButton(){const{editorType,_uiManager}=this.#editor,button=document.createElement("button");button.className="delete",button.tabIndex=0,button.setAttribute("data-l10n-id",EditorToolbar.#l10nRemove[editorType]),this.#addListenersToElement(button),button.addEventListener("click",e=>{_uiManager.delete()},{signal:_uiManager._signal}),this.#buttons.append(button)}get#divider(){const divider=document.createElement("div");return divider.className="divider",divider}async addAltText(altText){const button=await altText.render();this.#addListenersToElement(button),this.#buttons.append(button,this.#divider),this.#altText=altText}addColorPicker(colorPicker){this.#colorPicker=colorPicker;const button=colorPicker.renderButton();this.#addListenersToElement(button),this.#buttons.append(button,this.#divider)}async addEditSignatureButton(signatureManager){const button=this.#signatureDescriptionButton=await signatureManager.renderEditButton(this.#editor);this.#addListenersToElement(button),this.#buttons.append(button,this.#divider)}async addButton(name,tool){switch(name){case"colorPicker":this.addColorPicker(tool);break;case"altText":await this.addAltText(tool);break;case"editSignature":await this.addEditSignatureButton(tool);break;case"delete":this.addDeleteButton();break}}updateEditSignatureButton(description){this.#signatureDescriptionButton&&(this.#signatureDescriptionButton.title=description)}remove(){this.#toolbar.remove(),this.#colorPicker?.destroy(),this.#colorPicker=null}}class HighlightToolbar{#buttons=null;#toolbar=null;#uiManager;constructor(uiManager){this.#uiManager=uiManager}#render(){const editToolbar=this.#toolbar=document.createElement("div");editToolbar.className="editToolbar",editToolbar.setAttribute("role","toolbar"),editToolbar.addEventListener("contextmenu",noContextMenu,{signal:this.#uiManager._signal});const buttons=this.#buttons=document.createElement("div");return buttons.className="buttons",editToolbar.append(buttons),this.#addHighlightButton(),editToolbar}#getLastPoint(boxes,isLTR){let lastY=0,lastX=0;for(const box of boxes){const y=box.y+box.height;if(y<lastY)continue;const x=box.x+(isLTR?box.width:0);if(y>lastY){lastX=x,lastY=y;continue}isLTR?x>lastX&&(lastX=x):x<lastX&&(lastX=x)}return[isLTR?1-lastX:lastX,lastY]}show(parent,boxes,isLTR){const[x,y]=this.#getLastPoint(boxes,isLTR),{style}=this.#toolbar||=this.#render();parent.append(this.#toolbar),style.insetInlineEnd=`${100*x}%`,style.top=`calc(${100*y}% + var(--editor-toolbar-vert-offset))`}hide(){this.#toolbar.remove()}#addHighlightButton(){const button=document.createElement("button");button.className="highlightButton",button.tabIndex=0,button.setAttribute("data-l10n-id","pdfjs-highlight-floating-button1");const span=document.createElement("span");button.append(span),span.className="visuallyHidden",span.setAttribute("data-l10n-id","pdfjs-highlight-floating-button-label");const signal=this.#uiManager._signal;button.addEventListener("contextmenu",noContextMenu,{signal}),button.addEventListener("click",()=>{this.#uiManager.highlightSelection("floating_button")},{signal}),this.#buttons.append(button)}}function bindEvents(obj,element,names){for(const name of names)element.addEventListener(name,obj[name].bind(obj))}class IdManager{#id=0;get id(){return`${AnnotationEditorPrefix}${this.#id++}`}}class ImageManager{#baseId=getUuid();#id=0;#cache=null;static get _isSVGFittingCanvas(){const svg='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>',ctx=new OffscreenCanvas(1,3).getContext("2d",{willReadFrequently:!0}),image=new Image;image.src=svg;const promise=image.decode().then(()=>(ctx.drawImage(image,0,0,1,1,0,0,1,3),new Uint32Array(ctx.getImageData(0,0,1,1).data.buffer)[0]===0));return shadow(this,"_isSVGFittingCanvas",promise)}async#get(key,rawData){this.#cache||=new Map;let data=this.#cache.get(key);if(data===null)return null;if(data?.bitmap)return data.refCounter+=1,data;try{data||={bitmap:null,id:`image_${this.#baseId}_${this.#id++}`,refCounter:0,isSvg:!1};let image;if(typeof rawData=="string"?(data.url=rawData,image=await fetchData(rawData,"blob")):rawData instanceof File?image=data.file=rawData:rawData instanceof Blob&&(image=rawData),image.type==="image/svg+xml"){const mustRemoveAspectRatioPromise=ImageManager._isSVGFittingCanvas,fileReader=new FileReader,imageElement=new Image,imagePromise=new Promise((resolve,reject)=>{imageElement.onload=()=>{data.bitmap=imageElement,data.isSvg=!0,resolve()},fileReader.onload=async()=>{const url=data.svgUrl=fileReader.result;imageElement.src=await mustRemoveAspectRatioPromise?`${url}#svgView(preserveAspectRatio(none))`:url},imageElement.onerror=fileReader.onerror=reject});fileReader.readAsDataURL(image),await imagePromise}else data.bitmap=await createImageBitmap(image);data.refCounter=1}catch(e){warn(e),data=null}return this.#cache.set(key,data),data&&this.#cache.set(data.id,data),data}async getFromFile(file){const{lastModified,name,size,type}=file;return this.#get(`${lastModified}_${name}_${size}_${type}`,file)}async getFromUrl(url){return this.#get(url,url)}async getFromBlob(id,blobPromise){const blob=await blobPromise;return this.#get(id,blob)}async getFromId(id){this.#cache||=new Map;const data=this.#cache.get(id);if(!data)return null;if(data.bitmap)return data.refCounter+=1,data;if(data.file)return this.getFromFile(data.file);if(data.blobPromise){const{blobPromise}=data;return delete data.blobPromise,this.getFromBlob(data.id,blobPromise)}return this.getFromUrl(data.url)}getFromCanvas(id,canvas){this.#cache||=new Map;let data=this.#cache.get(id);if(data?.bitmap)return data.refCounter+=1,data;const offscreen=new OffscreenCanvas(canvas.width,canvas.height);return offscreen.getContext("2d").drawImage(canvas,0,0),data={bitmap:offscreen.transferToImageBitmap(),id:`image_${this.#baseId}_${this.#id++}`,refCounter:1,isSvg:!1},this.#cache.set(id,data),this.#cache.set(data.id,data),data}getSvgUrl(id){const data=this.#cache.get(id);return data?.isSvg?data.svgUrl:null}deleteId(id){this.#cache||=new Map;const data=this.#cache.get(id);if(!data||(data.refCounter-=1,data.refCounter!==0))return;const{bitmap}=data;if(!data.url&&!data.file){const canvas=new OffscreenCanvas(bitmap.width,bitmap.height);canvas.getContext("bitmaprenderer").transferFromImageBitmap(bitmap),data.blobPromise=canvas.convertToBlob()}bitmap.close?.(),data.bitmap=null}isValidId(id){return id.startsWith(`image_${this.#baseId}_`)}}class CommandManager{#commands=[];#locked=!1;#maxSize;#position=-1;constructor(maxSize=128){this.#maxSize=maxSize}add({cmd,undo,post,mustExec,type=NaN,overwriteIfSameType=!1,keepUndo=!1}){if(mustExec&&cmd(),this.#locked)return;const save={cmd,undo,post,type};if(this.#position===-1){this.#commands.length>0&&(this.#commands.length=0),this.#position=0,this.#commands.push(save);return}if(overwriteIfSameType&&this.#commands[this.#position].type===type){keepUndo&&(save.undo=this.#commands[this.#position].undo),this.#commands[this.#position]=save;return}const next=this.#position+1;next===this.#maxSize?this.#commands.splice(0,1):(this.#position=next,next<this.#commands.length&&this.#commands.splice(next)),this.#commands.push(save)}undo(){if(this.#position===-1)return;this.#locked=!0;const{undo,post}=this.#commands[this.#position];undo(),post?.(),this.#locked=!1,this.#position-=1}redo(){if(this.#position<this.#commands.length-1){this.#position+=1,this.#locked=!0;const{cmd,post}=this.#commands[this.#position];cmd(),post?.(),this.#locked=!1}}hasSomethingToUndo(){return this.#position!==-1}hasSomethingToRedo(){return this.#position<this.#commands.length-1}cleanType(type){if(this.#position!==-1){for(let i=this.#position;i>=0;i--)if(this.#commands[i].type!==type){this.#commands.splice(i+1,this.#position-i),this.#position=i;return}this.#commands.length=0,this.#position=-1}}destroy(){this.#commands=null}}class KeyboardManager{constructor(callbacks){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac}=util_FeatureTest.platform;for(const[keys,callback,options={}]of callbacks)for(const key of keys){const isMacKey=key.startsWith("mac+");isMac&&isMacKey?(this.callbacks.set(key.slice(4),{callback,options}),this.allKeys.add(key.split("+").at(-1))):!isMac&&!isMacKey&&(this.callbacks.set(key,{callback,options}),this.allKeys.add(key.split("+").at(-1)))}}#serialize(event){event.altKey&&this.buffer.push("alt"),event.ctrlKey&&this.buffer.push("ctrl"),event.metaKey&&this.buffer.push("meta"),event.shiftKey&&this.buffer.push("shift"),this.buffer.push(event.key);const str=this.buffer.join("+");return this.buffer.length=0,str}exec(self,event){if(!this.allKeys.has(event.key))return;const info2=this.callbacks.get(this.#serialize(event));if(!info2)return;const{callback,options:{bubbles=!1,args=[],checker=null}}=info2;checker&&!checker(self,event)||(callback.bind(self,...args,event)(),bubbles||stopEvent(event))}}class ColorManager{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const colors=new Map([["CanvasText",null],["Canvas",null]]);return getColorValues(colors),shadow(this,"_colors",colors)}convert(color){const rgb=getRGB(color);if(!window.matchMedia("(forced-colors: active)").matches)return rgb;for(const[name,RGB]of this._colors)if(RGB.every((x,i)=>x===rgb[i]))return ColorManager._colorsMapping.get(name);return rgb}getHexCode(name){const rgb=this._colors.get(name);return rgb?Util.makeHexColor(...rgb):name}}class AnnotationEditorUIManager{#abortController=new AbortController;#activeEditor=null;#allEditors=new Map;#allLayers=new Map;#altTextManager=null;#annotationStorage=null;#changedExistingAnnotations=null;#commandManager=new CommandManager;#copyPasteAC=null;#currentDrawingSession=null;#currentPageIndex=0;#deletedAnnotationsElementIds=new Set;#draggingEditors=null;#editorTypes=null;#editorsToRescale=new Set;_editorUndoBar=null;#enableHighlightFloatingButton=!1;#enableUpdatedAddImage=!1;#enableNewAltTextWhenAddingImage=!1;#filterFactory=null;#focusMainContainerTimeoutId=null;#focusManagerAC=null;#highlightColors=null;#highlightWhenShiftUp=!1;#highlightToolbar=null;#idManager=new IdManager;#isEnabled=!1;#isWaiting=!1;#keyboardManagerAC=null;#lastActiveElement=null;#mainHighlightColorPicker=null;#missingCanvases=null;#mlManager=null;#mode=AnnotationEditorType.NONE;#selectedEditors=new Set;#selectedTextNode=null;#signatureManager=null;#pageColors=null;#showAllStates=null;#previousStates={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1};#translation=[0,0];#translationTimeoutId=null;#container=null;#viewer=null;#viewerAlert=null;#updateModeCapability=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const proto=AnnotationEditorUIManager.prototype,arrowChecker=self=>self.#container.contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&self.hasSomethingToControl(),textInputChecker=(_self,{target:el})=>{if(el instanceof HTMLInputElement){const{type}=el;return type!=="text"&&type!=="number"}return!0},small=this.TRANSLATE_SMALL,big=this.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+a","mac+meta+a"],proto.selectAll,{checker:textInputChecker}],[["ctrl+z","mac+meta+z"],proto.undo,{checker:textInputChecker}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],proto.redo,{checker:textInputChecker}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],proto.delete,{checker:textInputChecker}],[["Enter","mac+Enter"],proto.addNewEditorFromKeyboard,{checker:(self,{target:el})=>!(el instanceof HTMLButtonElement)&&self.#container.contains(el)&&!self.isEnterHandled}],[[" ","mac+ "],proto.addNewEditorFromKeyboard,{checker:(self,{target:el})=>!(el instanceof HTMLButtonElement)&&self.#container.contains(document.activeElement)}],[["Escape","mac+Escape"],proto.unselectAll],[["ArrowLeft","mac+ArrowLeft"],proto.translateSelectedEditors,{args:[-small,0],checker:arrowChecker}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],proto.translateSelectedEditors,{args:[-big,0],checker:arrowChecker}],[["ArrowRight","mac+ArrowRight"],proto.translateSelectedEditors,{args:[small,0],checker:arrowChecker}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],proto.translateSelectedEditors,{args:[big,0],checker:arrowChecker}],[["ArrowUp","mac+ArrowUp"],proto.translateSelectedEditors,{args:[0,-small],checker:arrowChecker}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],proto.translateSelectedEditors,{args:[0,-big],checker:arrowChecker}],[["ArrowDown","mac+ArrowDown"],proto.translateSelectedEditors,{args:[0,small],checker:arrowChecker}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],proto.translateSelectedEditors,{args:[0,big],checker:arrowChecker}]]))}constructor(container,viewer,viewerAlert,altTextManager,signatureManager,eventBus,pdfDocument,pageColors,highlightColors,enableHighlightFloatingButton,enableUpdatedAddImage,enableNewAltTextWhenAddingImage,mlManager,editorUndoBar,supportsPinchToZoom){const signal=this._signal=this.#abortController.signal;this.#container=container,this.#viewer=viewer,this.#viewerAlert=viewerAlert,this.#altTextManager=altTextManager,this.#signatureManager=signatureManager,this._eventBus=eventBus,eventBus._on("editingaction",this.onEditingAction.bind(this),{signal}),eventBus._on("pagechanging",this.onPageChanging.bind(this),{signal}),eventBus._on("scalechanging",this.onScaleChanging.bind(this),{signal}),eventBus._on("rotationchanging",this.onRotationChanging.bind(this),{signal}),eventBus._on("setpreference",this.onSetPreference.bind(this),{signal}),eventBus._on("switchannotationeditorparams",evt=>this.updateParams(evt.type,evt.value),{signal}),this.#addSelectionListener(),this.#addDragAndDropListeners(),this.#addKeyboardManager(),this.#annotationStorage=pdfDocument.annotationStorage,this.#filterFactory=pdfDocument.filterFactory,this.#pageColors=pageColors,this.#highlightColors=highlightColors||null,this.#enableHighlightFloatingButton=enableHighlightFloatingButton,this.#enableUpdatedAddImage=enableUpdatedAddImage,this.#enableNewAltTextWhenAddingImage=enableNewAltTextWhenAddingImage,this.#mlManager=mlManager||null,this.viewParameters={realScale:PixelsPerInch.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=editorUndoBar||null,this._supportsPinchToZoom=supportsPinchToZoom!==!1}destroy(){this.#updateModeCapability?.resolve(),this.#updateModeCapability=null,this.#abortController?.abort(),this.#abortController=null,this._signal=null;for(const layer of this.#allLayers.values())layer.destroy();this.#allLayers.clear(),this.#allEditors.clear(),this.#editorsToRescale.clear(),this.#missingCanvases?.clear(),this.#activeEditor=null,this.#selectedEditors.clear(),this.#commandManager.destroy(),this.#altTextManager?.destroy(),this.#signatureManager?.destroy(),this.#highlightToolbar?.hide(),this.#highlightToolbar=null,this.#mainHighlightColorPicker?.destroy(),this.#mainHighlightColorPicker=null,this.#focusMainContainerTimeoutId&&(clearTimeout(this.#focusMainContainerTimeoutId),this.#focusMainContainerTimeoutId=null),this.#translationTimeoutId&&(clearTimeout(this.#translationTimeoutId),this.#translationTimeoutId=null),this._editorUndoBar?.destroy()}combinedSignal(ac){return AbortSignal.any([this._signal,ac.signal])}get mlManager(){return this.#mlManager}get useNewAltTextFlow(){return this.#enableUpdatedAddImage}get useNewAltTextWhenAddingImage(){return this.#enableNewAltTextWhenAddingImage}get hcmFilter(){return shadow(this,"hcmFilter",this.#pageColors?this.#filterFactory.addHCMFilter(this.#pageColors.foreground,this.#pageColors.background):"none")}get direction(){return shadow(this,"direction",getComputedStyle(this.#container).direction)}get highlightColors(){return shadow(this,"highlightColors",this.#highlightColors?new Map(this.#highlightColors.split(",").map(pair=>(pair=pair.split("=").map(x=>x.trim()),pair[1]=pair[1].toUpperCase(),pair))):null)}get highlightColorNames(){return shadow(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,e=>e.reverse())):null)}setCurrentDrawingSession(layer){layer?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),this.#currentDrawingSession=layer}setMainHighlightColorPicker(colorPicker){this.#mainHighlightColorPicker=colorPicker}editAltText(editor,firstTime=!1){this.#altTextManager?.editAltText(this,editor,firstTime)}getSignature(editor){this.#signatureManager?.getSignature({uiManager:this,editor})}get signatureManager(){return this.#signatureManager}switchToMode(mode,callback){this._eventBus.on("annotationeditormodechanged",callback,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode})}setPreference(name,value){this._eventBus.dispatch("setpreference",{source:this,name,value})}onSetPreference({name,value}){switch(name){case"enableNewAltTextWhenAddingImage":this.#enableNewAltTextWhenAddingImage=value;break}}onPageChanging({pageNumber}){this.#currentPageIndex=pageNumber-1}focusMainContainer(){this.#container.focus()}findParent(x,y){for(const layer of this.#allLayers.values()){const{x:layerX,y:layerY,width,height}=layer.div.getBoundingClientRect();if(x>=layerX&&x<=layerX+width&&y>=layerY&&y<=layerY+height)return layer}return null}disableUserSelect(value=!1){this.#viewer.classList.toggle("noUserSelect",value)}addShouldRescale(editor){this.#editorsToRescale.add(editor)}removeShouldRescale(editor){this.#editorsToRescale.delete(editor)}onScaleChanging({scale}){this.commitOrRemove(),this.viewParameters.realScale=scale*PixelsPerInch.PDF_TO_CSS_UNITS;for(const editor of this.#editorsToRescale)editor.onScaleChanging();this.#currentDrawingSession?.onScaleChanging()}onRotationChanging({pagesRotation}){this.commitOrRemove(),this.viewParameters.rotation=pagesRotation}#getAnchorElementForSelection({anchorNode}){return anchorNode.nodeType===Node.TEXT_NODE?anchorNode.parentElement:anchorNode}#getLayerForTextLayer(textLayer){const{currentLayer}=this;if(currentLayer.hasTextLayer(textLayer))return currentLayer;for(const layer of this.#allLayers.values())if(layer.hasTextLayer(textLayer))return layer;return null}highlightSelection(methodOfCreation=""){const selection=document.getSelection();if(!selection||selection.isCollapsed)return;const{anchorNode,anchorOffset,focusNode,focusOffset}=selection,text=selection.toString(),textLayer=this.#getAnchorElementForSelection(selection).closest(".textLayer"),boxes=this.getSelectionBoxes(textLayer);if(!boxes)return;selection.empty();const layer=this.#getLayerForTextLayer(textLayer),isNoneMode=this.#mode===AnnotationEditorType.NONE,callback=()=>{layer?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation,boxes,anchorNode,anchorOffset,focusNode,focusOffset,text}),isNoneMode&&this.showAllEditors("highlight",!0,!0)};if(isNoneMode){this.switchToMode(AnnotationEditorType.HIGHLIGHT,callback);return}callback()}#displayHighlightToolbar(){const selection=document.getSelection();if(!selection||selection.isCollapsed)return;const textLayer=this.#getAnchorElementForSelection(selection).closest(".textLayer"),boxes=this.getSelectionBoxes(textLayer);boxes&&(this.#highlightToolbar||=new HighlightToolbar(this),this.#highlightToolbar.show(textLayer,boxes,this.direction==="ltr"))}addToAnnotationStorage(editor){!editor.isEmpty()&&this.#annotationStorage&&!this.#annotationStorage.has(editor.id)&&this.#annotationStorage.setValue(editor.id,editor)}a11yAlert(messageId,args=null){const viewerAlert=this.#viewerAlert;viewerAlert&&(viewerAlert.setAttribute("data-l10n-id",messageId),args?viewerAlert.setAttribute("data-l10n-args",JSON.stringify(args)):viewerAlert.removeAttribute("data-l10n-args"))}#selectionChange(){const selection=document.getSelection();if(!selection||selection.isCollapsed){this.#selectedTextNode&&(this.#highlightToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}const{anchorNode}=selection;if(anchorNode===this.#selectedTextNode)return;const textLayer=this.#getAnchorElementForSelection(selection).closest(".textLayer");if(!textLayer){this.#selectedTextNode&&(this.#highlightToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}if(this.#highlightToolbar?.hide(),this.#selectedTextNode=anchorNode,this.#dispatchUpdateStates({hasSelectedText:!0}),!(this.#mode!==AnnotationEditorType.HIGHLIGHT&&this.#mode!==AnnotationEditorType.NONE)&&(this.#mode===AnnotationEditorType.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),this.#highlightWhenShiftUp=this.isShiftKeyDown,!this.isShiftKeyDown)){const activeLayer=this.#mode===AnnotationEditorType.HIGHLIGHT?this.#getLayerForTextLayer(textLayer):null;activeLayer?.toggleDrawing();const ac=new AbortController,signal=this.combinedSignal(ac),pointerup=e=>{e.type==="pointerup"&&e.button!==0||(ac.abort(),activeLayer?.toggleDrawing(!0),e.type==="pointerup"&&this.#onSelectEnd("main_toolbar"))};window.addEventListener("pointerup",pointerup,{signal}),window.addEventListener("blur",pointerup,{signal})}}#onSelectEnd(methodOfCreation=""){this.#mode===AnnotationEditorType.HIGHLIGHT?this.highlightSelection(methodOfCreation):this.#enableHighlightFloatingButton&&this.#displayHighlightToolbar()}#addSelectionListener(){document.addEventListener("selectionchange",this.#selectionChange.bind(this),{signal:this._signal})}#addFocusManager(){if(this.#focusManagerAC)return;this.#focusManagerAC=new AbortController;const signal=this.combinedSignal(this.#focusManagerAC);window.addEventListener("focus",this.focus.bind(this),{signal}),window.addEventListener("blur",this.blur.bind(this),{signal})}#removeFocusManager(){this.#focusManagerAC?.abort(),this.#focusManagerAC=null}blur(){if(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd("main_toolbar")),!this.hasSelection)return;const{activeElement}=document;for(const editor of this.#selectedEditors)if(editor.div.contains(activeElement)){this.#lastActiveElement=[editor,activeElement],editor._focusEventsAllowed=!1;break}}focus(){if(!this.#lastActiveElement)return;const[lastEditor,lastActiveElement]=this.#lastActiveElement;this.#lastActiveElement=null,lastActiveElement.addEventListener("focusin",()=>{lastEditor._focusEventsAllowed=!0},{once:!0,signal:this._signal}),lastActiveElement.focus()}#addKeyboardManager(){if(this.#keyboardManagerAC)return;this.#keyboardManagerAC=new AbortController;const signal=this.combinedSignal(this.#keyboardManagerAC);window.addEventListener("keydown",this.keydown.bind(this),{signal}),window.addEventListener("keyup",this.keyup.bind(this),{signal})}#removeKeyboardManager(){this.#keyboardManagerAC?.abort(),this.#keyboardManagerAC=null}#addCopyPasteListeners(){if(this.#copyPasteAC)return;this.#copyPasteAC=new AbortController;const signal=this.combinedSignal(this.#copyPasteAC);document.addEventListener("copy",this.copy.bind(this),{signal}),document.addEventListener("cut",this.cut.bind(this),{signal}),document.addEventListener("paste",this.paste.bind(this),{signal})}#removeCopyPasteListeners(){this.#copyPasteAC?.abort(),this.#copyPasteAC=null}#addDragAndDropListeners(){const signal=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal}),document.addEventListener("drop",this.drop.bind(this),{signal})}addEditListeners(){this.#addKeyboardManager(),this.#addCopyPasteListeners()}removeEditListeners(){this.#removeKeyboardManager(),this.#removeCopyPasteListeners()}dragOver(event){for(const{type}of event.dataTransfer.items)for(const editorType of this.#editorTypes)if(editorType.isHandlingMimeForPasting(type)){event.dataTransfer.dropEffect="copy",event.preventDefault();return}}drop(event){for(const item of event.dataTransfer.items)for(const editorType of this.#editorTypes)if(editorType.isHandlingMimeForPasting(item.type)){editorType.paste(item,this.currentLayer),event.preventDefault();return}}copy(event){if(event.preventDefault(),this.#activeEditor?.commitOrRemove(),!this.hasSelection)return;const editors=[];for(const editor of this.#selectedEditors){const serialized=editor.serialize(!0);serialized&&editors.push(serialized)}editors.length!==0&&event.clipboardData.setData("application/pdfjs",JSON.stringify(editors))}cut(event){this.copy(event),this.delete()}async paste(event){event.preventDefault();const{clipboardData}=event;for(const item of clipboardData.items)for(const editorType of this.#editorTypes)if(editorType.isHandlingMimeForPasting(item.type)){editorType.paste(item,this.currentLayer);return}let data=clipboardData.getData("application/pdfjs");if(!data)return;try{data=JSON.parse(data)}catch(ex){warn(`paste: "${ex.message}".`);return}if(!Array.isArray(data))return;this.unselectAll();const layer=this.currentLayer;try{const newEditors=[];for(const editor of data){const deserializedEditor=await layer.deserialize(editor);if(!deserializedEditor)return;newEditors.push(deserializedEditor)}const cmd=()=>{for(const editor of newEditors)this.#addEditorToLayer(editor);this.#selectEditors(newEditors)},undo=()=>{for(const editor of newEditors)editor.remove()};this.addCommands({cmd,undo,mustExec:!0})}catch(ex){warn(`paste: "${ex.message}".`)}}keydown(event){!this.isShiftKeyDown&&event.key==="Shift"&&(this.isShiftKeyDown=!0),this.#mode!==AnnotationEditorType.NONE&&!this.isEditorHandlingKeyboard&&AnnotationEditorUIManager._keyboardManager.exec(this,event)}keyup(event){this.isShiftKeyDown&&event.key==="Shift"&&(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd("main_toolbar")))}onEditingAction({name}){switch(name){case"undo":case"redo":case"delete":case"selectAll":this[name]();break;case"highlightSelection":this.highlightSelection("context_menu");break}}#dispatchUpdateStates(details){Object.entries(details).some(([key,value])=>this.#previousStates[key]!==value)&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#previousStates,details)}),this.#mode===AnnotationEditorType.HIGHLIGHT&&details.hasSelectedEditor===!1&&this.#dispatchUpdateUI([[AnnotationEditorParamsType.HIGHLIGHT_FREE,!0]]))}#dispatchUpdateUI(details){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details})}setEditingState(isEditing){isEditing?(this.#addFocusManager(),this.#addCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:this.#mode!==AnnotationEditorType.NONE,isEmpty:this.#isEmpty(),hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#removeFocusManager(),this.#removeCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(types){if(!this.#editorTypes){this.#editorTypes=types;for(const editorType of this.#editorTypes)this.#dispatchUpdateUI(editorType.defaultPropertiesToUpdate)}}getId(){return this.#idManager.id}get currentLayer(){return this.#allLayers.get(this.#currentPageIndex)}getLayer(pageIndex){return this.#allLayers.get(pageIndex)}get currentPageIndex(){return this.#currentPageIndex}addLayer(layer){this.#allLayers.set(layer.pageIndex,layer),this.#isEnabled?layer.enable():layer.disable()}removeLayer(layer){this.#allLayers.delete(layer.pageIndex)}async updateMode(mode,editId=null,isFromKeyboard=!1,mustEnterInEditMode=!1){if(this.#mode!==mode&&!(this.#updateModeCapability&&(await this.#updateModeCapability.promise,!this.#updateModeCapability))){if(this.#updateModeCapability=Promise.withResolvers(),this.#currentDrawingSession?.commitOrRemove(),this.#mode=mode,mode===AnnotationEditorType.NONE){this.setEditingState(!1),this.#disableAll(),this._editorUndoBar?.hide(),this.#updateModeCapability.resolve();return}mode===AnnotationEditorType.SIGNATURE&&await this.#signatureManager?.loadSignatures(),this.setEditingState(!0),await this.#enableAll(),this.unselectAll();for(const layer of this.#allLayers.values())layer.updateMode(mode);if(!editId){isFromKeyboard&&this.addNewEditorFromKeyboard(),this.#updateModeCapability.resolve();return}for(const editor of this.#allEditors.values())editor.annotationElementId===editId||editor.id===editId?(this.setSelected(editor),mustEnterInEditMode&&editor.enterInEditMode()):editor.unselect();this.#updateModeCapability.resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(options){options.mode!==this.#mode&&this._eventBus.dispatch("switchannotationeditormode",{source:this,...options})}updateParams(type,value){if(this.#editorTypes){switch(type){case AnnotationEditorParamsType.CREATE:this.currentLayer.addNewEditor(value);return;case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:this.#mainHighlightColorPicker?.updateColor(value);break;case AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(this.#showAllStates||=new Map).set(type,value),this.showAllEditors("highlight",value);break}for(const editor of this.#selectedEditors)editor.updateParams(type,value);for(const editorType of this.#editorTypes)editorType.updateDefaultParams(type,value)}}showAllEditors(type,visible,updateButton=!1){for(const editor of this.#allEditors.values())editor.editorType===type&&editor.show(visible);(this.#showAllStates?.get(AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL)??!0)!==visible&&this.#dispatchUpdateUI([[AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL,visible]])}enableWaiting(mustWait=!1){if(this.#isWaiting!==mustWait){this.#isWaiting=mustWait;for(const layer of this.#allLayers.values())mustWait?layer.disableClick():layer.enableClick(),layer.div.classList.toggle("waiting",mustWait)}}async#enableAll(){if(!this.#isEnabled){this.#isEnabled=!0;const promises=[];for(const layer of this.#allLayers.values())promises.push(layer.enable());await Promise.all(promises);for(const editor of this.#allEditors.values())editor.enable()}}#disableAll(){if(this.unselectAll(),this.#isEnabled){this.#isEnabled=!1;for(const layer of this.#allLayers.values())layer.disable();for(const editor of this.#allEditors.values())editor.disable()}}getEditors(pageIndex){const editors=[];for(const editor of this.#allEditors.values())editor.pageIndex===pageIndex&&editors.push(editor);return editors}getEditor(id){return this.#allEditors.get(id)}addEditor(editor){this.#allEditors.set(editor.id,editor)}removeEditor(editor){editor.div.contains(document.activeElement)&&(this.#focusMainContainerTimeoutId&&clearTimeout(this.#focusMainContainerTimeoutId),this.#focusMainContainerTimeoutId=setTimeout(()=>{this.focusMainContainer(),this.#focusMainContainerTimeoutId=null},0)),this.#allEditors.delete(editor.id),editor.annotationElementId&&this.#missingCanvases?.delete(editor.annotationElementId),this.unselect(editor),(!editor.annotationElementId||!this.#deletedAnnotationsElementIds.has(editor.annotationElementId))&&this.#annotationStorage?.remove(editor.id)}addDeletedAnnotationElement(editor){this.#deletedAnnotationsElementIds.add(editor.annotationElementId),this.addChangedExistingAnnotation(editor),editor.deleted=!0}isDeletedAnnotationElement(annotationElementId){return this.#deletedAnnotationsElementIds.has(annotationElementId)}removeDeletedAnnotationElement(editor){this.#deletedAnnotationsElementIds.delete(editor.annotationElementId),this.removeChangedExistingAnnotation(editor),editor.deleted=!1}#addEditorToLayer(editor){const layer=this.#allLayers.get(editor.pageIndex);layer?layer.addOrRebuild(editor):(this.addEditor(editor),this.addToAnnotationStorage(editor))}setActiveEditor(editor){this.#activeEditor!==editor&&(this.#activeEditor=editor,editor&&this.#dispatchUpdateUI(editor.propertiesToUpdate))}get#lastSelectedEditor(){let ed=null;for(ed of this.#selectedEditors);return ed}updateUI(editor){this.#lastSelectedEditor===editor&&this.#dispatchUpdateUI(editor.propertiesToUpdate)}updateUIForDefaultProperties(editorType){this.#dispatchUpdateUI(editorType.defaultPropertiesToUpdate)}toggleSelected(editor){if(this.#selectedEditors.has(editor)){this.#selectedEditors.delete(editor),editor.unselect(),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection});return}this.#selectedEditors.add(editor),editor.select(),this.#dispatchUpdateUI(editor.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}setSelected(editor){this.updateToolbar({mode:editor.mode,editId:editor.id}),this.#currentDrawingSession?.commitOrRemove();for(const ed of this.#selectedEditors)ed!==editor&&ed.unselect();this.#selectedEditors.clear(),this.#selectedEditors.add(editor),editor.select(),this.#dispatchUpdateUI(editor.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}isSelected(editor){return this.#selectedEditors.has(editor)}get firstSelectedEditor(){return this.#selectedEditors.values().next().value}unselect(editor){editor.unselect(),this.#selectedEditors.delete(editor),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#selectedEditors.size!==0}get isEnterHandled(){return this.#selectedEditors.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#commandManager.undo(),this.#dispatchUpdateStates({hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#isEmpty()}),this._editorUndoBar?.hide()}redo(){this.#commandManager.redo(),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),isEmpty:this.#isEmpty()})}addCommands(params){this.#commandManager.add(params),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#isEmpty()})}cleanUndoStack(type){this.#commandManager.cleanType(type)}#isEmpty(){if(this.#allEditors.size===0)return!0;if(this.#allEditors.size===1)for(const editor of this.#allEditors.values())return editor.isEmpty();return!1}delete(){this.commitOrRemove();const drawingEditor=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!drawingEditor)return;const editors=drawingEditor?[drawingEditor]:[...this.#selectedEditors],cmd=()=>{this._editorUndoBar?.show(undo,editors.length===1?editors[0].editorType:editors.length);for(const editor of editors)editor.remove()},undo=()=>{for(const editor of editors)this.#addEditorToLayer(editor)};this.addCommands({cmd,undo,mustExec:!0})}commitOrRemove(){this.#activeEditor?.commitOrRemove()}hasSomethingToControl(){return this.#activeEditor||this.hasSelection}#selectEditors(editors){for(const editor of this.#selectedEditors)editor.unselect();this.#selectedEditors.clear();for(const editor of editors)editor.isEmpty()||(this.#selectedEditors.add(editor),editor.select());this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}selectAll(){for(const editor of this.#selectedEditors)editor.commit();this.#selectEditors(this.#allEditors.values())}unselectAll(){if(!(this.#activeEditor&&(this.#activeEditor.commitOrRemove(),this.#mode!==AnnotationEditorType.NONE))&&!this.#currentDrawingSession?.commitOrRemove()&&this.hasSelection){for(const editor of this.#selectedEditors)editor.unselect();this.#selectedEditors.clear(),this.#dispatchUpdateStates({hasSelectedEditor:!1})}}translateSelectedEditors(x,y,noCommit=!1){if(noCommit||this.commitOrRemove(),!this.hasSelection)return;this.#translation[0]+=x,this.#translation[1]+=y;const[totalX,totalY]=this.#translation,editors=[...this.#selectedEditors],TIME_TO_WAIT=1e3;this.#translationTimeoutId&&clearTimeout(this.#translationTimeoutId),this.#translationTimeoutId=setTimeout(()=>{this.#translationTimeoutId=null,this.#translation[0]=this.#translation[1]=0,this.addCommands({cmd:()=>{for(const editor of editors)this.#allEditors.has(editor.id)&&(editor.translateInPage(totalX,totalY),editor.translationDone())},undo:()=>{for(const editor of editors)this.#allEditors.has(editor.id)&&(editor.translateInPage(-totalX,-totalY),editor.translationDone())},mustExec:!1})},TIME_TO_WAIT);for(const editor of editors)editor.translateInPage(x,y),editor.translationDone()}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),this.#draggingEditors=new Map;for(const editor of this.#selectedEditors)this.#draggingEditors.set(editor,{savedX:editor.x,savedY:editor.y,savedPageIndex:editor.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#draggingEditors)return!1;this.disableUserSelect(!1);const map=this.#draggingEditors;this.#draggingEditors=null;let mustBeAddedInUndoStack=!1;for(const[{x,y,pageIndex},value]of map)value.newX=x,value.newY=y,value.newPageIndex=pageIndex,mustBeAddedInUndoStack||=x!==value.savedX||y!==value.savedY||pageIndex!==value.savedPageIndex;if(!mustBeAddedInUndoStack)return!1;const move=(editor,x,y,pageIndex)=>{if(this.#allEditors.has(editor.id)){const parent=this.#allLayers.get(pageIndex);parent?editor._setParentAndPosition(parent,x,y):(editor.pageIndex=pageIndex,editor.x=x,editor.y=y)}};return this.addCommands({cmd:()=>{for(const[editor,{newX,newY,newPageIndex}]of map)move(editor,newX,newY,newPageIndex)},undo:()=>{for(const[editor,{savedX,savedY,savedPageIndex}]of map)move(editor,savedX,savedY,savedPageIndex)},mustExec:!0}),!0}dragSelectedEditors(tx,ty){if(this.#draggingEditors)for(const editor of this.#draggingEditors.keys())editor.drag(tx,ty)}rebuild(editor){if(editor.parent===null){const parent=this.getLayer(editor.pageIndex);parent?(parent.changeParent(editor),parent.addOrRebuild(editor)):(this.addEditor(editor),this.addToAnnotationStorage(editor),editor.rebuild())}else editor.parent.addOrRebuild(editor)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#selectedEditors.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(editor){return this.#activeEditor===editor}getActive(){return this.#activeEditor}getMode(){return this.#mode}get imageManager(){return shadow(this,"imageManager",new ImageManager)}getSelectionBoxes(textLayer){if(!textLayer)return null;const selection=document.getSelection();for(let i=0,ii=selection.rangeCount;i<ii;i++)if(!textLayer.contains(selection.getRangeAt(i).commonAncestorContainer))return null;const{x:layerX,y:layerY,width:parentWidth,height:parentHeight}=textLayer.getBoundingClientRect();let rotator;switch(textLayer.getAttribute("data-main-rotation")){case"90":rotator=(x,y,w,h)=>({x:(y-layerY)/parentHeight,y:1-(x+w-layerX)/parentWidth,width:h/parentHeight,height:w/parentWidth});break;case"180":rotator=(x,y,w,h)=>({x:1-(x+w-layerX)/parentWidth,y:1-(y+h-layerY)/parentHeight,width:w/parentWidth,height:h/parentHeight});break;case"270":rotator=(x,y,w,h)=>({x:1-(y+h-layerY)/parentHeight,y:(x-layerX)/parentWidth,width:h/parentHeight,height:w/parentWidth});break;default:rotator=(x,y,w,h)=>({x:(x-layerX)/parentWidth,y:(y-layerY)/parentHeight,width:w/parentWidth,height:h/parentHeight});break}const boxes=[];for(let i=0,ii=selection.rangeCount;i<ii;i++){const range=selection.getRangeAt(i);if(!range.collapsed)for(const{x,y,width,height}of range.getClientRects())width===0||height===0||boxes.push(rotator(x,y,width,height))}return boxes.length===0?null:boxes}addChangedExistingAnnotation({annotationElementId,id}){(this.#changedExistingAnnotations||=new Map).set(annotationElementId,id)}removeChangedExistingAnnotation({annotationElementId}){this.#changedExistingAnnotations?.delete(annotationElementId)}renderAnnotationElement(annotation){const editorId=this.#changedExistingAnnotations?.get(annotation.data.id);if(!editorId)return;const editor=this.#annotationStorage.getRawValue(editorId);editor&&(this.#mode===AnnotationEditorType.NONE&&!editor.hasBeenModified||editor.renderAnnotationElement(annotation))}setMissingCanvas(annotationId,annotationElementId,canvas){const editor=this.#missingCanvases?.get(annotationId);editor&&(editor.setCanvas(annotationElementId,canvas),this.#missingCanvases.delete(annotationId))}addMissingCanvas(annotationId,editor){(this.#missingCanvases||=new Map).set(annotationId,editor)}}class AltText{#altText=null;#altTextDecorative=!1;#altTextButton=null;#altTextButtonLabel=null;#altTextTooltip=null;#altTextTooltipTimeout=null;#altTextWasFromKeyBoard=!1;#badge=null;#editor=null;#guessedText=null;#textWithDisclaimer=null;#useNewAltTextFlow=!1;static#l10nNewButton=null;static _l10n=null;constructor(editor){this.#editor=editor,this.#useNewAltTextFlow=editor._uiManager.useNewAltTextFlow,AltText.#l10nNewButton||=Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"})}static initialize(l10n){AltText._l10n??=l10n}async render(){const altText=this.#altTextButton=document.createElement("button");altText.className="altText",altText.tabIndex="0";const label=this.#altTextButtonLabel=document.createElement("span");altText.append(label),this.#useNewAltTextFlow?(altText.classList.add("new"),altText.setAttribute("data-l10n-id",AltText.#l10nNewButton.missing),label.setAttribute("data-l10n-id",AltText.#l10nNewButton["missing-label"])):(altText.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),label.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));const signal=this.#editor._uiManager._signal;altText.addEventListener("contextmenu",noContextMenu,{signal}),altText.addEventListener("pointerdown",event=>event.stopPropagation(),{signal});const onClick=event=>{event.preventDefault(),this.#editor._uiManager.editAltText(this.#editor),this.#useNewAltTextFlow&&this.#editor._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:this.#label}})};return altText.addEventListener("click",onClick,{capture:!0,signal}),altText.addEventListener("keydown",event=>{event.target===altText&&event.key==="Enter"&&(this.#altTextWasFromKeyBoard=!0,onClick(event))},{signal}),await this.#setState(),altText}get#label(){return this.#altText&&"added"||this.#altText===null&&this.guessedText&&"review"||"missing"}finish(){this.#altTextButton&&(this.#altTextButton.focus({focusVisible:this.#altTextWasFromKeyBoard}),this.#altTextWasFromKeyBoard=!1)}isEmpty(){return this.#useNewAltTextFlow?this.#altText===null:!this.#altText&&!this.#altTextDecorative}hasData(){return this.#useNewAltTextFlow?this.#altText!==null||!!this.#guessedText:this.isEmpty()}get guessedText(){return this.#guessedText}async setGuessedText(guessedText){this.#altText===null&&(this.#guessedText=guessedText,this.#textWithDisclaimer=await AltText._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:guessedText}),this.#setState())}toggleAltTextBadge(visibility=!1){if(!this.#useNewAltTextFlow||this.#altText){this.#badge?.remove(),this.#badge=null;return}if(!this.#badge){const badge=this.#badge=document.createElement("div");badge.className="noAltTextBadge",this.#editor.div.append(badge)}this.#badge.classList.toggle("hidden",!visibility)}serialize(isForCopying){let altText=this.#altText;return!isForCopying&&this.#guessedText===altText&&(altText=this.#textWithDisclaimer),{altText,decorative:this.#altTextDecorative,guessedText:this.#guessedText,textWithDisclaimer:this.#textWithDisclaimer}}get data(){return{altText:this.#altText,decorative:this.#altTextDecorative}}set data({altText,decorative,guessedText,textWithDisclaimer,cancel=!1}){guessedText&&(this.#guessedText=guessedText,this.#textWithDisclaimer=textWithDisclaimer),!(this.#altText===altText&&this.#altTextDecorative===decorative)&&(cancel||(this.#altText=altText,this.#altTextDecorative=decorative),this.#setState())}toggle(enabled=!1){this.#altTextButton&&(!enabled&&this.#altTextTooltipTimeout&&(clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null),this.#altTextButton.disabled=!enabled)}shown(){this.#editor._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:this.#label}})}destroy(){this.#altTextButton?.remove(),this.#altTextButton=null,this.#altTextButtonLabel=null,this.#altTextTooltip=null,this.#badge?.remove(),this.#badge=null}async#setState(){const button=this.#altTextButton;if(!button)return;if(this.#useNewAltTextFlow){if(button.classList.toggle("done",!!this.#altText),button.setAttribute("data-l10n-id",AltText.#l10nNewButton[this.#label]),this.#altTextButtonLabel?.setAttribute("data-l10n-id",AltText.#l10nNewButton[`${this.#label}-label`]),!this.#altText){this.#altTextTooltip?.remove();return}}else{if(!this.#altText&&!this.#altTextDecorative){button.classList.remove("done"),this.#altTextTooltip?.remove();return}button.classList.add("done"),button.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let tooltip=this.#altTextTooltip;if(!tooltip){this.#altTextTooltip=tooltip=document.createElement("span"),tooltip.className="tooltip",tooltip.setAttribute("role","tooltip"),tooltip.id=`alt-text-tooltip-${this.#editor.id}`;const DELAY_TO_SHOW_TOOLTIP=100,signal=this.#editor._uiManager._signal;signal.addEventListener("abort",()=>{clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null},{once:!0}),button.addEventListener("mouseenter",()=>{this.#altTextTooltipTimeout=setTimeout(()=>{this.#altTextTooltipTimeout=null,this.#altTextTooltip.classList.add("show"),this.#editor._reportTelemetry({action:"alt_text_tooltip"})},DELAY_TO_SHOW_TOOLTIP)},{signal}),button.addEventListener("mouseleave",()=>{this.#altTextTooltipTimeout&&(clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null),this.#altTextTooltip?.classList.remove("show")},{signal})}this.#altTextDecorative?tooltip.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(tooltip.removeAttribute("data-l10n-id"),tooltip.textContent=this.#altText),tooltip.parentNode||button.append(tooltip),this.#editor.getElementForAltText()?.setAttribute("aria-describedby",tooltip.id)}}class TouchManager{#container;#isPinching=!1;#isPinchingStopped=null;#isPinchingDisabled;#onPinchStart;#onPinching;#onPinchEnd;#pointerDownAC=null;#signal;#touchInfo=null;#touchManagerAC;#touchMoveAC=null;constructor({container,isPinchingDisabled=null,isPinchingStopped=null,onPinchStart=null,onPinching=null,onPinchEnd=null,signal}){this.#container=container,this.#isPinchingStopped=isPinchingStopped,this.#isPinchingDisabled=isPinchingDisabled,this.#onPinchStart=onPinchStart,this.#onPinching=onPinching,this.#onPinchEnd=onPinchEnd,this.#touchManagerAC=new AbortController,this.#signal=AbortSignal.any([signal,this.#touchManagerAC.signal]),container.addEventListener("touchstart",this.#onTouchStart.bind(this),{passive:!1,signal:this.#signal})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/OutputScale.pixelRatio}#onTouchStart(evt){if(this.#isPinchingDisabled?.())return;if(evt.touches.length===1){if(this.#pointerDownAC)return;const pointerDownAC=this.#pointerDownAC=new AbortController,signal=AbortSignal.any([this.#signal,pointerDownAC.signal]),container=this.#container,opts={capture:!0,signal,passive:!1},cancelPointerDown=e=>{e.pointerType==="touch"&&(this.#pointerDownAC?.abort(),this.#pointerDownAC=null)};container.addEventListener("pointerdown",e=>{e.pointerType==="touch"&&(stopEvent(e),cancelPointerDown(e))},opts),container.addEventListener("pointerup",cancelPointerDown,opts),container.addEventListener("pointercancel",cancelPointerDown,opts);return}if(!this.#touchMoveAC){this.#touchMoveAC=new AbortController;const signal=AbortSignal.any([this.#signal,this.#touchMoveAC.signal]),container=this.#container,opt={signal,capture:!1,passive:!1};container.addEventListener("touchmove",this.#onTouchMove.bind(this),opt);const onTouchEnd=this.#onTouchEnd.bind(this);container.addEventListener("touchend",onTouchEnd,opt),container.addEventListener("touchcancel",onTouchEnd,opt),opt.capture=!0,container.addEventListener("pointerdown",stopEvent,opt),container.addEventListener("pointermove",stopEvent,opt),container.addEventListener("pointercancel",stopEvent,opt),container.addEventListener("pointerup",stopEvent,opt),this.#onPinchStart?.()}if(stopEvent(evt),evt.touches.length!==2||this.#isPinchingStopped?.()){this.#touchInfo=null;return}let[touch0,touch1]=evt.touches;touch0.identifier>touch1.identifier&&([touch0,touch1]=[touch1,touch0]),this.#touchInfo={touch0X:touch0.screenX,touch0Y:touch0.screenY,touch1X:touch1.screenX,touch1Y:touch1.screenY}}#onTouchMove(evt){if(!this.#touchInfo||evt.touches.length!==2)return;stopEvent(evt);let[touch0,touch1]=evt.touches;touch0.identifier>touch1.identifier&&([touch0,touch1]=[touch1,touch0]);const{screenX:screen0X,screenY:screen0Y}=touch0,{screenX:screen1X,screenY:screen1Y}=touch1,touchInfo=this.#touchInfo,{touch0X:pTouch0X,touch0Y:pTouch0Y,touch1X:pTouch1X,touch1Y:pTouch1Y}=touchInfo,prevGapX=pTouch1X-pTouch0X,prevGapY=pTouch1Y-pTouch0Y,currGapX=screen1X-screen0X,currGapY=screen1Y-screen0Y,distance=Math.hypot(currGapX,currGapY)||1,pDistance=Math.hypot(prevGapX,prevGapY)||1;if(!this.#isPinching&&Math.abs(pDistance-distance)<=TouchManager.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(touchInfo.touch0X=screen0X,touchInfo.touch0Y=screen0Y,touchInfo.touch1X=screen1X,touchInfo.touch1Y=screen1Y,!this.#isPinching){this.#isPinching=!0;return}const origin=[(screen0X+screen1X)/2,(screen0Y+screen1Y)/2];this.#onPinching?.(origin,pDistance,distance)}#onTouchEnd(evt){evt.touches.length>=2||(this.#touchMoveAC&&(this.#touchMoveAC.abort(),this.#touchMoveAC=null,this.#onPinchEnd?.()),this.#touchInfo&&(stopEvent(evt),this.#touchInfo=null,this.#isPinching=!1))}destroy(){this.#touchManagerAC?.abort(),this.#touchManagerAC=null,this.#pointerDownAC?.abort(),this.#pointerDownAC=null}}class AnnotationEditor{#accessibilityData=null;#allResizerDivs=null;#altText=null;#disabled=!1;#dragPointerId=null;#dragPointerType="";#keepAspectRatio=!1;#resizersDiv=null;#lastPointerCoords=null;#savedDimensions=null;#focusAC=null;#focusedResizerName="";#hasBeenClicked=!1;#initialRect=null;#isEditing=!1;#isInEditMode=!1;#isResizerEnabledForKeyboard=!1;#moveInDOMTimeout=null;#prevDragX=0;#prevDragY=0;#telemetryTimeouts=null;#touchManager=null;isSelected=!1;_isCopy=!1;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=!0;_uiManager=null;_focusEventsAllowed=!0;static _l10n=null;static _l10nResizer=null;#isDraggable=!1;#zIndex=AnnotationEditor._zIndex++;static _borderLineWidth=-1;static _colorManager=new ColorManager;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const resize=AnnotationEditor.prototype._resizeWithKeyboard,small=AnnotationEditorUIManager.TRANSLATE_SMALL,big=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_resizerKeyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],resize,{args:[-small,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],resize,{args:[-big,0]}],[["ArrowRight","mac+ArrowRight"],resize,{args:[small,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],resize,{args:[big,0]}],[["ArrowUp","mac+ArrowUp"],resize,{args:[0,-small]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],resize,{args:[0,-big]}],[["ArrowDown","mac+ArrowDown"],resize,{args:[0,small]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],resize,{args:[0,big]}],[["Escape","mac+Escape"],AnnotationEditor.prototype._stopResizingWithKeyboard]]))}constructor(parameters){this.parent=parameters.parent,this.id=parameters.id,this.width=this.height=null,this.pageIndex=parameters.parent.pageIndex,this.name=parameters.name,this.div=null,this._uiManager=parameters.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=parameters.isCentered,this._structTreeParentId=null,this.annotationElementId=parameters.annotationElementId||null;const{rotation,rawDims:{pageWidth,pageHeight,pageX,pageY}}=this.parent.viewport;this.rotation=rotation,this.pageRotation=(360+rotation-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[pageWidth,pageHeight],this.pageTranslation=[pageX,pageY];const[width,height]=this.parentDimensions;this.x=parameters.x/width,this.y=parameters.y/height,this.isAttachedToDOM=!1,this.deleted=!1}get editorType(){return Object.getPrototypeOf(this).constructor._type}get mode(){return Object.getPrototypeOf(this).constructor._editorType}static get isDrawer(){return!1}static get _defaultLineColor(){return shadow(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(editor){const fakeEditor=new FakeEditor({id:editor.parent.getNextId(),parent:editor.parent,uiManager:editor._uiManager});fakeEditor.annotationElementId=editor.annotationElementId,fakeEditor.deleted=!0,fakeEditor._uiManager.addToAnnotationStorage(fakeEditor)}static initialize(l10n,_uiManager){if(AnnotationEditor._l10n??=l10n,AnnotationEditor._l10nResizer||=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"}),AnnotationEditor._borderLineWidth!==-1)return;const style=getComputedStyle(document.documentElement);AnnotationEditor._borderLineWidth=parseFloat(style.getPropertyValue("--outline-width"))||0}static updateDefaultParams(_type,_value){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(mime){return!1}static paste(item,parent){unreachable("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#isDraggable}set _isDraggable(value){this.#isDraggable=value,this.div?.classList.toggle("draggable",value)}get isEnterHandled(){return!0}center(){const[pageWidth,pageHeight]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*pageHeight/(pageWidth*2),this.y+=this.width*pageWidth/(pageHeight*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*pageHeight/(pageWidth*2),this.y-=this.width*pageWidth/(pageHeight*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(params){this._uiManager.addCommands(params)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#zIndex}setParent(parent){parent!==null?(this.pageIndex=parent.pageIndex,this.pageDimensions=parent.pageDimensions):this.#stopResizing(),this.parent=parent}focusin(event){this._focusEventsAllowed&&(this.#hasBeenClicked?this.#hasBeenClicked=!1:this.parent.setSelected(this))}focusout(event){!this._focusEventsAllowed||!this.isAttachedToDOM||event.relatedTarget?.closest(`#${this.id}`)||(event.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.isInEditMode()&&this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(x,y,tx,ty){const[width,height]=this.parentDimensions;[tx,ty]=this.screenToPageTranslation(tx,ty),this.x=(x+tx)/width,this.y=(y+ty)/height,this.fixAndSetPosition()}_moveAfterPaste(baseX,baseY){const[parentWidth,parentHeight]=this.parentDimensions;this.setAt(baseX*parentWidth,baseY*parentHeight,this.width*parentWidth,this.height*parentHeight),this._onTranslated()}#translate([width,height],x,y){[x,y]=this.screenToPageTranslation(x,y),this.x+=x/width,this.y+=y/height,this._onTranslating(this.x,this.y),this.fixAndSetPosition()}translate(x,y){this.#translate(this.parentDimensions,x,y)}translateInPage(x,y){this.#initialRect||=[this.x,this.y,this.width,this.height],this.#translate(this.pageDimensions,x,y),this.div.scrollIntoView({block:"nearest"})}translationDone(){this._onTranslated(this.x,this.y)}drag(tx,ty){this.#initialRect||=[this.x,this.y,this.width,this.height];const{div,parentDimensions:[parentWidth,parentHeight]}=this;if(this.x+=tx/parentWidth,this.y+=ty/parentHeight,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:x2,y:y2}=this.div.getBoundingClientRect();this.parent.findNewParent(this,x2,y2)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x,y}=this;const[bx,by]=this.getBaseTranslation();x+=bx,y+=by;const{style}=div;style.left=`${(100*x).toFixed(2)}%`,style.top=`${(100*y).toFixed(2)}%`,this._onTranslating(x,y),div.scrollIntoView({block:"nearest"})}_onTranslating(x,y){}_onTranslated(x,y){}get _hasBeenMoved(){return!!this.#initialRect&&(this.#initialRect[0]!==this.x||this.#initialRect[1]!==this.y)}get _hasBeenResized(){return!!this.#initialRect&&(this.#initialRect[2]!==this.width||this.#initialRect[3]!==this.height)}getBaseTranslation(){const[parentWidth,parentHeight]=this.parentDimensions,{_borderLineWidth}=AnnotationEditor,x=_borderLineWidth/parentWidth,y=_borderLineWidth/parentHeight;switch(this.rotation){case 90:return[-x,y];case 180:return[x,y];case 270:return[x,-y];default:return[-x,-y]}}get _mustFixPosition(){return!0}fixAndSetPosition(rotation=this.rotation){const{div:{style},pageDimensions:[pageWidth,pageHeight]}=this;let{x,y,width,height}=this;if(width*=pageWidth,height*=pageHeight,x*=pageWidth,y*=pageHeight,this._mustFixPosition)switch(rotation){case 0:x=MathClamp(x,0,pageWidth-width),y=MathClamp(y,0,pageHeight-height);break;case 90:x=MathClamp(x,0,pageWidth-height),y=MathClamp(y,width,pageHeight);break;case 180:x=MathClamp(x,width,pageWidth),y=MathClamp(y,height,pageHeight);break;case 270:x=MathClamp(x,height,pageWidth),y=MathClamp(y,0,pageHeight-width);break}this.x=x/=pageWidth,this.y=y/=pageHeight;const[bx,by]=this.getBaseTranslation();x+=bx,y+=by,style.left=`${(100*x).toFixed(2)}%`,style.top=`${(100*y).toFixed(2)}%`,this.moveInDOM()}static#rotatePoint(x,y,angle){switch(angle){case 90:return[y,-x];case 180:return[-x,-y];case 270:return[-y,x];default:return[x,y]}}screenToPageTranslation(x,y){return AnnotationEditor.#rotatePoint(x,y,this.parentRotation)}pageTranslationToScreen(x,y){return AnnotationEditor.#rotatePoint(x,y,360-this.parentRotation)}#getRotationMatrix(rotation){switch(rotation){case 90:{const[pageWidth,pageHeight]=this.pageDimensions;return[0,-pageWidth/pageHeight,pageHeight/pageWidth,0]}case 180:return[-1,0,0,-1];case 270:{const[pageWidth,pageHeight]=this.pageDimensions;return[0,pageWidth/pageHeight,-pageHeight/pageWidth,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale,pageDimensions:[pageWidth,pageHeight]}=this;return[pageWidth*parentScale,pageHeight*parentScale]}setDims(width,height){const[parentWidth,parentHeight]=this.parentDimensions,{style}=this.div;style.width=`${(100*width/parentWidth).toFixed(2)}%`,this.#keepAspectRatio||(style.height=`${(100*height/parentHeight).toFixed(2)}%`)}fixDims(){const{style}=this.div,{height,width}=style,widthPercent=width.endsWith("%"),heightPercent=!this.#keepAspectRatio&&height.endsWith("%");if(widthPercent&&heightPercent)return;const[parentWidth,parentHeight]=this.parentDimensions;widthPercent||(style.width=`${(100*parseFloat(width)/parentWidth).toFixed(2)}%`),!this.#keepAspectRatio&&!heightPercent&&(style.height=`${(100*parseFloat(height)/parentHeight).toFixed(2)}%`)}getInitialTranslation(){return[0,0]}#createResizers(){if(this.#resizersDiv)return;this.#resizersDiv=document.createElement("div"),this.#resizersDiv.classList.add("resizers");const classes=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],signal=this._uiManager._signal;for(const name of classes){const div=document.createElement("div");this.#resizersDiv.append(div),div.classList.add("resizer",name),div.setAttribute("data-resizer-name",name),div.addEventListener("pointerdown",this.#resizerPointerdown.bind(this,name),{signal}),div.addEventListener("contextmenu",noContextMenu,{signal}),div.tabIndex=-1}this.div.prepend(this.#resizersDiv)}#resizerPointerdown(name,event){event.preventDefault();const{isMac}=util_FeatureTest.platform;if(event.button!==0||event.ctrlKey&&isMac)return;this.#altText?.toggle(!1);const savedDraggable=this._isDraggable;this._isDraggable=!1,this.#lastPointerCoords=[event.screenX,event.screenY];const ac=new AbortController,signal=this._uiManager.combinedSignal(ac);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",this.#resizerPointermove.bind(this,name),{passive:!0,capture:!0,signal}),window.addEventListener("touchmove",stopEvent,{passive:!1,signal}),window.addEventListener("contextmenu",noContextMenu,{signal}),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const savedParentCursor=this.parent.div.style.cursor,savedCursor=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(event.target).cursor;const pointerUpCallback=()=>{ac.abort(),this.parent.togglePointerEvents(!0),this.#altText?.toggle(!0),this._isDraggable=savedDraggable,this.parent.div.style.cursor=savedParentCursor,this.div.style.cursor=savedCursor,this.#addResizeToUndoStack()};window.addEventListener("pointerup",pointerUpCallback,{signal}),window.addEventListener("blur",pointerUpCallback,{signal})}#resize(x,y,width,height){this.width=width,this.height=height,this.x=x,this.y=y;const[parentWidth,parentHeight]=this.parentDimensions;this.setDims(parentWidth*width,parentHeight*height),this.fixAndSetPosition(),this._onResized()}_onResized(){}#addResizeToUndoStack(){if(!this.#savedDimensions)return;const{savedX,savedY,savedWidth,savedHeight}=this.#savedDimensions;this.#savedDimensions=null;const newX=this.x,newY=this.y,newWidth=this.width,newHeight=this.height;newX===savedX&&newY===savedY&&newWidth===savedWidth&&newHeight===savedHeight||this.addCommands({cmd:this.#resize.bind(this,newX,newY,newWidth,newHeight),undo:this.#resize.bind(this,savedX,savedY,savedWidth,savedHeight),mustExec:!0})}static _round(x){return Math.round(x*1e4)/1e4}#resizerPointermove(name,event){const[parentWidth,parentHeight]=this.parentDimensions,savedX=this.x,savedY=this.y,savedWidth=this.width,savedHeight=this.height,minWidth=AnnotationEditor.MIN_SIZE/parentWidth,minHeight=AnnotationEditor.MIN_SIZE/parentHeight,rotationMatrix=this.#getRotationMatrix(this.rotation),transf=(x,y)=>[rotationMatrix[0]*x+rotationMatrix[2]*y,rotationMatrix[1]*x+rotationMatrix[3]*y],invRotationMatrix=this.#getRotationMatrix(360-this.rotation),invTransf=(x,y)=>[invRotationMatrix[0]*x+invRotationMatrix[2]*y,invRotationMatrix[1]*x+invRotationMatrix[3]*y];let getPoint,getOpposite,isDiagonal=!1,isHorizontal=!1;switch(name){case"topLeft":isDiagonal=!0,getPoint=(w,h)=>[0,0],getOpposite=(w,h)=>[w,h];break;case"topMiddle":getPoint=(w,h)=>[w/2,0],getOpposite=(w,h)=>[w/2,h];break;case"topRight":isDiagonal=!0,getPoint=(w,h)=>[w,0],getOpposite=(w,h)=>[0,h];break;case"middleRight":isHorizontal=!0,getPoint=(w,h)=>[w,h/2],getOpposite=(w,h)=>[0,h/2];break;case"bottomRight":isDiagonal=!0,getPoint=(w,h)=>[w,h],getOpposite=(w,h)=>[0,0];break;case"bottomMiddle":getPoint=(w,h)=>[w/2,h],getOpposite=(w,h)=>[w/2,0];break;case"bottomLeft":isDiagonal=!0,getPoint=(w,h)=>[0,h],getOpposite=(w,h)=>[w,0];break;case"middleLeft":isHorizontal=!0,getPoint=(w,h)=>[0,h/2],getOpposite=(w,h)=>[w,h/2];break}const point=getPoint(savedWidth,savedHeight),oppositePoint=getOpposite(savedWidth,savedHeight);let transfOppositePoint=transf(...oppositePoint);const oppositeX=AnnotationEditor._round(savedX+transfOppositePoint[0]),oppositeY=AnnotationEditor._round(savedY+transfOppositePoint[1]);let ratioX=1,ratioY=1,deltaX,deltaY;if(event.fromKeyboard)({deltaX,deltaY}=event);else{const{screenX,screenY}=event,[lastScreenX,lastScreenY]=this.#lastPointerCoords;[deltaX,deltaY]=this.screenToPageTranslation(screenX-lastScreenX,screenY-lastScreenY),this.#lastPointerCoords[0]=screenX,this.#lastPointerCoords[1]=screenY}if([deltaX,deltaY]=invTransf(deltaX/parentWidth,deltaY/parentHeight),isDiagonal){const oldDiag=Math.hypot(savedWidth,savedHeight);ratioX=ratioY=Math.max(Math.min(Math.hypot(oppositePoint[0]-point[0]-deltaX,oppositePoint[1]-point[1]-deltaY)/oldDiag,1/savedWidth,1/savedHeight),minWidth/savedWidth,minHeight/savedHeight)}else isHorizontal?ratioX=MathClamp(Math.abs(oppositePoint[0]-point[0]-deltaX),minWidth,1)/savedWidth:ratioY=MathClamp(Math.abs(oppositePoint[1]-point[1]-deltaY),minHeight,1)/savedHeight;const newWidth=AnnotationEditor._round(savedWidth*ratioX),newHeight=AnnotationEditor._round(savedHeight*ratioY);transfOppositePoint=transf(...getOpposite(newWidth,newHeight));const newX=oppositeX-transfOppositePoint[0],newY=oppositeY-transfOppositePoint[1];this.#initialRect||=[this.x,this.y,this.width,this.height],this.width=newWidth,this.height=newHeight,this.x=newX,this.y=newY,this.setDims(parentWidth*newWidth,parentHeight*newHeight),this.fixAndSetPosition(),this._onResizing()}_onResizing(){}altTextFinish(){this.#altText?.finish()}get toolbarButtons(){return null}async addEditToolbar(){if(this._editToolbar||this.#isInEditMode)return this._editToolbar;this._editToolbar=new EditorToolbar(this),this.div.append(this._editToolbar.render());const{toolbarButtons}=this;if(toolbarButtons)for(const[name,tool]of toolbarButtons)await this._editToolbar.addButton(name,tool);return this._editToolbar.addButton("delete"),this._editToolbar}removeEditToolbar(){this._editToolbar&&(this._editToolbar.remove(),this._editToolbar=null,this.#altText?.destroy())}addContainer(container){const editToolbarDiv=this._editToolbar?.div;editToolbarDiv?editToolbarDiv.before(container):this.div.append(container)}getClientDimensions(){return this.div.getBoundingClientRect()}createAltText(){return this.#altText||(AltText.initialize(AnnotationEditor._l10n),this.#altText=new AltText(this),this.#accessibilityData&&(this.#altText.data=this.#accessibilityData,this.#accessibilityData=null)),this.#altText}get altTextData(){return this.#altText?.data}set altTextData(data){this.#altText&&(this.#altText.data=data)}get guessedAltText(){return this.#altText?.guessedText}async setGuessedAltText(text){await this.#altText?.setGuessedText(text)}serializeAltText(isForCopying){return this.#altText?.serialize(isForCopying)}hasAltText(){return!!this.#altText&&!this.#altText.isEmpty()}hasAltTextData(){return this.#altText?.hasData()??!1}render(){const div=this.div=document.createElement("div");div.setAttribute("data-editor-rotation",(360-this.rotation)%360),div.className=this.name,div.setAttribute("id",this.id),div.tabIndex=this.#disabled?-1:0,div.setAttribute("role","application"),this.defaultL10nId&&div.setAttribute("data-l10n-id",this.defaultL10nId),this._isVisible||div.classList.add("hidden"),this.setInForeground(),this.#addFocusListeners();const[parentWidth,parentHeight]=this.parentDimensions;this.parentRotation%180!==0&&(div.style.maxWidth=`${(100*parentHeight/parentWidth).toFixed(2)}%`,div.style.maxHeight=`${(100*parentWidth/parentHeight).toFixed(2)}%`);const[tx,ty]=this.getInitialTranslation();return this.translate(tx,ty),bindEvents(this,div,["keydown","pointerdown","dblclick"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(this.#touchManager||=new TouchManager({container:div,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#touchPinchStartCallback.bind(this),onPinching:this.#touchPinchCallback.bind(this),onPinchEnd:this.#touchPinchEndCallback.bind(this),signal:this._uiManager._signal})),this._uiManager._editorUndoBar?.hide(),div}#touchPinchStartCallback(){this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height},this.#altText?.toggle(!1),this.parent.togglePointerEvents(!1)}#touchPinchCallback(_origin,prevDistance,distance){let factor=.7*(distance/prevDistance)+1-.7;if(factor===1)return;const rotationMatrix=this.#getRotationMatrix(this.rotation),transf=(x,y)=>[rotationMatrix[0]*x+rotationMatrix[2]*y,rotationMatrix[1]*x+rotationMatrix[3]*y],[parentWidth,parentHeight]=this.parentDimensions,savedX=this.x,savedY=this.y,savedWidth=this.width,savedHeight=this.height,minWidth=AnnotationEditor.MIN_SIZE/parentWidth,minHeight=AnnotationEditor.MIN_SIZE/parentHeight;factor=Math.max(Math.min(factor,1/savedWidth,1/savedHeight),minWidth/savedWidth,minHeight/savedHeight);const newWidth=AnnotationEditor._round(savedWidth*factor),newHeight=AnnotationEditor._round(savedHeight*factor);if(newWidth===savedWidth&&newHeight===savedHeight)return;this.#initialRect||=[savedX,savedY,savedWidth,savedHeight];const transfCenterPoint=transf(savedWidth/2,savedHeight/2),centerX=AnnotationEditor._round(savedX+transfCenterPoint[0]),centerY=AnnotationEditor._round(savedY+transfCenterPoint[1]),newTransfCenterPoint=transf(newWidth/2,newHeight/2);this.x=centerX-newTransfCenterPoint[0],this.y=centerY-newTransfCenterPoint[1],this.width=newWidth,this.height=newHeight,this.setDims(parentWidth*newWidth,parentHeight*newHeight),this.fixAndSetPosition(),this._onResizing()}#touchPinchEndCallback(){this.#altText?.toggle(!0),this.parent.togglePointerEvents(!0),this.#addResizeToUndoStack()}pointerdown(event){const{isMac}=util_FeatureTest.platform;if(event.button!==0||event.ctrlKey&&isMac){event.preventDefault();return}if(this.#hasBeenClicked=!0,this._isDraggable){this.#setUpDragSession(event);return}this.#selectOnPointerEvent(event)}#selectOnPointerEvent(event){const{isMac}=util_FeatureTest.platform;event.ctrlKey&&!isMac||event.shiftKey||event.metaKey&&isMac?this.parent.toggleSelected(this):this.parent.setSelected(this)}#setUpDragSession(event){const{isSelected}=this;this._uiManager.setUpDragSession();let hasDraggingStarted=!1;const ac=new AbortController,signal=this._uiManager.combinedSignal(ac),opts={capture:!0,passive:!1,signal},cancelDrag=e=>{ac.abort(),this.#dragPointerId=null,this.#hasBeenClicked=!1,this._uiManager.endDragSession()||this.#selectOnPointerEvent(e),hasDraggingStarted&&this._onStopDragging()};isSelected&&(this.#prevDragX=event.clientX,this.#prevDragY=event.clientY,this.#dragPointerId=event.pointerId,this.#dragPointerType=event.pointerType,window.addEventListener("pointermove",e=>{hasDraggingStarted||(hasDraggingStarted=!0,this._onStartDragging());const{clientX:x,clientY:y,pointerId}=e;if(pointerId!==this.#dragPointerId){stopEvent(e);return}const[tx,ty]=this.screenToPageTranslation(x-this.#prevDragX,y-this.#prevDragY);this.#prevDragX=x,this.#prevDragY=y,this._uiManager.dragSelectedEditors(tx,ty)},opts),window.addEventListener("touchmove",stopEvent,opts),window.addEventListener("pointerdown",e=>{e.pointerType===this.#dragPointerType&&(this.#touchManager||e.isPrimary)&&cancelDrag(e),stopEvent(e)},opts));const pointerUpCallback=e=>{if(!this.#dragPointerId||this.#dragPointerId===e.pointerId){cancelDrag(e);return}stopEvent(e)};window.addEventListener("pointerup",pointerUpCallback,{signal}),window.addEventListener("blur",pointerUpCallback,{signal})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){this.#moveInDOMTimeout&&clearTimeout(this.#moveInDOMTimeout),this.#moveInDOMTimeout=setTimeout(()=>{this.#moveInDOMTimeout=null,this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(parent,x,y){parent.changeParent(this),this.x=x,this.y=y,this.fixAndSetPosition(),this._onTranslated()}getRect(tx,ty,rotation=this.rotation){const scale=this.parentScale,[pageWidth,pageHeight]=this.pageDimensions,[pageX,pageY]=this.pageTranslation,shiftX=tx/scale,shiftY=ty/scale,x=this.x*pageWidth,y=this.y*pageHeight,width=this.width*pageWidth,height=this.height*pageHeight;switch(rotation){case 0:return[x+shiftX+pageX,pageHeight-y-shiftY-height+pageY,x+shiftX+width+pageX,pageHeight-y-shiftY+pageY];case 90:return[x+shiftY+pageX,pageHeight-y+shiftX+pageY,x+shiftY+height+pageX,pageHeight-y+shiftX+width+pageY];case 180:return[x-shiftX-width+pageX,pageHeight-y+shiftY+pageY,x-shiftX+pageX,pageHeight-y+shiftY+height+pageY];case 270:return[x-shiftY-height+pageX,pageHeight-y-shiftX-width+pageY,x-shiftY+pageX,pageHeight-y-shiftX+pageY];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(rect,pageHeight){const[x1,y1,x2,y2]=rect,width=x2-x1,height=y2-y1;switch(this.rotation){case 0:return[x1,pageHeight-y2,width,height];case 90:return[x1,pageHeight-y1,height,width];case 180:return[x2,pageHeight-y1,width,height];case 270:return[x2,pageHeight-y2,height,width];default:throw new Error("Invalid rotation")}}onceAdded(focus){}isEmpty(){return!1}enableEditMode(){return this.isInEditMode()?!1:(this.parent.setEditingState(!1),this.#isInEditMode=!0,!0)}disableEditMode(){return this.isInEditMode()?(this.parent.setEditingState(!0),this.#isInEditMode=!1,!0):!1}isInEditMode(){return this.#isInEditMode}shouldGetKeyboardEvents(){return this.#isResizerEnabledForKeyboard}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top,left,bottom,right}=this.getClientDimensions(),{innerHeight,innerWidth}=window;return left<innerWidth&&right>0&&top<innerHeight&&bottom>0}#addFocusListeners(){if(this.#focusAC||!this.div)return;this.#focusAC=new AbortController;const signal=this._uiManager.combinedSignal(this.#focusAC);this.div.addEventListener("focusin",this.focusin.bind(this),{signal}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal})}rebuild(){this.#addFocusListeners()}rotate(_angle){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(isForCopying=!1,context=null){unreachable("An editor must be serializable")}static async deserialize(data,parent,uiManager){const editor=new this.prototype.constructor({parent,id:parent.getNextId(),uiManager,annotationElementId:data.annotationElementId});editor.rotation=data.rotation,editor.#accessibilityData=data.accessibilityData,editor._isCopy=data.isCopy||!1;const[pageWidth,pageHeight]=editor.pageDimensions,[x,y,width,height]=editor.getRectInCurrentCoords(data.rect,pageHeight);return editor.x=x/pageWidth,editor.y=y/pageHeight,editor.width=width/pageWidth,editor.height=height/pageHeight,editor}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){if(this.#focusAC?.abort(),this.#focusAC=null,this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.#moveInDOMTimeout&&(clearTimeout(this.#moveInDOMTimeout),this.#moveInDOMTimeout=null),this.#stopResizing(),this.removeEditToolbar(),this.#telemetryTimeouts){for(const timeout of this.#telemetryTimeouts.values())clearTimeout(timeout);this.#telemetryTimeouts=null}this.parent=null,this.#touchManager?.destroy(),this.#touchManager=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#createResizers(),this.#resizersDiv.classList.remove("hidden"))}get toolbarPosition(){return null}keydown(event){if(!this.isResizable||event.target!==this.div||event.key!=="Enter")return;this._uiManager.setSelected(this),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const children=this.#resizersDiv.children;if(!this.#allResizerDivs){this.#allResizerDivs=Array.from(children);const boundResizerKeydown=this.#resizerKeydown.bind(this),boundResizerBlur=this.#resizerBlur.bind(this),signal=this._uiManager._signal;for(const div of this.#allResizerDivs){const name=div.getAttribute("data-resizer-name");div.setAttribute("role","spinbutton"),div.addEventListener("keydown",boundResizerKeydown,{signal}),div.addEventListener("blur",boundResizerBlur,{signal}),div.addEventListener("focus",this.#resizerFocus.bind(this,name),{signal}),div.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[name])}}const first=this.#allResizerDivs[0];let firstPosition=0;for(const div of children){if(div===first)break;firstPosition++}const nextFirstPosition=(360-this.rotation+this.parentRotation)%360/90*(this.#allResizerDivs.length/4);if(nextFirstPosition!==firstPosition){if(nextFirstPosition<firstPosition)for(let i2=0;i2<firstPosition-nextFirstPosition;i2++)this.#resizersDiv.append(this.#resizersDiv.firstChild);else if(nextFirstPosition>firstPosition)for(let i2=0;i2<nextFirstPosition-firstPosition;i2++)this.#resizersDiv.firstChild.before(this.#resizersDiv.lastChild);let i=0;for(const child of children){const name=this.#allResizerDivs[i++].getAttribute("data-resizer-name");child.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[name])}}this.#setResizerTabIndex(0),this.#isResizerEnabledForKeyboard=!0,this.#resizersDiv.firstChild.focus({focusVisible:!0}),event.preventDefault(),event.stopImmediatePropagation()}#resizerKeydown(event){AnnotationEditor._resizerKeyboardManager.exec(this,event)}#resizerBlur(event){this.#isResizerEnabledForKeyboard&&event.relatedTarget?.parentNode!==this.#resizersDiv&&this.#stopResizing()}#resizerFocus(name){this.#focusedResizerName=this.#isResizerEnabledForKeyboard?name:""}#setResizerTabIndex(value){if(this.#allResizerDivs)for(const div of this.#allResizerDivs)div.tabIndex=value}_resizeWithKeyboard(x,y){this.#isResizerEnabledForKeyboard&&this.#resizerPointermove(this.#focusedResizerName,{deltaX:x,deltaY:y,fromKeyboard:!0})}#stopResizing(){this.#isResizerEnabledForKeyboard=!1,this.#setResizerTabIndex(-1),this.#addResizeToUndoStack()}_stopResizingWithKeyboard(){this.#stopResizing(),this.div.focus()}select(){if(!(this.isSelected&&this._editToolbar)){if(this.isSelected=!0,this.makeResizable(),this.div?.classList.add("selectedEditor"),!this._editToolbar){this.addEditToolbar().then(()=>{this.div?.classList.contains("selectedEditor")&&this._editToolbar?.show()});return}this._editToolbar?.show(),this.#altText?.toggleAltTextBadge(!1)}}unselect(){this.isSelected&&(this.isSelected=!1,this.#resizersDiv?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),this.#altText?.toggleAltTextBadge(!0))}updateParams(type,value){}disableEditing(){}enableEditing(){}get canChangeContent(){return!1}enterInEditMode(){this.canChangeContent&&(this.enableEditMode(),this.div.focus())}dblclick(event){this.enterInEditMode(),this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.id})}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#isEditing}set isEditing(value){this.#isEditing=value,this.parent&&(value?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}setAspectRatio(width,height){this.#keepAspectRatio=!0;const aspectRatio=width/height,{style}=this.div;style.aspectRatio=aspectRatio,style.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(data,mustWait=!1){if(mustWait){this.#telemetryTimeouts||=new Map;const{action}=data;let timeout=this.#telemetryTimeouts.get(action);timeout&&clearTimeout(timeout),timeout=setTimeout(()=>{this._reportTelemetry(data),this.#telemetryTimeouts.delete(action),this.#telemetryTimeouts.size===0&&(this.#telemetryTimeouts=null)},AnnotationEditor._telemetryTimeout),this.#telemetryTimeouts.set(action,timeout);return}data.type||=this.editorType,this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data}})}show(visible=this._isVisible){this.div.classList.toggle("hidden",!visible),this._isVisible=visible}enable(){this.div&&(this.div.tabIndex=0),this.#disabled=!1}disable(){this.div&&(this.div.tabIndex=-1),this.#disabled=!0}renderAnnotationElement(annotation){let content=annotation.container.querySelector(".annotationContent");if(!content)content=document.createElement("div"),content.classList.add("annotationContent",this.editorType),annotation.container.prepend(content);else if(content.nodeName==="CANVAS"){const canvas=content;content=document.createElement("div"),content.classList.add("annotationContent",this.editorType),canvas.before(content)}return content}resetAnnotationElement(annotation){const{firstChild}=annotation.container;firstChild?.nodeName==="DIV"&&firstChild.classList.contains("annotationContent")&&firstChild.remove()}}class FakeEditor extends AnnotationEditor{constructor(params){super(params),this.annotationElementId=params.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}}const SEED=3285377520,MASK_HIGH=4294901760,MASK_LOW=65535;class MurmurHash3_64{constructor(seed){this.h1=seed?seed&4294967295:SEED,this.h2=seed?seed&4294967295:SEED}update(input){let data,length;if(typeof input=="string"){data=new Uint8Array(input.length*2),length=0;for(let i=0,ii=input.length;i<ii;i++){const code=input.charCodeAt(i);code<=255?data[length++]=code:(data[length++]=code>>>8,data[length++]=code&255)}}else if(ArrayBuffer.isView(input))data=input.slice(),length=data.byteLength;else throw new Error("Invalid data format, must be a string or TypedArray.");const blockCounts=length>>2,tailLength=length-blockCounts*4,dataUint32=new Uint32Array(data.buffer,0,blockCounts);let k1=0,k2=0,h1=this.h1,h2=this.h2;const C1=3432918353,C2=461845907,C1_LOW=C1&MASK_LOW,C2_LOW=C2&MASK_LOW;for(let i=0;i<blockCounts;i++)i&1?(k1=dataUint32[i],k1=k1*C1&MASK_HIGH|k1*C1_LOW&MASK_LOW,k1=k1<<15|k1>>>17,k1=k1*C2&MASK_HIGH|k1*C2_LOW&MASK_LOW,h1^=k1,h1=h1<<13|h1>>>19,h1=h1*5+3864292196):(k2=dataUint32[i],k2=k2*C1&MASK_HIGH|k2*C1_LOW&MASK_LOW,k2=k2<<15|k2>>>17,k2=k2*C2&MASK_HIGH|k2*C2_LOW&MASK_LOW,h2^=k2,h2=h2<<13|h2>>>19,h2=h2*5+3864292196);switch(k1=0,tailLength){case 3:k1^=data[blockCounts*4+2]<<16;case 2:k1^=data[blockCounts*4+1]<<8;case 1:k1^=data[blockCounts*4],k1=k1*C1&MASK_HIGH|k1*C1_LOW&MASK_LOW,k1=k1<<15|k1>>>17,k1=k1*C2&MASK_HIGH|k1*C2_LOW&MASK_LOW,blockCounts&1?h1^=k1:h2^=k1}this.h1=h1,this.h2=h2}hexdigest(){let h1=this.h1,h2=this.h2;return h1^=h2>>>1,h1=h1*3981806797&MASK_HIGH|h1*36045&MASK_LOW,h2=h2*4283543511&MASK_HIGH|((h2<<16|h1>>>16)*2950163797&MASK_HIGH)>>>16,h1^=h2>>>1,h1=h1*444984403&MASK_HIGH|h1*60499&MASK_LOW,h2=h2*3301882366&MASK_HIGH|((h2<<16|h1>>>16)*3120437893&MASK_HIGH)>>>16,h1^=h2>>>1,(h1>>>0).toString(16).padStart(8,"0")+(h2>>>0).toString(16).padStart(8,"0")}}const SerializableEmpty=Object.freeze({map:null,hash:"",transfer:void 0});class AnnotationStorage{#modified=!1;#modifiedIds=null;#storage=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(key,defaultValue){const value=this.#storage.get(key);return value===void 0?defaultValue:Object.assign(defaultValue,value)}getRawValue(key){return this.#storage.get(key)}remove(key){if(this.#storage.delete(key),this.#storage.size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function"){for(const value of this.#storage.values())if(value instanceof AnnotationEditor)return;this.onAnnotationEditor(null)}}setValue(key,value){const obj=this.#storage.get(key);let modified=!1;if(obj!==void 0)for(const[entry,val]of Object.entries(value))obj[entry]!==val&&(modified=!0,obj[entry]=val);else modified=!0,this.#storage.set(key,value);modified&&this.#setModified(),value instanceof AnnotationEditor&&typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(value.constructor._type)}has(key){return this.#storage.has(key)}get size(){return this.#storage.size}#setModified(){this.#modified||(this.#modified=!0,typeof this.onSetModified=="function"&&this.onSetModified())}resetModified(){this.#modified&&(this.#modified=!1,typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new PrintAnnotationStorage(this)}get serializable(){if(this.#storage.size===0)return SerializableEmpty;const map=new Map,hash=new MurmurHash3_64,transfer=[],context=Object.create(null);let hasBitmap=!1;for(const[key,val]of this.#storage){const serialized=val instanceof AnnotationEditor?val.serialize(!1,context):val;serialized&&(map.set(key,serialized),hash.update(`${key}:${JSON.stringify(serialized)}`),hasBitmap||=!!serialized.bitmap)}if(hasBitmap)for(const value of map.values())value.bitmap&&transfer.push(value.bitmap);return map.size>0?{map,hash:hash.hexdigest(),transfer}:SerializableEmpty}get editorStats(){let stats=null;const typeToEditor=new Map;for(const value of this.#storage.values()){if(!(value instanceof AnnotationEditor))continue;const editorStats=value.telemetryFinalData;if(!editorStats)continue;const{type}=editorStats;typeToEditor.has(type)||typeToEditor.set(type,Object.getPrototypeOf(value).constructor),stats||=Object.create(null);const map=stats[type]||=new Map;for(const[key,val]of Object.entries(editorStats)){if(key==="type")continue;let counters=map.get(key);counters||(counters=new Map,map.set(key,counters));const count=counters.get(val)??0;counters.set(val,count+1)}}for(const[type,editor]of typeToEditor)stats[type]=editor.computeTelemetryFinalData(stats[type]);return stats}resetModifiedIds(){this.#modifiedIds=null}get modifiedIds(){if(this.#modifiedIds)return this.#modifiedIds;const ids=[];for(const value of this.#storage.values())!(value instanceof AnnotationEditor)||!value.annotationElementId||!value.serialize()||ids.push(value.annotationElementId);return this.#modifiedIds={ids:new Set(ids),hash:ids.join(",")}}[Symbol.iterator](){return this.#storage.entries()}}class PrintAnnotationStorage extends AnnotationStorage{#serializable;constructor(parent){super();const{map,hash,transfer}=parent.serializable,clone=structuredClone(map,transfer?{transfer}:null);this.#serializable={map:clone,hash,transfer}}get print(){unreachable("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#serializable}get modifiedIds(){return shadow(this,"modifiedIds",{ids:new Set,hash:""})}}class FontLoader{#systemFonts=new Set;constructor({ownerDocument=globalThis.document,styleElement=null}){this._document=ownerDocument,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(nativeFontFace){this.nativeFontFaces.add(nativeFontFace),this._document.fonts.add(nativeFontFace)}removeNativeFontFace(nativeFontFace){this.nativeFontFaces.delete(nativeFontFace),this._document.fonts.delete(nativeFontFace)}insertRule(rule){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const styleSheet=this.styleElement.sheet;styleSheet.insertRule(rule,styleSheet.cssRules.length)}clear(){for(const nativeFontFace of this.nativeFontFaces)this._document.fonts.delete(nativeFontFace);this.nativeFontFaces.clear(),this.#systemFonts.clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:info2,disableFontFace,_inspectFont}){if(!(!info2||this.#systemFonts.has(info2.loadedName))){if(assert(!disableFontFace,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName,src,style}=info2,fontFace=new FontFace(loadedName,src,style);this.addNativeFontFace(fontFace);try{await fontFace.load(),this.#systemFonts.add(loadedName),_inspectFont?.(info2)}catch{warn(`Cannot load system font: ${info2.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(fontFace)}return}unreachable("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(font){if(font.attached||font.missingFile&&!font.systemFontInfo)return;if(font.attached=!0,font.systemFontInfo){await this.loadSystemFont(font);return}if(this.isFontLoadingAPISupported){const nativeFontFace=font.createNativeFontFace();if(nativeFontFace){this.addNativeFontFace(nativeFontFace);try{await nativeFontFace.loaded}catch(ex){throw warn(`Failed to load font '${nativeFontFace.family}': '${ex}'.`),font.disableFontFace=!0,ex}}return}const rule=font.createFontFaceRule();if(rule){if(this.insertRule(rule),this.isSyncFontLoadingSupported)return;await new Promise(resolve=>{const request=this._queueLoadingCallback(resolve);this._prepareFontLoadEvent(font,request)})}}get isFontLoadingAPISupported(){const hasFonts=!!this._document?.fonts;return shadow(this,"isFontLoadingAPISupported",hasFonts)}get isSyncFontLoadingSupported(){return shadow(this,"isSyncFontLoadingSupported",isNodeJS||util_FeatureTest.platform.isFirefox)}_queueLoadingCallback(callback){function completeRequest(){for(assert(!request.done,"completeRequest() cannot be called twice."),request.done=!0;loadingRequests.length>0&&loadingRequests[0].done;){const otherRequest=loadingRequests.shift();setTimeout(otherRequest.callback,0)}}const{loadingRequests}=this,request={done:!1,complete:completeRequest,callback};return loadingRequests.push(request),request}get _loadTestFont(){const testFont=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return shadow(this,"_loadTestFont",testFont)}_prepareFontLoadEvent(font,request){function int32(data2,offset){return data2.charCodeAt(offset)<<24|data2.charCodeAt(offset+1)<<16|data2.charCodeAt(offset+2)<<8|data2.charCodeAt(offset+3)&255}function spliceString(s,offset,remove,insert){const chunk1=s.substring(0,offset),chunk2=s.substring(offset+remove);return chunk1+insert+chunk2}let i,ii;const canvas=this._document.createElement("canvas");canvas.width=1,canvas.height=1;const ctx=canvas.getContext("2d");let called=0;function isFontReady(name,callback){if(++called>30){warn("Load test font never loaded."),callback();return}if(ctx.font="30px "+name,ctx.fillText(".",0,20),ctx.getImageData(0,0,1,1).data[3]>0){callback();return}setTimeout(isFontReady.bind(null,name,callback))}const loadTestFontId=`lt${Date.now()}${this.loadTestFontId++}`;let data=this._loadTestFont;data=spliceString(data,976,loadTestFontId.length,loadTestFontId);const CFF_CHECKSUM_OFFSET=16,XXXX_VALUE=1482184792;let checksum=int32(data,CFF_CHECKSUM_OFFSET);for(i=0,ii=loadTestFontId.length-3;i<ii;i+=4)checksum=checksum-XXXX_VALUE+int32(loadTestFontId,i)|0;i<loadTestFontId.length&&(checksum=checksum-XXXX_VALUE+int32(loadTestFontId+"XXX",i)|0),data=spliceString(data,CFF_CHECKSUM_OFFSET,4,string32(checksum));const url=`url(data:font/opentype;base64,${btoa(data)});`,rule=`@font-face {font-family:"${loadTestFontId}";src:${url}}`;this.insertRule(rule);const div=this._document.createElement("div");div.style.visibility="hidden",div.style.width=div.style.height="10px",div.style.position="absolute",div.style.top=div.style.left="0px";for(const name of[font.loadedName,loadTestFontId]){const span=this._document.createElement("span");span.textContent="Hi",span.style.fontFamily=name,div.append(span)}this._document.body.append(div),isFontReady(loadTestFontId,()=>{div.remove(),request.complete()})}}class FontFaceObject{constructor(translatedData,inspectFont=null){this.compiledGlyphs=Object.create(null);for(const i in translatedData)this[i]=translatedData[i];this._inspectFont=inspectFont}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let nativeFontFace;if(!this.cssFontInfo)nativeFontFace=new FontFace(this.loadedName,this.data,{});else{const css={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(css.style=`oblique ${this.cssFontInfo.italicAngle}deg`),nativeFontFace=new FontFace(this.cssFontInfo.fontFamily,this.data,css)}return this._inspectFont?.(this),nativeFontFace}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const url=`url(data:${this.mimetype};base64,${toBase64Util(this.data)});`;let rule;if(!this.cssFontInfo)rule=`@font-face {font-family:"${this.loadedName}";src:${url}}`;else{let css=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(css+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),rule=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${css}src:${url}}`}return this._inspectFont?.(this,url),rule}getPathGenerator(objs,character){if(this.compiledGlyphs[character]!==void 0)return this.compiledGlyphs[character];const objId=this.loadedName+"_path_"+character;let cmds;try{cmds=objs.get(objId)}catch(ex){warn(`getPathGenerator - ignoring character: "${ex}".`)}const path=new Path2D(cmds||"");return this.fontExtraProperties||objs.delete(objId),this.compiledGlyphs[character]=path}}function getUrlProp(val){if(val instanceof URL)return val.href;if(typeof val=="string"){if(isNodeJS)return val;const url=URL.parse(val,window.location);if(url)return url.href}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function getDataProp(val){if(isNodeJS&&typeof Buffer<"u"&&val instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(val instanceof Uint8Array&&val.byteLength===val.buffer.byteLength)return val;if(typeof val=="string")return stringToBytes(val);if(val instanceof ArrayBuffer||ArrayBuffer.isView(val)||typeof val=="object"&&!isNaN(val?.length))return new Uint8Array(val);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}function getFactoryUrlProp(val){if(typeof val!="string")return null;if(val.endsWith("/"))return val;throw new Error(`Invalid factory url: "${val}" must include trailing slash.`)}const isRefProxy=v=>typeof v=="object"&&Number.isInteger(v?.num)&&v.num>=0&&Number.isInteger(v?.gen)&&v.gen>=0,isNameProxy=v=>typeof v=="object"&&typeof v?.name=="string",isValidExplicitDest=_isValidExplicitDest.bind(null,isRefProxy,isNameProxy);class LoopbackPort{#listeners=new Map;#deferred=Promise.resolve();postMessage(obj,transfer){const event={data:structuredClone(obj,transfer?{transfer}:null)};this.#deferred.then(()=>{for(const[listener]of this.#listeners)listener.call(this,event)})}addEventListener(name,listener,options=null){let rmAbort=null;if(options?.signal instanceof AbortSignal){const{signal}=options;if(signal.aborted){warn("LoopbackPort - cannot use an `aborted` signal.");return}const onAbort=()=>this.removeEventListener(name,listener);rmAbort=()=>signal.removeEventListener("abort",onAbort),signal.addEventListener("abort",onAbort)}this.#listeners.set(listener,rmAbort)}removeEventListener(name,listener){this.#listeners.get(listener)?.(),this.#listeners.delete(listener)}terminate(){for(const[,rmAbort]of this.#listeners)rmAbort?.();this.#listeners.clear()}}const CallbackKind={DATA:1,ERROR:2},StreamKind={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function onFn(){}function wrapReason(ex){if(ex instanceof AbortException||ex instanceof InvalidPDFException||ex instanceof PasswordException||ex instanceof ResponseException||ex instanceof UnknownErrorException)return ex;switch(ex instanceof Error||typeof ex=="object"&&ex!==null||unreachable('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),ex.name){case"AbortException":return new AbortException(ex.message);case"InvalidPDFException":return new InvalidPDFException(ex.message);case"PasswordException":return new PasswordException(ex.message,ex.code);case"ResponseException":return new ResponseException(ex.message,ex.status,ex.missing);case"UnknownErrorException":return new UnknownErrorException(ex.message,ex.details)}return new UnknownErrorException(ex.message,ex.toString())}class MessageHandler{#messageAC=new AbortController;constructor(sourceName,targetName,comObj){this.sourceName=sourceName,this.targetName=targetName,this.comObj=comObj,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),comObj.addEventListener("message",this.#onMessage.bind(this),{signal:this.#messageAC.signal})}#onMessage({data}){if(data.targetName!==this.sourceName)return;if(data.stream){this.#processStreamMessage(data);return}if(data.callback){const callbackId=data.callbackId,capability=this.callbackCapabilities[callbackId];if(!capability)throw new Error(`Cannot resolve callback ${callbackId}`);if(delete this.callbackCapabilities[callbackId],data.callback===CallbackKind.DATA)capability.resolve(data.data);else if(data.callback===CallbackKind.ERROR)capability.reject(wrapReason(data.reason));else throw new Error("Unexpected callback case");return}const action=this.actionHandler[data.action];if(!action)throw new Error(`Unknown action from worker: ${data.action}`);if(data.callbackId){const sourceName=this.sourceName,targetName=data.sourceName,comObj=this.comObj;Promise.try(action,data.data).then(function(result){comObj.postMessage({sourceName,targetName,callback:CallbackKind.DATA,callbackId:data.callbackId,data:result})},function(reason){comObj.postMessage({sourceName,targetName,callback:CallbackKind.ERROR,callbackId:data.callbackId,reason:wrapReason(reason)})});return}if(data.streamId){this.#createStreamSink(data);return}action(data.data)}on(actionName,handler){const ah=this.actionHandler;if(ah[actionName])throw new Error(`There is already an actionName called "${actionName}"`);ah[actionName]=handler}send(actionName,data,transfers){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:actionName,data},transfers)}sendWithPromise(actionName,data,transfers){const callbackId=this.callbackId++,capability=Promise.withResolvers();this.callbackCapabilities[callbackId]=capability;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:actionName,callbackId,data},transfers)}catch(ex){capability.reject(ex)}return capability.promise}sendWithStream(actionName,data,queueingStrategy,transfers){const streamId=this.streamId++,sourceName=this.sourceName,targetName=this.targetName,comObj=this.comObj;return new ReadableStream({start:controller=>{const startCapability=Promise.withResolvers();return this.streamControllers[streamId]={controller,startCall:startCapability,pullCall:null,cancelCall:null,isClosed:!1},comObj.postMessage({sourceName,targetName,action:actionName,streamId,data,desiredSize:controller.desiredSize},transfers),startCapability.promise},pull:controller=>{const pullCapability=Promise.withResolvers();return this.streamControllers[streamId].pullCall=pullCapability,comObj.postMessage({sourceName,targetName,stream:StreamKind.PULL,streamId,desiredSize:controller.desiredSize}),pullCapability.promise},cancel:reason=>{assert(reason instanceof Error,"cancel must have a valid reason");const cancelCapability=Promise.withResolvers();return this.streamControllers[streamId].cancelCall=cancelCapability,this.streamControllers[streamId].isClosed=!0,comObj.postMessage({sourceName,targetName,stream:StreamKind.CANCEL,streamId,reason:wrapReason(reason)}),cancelCapability.promise}},queueingStrategy)}#createStreamSink(data){const streamId=data.streamId,sourceName=this.sourceName,targetName=data.sourceName,comObj=this.comObj,self=this,action=this.actionHandler[data.action],streamSink={enqueue(chunk,size=1,transfers){if(this.isCancelled)return;const lastDesiredSize=this.desiredSize;this.desiredSize-=size,lastDesiredSize>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),comObj.postMessage({sourceName,targetName,stream:StreamKind.ENQUEUE,streamId,chunk},transfers)},close(){this.isCancelled||(this.isCancelled=!0,comObj.postMessage({sourceName,targetName,stream:StreamKind.CLOSE,streamId}),delete self.streamSinks[streamId])},error(reason){assert(reason instanceof Error,"error must have a valid reason"),!this.isCancelled&&(this.isCancelled=!0,comObj.postMessage({sourceName,targetName,stream:StreamKind.ERROR,streamId,reason:wrapReason(reason)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:data.desiredSize,ready:null};streamSink.sinkCapability.resolve(),streamSink.ready=streamSink.sinkCapability.promise,this.streamSinks[streamId]=streamSink,Promise.try(action,data.data,streamSink).then(function(){comObj.postMessage({sourceName,targetName,stream:StreamKind.START_COMPLETE,streamId,success:!0})},function(reason){comObj.postMessage({sourceName,targetName,stream:StreamKind.START_COMPLETE,streamId,reason:wrapReason(reason)})})}#processStreamMessage(data){const streamId=data.streamId,sourceName=this.sourceName,targetName=data.sourceName,comObj=this.comObj,streamController=this.streamControllers[streamId],streamSink=this.streamSinks[streamId];switch(data.stream){case StreamKind.START_COMPLETE:data.success?streamController.startCall.resolve():streamController.startCall.reject(wrapReason(data.reason));break;case StreamKind.PULL_COMPLETE:data.success?streamController.pullCall.resolve():streamController.pullCall.reject(wrapReason(data.reason));break;case StreamKind.PULL:if(!streamSink){comObj.postMessage({sourceName,targetName,stream:StreamKind.PULL_COMPLETE,streamId,success:!0});break}streamSink.desiredSize<=0&&data.desiredSize>0&&streamSink.sinkCapability.resolve(),streamSink.desiredSize=data.desiredSize,Promise.try(streamSink.onPull||onFn).then(function(){comObj.postMessage({sourceName,targetName,stream:StreamKind.PULL_COMPLETE,streamId,success:!0})},function(reason){comObj.postMessage({sourceName,targetName,stream:StreamKind.PULL_COMPLETE,streamId,reason:wrapReason(reason)})});break;case StreamKind.ENQUEUE:if(assert(streamController,"enqueue should have stream controller"),streamController.isClosed)break;streamController.controller.enqueue(data.chunk);break;case StreamKind.CLOSE:if(assert(streamController,"close should have stream controller"),streamController.isClosed)break;streamController.isClosed=!0,streamController.controller.close(),this.#deleteStreamController(streamController,streamId);break;case StreamKind.ERROR:assert(streamController,"error should have stream controller"),streamController.controller.error(wrapReason(data.reason)),this.#deleteStreamController(streamController,streamId);break;case StreamKind.CANCEL_COMPLETE:data.success?streamController.cancelCall.resolve():streamController.cancelCall.reject(wrapReason(data.reason)),this.#deleteStreamController(streamController,streamId);break;case StreamKind.CANCEL:if(!streamSink)break;const dataReason=wrapReason(data.reason);Promise.try(streamSink.onCancel||onFn,dataReason).then(function(){comObj.postMessage({sourceName,targetName,stream:StreamKind.CANCEL_COMPLETE,streamId,success:!0})},function(reason){comObj.postMessage({sourceName,targetName,stream:StreamKind.CANCEL_COMPLETE,streamId,reason:wrapReason(reason)})}),streamSink.sinkCapability.reject(dataReason),streamSink.isCancelled=!0,delete this.streamSinks[streamId];break;default:throw new Error("Unexpected stream case")}}async#deleteStreamController(streamController,streamId){await Promise.allSettled([streamController.startCall?.promise,streamController.pullCall?.promise,streamController.cancelCall?.promise]),delete this.streamControllers[streamId]}destroy(){this.#messageAC?.abort(),this.#messageAC=null}}class BaseCanvasFactory{#enableHWA=!1;constructor({enableHWA=!1}){this.#enableHWA=enableHWA}create(width,height){if(width<=0||height<=0)throw new Error("Invalid canvas size");const canvas=this._createCanvas(width,height);return{canvas,context:canvas.getContext("2d",{willReadFrequently:!this.#enableHWA})}}reset(canvasAndContext,width,height){if(!canvasAndContext.canvas)throw new Error("Canvas is not specified");if(width<=0||height<=0)throw new Error("Invalid canvas size");canvasAndContext.canvas.width=width,canvasAndContext.canvas.height=height}destroy(canvasAndContext){if(!canvasAndContext.canvas)throw new Error("Canvas is not specified");canvasAndContext.canvas.width=0,canvasAndContext.canvas.height=0,canvasAndContext.canvas=null,canvasAndContext.context=null}_createCanvas(width,height){unreachable("Abstract method `_createCanvas` called.")}}class DOMCanvasFactory extends BaseCanvasFactory{constructor({ownerDocument=globalThis.document,enableHWA=!1}){super({enableHWA}),this._document=ownerDocument}_createCanvas(width,height){const canvas=this._document.createElement("canvas");return canvas.width=width,canvas.height=height,canvas}}class BaseCMapReaderFactory{constructor({baseUrl=null,isCompressed=!0}){this.baseUrl=baseUrl,this.isCompressed=isCompressed}async fetch({name}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!name)throw new Error("CMap name must be specified.");const url=this.baseUrl+name+(this.isCompressed?".bcmap":"");return this._fetch(url).then(cMapData=>({cMapData,isCompressed:this.isCompressed})).catch(reason=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${url}`)})}async _fetch(url){unreachable("Abstract method `_fetch` called.")}}class DOMCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(url){const data=await fetchData(url,this.isCompressed?"arraybuffer":"text");return data instanceof ArrayBuffer?new Uint8Array(data):stringToBytes(data)}}class BaseFilterFactory{addFilter(maps){return"none"}addHCMFilter(fgColor,bgColor){return"none"}addAlphaFilter(map){return"none"}addLuminosityFilter(map){return"none"}addHighlightHCMFilter(filterName,fgColor,bgColor,newFgColor,newBgColor){return"none"}destroy(keepHCM=!1){}}class DOMFilterFactory extends BaseFilterFactory{#baseUrl;#_cache;#_defs;#docId;#document;#_hcmCache;#id=0;constructor({docId,ownerDocument=globalThis.document}){super(),this.#docId=docId,this.#document=ownerDocument}get#cache(){return this.#_cache||=new Map}get#hcmCache(){return this.#_hcmCache||=new Map}get#defs(){if(!this.#_defs){const div=this.#document.createElement("div"),{style}=div;style.visibility="hidden",style.contain="strict",style.width=style.height=0,style.position="absolute",style.top=style.left=0,style.zIndex=-1;const svg=this.#document.createElementNS(SVG_NS,"svg");svg.setAttribute("width",0),svg.setAttribute("height",0),this.#_defs=this.#document.createElementNS(SVG_NS,"defs"),div.append(svg),svg.append(this.#_defs),this.#document.body.append(div)}return this.#_defs}#createTables(maps){if(maps.length===1){const mapR2=maps[0],buffer=new Array(256);for(let i=0;i<256;i++)buffer[i]=mapR2[i]/255;const table=buffer.join(",");return[table,table,table]}const[mapR,mapG,mapB]=maps,bufferR=new Array(256),bufferG=new Array(256),bufferB=new Array(256);for(let i=0;i<256;i++)bufferR[i]=mapR[i]/255,bufferG[i]=mapG[i]/255,bufferB[i]=mapB[i]/255;return[bufferR.join(","),bufferG.join(","),bufferB.join(",")]}#createUrl(id){if(this.#baseUrl===void 0){this.#baseUrl="";const url=this.#document.URL;url!==this.#document.baseURI&&(isDataScheme(url)?warn('#createUrl: ignore "data:"-URL for performance reasons.'):this.#baseUrl=updateUrlHash(url,""))}return`url(${this.#baseUrl}#${id})`}addFilter(maps){if(!maps)return"none";let value=this.#cache.get(maps);if(value)return value;const[tableR,tableG,tableB]=this.#createTables(maps),key=maps.length===1?tableR:`${tableR}${tableG}${tableB}`;if(value=this.#cache.get(key),value)return this.#cache.set(maps,value),value;const id=`g_${this.#docId}_transfer_map_${this.#id++}`,url=this.#createUrl(id);this.#cache.set(maps,url),this.#cache.set(key,url);const filter=this.#createFilter(id);return this.#addTransferMapConversion(tableR,tableG,tableB,filter),url}addHCMFilter(fgColor,bgColor){const key=`${fgColor}-${bgColor}`,filterName="base";let info2=this.#hcmCache.get(filterName);if(info2?.key===key||(info2?(info2.filter?.remove(),info2.key=key,info2.url="none",info2.filter=null):(info2={key,url:"none",filter:null},this.#hcmCache.set(filterName,info2)),!fgColor||!bgColor))return info2.url;const fgRGB=this.#getRGB(fgColor);fgColor=Util.makeHexColor(...fgRGB);const bgRGB=this.#getRGB(bgColor);if(bgColor=Util.makeHexColor(...bgRGB),this.#defs.style.color="",fgColor==="#000000"&&bgColor==="#ffffff"||fgColor===bgColor)return info2.url;const map=new Array(256);for(let i=0;i<=255;i++){const x=i/255;map[i]=x<=.03928?x/12.92:((x+.055)/1.055)**2.4}const table=map.join(","),id=`g_${this.#docId}_hcm_filter`,filter=info2.filter=this.#createFilter(id);this.#addTransferMapConversion(table,table,table,filter),this.#addGrayConversion(filter);const getSteps=(c,n)=>{const start=fgRGB[c]/255,end=bgRGB[c]/255,arr=new Array(n+1);for(let i=0;i<=n;i++)arr[i]=start+i/n*(end-start);return arr.join(",")};return this.#addTransferMapConversion(getSteps(0,5),getSteps(1,5),getSteps(2,5),filter),info2.url=this.#createUrl(id),info2.url}addAlphaFilter(map){let value=this.#cache.get(map);if(value)return value;const[tableA]=this.#createTables([map]),key=`alpha_${tableA}`;if(value=this.#cache.get(key),value)return this.#cache.set(map,value),value;const id=`g_${this.#docId}_alpha_map_${this.#id++}`,url=this.#createUrl(id);this.#cache.set(map,url),this.#cache.set(key,url);const filter=this.#createFilter(id);return this.#addTransferMapAlphaConversion(tableA,filter),url}addLuminosityFilter(map){let value=this.#cache.get(map||"luminosity");if(value)return value;let tableA,key;if(map?([tableA]=this.#createTables([map]),key=`luminosity_${tableA}`):key="luminosity",value=this.#cache.get(key),value)return this.#cache.set(map,value),value;const id=`g_${this.#docId}_luminosity_map_${this.#id++}`,url=this.#createUrl(id);this.#cache.set(map,url),this.#cache.set(key,url);const filter=this.#createFilter(id);return this.#addLuminosityConversion(filter),map&&this.#addTransferMapAlphaConversion(tableA,filter),url}addHighlightHCMFilter(filterName,fgColor,bgColor,newFgColor,newBgColor){const key=`${fgColor}-${bgColor}-${newFgColor}-${newBgColor}`;let info2=this.#hcmCache.get(filterName);if(info2?.key===key||(info2?(info2.filter?.remove(),info2.key=key,info2.url="none",info2.filter=null):(info2={key,url:"none",filter:null},this.#hcmCache.set(filterName,info2)),!fgColor||!bgColor))return info2.url;const[fgRGB,bgRGB]=[fgColor,bgColor].map(this.#getRGB.bind(this));let fgGray=Math.round(.2126*fgRGB[0]+.7152*fgRGB[1]+.0722*fgRGB[2]),bgGray=Math.round(.2126*bgRGB[0]+.7152*bgRGB[1]+.0722*bgRGB[2]),[newFgRGB,newBgRGB]=[newFgColor,newBgColor].map(this.#getRGB.bind(this));bgGray<fgGray&&([fgGray,bgGray,newFgRGB,newBgRGB]=[bgGray,fgGray,newBgRGB,newFgRGB]),this.#defs.style.color="";const getSteps=(fg,bg,n)=>{const arr=new Array(256),step=(bgGray-fgGray)/n,newStart=fg/255,newStep=(bg-fg)/(255*n);let prev=0;for(let i=0;i<=n;i++){const k=Math.round(fgGray+i*step),value=newStart+i*newStep;for(let j=prev;j<=k;j++)arr[j]=value;prev=k+1}for(let i=prev;i<256;i++)arr[i]=arr[prev-1];return arr.join(",")},id=`g_${this.#docId}_hcm_${filterName}_filter`,filter=info2.filter=this.#createFilter(id);return this.#addGrayConversion(filter),this.#addTransferMapConversion(getSteps(newFgRGB[0],newBgRGB[0],5),getSteps(newFgRGB[1],newBgRGB[1],5),getSteps(newFgRGB[2],newBgRGB[2],5),filter),info2.url=this.#createUrl(id),info2.url}destroy(keepHCM=!1){keepHCM&&this.#_hcmCache?.size||(this.#_defs?.parentNode.parentNode.remove(),this.#_defs=null,this.#_cache?.clear(),this.#_cache=null,this.#_hcmCache?.clear(),this.#_hcmCache=null,this.#id=0)}#addLuminosityConversion(filter){const feColorMatrix=this.#document.createElementNS(SVG_NS,"feColorMatrix");feColorMatrix.setAttribute("type","matrix"),feColorMatrix.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),filter.append(feColorMatrix)}#addGrayConversion(filter){const feColorMatrix=this.#document.createElementNS(SVG_NS,"feColorMatrix");feColorMatrix.setAttribute("type","matrix"),feColorMatrix.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),filter.append(feColorMatrix)}#createFilter(id){const filter=this.#document.createElementNS(SVG_NS,"filter");return filter.setAttribute("color-interpolation-filters","sRGB"),filter.setAttribute("id",id),this.#defs.append(filter),filter}#appendFeFunc(feComponentTransfer,func,table){const feFunc=this.#document.createElementNS(SVG_NS,func);feFunc.setAttribute("type","discrete"),feFunc.setAttribute("tableValues",table),feComponentTransfer.append(feFunc)}#addTransferMapConversion(rTable,gTable,bTable,filter){const feComponentTransfer=this.#document.createElementNS(SVG_NS,"feComponentTransfer");filter.append(feComponentTransfer),this.#appendFeFunc(feComponentTransfer,"feFuncR",rTable),this.#appendFeFunc(feComponentTransfer,"feFuncG",gTable),this.#appendFeFunc(feComponentTransfer,"feFuncB",bTable)}#addTransferMapAlphaConversion(aTable,filter){const feComponentTransfer=this.#document.createElementNS(SVG_NS,"feComponentTransfer");filter.append(feComponentTransfer),this.#appendFeFunc(feComponentTransfer,"feFuncA",aTable)}#getRGB(color){return this.#defs.style.color=color,getRGB(getComputedStyle(this.#defs).getPropertyValue("color"))}}class BaseStandardFontDataFactory{constructor({baseUrl=null}){this.baseUrl=baseUrl}async fetch({filename}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!filename)throw new Error("Font filename must be specified.");const url=`${this.baseUrl}${filename}`;return this._fetch(url).catch(reason=>{throw new Error(`Unable to load font data at: ${url}`)})}async _fetch(url){unreachable("Abstract method `_fetch` called.")}}class DOMStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(url){const data=await fetchData(url,"arraybuffer");return new Uint8Array(data)}}class BaseWasmFactory{constructor({baseUrl=null}){this.baseUrl=baseUrl}async fetch({filename}){if(!this.baseUrl)throw new Error("Ensure that the `wasmUrl` API parameter is provided.");if(!filename)throw new Error("Wasm filename must be specified.");const url=`${this.baseUrl}${filename}`;return this._fetch(url).catch(reason=>{throw new Error(`Unable to load wasm data at: ${url}`)})}async _fetch(url){unreachable("Abstract method `_fetch` called.")}}class DOMWasmFactory extends BaseWasmFactory{async _fetch(url){const data=await fetchData(url,"arraybuffer");return new Uint8Array(data)}}isNodeJS&&warn("Please use the `legacy` build in Node.js environments.");async function node_utils_fetchData(url){const data=await process.getBuiltinModule("fs").promises.readFile(url);return new Uint8Array(data)}class NodeFilterFactory extends BaseFilterFactory{}class NodeCanvasFactory extends BaseCanvasFactory{_createCanvas(width,height){return process.getBuiltinModule("module").createRequire(import.meta.url)("@napi-rs/canvas").createCanvas(width,height)}}class NodeCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(url){return node_utils_fetchData(url)}}class NodeStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(url){return node_utils_fetchData(url)}}class NodeWasmFactory extends BaseWasmFactory{async _fetch(url){return node_utils_fetchData(url)}}const PathType={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function applyBoundingBox(ctx,bbox){if(!bbox)return;const width=bbox[2]-bbox[0],height=bbox[3]-bbox[1],region=new Path2D;region.rect(bbox[0],bbox[1],width,height),ctx.clip(region)}class BaseShadingPattern{isModifyingCurrentTransform(){return!1}getPattern(){unreachable("Abstract method `getPattern` called.")}}class RadialAxialShadingPattern extends BaseShadingPattern{constructor(IR){super(),this._type=IR[1],this._bbox=IR[2],this._colorStops=IR[3],this._p0=IR[4],this._p1=IR[5],this._r0=IR[6],this._r1=IR[7],this.matrix=null}_createGradient(ctx){let grad;this._type==="axial"?grad=ctx.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(grad=ctx.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(const colorStop of this._colorStops)grad.addColorStop(colorStop[0],colorStop[1]);return grad}getPattern(ctx,owner,inverse,pathType){let pattern;if(pathType===PathType.STROKE||pathType===PathType.FILL){const ownerBBox=owner.current.getClippedPathBoundingBox(pathType,getCurrentTransform(ctx))||[0,0,0,0],width=Math.ceil(ownerBBox[2]-ownerBBox[0])||1,height=Math.ceil(ownerBBox[3]-ownerBBox[1])||1,tmpCanvas=owner.cachedCanvases.getCanvas("pattern",width,height),tmpCtx=tmpCanvas.context;tmpCtx.clearRect(0,0,tmpCtx.canvas.width,tmpCtx.canvas.height),tmpCtx.beginPath(),tmpCtx.rect(0,0,tmpCtx.canvas.width,tmpCtx.canvas.height),tmpCtx.translate(-ownerBBox[0],-ownerBBox[1]),inverse=Util.transform(inverse,[1,0,0,1,ownerBBox[0],ownerBBox[1]]),tmpCtx.transform(...owner.baseTransform),this.matrix&&tmpCtx.transform(...this.matrix),applyBoundingBox(tmpCtx,this._bbox),tmpCtx.fillStyle=this._createGradient(tmpCtx),tmpCtx.fill(),pattern=ctx.createPattern(tmpCanvas.canvas,"no-repeat");const domMatrix=new DOMMatrix(inverse);pattern.setTransform(domMatrix)}else applyBoundingBox(ctx,this._bbox),pattern=this._createGradient(ctx);return pattern}}function drawTriangle(data,context,p1,p2,p3,c1,c2,c3){const coords=context.coords,colors=context.colors,bytes=data.data,rowSize=data.width*4;let tmp;coords[p1+1]>coords[p2+1]&&(tmp=p1,p1=p2,p2=tmp,tmp=c1,c1=c2,c2=tmp),coords[p2+1]>coords[p3+1]&&(tmp=p2,p2=p3,p3=tmp,tmp=c2,c2=c3,c3=tmp),coords[p1+1]>coords[p2+1]&&(tmp=p1,p1=p2,p2=tmp,tmp=c1,c1=c2,c2=tmp);const x1=(coords[p1]+context.offsetX)*context.scaleX,y1=(coords[p1+1]+context.offsetY)*context.scaleY,x2=(coords[p2]+context.offsetX)*context.scaleX,y2=(coords[p2+1]+context.offsetY)*context.scaleY,x3=(coords[p3]+context.offsetX)*context.scaleX,y3=(coords[p3+1]+context.offsetY)*context.scaleY;if(y1>=y3)return;const c1r=colors[c1],c1g=colors[c1+1],c1b=colors[c1+2],c2r=colors[c2],c2g=colors[c2+1],c2b=colors[c2+2],c3r=colors[c3],c3g=colors[c3+1],c3b=colors[c3+2],minY=Math.round(y1),maxY=Math.round(y3);let xa,car,cag,cab,xb,cbr,cbg,cbb;for(let y=minY;y<=maxY;y++){if(y<y2){const k2=y<y1?0:(y1-y)/(y1-y2);xa=x1-(x1-x2)*k2,car=c1r-(c1r-c2r)*k2,cag=c1g-(c1g-c2g)*k2,cab=c1b-(c1b-c2b)*k2}else{let k2;y>y3?k2=1:y2===y3?k2=0:k2=(y2-y)/(y2-y3),xa=x2-(x2-x3)*k2,car=c2r-(c2r-c3r)*k2,cag=c2g-(c2g-c3g)*k2,cab=c2b-(c2b-c3b)*k2}let k;y<y1?k=0:y>y3?k=1:k=(y1-y)/(y1-y3),xb=x1-(x1-x3)*k,cbr=c1r-(c1r-c3r)*k,cbg=c1g-(c1g-c3g)*k,cbb=c1b-(c1b-c3b)*k;const x1_=Math.round(Math.min(xa,xb)),x2_=Math.round(Math.max(xa,xb));let j=rowSize*y+x1_*4;for(let x=x1_;x<=x2_;x++)k=(xa-x)/(xa-xb),k<0?k=0:k>1&&(k=1),bytes[j++]=car-(car-cbr)*k|0,bytes[j++]=cag-(cag-cbg)*k|0,bytes[j++]=cab-(cab-cbb)*k|0,bytes[j++]=255}}function drawFigure(data,figure,context){const ps=figure.coords,cs=figure.colors;let i,ii;switch(figure.type){case"lattice":const verticesPerRow=figure.verticesPerRow,rows=Math.floor(ps.length/verticesPerRow)-1,cols=verticesPerRow-1;for(i=0;i<rows;i++){let q=i*verticesPerRow;for(let j=0;j<cols;j++,q++)drawTriangle(data,context,ps[q],ps[q+1],ps[q+verticesPerRow],cs[q],cs[q+1],cs[q+verticesPerRow]),drawTriangle(data,context,ps[q+verticesPerRow+1],ps[q+1],ps[q+verticesPerRow],cs[q+verticesPerRow+1],cs[q+1],cs[q+verticesPerRow])}break;case"triangles":for(i=0,ii=ps.length;i<ii;i+=3)drawTriangle(data,context,ps[i],ps[i+1],ps[i+2],cs[i],cs[i+1],cs[i+2]);break;default:throw new Error("illegal figure")}}class MeshShadingPattern extends BaseShadingPattern{constructor(IR){super(),this._coords=IR[2],this._colors=IR[3],this._figures=IR[4],this._bounds=IR[5],this._bbox=IR[6],this._background=IR[7],this.matrix=null}_createMeshCanvas(combinedScale,backgroundColor,cachedCanvases){const offsetX=Math.floor(this._bounds[0]),offsetY=Math.floor(this._bounds[1]),boundsWidth=Math.ceil(this._bounds[2])-offsetX,boundsHeight=Math.ceil(this._bounds[3])-offsetY,width=Math.min(Math.ceil(Math.abs(boundsWidth*combinedScale[0]*1.1)),3e3),height=Math.min(Math.ceil(Math.abs(boundsHeight*combinedScale[1]*1.1)),3e3),scaleX=boundsWidth/width,scaleY=boundsHeight/height,context={coords:this._coords,colors:this._colors,offsetX:-offsetX,offsetY:-offsetY,scaleX:1/scaleX,scaleY:1/scaleY},paddedWidth=width+2*2,paddedHeight=height+2*2,tmpCanvas=cachedCanvases.getCanvas("mesh",paddedWidth,paddedHeight),tmpCtx=tmpCanvas.context,data=tmpCtx.createImageData(width,height);if(backgroundColor){const bytes=data.data;for(let i=0,ii=bytes.length;i<ii;i+=4)bytes[i]=backgroundColor[0],bytes[i+1]=backgroundColor[1],bytes[i+2]=backgroundColor[2],bytes[i+3]=255}for(const figure of this._figures)drawFigure(data,figure,context);return tmpCtx.putImageData(data,2,2),{canvas:tmpCanvas.canvas,offsetX:offsetX-2*scaleX,offsetY:offsetY-2*scaleY,scaleX,scaleY}}isModifyingCurrentTransform(){return!0}getPattern(ctx,owner,inverse,pathType){applyBoundingBox(ctx,this._bbox);const scale=new Float32Array(2);if(pathType===PathType.SHADING)Util.singularValueDecompose2dScale(getCurrentTransform(ctx),scale);else if(this.matrix){Util.singularValueDecompose2dScale(this.matrix,scale);const[matrixScaleX,matrixScaleY]=scale;Util.singularValueDecompose2dScale(owner.baseTransform,scale),scale[0]*=matrixScaleX,scale[1]*=matrixScaleY}else Util.singularValueDecompose2dScale(owner.baseTransform,scale);const temporaryPatternCanvas=this._createMeshCanvas(scale,pathType===PathType.SHADING?null:this._background,owner.cachedCanvases);return pathType!==PathType.SHADING&&(ctx.setTransform(...owner.baseTransform),this.matrix&&ctx.transform(...this.matrix)),ctx.translate(temporaryPatternCanvas.offsetX,temporaryPatternCanvas.offsetY),ctx.scale(temporaryPatternCanvas.scaleX,temporaryPatternCanvas.scaleY),ctx.createPattern(temporaryPatternCanvas.canvas,"no-repeat")}}class DummyShadingPattern extends BaseShadingPattern{getPattern(){return"hotpink"}}function getShadingPattern(IR){switch(IR[0]){case"RadialAxial":return new RadialAxialShadingPattern(IR);case"Mesh":return new MeshShadingPattern(IR);case"Dummy":return new DummyShadingPattern}throw new Error(`Unknown IR type: ${IR[0]}`)}const PaintType={COLORED:1,UNCOLORED:2};class TilingPattern{static MAX_PATTERN_SIZE=3e3;constructor(IR,ctx,canvasGraphicsFactory,baseTransform){this.color=IR[1],this.operatorList=IR[2],this.matrix=IR[3],this.bbox=IR[4],this.xstep=IR[5],this.ystep=IR[6],this.paintType=IR[7],this.tilingType=IR[8],this.ctx=ctx,this.canvasGraphicsFactory=canvasGraphicsFactory,this.baseTransform=baseTransform}createPatternCanvas(owner){const{bbox,operatorList,paintType,tilingType,color,canvasGraphicsFactory}=this;let{xstep,ystep}=this;xstep=Math.abs(xstep),ystep=Math.abs(ystep),info("TilingType: "+tilingType);const x0=bbox[0],y0=bbox[1],x1=bbox[2],y1=bbox[3],width=x1-x0,height=y1-y0,scale=new Float32Array(2);Util.singularValueDecompose2dScale(this.matrix,scale);const[matrixScaleX,matrixScaleY]=scale;Util.singularValueDecompose2dScale(this.baseTransform,scale);const combinedScaleX=matrixScaleX*scale[0],combinedScaleY=matrixScaleY*scale[1];let canvasWidth=width,canvasHeight=height,redrawHorizontally=!1,redrawVertically=!1;const xScaledStep=Math.ceil(xstep*combinedScaleX),yScaledStep=Math.ceil(ystep*combinedScaleY),xScaledWidth=Math.ceil(width*combinedScaleX),yScaledHeight=Math.ceil(height*combinedScaleY);xScaledStep>=xScaledWidth?canvasWidth=xstep:redrawHorizontally=!0,yScaledStep>=yScaledHeight?canvasHeight=ystep:redrawVertically=!0;const dimx=this.getSizeAndScale(canvasWidth,this.ctx.canvas.width,combinedScaleX),dimy=this.getSizeAndScale(canvasHeight,this.ctx.canvas.height,combinedScaleY),tmpCanvas=owner.cachedCanvases.getCanvas("pattern",dimx.size,dimy.size),tmpCtx=tmpCanvas.context,graphics=canvasGraphicsFactory.createCanvasGraphics(tmpCtx);if(graphics.groupLevel=owner.groupLevel,this.setFillAndStrokeStyleToContext(graphics,paintType,color),tmpCtx.translate(-dimx.scale*x0,-dimy.scale*y0),graphics.transform(dimx.scale,0,0,dimy.scale,0,0),tmpCtx.save(),this.clipBbox(graphics,x0,y0,x1,y1),graphics.baseTransform=getCurrentTransform(graphics.ctx),graphics.executeOperatorList(operatorList),graphics.endDrawing(),tmpCtx.restore(),redrawHorizontally||redrawVertically){const image=tmpCanvas.canvas;redrawHorizontally&&(canvasWidth=xstep),redrawVertically&&(canvasHeight=ystep);const dimx2=this.getSizeAndScale(canvasWidth,this.ctx.canvas.width,combinedScaleX),dimy2=this.getSizeAndScale(canvasHeight,this.ctx.canvas.height,combinedScaleY),xSize=dimx2.size,ySize=dimy2.size,tmpCanvas2=owner.cachedCanvases.getCanvas("pattern-workaround",xSize,ySize),tmpCtx2=tmpCanvas2.context,ii=redrawHorizontally?Math.floor(width/xstep):0,jj=redrawVertically?Math.floor(height/ystep):0;for(let i=0;i<=ii;i++)for(let j=0;j<=jj;j++)tmpCtx2.drawImage(image,xSize*i,ySize*j,xSize,ySize,0,0,xSize,ySize);return{canvas:tmpCanvas2.canvas,scaleX:dimx2.scale,scaleY:dimy2.scale,offsetX:x0,offsetY:y0}}return{canvas:tmpCanvas.canvas,scaleX:dimx.scale,scaleY:dimy.scale,offsetX:x0,offsetY:y0}}getSizeAndScale(step,realOutputSize,scale){const maxSize=Math.max(TilingPattern.MAX_PATTERN_SIZE,realOutputSize);let size=Math.ceil(step*scale);return size>=maxSize?size=maxSize:scale=size/step,{scale,size}}clipBbox(graphics,x0,y0,x1,y1){const bboxWidth=x1-x0,bboxHeight=y1-y0;graphics.ctx.rect(x0,y0,bboxWidth,bboxHeight),Util.axialAlignedBoundingBox([x0,y0,x1,y1],getCurrentTransform(graphics.ctx),graphics.current.minMax),graphics.clip(),graphics.endPath()}setFillAndStrokeStyleToContext(graphics,paintType,color){const context=graphics.ctx,current=graphics.current;switch(paintType){case PaintType.COLORED:const{fillStyle,strokeStyle}=this.ctx;context.fillStyle=current.fillColor=fillStyle,context.strokeStyle=current.strokeColor=strokeStyle;break;case PaintType.UNCOLORED:context.fillStyle=context.strokeStyle=color,current.fillColor=current.strokeColor=color;break;default:throw new FormatError(`Unsupported paint type: ${paintType}`)}}isModifyingCurrentTransform(){return!1}getPattern(ctx,owner,inverse,pathType){let matrix=inverse;pathType!==PathType.SHADING&&(matrix=Util.transform(matrix,owner.baseTransform),this.matrix&&(matrix=Util.transform(matrix,this.matrix)));const temporaryPatternCanvas=this.createPatternCanvas(owner);let domMatrix=new DOMMatrix(matrix);domMatrix=domMatrix.translate(temporaryPatternCanvas.offsetX,temporaryPatternCanvas.offsetY),domMatrix=domMatrix.scale(1/temporaryPatternCanvas.scaleX,1/temporaryPatternCanvas.scaleY);const pattern=ctx.createPattern(temporaryPatternCanvas.canvas,"repeat");return pattern.setTransform(domMatrix),pattern}}function convertBlackAndWhiteToRGBA({src,srcPos=0,dest,width,height,nonBlackColor=4294967295,inverseDecode=!1}){const black=util_FeatureTest.isLittleEndian?4278190080:255,[zeroMapping,oneMapping]=inverseDecode?[nonBlackColor,black]:[black,nonBlackColor],widthInSource=width>>3,widthRemainder=width&7,srcLength=src.length;dest=new Uint32Array(dest.buffer);let destPos=0;for(let i=0;i<height;i++){for(const max=srcPos+widthInSource;srcPos<max;srcPos++){const elem2=srcPos<srcLength?src[srcPos]:255;dest[destPos++]=elem2&128?oneMapping:zeroMapping,dest[destPos++]=elem2&64?oneMapping:zeroMapping,dest[destPos++]=elem2&32?oneMapping:zeroMapping,dest[destPos++]=elem2&16?oneMapping:zeroMapping,dest[destPos++]=elem2&8?oneMapping:zeroMapping,dest[destPos++]=elem2&4?oneMapping:zeroMapping,dest[destPos++]=elem2&2?oneMapping:zeroMapping,dest[destPos++]=elem2&1?oneMapping:zeroMapping}if(widthRemainder===0)continue;const elem=srcPos<srcLength?src[srcPos++]:255;for(let j=0;j<widthRemainder;j++)dest[destPos++]=elem&1<<7-j?oneMapping:zeroMapping}return{srcPos,destPos}}const MIN_FONT_SIZE=16,MAX_FONT_SIZE=100,EXECUTION_TIME=15,EXECUTION_STEPS=10,FULL_CHUNK_HEIGHT=16,SCALE_MATRIX=new DOMMatrix,XY=new Float32Array(2),MIN_MAX_INIT=new Float32Array([1/0,1/0,-1/0,-1/0]);function mirrorContextOperations(ctx,destCtx){if(ctx._removeMirroring)throw new Error("Context is already forwarding operations.");ctx.__originalSave=ctx.save,ctx.__originalRestore=ctx.restore,ctx.__originalRotate=ctx.rotate,ctx.__originalScale=ctx.scale,ctx.__originalTranslate=ctx.translate,ctx.__originalTransform=ctx.transform,ctx.__originalSetTransform=ctx.setTransform,ctx.__originalResetTransform=ctx.resetTransform,ctx.__originalClip=ctx.clip,ctx.__originalMoveTo=ctx.moveTo,ctx.__originalLineTo=ctx.lineTo,ctx.__originalBezierCurveTo=ctx.bezierCurveTo,ctx.__originalRect=ctx.rect,ctx.__originalClosePath=ctx.closePath,ctx.__originalBeginPath=ctx.beginPath,ctx._removeMirroring=()=>{ctx.save=ctx.__originalSave,ctx.restore=ctx.__originalRestore,ctx.rotate=ctx.__originalRotate,ctx.scale=ctx.__originalScale,ctx.translate=ctx.__originalTranslate,ctx.transform=ctx.__originalTransform,ctx.setTransform=ctx.__originalSetTransform,ctx.resetTransform=ctx.__originalResetTransform,ctx.clip=ctx.__originalClip,ctx.moveTo=ctx.__originalMoveTo,ctx.lineTo=ctx.__originalLineTo,ctx.bezierCurveTo=ctx.__originalBezierCurveTo,ctx.rect=ctx.__originalRect,ctx.closePath=ctx.__originalClosePath,ctx.beginPath=ctx.__originalBeginPath,delete ctx._removeMirroring},ctx.save=function(){destCtx.save(),this.__originalSave()},ctx.restore=function(){destCtx.restore(),this.__originalRestore()},ctx.translate=function(x,y){destCtx.translate(x,y),this.__originalTranslate(x,y)},ctx.scale=function(x,y){destCtx.scale(x,y),this.__originalScale(x,y)},ctx.transform=function(a,b,c,d,e,f){destCtx.transform(a,b,c,d,e,f),this.__originalTransform(a,b,c,d,e,f)},ctx.setTransform=function(a,b,c,d,e,f){destCtx.setTransform(a,b,c,d,e,f),this.__originalSetTransform(a,b,c,d,e,f)},ctx.resetTransform=function(){destCtx.resetTransform(),this.__originalResetTransform()},ctx.rotate=function(angle){destCtx.rotate(angle),this.__originalRotate(angle)},ctx.clip=function(rule){destCtx.clip(rule),this.__originalClip(rule)},ctx.moveTo=function(x,y){destCtx.moveTo(x,y),this.__originalMoveTo(x,y)},ctx.lineTo=function(x,y){destCtx.lineTo(x,y),this.__originalLineTo(x,y)},ctx.bezierCurveTo=function(cp1x,cp1y,cp2x,cp2y,x,y){destCtx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y),this.__originalBezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y)},ctx.rect=function(x,y,width,height){destCtx.rect(x,y,width,height),this.__originalRect(x,y,width,height)},ctx.closePath=function(){destCtx.closePath(),this.__originalClosePath()},ctx.beginPath=function(){destCtx.beginPath(),this.__originalBeginPath()}}class CachedCanvases{constructor(canvasFactory){this.canvasFactory=canvasFactory,this.cache=Object.create(null)}getCanvas(id,width,height){let canvasEntry;return this.cache[id]!==void 0?(canvasEntry=this.cache[id],this.canvasFactory.reset(canvasEntry,width,height)):(canvasEntry=this.canvasFactory.create(width,height),this.cache[id]=canvasEntry),canvasEntry}delete(id){delete this.cache[id]}clear(){for(const id in this.cache){const canvasEntry=this.cache[id];this.canvasFactory.destroy(canvasEntry),delete this.cache[id]}}}function drawImageAtIntegerCoords(ctx,srcImg,srcX,srcY,srcW,srcH,destX,destY,destW,destH){const[a,b,c,d,tx,ty]=getCurrentTransform(ctx);if(b===0&&c===0){const tlX=destX*a+tx,rTlX=Math.round(tlX),tlY=destY*d+ty,rTlY=Math.round(tlY),brX=(destX+destW)*a+tx,rWidth=Math.abs(Math.round(brX)-rTlX)||1,brY=(destY+destH)*d+ty,rHeight=Math.abs(Math.round(brY)-rTlY)||1;return ctx.setTransform(Math.sign(a),0,0,Math.sign(d),rTlX,rTlY),ctx.drawImage(srcImg,srcX,srcY,srcW,srcH,0,0,rWidth,rHeight),ctx.setTransform(a,b,c,d,tx,ty),[rWidth,rHeight]}if(a===0&&d===0){const tlX=destY*c+tx,rTlX=Math.round(tlX),tlY=destX*b+ty,rTlY=Math.round(tlY),brX=(destY+destH)*c+tx,rWidth=Math.abs(Math.round(brX)-rTlX)||1,brY=(destX+destW)*b+ty,rHeight=Math.abs(Math.round(brY)-rTlY)||1;return ctx.setTransform(0,Math.sign(b),Math.sign(c),0,rTlX,rTlY),ctx.drawImage(srcImg,srcX,srcY,srcW,srcH,0,0,rHeight,rWidth),ctx.setTransform(a,b,c,d,tx,ty),[rHeight,rWidth]}ctx.drawImage(srcImg,srcX,srcY,srcW,srcH,destX,destY,destW,destH);const scaleX=Math.hypot(a,b),scaleY=Math.hypot(c,d);return[scaleX*destW,scaleY*destH]}class CanvasExtraState{alphaIsShape=!1;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=FONT_IDENTITY_MATRIX;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=TextRenderingMode.FILL;textRise=0;fillColor="#000000";strokeColor="#000000";patternFill=!1;patternStroke=!1;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps="none";constructor(width,height){this.clipBox=new Float32Array([0,0,width,height]),this.minMax=MIN_MAX_INIT.slice()}clone(){const clone=Object.create(this);return clone.clipBox=this.clipBox.slice(),clone.minMax=this.minMax.slice(),clone}getPathBoundingBox(pathType=PathType.FILL,transform=null){const box=this.minMax.slice();if(pathType===PathType.STROKE){transform||unreachable("Stroke bounding box must include transform."),Util.singularValueDecompose2dScale(transform,XY);const xStrokePad=XY[0]*this.lineWidth/2,yStrokePad=XY[1]*this.lineWidth/2;box[0]-=xStrokePad,box[1]-=yStrokePad,box[2]+=xStrokePad,box[3]+=yStrokePad}return box}updateClipFromPath(){const intersect=Util.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(intersect||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===1/0}startNewPathAndClipBox(box){this.clipBox.set(box,0),this.minMax.set(MIN_MAX_INIT,0)}getClippedPathBoundingBox(pathType=PathType.FILL,transform=null){return Util.intersect(this.clipBox,this.getPathBoundingBox(pathType,transform))}}function putBinaryImageData(ctx,imgData){if(imgData instanceof ImageData){ctx.putImageData(imgData,0,0);return}const height=imgData.height,width=imgData.width,partialChunkHeight=height%FULL_CHUNK_HEIGHT,fullChunks=(height-partialChunkHeight)/FULL_CHUNK_HEIGHT,totalChunks=partialChunkHeight===0?fullChunks:fullChunks+1,chunkImgData=ctx.createImageData(width,FULL_CHUNK_HEIGHT);let srcPos=0,destPos;const src=imgData.data,dest=chunkImgData.data;let i,j,thisChunkHeight,elemsInThisChunk;if(imgData.kind===util_ImageKind.GRAYSCALE_1BPP){const srcLength=src.byteLength,dest32=new Uint32Array(dest.buffer,0,dest.byteLength>>2),dest32DataLength=dest32.length,fullSrcDiff=width+7>>3,white=4294967295,black=util_FeatureTest.isLittleEndian?4278190080:255;for(i=0;i<totalChunks;i++){for(thisChunkHeight=i<fullChunks?FULL_CHUNK_HEIGHT:partialChunkHeight,destPos=0,j=0;j<thisChunkHeight;j++){const srcDiff=srcLength-srcPos;let k=0;const kEnd=srcDiff>fullSrcDiff?width:srcDiff*8-7,kEndUnrolled=kEnd&-8;let mask=0,srcByte=0;for(;k<kEndUnrolled;k+=8)srcByte=src[srcPos++],dest32[destPos++]=srcByte&128?white:black,dest32[destPos++]=srcByte&64?white:black,dest32[destPos++]=srcByte&32?white:black,dest32[destPos++]=srcByte&16?white:black,dest32[destPos++]=srcByte&8?white:black,dest32[destPos++]=srcByte&4?white:black,dest32[destPos++]=srcByte&2?white:black,dest32[destPos++]=srcByte&1?white:black;for(;k<kEnd;k++)mask===0&&(srcByte=src[srcPos++],mask=128),dest32[destPos++]=srcByte&mask?white:black,mask>>=1}for(;destPos<dest32DataLength;)dest32[destPos++]=0;ctx.putImageData(chunkImgData,0,i*FULL_CHUNK_HEIGHT)}}else if(imgData.kind===util_ImageKind.RGBA_32BPP){for(j=0,elemsInThisChunk=width*FULL_CHUNK_HEIGHT*4,i=0;i<fullChunks;i++)dest.set(src.subarray(srcPos,srcPos+elemsInThisChunk)),srcPos+=elemsInThisChunk,ctx.putImageData(chunkImgData,0,j),j+=FULL_CHUNK_HEIGHT;i<totalChunks&&(elemsInThisChunk=width*partialChunkHeight*4,dest.set(src.subarray(srcPos,srcPos+elemsInThisChunk)),ctx.putImageData(chunkImgData,0,j))}else if(imgData.kind===util_ImageKind.RGB_24BPP)for(thisChunkHeight=FULL_CHUNK_HEIGHT,elemsInThisChunk=width*thisChunkHeight,i=0;i<totalChunks;i++){for(i>=fullChunks&&(thisChunkHeight=partialChunkHeight,elemsInThisChunk=width*thisChunkHeight),destPos=0,j=elemsInThisChunk;j--;)dest[destPos++]=src[srcPos++],dest[destPos++]=src[srcPos++],dest[destPos++]=src[srcPos++],dest[destPos++]=255;ctx.putImageData(chunkImgData,0,i*FULL_CHUNK_HEIGHT)}else throw new Error(`bad image kind: ${imgData.kind}`)}function putBinaryImageMask(ctx,imgData){if(imgData.bitmap){ctx.drawImage(imgData.bitmap,0,0);return}const height=imgData.height,width=imgData.width,partialChunkHeight=height%FULL_CHUNK_HEIGHT,fullChunks=(height-partialChunkHeight)/FULL_CHUNK_HEIGHT,totalChunks=partialChunkHeight===0?fullChunks:fullChunks+1,chunkImgData=ctx.createImageData(width,FULL_CHUNK_HEIGHT);let srcPos=0;const src=imgData.data,dest=chunkImgData.data;for(let i=0;i<totalChunks;i++){const thisChunkHeight=i<fullChunks?FULL_CHUNK_HEIGHT:partialChunkHeight;({srcPos}=convertBlackAndWhiteToRGBA({src,srcPos,dest,width,height:thisChunkHeight,nonBlackColor:0})),ctx.putImageData(chunkImgData,0,i*FULL_CHUNK_HEIGHT)}}function copyCtxState(sourceCtx,destCtx){const properties=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const property of properties)sourceCtx[property]!==void 0&&(destCtx[property]=sourceCtx[property]);sourceCtx.setLineDash!==void 0&&(destCtx.setLineDash(sourceCtx.getLineDash()),destCtx.lineDashOffset=sourceCtx.lineDashOffset)}function resetCtxToDefault(ctx){ctx.strokeStyle=ctx.fillStyle="#000000",ctx.fillRule="nonzero",ctx.globalAlpha=1,ctx.lineWidth=1,ctx.lineCap="butt",ctx.lineJoin="miter",ctx.miterLimit=10,ctx.globalCompositeOperation="source-over",ctx.font="10px sans-serif",ctx.setLineDash!==void 0&&(ctx.setLineDash([]),ctx.lineDashOffset=0);const{filter}=ctx;filter!=="none"&&filter!==""&&(ctx.filter="none")}function getImageSmoothingEnabled(transform,interpolate){if(interpolate)return!0;Util.singularValueDecompose2dScale(transform,XY);const actualScale=Math.fround(OutputScale.pixelRatio*PixelsPerInch.PDF_TO_CSS_UNITS);return XY[0]<=actualScale&&XY[1]<=actualScale}const LINE_CAP_STYLES=["butt","round","square"],LINE_JOIN_STYLES=["miter","round","bevel"],NORMAL_CLIP={},EO_CLIP={};class CanvasGraphics{constructor(canvasCtx,commonObjs,objs,canvasFactory,filterFactory,{optionalContentConfig,markedContentStack=null},annotationCanvasMap,pageColors){this.ctx=canvasCtx,this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=commonObjs,this.objs=objs,this.canvasFactory=canvasFactory,this.filterFactory=filterFactory,this.groupStack=[],this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=markedContentStack||[],this.optionalContentConfig=optionalContentConfig,this.cachedCanvases=new CachedCanvases(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=annotationCanvasMap,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=pageColors,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map}getObject(data,fallback=null){return typeof data=="string"?data.startsWith("g_")?this.commonObjs.get(data):this.objs.get(data):fallback}beginDrawing({transform,viewport,transparency=!1,background=null}){const width=this.ctx.canvas.width,height=this.ctx.canvas.height,savedFillStyle=this.ctx.fillStyle;if(this.ctx.fillStyle=background||"#ffffff",this.ctx.fillRect(0,0,width,height),this.ctx.fillStyle=savedFillStyle,transparency){const transparentCanvas=this.cachedCanvases.getCanvas("transparent",width,height);this.compositeCtx=this.ctx,this.transparentCanvas=transparentCanvas.canvas,this.ctx=transparentCanvas.context,this.ctx.save(),this.ctx.transform(...getCurrentTransform(this.compositeCtx))}this.ctx.save(),resetCtxToDefault(this.ctx),transform&&(this.ctx.transform(...transform),this.outputScaleX=transform[0],this.outputScaleY=transform[0]),this.ctx.transform(...viewport.transform),this.viewportScale=viewport.scale,this.baseTransform=getCurrentTransform(this.ctx)}executeOperatorList(operatorList,executionStartIdx,continueCallback,stepper){const argsArray=operatorList.argsArray,fnArray=operatorList.fnArray;let i=executionStartIdx||0;const argsArrayLen=argsArray.length;if(argsArrayLen===i)return i;const chunkOperations=argsArrayLen-i>EXECUTION_STEPS&&typeof continueCallback=="function",endTime=chunkOperations?Date.now()+EXECUTION_TIME:0;let steps=0;const commonObjs=this.commonObjs,objs=this.objs;let fnId;for(;;){if(stepper!==void 0&&i===stepper.nextBreakPoint)return stepper.breakIt(i,continueCallback),i;if(fnId=fnArray[i],fnId!==OPS.dependency)this[fnId].apply(this,argsArray[i]);else for(const depObjId of argsArray[i]){const objsPool=depObjId.startsWith("g_")?commonObjs:objs;if(!objsPool.has(depObjId))return objsPool.get(depObjId,continueCallback),i}if(i++,i===argsArrayLen)return i;if(chunkOperations&&++steps>EXECUTION_STEPS){if(Date.now()>endTime)return continueCallback(),i;steps=0}}}#restoreInitialState(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)}endDrawing(){this.#restoreInitialState(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const cache of this._cachedBitmapsMap.values()){for(const canvas of cache.values())typeof HTMLCanvasElement<"u"&&canvas instanceof HTMLCanvasElement&&(canvas.width=canvas.height=0);cache.clear()}this._cachedBitmapsMap.clear(),this.#drawFilter()}#drawFilter(){if(this.pageColors){const hcmFilterId=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(hcmFilterId!=="none"){const savedFilter=this.ctx.filter;this.ctx.filter=hcmFilterId,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=savedFilter}}}_scaleImage(img,inverseTransform){const width=img.width??img.displayWidth,height=img.height??img.displayHeight;let widthScale=Math.max(Math.hypot(inverseTransform[0],inverseTransform[1]),1),heightScale=Math.max(Math.hypot(inverseTransform[2],inverseTransform[3]),1),paintWidth=width,paintHeight=height,tmpCanvasId="prescale1",tmpCanvas,tmpCtx;for(;widthScale>2&&paintWidth>1||heightScale>2&&paintHeight>1;){let newWidth=paintWidth,newHeight=paintHeight;widthScale>2&&paintWidth>1&&(newWidth=paintWidth>=16384?Math.floor(paintWidth/2)-1||1:Math.ceil(paintWidth/2),widthScale/=paintWidth/newWidth),heightScale>2&&paintHeight>1&&(newHeight=paintHeight>=16384?Math.floor(paintHeight/2)-1||1:Math.ceil(paintHeight)/2,heightScale/=paintHeight/newHeight),tmpCanvas=this.cachedCanvases.getCanvas(tmpCanvasId,newWidth,newHeight),tmpCtx=tmpCanvas.context,tmpCtx.clearRect(0,0,newWidth,newHeight),tmpCtx.drawImage(img,0,0,paintWidth,paintHeight,0,0,newWidth,newHeight),img=tmpCanvas.canvas,paintWidth=newWidth,paintHeight=newHeight,tmpCanvasId=tmpCanvasId==="prescale1"?"prescale2":"prescale1"}return{img,paintWidth,paintHeight}}_createMaskCanvas(img){const ctx=this.ctx,{width,height}=img,fillColor=this.current.fillColor,isPatternFill=this.current.patternFill,currentTransform=getCurrentTransform(ctx);let cache,cacheKey,scaled,maskCanvas;if((img.bitmap||img.data)&&img.count>1){const mainKey=img.bitmap||img.data.buffer;cacheKey=JSON.stringify(isPatternFill?currentTransform:[currentTransform.slice(0,4),fillColor]),cache=this._cachedBitmapsMap.get(mainKey),cache||(cache=new Map,this._cachedBitmapsMap.set(mainKey,cache));const cachedImage=cache.get(cacheKey);if(cachedImage&&!isPatternFill){const offsetX2=Math.round(Math.min(currentTransform[0],currentTransform[2])+currentTransform[4]),offsetY2=Math.round(Math.min(currentTransform[1],currentTransform[3])+currentTransform[5]);return{canvas:cachedImage,offsetX:offsetX2,offsetY:offsetY2}}scaled=cachedImage}scaled||(maskCanvas=this.cachedCanvases.getCanvas("maskCanvas",width,height),putBinaryImageMask(maskCanvas.context,img));let maskToCanvas=Util.transform(currentTransform,[1/width,0,0,-1/height,0,0]);maskToCanvas=Util.transform(maskToCanvas,[1,0,0,1,0,-height]);const minMax=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,width,height],maskToCanvas,minMax);const[minX,minY,maxX,maxY]=minMax,drawnWidth=Math.round(maxX-minX)||1,drawnHeight=Math.round(maxY-minY)||1,fillCanvas=this.cachedCanvases.getCanvas("fillCanvas",drawnWidth,drawnHeight),fillCtx=fillCanvas.context,offsetX=minX,offsetY=minY;fillCtx.translate(-offsetX,-offsetY),fillCtx.transform(...maskToCanvas),scaled||(scaled=this._scaleImage(maskCanvas.canvas,getCurrentTransformInverse(fillCtx)),scaled=scaled.img,cache&&isPatternFill&&cache.set(cacheKey,scaled)),fillCtx.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(fillCtx),img.interpolate),drawImageAtIntegerCoords(fillCtx,scaled,0,0,scaled.width,scaled.height,0,0,width,height),fillCtx.globalCompositeOperation="source-in";const inverse=Util.transform(getCurrentTransformInverse(fillCtx),[1,0,0,1,-offsetX,-offsetY]);return fillCtx.fillStyle=isPatternFill?fillColor.getPattern(ctx,this,inverse,PathType.FILL):fillColor,fillCtx.fillRect(0,0,width,height),cache&&!isPatternFill&&(this.cachedCanvases.delete("fillCanvas"),cache.set(cacheKey,fillCanvas.canvas)),{canvas:fillCanvas.canvas,offsetX:Math.round(offsetX),offsetY:Math.round(offsetY)}}setLineWidth(width){width!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=width,this.ctx.lineWidth=width}setLineCap(style){this.ctx.lineCap=LINE_CAP_STYLES[style]}setLineJoin(style){this.ctx.lineJoin=LINE_JOIN_STYLES[style]}setMiterLimit(limit){this.ctx.miterLimit=limit}setDash(dashArray,dashPhase){const ctx=this.ctx;ctx.setLineDash!==void 0&&(ctx.setLineDash(dashArray),ctx.lineDashOffset=dashPhase)}setRenderingIntent(intent){}setFlatness(flatness){}setGState(states){for(const[key,value]of states)switch(key){case"LW":this.setLineWidth(value);break;case"LC":this.setLineCap(value);break;case"LJ":this.setLineJoin(value);break;case"ML":this.setMiterLimit(value);break;case"D":this.setDash(value[0],value[1]);break;case"RI":this.setRenderingIntent(value);break;case"FL":this.setFlatness(value);break;case"Font":this.setFont(value[0],value[1]);break;case"CA":this.current.strokeAlpha=value;break;case"ca":this.ctx.globalAlpha=this.current.fillAlpha=value;break;case"BM":this.ctx.globalCompositeOperation=value;break;case"SMask":this.current.activeSMask=value?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(value);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const inSMaskMode=this.inSMaskMode;this.current.activeSMask&&!inSMaskMode?this.beginSMaskMode():!this.current.activeSMask&&inSMaskMode&&this.endSMaskMode()}beginSMaskMode(){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const drawnWidth=this.ctx.canvas.width,drawnHeight=this.ctx.canvas.height,cacheId="smaskGroupAt"+this.groupLevel,scratchCanvas=this.cachedCanvases.getCanvas(cacheId,drawnWidth,drawnHeight);this.suspendedCtx=this.ctx;const ctx=this.ctx=scratchCanvas.context;ctx.setTransform(this.suspendedCtx.getTransform()),copyCtxState(this.suspendedCtx,ctx),mirrorContextOperations(ctx,this.suspendedCtx),this.setGState([["BM","source-over"]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),copyCtxState(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(dirtyBox){if(!this.current.activeSMask)return;dirtyBox?(dirtyBox[0]=Math.floor(dirtyBox[0]),dirtyBox[1]=Math.floor(dirtyBox[1]),dirtyBox[2]=Math.ceil(dirtyBox[2]),dirtyBox[3]=Math.ceil(dirtyBox[3])):dirtyBox=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const smask=this.current.activeSMask,suspendedCtx=this.suspendedCtx;this.composeSMask(suspendedCtx,smask,this.ctx,dirtyBox),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(ctx,smask,layerCtx,layerBox){const layerOffsetX=layerBox[0],layerOffsetY=layerBox[1],layerWidth=layerBox[2]-layerOffsetX,layerHeight=layerBox[3]-layerOffsetY;layerWidth===0||layerHeight===0||(this.genericComposeSMask(smask.context,layerCtx,layerWidth,layerHeight,smask.subtype,smask.backdrop,smask.transferMap,layerOffsetX,layerOffsetY,smask.offsetX,smask.offsetY),ctx.save(),ctx.globalAlpha=1,ctx.globalCompositeOperation="source-over",ctx.setTransform(1,0,0,1,0,0),ctx.drawImage(layerCtx.canvas,0,0),ctx.restore())}genericComposeSMask(maskCtx,layerCtx,width,height,subtype,backdrop,transferMap,layerOffsetX,layerOffsetY,maskOffsetX,maskOffsetY){let maskCanvas=maskCtx.canvas,maskX=layerOffsetX-maskOffsetX,maskY=layerOffsetY-maskOffsetY;if(backdrop)if(maskX<0||maskY<0||maskX+width>maskCanvas.width||maskY+height>maskCanvas.height){const canvas=this.cachedCanvases.getCanvas("maskExtension",width,height),ctx=canvas.context;ctx.drawImage(maskCanvas,-maskX,-maskY),ctx.globalCompositeOperation="destination-atop",ctx.fillStyle=backdrop,ctx.fillRect(0,0,width,height),ctx.globalCompositeOperation="source-over",maskCanvas=canvas.canvas,maskX=maskY=0}else{maskCtx.save(),maskCtx.globalAlpha=1,maskCtx.setTransform(1,0,0,1,0,0);const clip2=new Path2D;clip2.rect(maskX,maskY,width,height),maskCtx.clip(clip2),maskCtx.globalCompositeOperation="destination-atop",maskCtx.fillStyle=backdrop,maskCtx.fillRect(maskX,maskY,width,height),maskCtx.restore()}layerCtx.save(),layerCtx.globalAlpha=1,layerCtx.setTransform(1,0,0,1,0,0),subtype==="Alpha"&&transferMap?layerCtx.filter=this.filterFactory.addAlphaFilter(transferMap):subtype==="Luminosity"&&(layerCtx.filter=this.filterFactory.addLuminosityFilter(transferMap));const clip=new Path2D;clip.rect(layerOffsetX,layerOffsetY,width,height),layerCtx.clip(clip),layerCtx.globalCompositeOperation="destination-in",layerCtx.drawImage(maskCanvas,maskX,maskY,width,height,layerOffsetX,layerOffsetY,width,height),layerCtx.restore()}save(){this.inSMaskMode&&copyCtxState(this.ctx,this.suspendedCtx),this.ctx.save();const old=this.current;this.stateStack.push(old),this.current=old.clone()}restore(){if(this.stateStack.length===0){this.inSMaskMode&&this.endSMaskMode();return}this.current=this.stateStack.pop(),this.ctx.restore(),this.inSMaskMode&&copyCtxState(this.suspendedCtx,this.ctx),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}transform(a,b,c,d,e,f){this.ctx.transform(a,b,c,d,e,f),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(op,data,minMax){let[path]=data;if(!minMax){path||=data[0]=new Path2D,this[op](path);return}if(!(path instanceof Path2D)){const path2d=data[0]=new Path2D;for(let i=0,ii=path.length;i<ii;)switch(path[i++]){case DrawOPS.moveTo:path2d.moveTo(path[i++],path[i++]);break;case DrawOPS.lineTo:path2d.lineTo(path[i++],path[i++]);break;case DrawOPS.curveTo:path2d.bezierCurveTo(path[i++],path[i++],path[i++],path[i++],path[i++],path[i++]);break;case DrawOPS.closePath:path2d.closePath();break;default:warn(`Unrecognized drawing path operator: ${path[i-1]}`);break}path=path2d}Util.axialAlignedBoundingBox(minMax,getCurrentTransform(this.ctx),this.current.minMax),this[op](path)}closePath(){this.ctx.closePath()}stroke(path,consumePath=!0){const ctx=this.ctx,strokeColor=this.current.strokeColor;if(ctx.globalAlpha=this.current.strokeAlpha,this.contentVisible)if(typeof strokeColor=="object"&&strokeColor?.getPattern){const baseTransform=strokeColor.isModifyingCurrentTransform()?ctx.getTransform():null;if(ctx.save(),ctx.strokeStyle=strokeColor.getPattern(ctx,this,getCurrentTransformInverse(ctx),PathType.STROKE),baseTransform){const newPath=new Path2D;newPath.addPath(path,ctx.getTransform().invertSelf().multiplySelf(baseTransform)),path=newPath}this.rescaleAndStroke(path,!1),ctx.restore()}else this.rescaleAndStroke(path,!0);consumePath&&this.consumePath(path,this.current.getClippedPathBoundingBox(PathType.STROKE,getCurrentTransform(this.ctx))),ctx.globalAlpha=this.current.fillAlpha}closeStroke(path){this.stroke(path)}fill(path,consumePath=!0){const ctx=this.ctx,fillColor=this.current.fillColor,isPatternFill=this.current.patternFill;let needRestore=!1;if(isPatternFill){const baseTransform=fillColor.isModifyingCurrentTransform()?ctx.getTransform():null;if(ctx.save(),ctx.fillStyle=fillColor.getPattern(ctx,this,getCurrentTransformInverse(ctx),PathType.FILL),baseTransform){const newPath=new Path2D;newPath.addPath(path,ctx.getTransform().invertSelf().multiplySelf(baseTransform)),path=newPath}needRestore=!0}const intersect=this.current.getClippedPathBoundingBox();this.contentVisible&&intersect!==null&&(this.pendingEOFill?(ctx.fill(path,"evenodd"),this.pendingEOFill=!1):ctx.fill(path)),needRestore&&ctx.restore(),consumePath&&this.consumePath(path,intersect)}eoFill(path){this.pendingEOFill=!0,this.fill(path)}fillStroke(path){this.fill(path,!1),this.stroke(path,!1),this.consumePath(path)}eoFillStroke(path){this.pendingEOFill=!0,this.fillStroke(path)}closeFillStroke(path){this.fillStroke(path)}closeEOFillStroke(path){this.pendingEOFill=!0,this.fillStroke(path)}endPath(path){this.consumePath(path)}rawFillPath(path){this.ctx.fill(path)}clip(){this.pendingClip=NORMAL_CLIP}eoClip(){this.pendingClip=EO_CLIP}beginText(){this.current.textMatrix=null,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}endText(){const paths=this.pendingTextPaths,ctx=this.ctx;if(paths===void 0)return;const newPath=new Path2D,invTransf=ctx.getTransform().invertSelf();for(const{transform,x,y,fontSize,path}of paths)newPath.addPath(path,new DOMMatrix(transform).preMultiplySelf(invTransf).translate(x,y).scale(fontSize,-fontSize));ctx.clip(newPath),delete this.pendingTextPaths}setCharSpacing(spacing){this.current.charSpacing=spacing}setWordSpacing(spacing){this.current.wordSpacing=spacing}setHScale(scale){this.current.textHScale=scale/100}setLeading(leading){this.current.leading=-leading}setFont(fontRefName,size){const fontObj=this.commonObjs.get(fontRefName),current=this.current;if(!fontObj)throw new Error(`Can't find font for ${fontRefName}`);if(current.fontMatrix=fontObj.fontMatrix||FONT_IDENTITY_MATRIX,(current.fontMatrix[0]===0||current.fontMatrix[3]===0)&&warn("Invalid font matrix for font "+fontRefName),size<0?(size=-size,current.fontDirection=-1):current.fontDirection=1,this.current.font=fontObj,this.current.fontSize=size,fontObj.isType3Font)return;const name=fontObj.loadedName||"sans-serif",typeface=fontObj.systemFontInfo?.css||`"${name}", ${fontObj.fallbackName}`;let bold="normal";fontObj.black?bold="900":fontObj.bold&&(bold="bold");const italic=fontObj.italic?"italic":"normal";let browserFontSize=size;size<MIN_FONT_SIZE?browserFontSize=MIN_FONT_SIZE:size>MAX_FONT_SIZE&&(browserFontSize=MAX_FONT_SIZE),this.current.fontSizeScale=size/browserFontSize,this.ctx.font=`${italic} ${bold} ${browserFontSize}px ${typeface}`}setTextRenderingMode(mode){this.current.textRenderingMode=mode}setTextRise(rise){this.current.textRise=rise}moveText(x,y){this.current.x=this.current.lineX+=x,this.current.y=this.current.lineY+=y}setLeadingMoveText(x,y){this.setLeading(-y),this.moveText(x,y)}setTextMatrix(matrix){const{current}=this;current.textMatrix=matrix,current.textMatrixScale=Math.hypot(matrix[0],matrix[1]),current.x=current.lineX=0,current.y=current.lineY=0}nextLine(){this.moveText(0,this.current.leading)}#getScaledPath(path,currentTransform,transform){const newPath=new Path2D;return newPath.addPath(path,new DOMMatrix(transform).invertSelf().multiplySelf(currentTransform)),newPath}paintChar(character,x,y,patternFillTransform,patternStrokeTransform){const ctx=this.ctx,current=this.current,font=current.font,textRenderingMode=current.textRenderingMode,fontSize=current.fontSize/current.fontSizeScale,fillStrokeMode=textRenderingMode&TextRenderingMode.FILL_STROKE_MASK,isAddToPathSet=!!(textRenderingMode&TextRenderingMode.ADD_TO_PATH_FLAG),patternFill=current.patternFill&&!font.missingFile,patternStroke=current.patternStroke&&!font.missingFile;let path;if((font.disableFontFace||isAddToPathSet||patternFill||patternStroke)&&(path=font.getPathGenerator(this.commonObjs,character)),font.disableFontFace||patternFill||patternStroke){ctx.save(),ctx.translate(x,y),ctx.scale(fontSize,-fontSize);let currentTransform;if((fillStrokeMode===TextRenderingMode.FILL||fillStrokeMode===TextRenderingMode.FILL_STROKE)&&(patternFillTransform?(currentTransform=ctx.getTransform(),ctx.setTransform(...patternFillTransform),ctx.fill(this.#getScaledPath(path,currentTransform,patternFillTransform))):ctx.fill(path)),fillStrokeMode===TextRenderingMode.STROKE||fillStrokeMode===TextRenderingMode.FILL_STROKE)if(patternStrokeTransform){currentTransform||=ctx.getTransform(),ctx.setTransform(...patternStrokeTransform);const{a,b,c,d}=currentTransform,invPatternTransform=Util.inverseTransform(patternStrokeTransform),transf=Util.transform([a,b,c,d,0,0],invPatternTransform);Util.singularValueDecompose2dScale(transf,XY),ctx.lineWidth*=Math.max(XY[0],XY[1])/fontSize,ctx.stroke(this.#getScaledPath(path,currentTransform,patternStrokeTransform))}else ctx.lineWidth/=fontSize,ctx.stroke(path);ctx.restore()}else(fillStrokeMode===TextRenderingMode.FILL||fillStrokeMode===TextRenderingMode.FILL_STROKE)&&ctx.fillText(character,x,y),(fillStrokeMode===TextRenderingMode.STROKE||fillStrokeMode===TextRenderingMode.FILL_STROKE)&&ctx.strokeText(character,x,y);isAddToPathSet&&(this.pendingTextPaths||=[]).push({transform:getCurrentTransform(ctx),x,y,fontSize,path})}get isFontSubpixelAAEnabled(){const{context:ctx}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);ctx.scale(1.5,1),ctx.fillText("I",0,10);const data=ctx.getImageData(0,0,10,10).data;let enabled=!1;for(let i=3;i<data.length;i+=4)if(data[i]>0&&data[i]<255){enabled=!0;break}return shadow(this,"isFontSubpixelAAEnabled",enabled)}showText(glyphs){const current=this.current,font=current.font;if(font.isType3Font)return this.showType3Text(glyphs);const fontSize=current.fontSize;if(fontSize===0)return;const ctx=this.ctx,fontSizeScale=current.fontSizeScale,charSpacing=current.charSpacing,wordSpacing=current.wordSpacing,fontDirection=current.fontDirection,textHScale=current.textHScale*fontDirection,glyphsLength=glyphs.length,vertical=font.vertical,spacingDir=vertical?1:-1,defaultVMetrics=font.defaultVMetrics,widthAdvanceScale=fontSize*current.fontMatrix[0],simpleFillText=current.textRenderingMode===TextRenderingMode.FILL&&!font.disableFontFace&&!current.patternFill;ctx.save(),current.textMatrix&&ctx.transform(...current.textMatrix),ctx.translate(current.x,current.y+current.textRise),fontDirection>0?ctx.scale(textHScale,-1):ctx.scale(textHScale,1);let patternFillTransform,patternStrokeTransform;if(current.patternFill){ctx.save();const pattern=current.fillColor.getPattern(ctx,this,getCurrentTransformInverse(ctx),PathType.FILL);patternFillTransform=getCurrentTransform(ctx),ctx.restore(),ctx.fillStyle=pattern}if(current.patternStroke){ctx.save();const pattern=current.strokeColor.getPattern(ctx,this,getCurrentTransformInverse(ctx),PathType.STROKE);patternStrokeTransform=getCurrentTransform(ctx),ctx.restore(),ctx.strokeStyle=pattern}let lineWidth=current.lineWidth;const scale=current.textMatrixScale;if(scale===0||lineWidth===0){const fillStrokeMode=current.textRenderingMode&TextRenderingMode.FILL_STROKE_MASK;(fillStrokeMode===TextRenderingMode.STROKE||fillStrokeMode===TextRenderingMode.FILL_STROKE)&&(lineWidth=this.getSinglePixelWidth())}else lineWidth/=scale;if(fontSizeScale!==1&&(ctx.scale(fontSizeScale,fontSizeScale),lineWidth/=fontSizeScale),ctx.lineWidth=lineWidth,font.isInvalidPDFjsFont){const chars=[];let width=0;for(const glyph of glyphs)chars.push(glyph.unicode),width+=glyph.width;ctx.fillText(chars.join(""),0,0),current.x+=width*widthAdvanceScale*textHScale,ctx.restore(),this.compose();return}let x=0,i;for(i=0;i<glyphsLength;++i){const glyph=glyphs[i];if(typeof glyph=="number"){x+=spacingDir*glyph*fontSize/1e3;continue}let restoreNeeded=!1;const spacing=(glyph.isSpace?wordSpacing:0)+charSpacing,character=glyph.fontChar,accent=glyph.accent;let scaledX,scaledY,width=glyph.width;if(vertical){const vmetric=glyph.vmetric||defaultVMetrics,vx=-(glyph.vmetric?vmetric[1]:width*.5)*widthAdvanceScale,vy=vmetric[2]*widthAdvanceScale;width=vmetric?-vmetric[0]:width,scaledX=vx/fontSizeScale,scaledY=(x+vy)/fontSizeScale}else scaledX=x/fontSizeScale,scaledY=0;if(font.remeasure&&width>0){const measuredWidth=ctx.measureText(character).width*1e3/fontSize*fontSizeScale;if(width<measuredWidth&&this.isFontSubpixelAAEnabled){const characterScaleX=width/measuredWidth;restoreNeeded=!0,ctx.save(),ctx.scale(characterScaleX,1),scaledX/=characterScaleX}else width!==measuredWidth&&(scaledX+=(width-measuredWidth)/2e3*fontSize/fontSizeScale)}if(this.contentVisible&&(glyph.isInFont||font.missingFile)){if(simpleFillText&&!accent)ctx.fillText(character,scaledX,scaledY);else if(this.paintChar(character,scaledX,scaledY,patternFillTransform,patternStrokeTransform),accent){const scaledAccentX=scaledX+fontSize*accent.offset.x/fontSizeScale,scaledAccentY=scaledY-fontSize*accent.offset.y/fontSizeScale;this.paintChar(accent.fontChar,scaledAccentX,scaledAccentY,patternFillTransform,patternStrokeTransform)}}const charWidth=vertical?width*widthAdvanceScale-spacing*fontDirection:width*widthAdvanceScale+spacing*fontDirection;x+=charWidth,restoreNeeded&&ctx.restore()}vertical?current.y-=x:current.x+=x*textHScale,ctx.restore(),this.compose()}showType3Text(glyphs){const ctx=this.ctx,current=this.current,font=current.font,fontSize=current.fontSize,fontDirection=current.fontDirection,spacingDir=font.vertical?1:-1,charSpacing=current.charSpacing,wordSpacing=current.wordSpacing,textHScale=current.textHScale*fontDirection,fontMatrix=current.fontMatrix||FONT_IDENTITY_MATRIX,glyphsLength=glyphs.length,isTextInvisible=current.textRenderingMode===TextRenderingMode.INVISIBLE;let i,glyph,width,spacingLength;if(!(isTextInvisible||fontSize===0)){for(this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,ctx.save(),current.textMatrix&&ctx.transform(...current.textMatrix),ctx.translate(current.x,current.y+current.textRise),ctx.scale(textHScale,fontDirection),i=0;i<glyphsLength;++i){if(glyph=glyphs[i],typeof glyph=="number"){spacingLength=spacingDir*glyph*fontSize/1e3,this.ctx.translate(spacingLength,0),current.x+=spacingLength*textHScale;continue}const spacing=(glyph.isSpace?wordSpacing:0)+charSpacing,operatorList=font.charProcOperatorList[glyph.operatorListId];operatorList?this.contentVisible&&(this.save(),ctx.scale(fontSize,fontSize),ctx.transform(...fontMatrix),this.executeOperatorList(operatorList),this.restore()):warn(`Type3 character "${glyph.operatorListId}" is not available.`);const p=[glyph.width,0];Util.applyTransform(p,fontMatrix),width=p[0]*fontSize+spacing,ctx.translate(width,0),current.x+=width*textHScale}ctx.restore()}}setCharWidth(xWidth,yWidth){}setCharWidthAndBounds(xWidth,yWidth,llx,lly,urx,ury){const clip=new Path2D;clip.rect(llx,lly,urx-llx,ury-lly),this.ctx.clip(clip),this.endPath()}getColorN_Pattern(IR){let pattern;if(IR[0]==="TilingPattern"){const baseTransform=this.baseTransform||getCurrentTransform(this.ctx),canvasGraphicsFactory={createCanvasGraphics:ctx=>new CanvasGraphics(ctx,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};pattern=new TilingPattern(IR,this.ctx,canvasGraphicsFactory,baseTransform)}else pattern=this._getPattern(IR[1],IR[2]);return pattern}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments),this.current.patternStroke=!0}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0}setStrokeRGBColor(color){this.ctx.strokeStyle=this.current.strokeColor=color,this.current.patternStroke=!1}setStrokeTransparent(){this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(color){this.ctx.fillStyle=this.current.fillColor=color,this.current.patternFill=!1}setFillTransparent(){this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(objId,matrix=null){let pattern;return this.cachedPatterns.has(objId)?pattern=this.cachedPatterns.get(objId):(pattern=getShadingPattern(this.getObject(objId)),this.cachedPatterns.set(objId,pattern)),matrix&&(pattern.matrix=matrix),pattern}shadingFill(objId){if(!this.contentVisible)return;const ctx=this.ctx;this.save();const pattern=this._getPattern(objId);ctx.fillStyle=pattern.getPattern(ctx,this,getCurrentTransformInverse(ctx),PathType.SHADING);const inv=getCurrentTransformInverse(ctx);if(inv){const{width,height}=ctx.canvas,minMax=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,width,height],inv,minMax);const[x0,y0,x1,y1]=minMax;this.ctx.fillRect(x0,y0,x1-x0,y1-y0)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.compose(this.current.getClippedPathBoundingBox()),this.restore()}beginInlineImage(){unreachable("Should not call beginInlineImage")}beginImageData(){unreachable("Should not call beginImageData")}paintFormXObjectBegin(matrix,bbox){if(this.contentVisible&&(this.save(),this.baseTransformStack.push(this.baseTransform),matrix&&this.transform(...matrix),this.baseTransform=getCurrentTransform(this.ctx),bbox)){Util.axialAlignedBoundingBox(bbox,this.baseTransform,this.current.minMax);const[x0,y0,x1,y1]=bbox,clip=new Path2D;clip.rect(x0,y0,x1-x0,y1-y0),this.ctx.clip(clip),this.endPath()}}paintFormXObjectEnd(){this.contentVisible&&(this.restore(),this.baseTransform=this.baseTransformStack.pop())}beginGroup(group){if(!this.contentVisible)return;this.save(),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const currentCtx=this.ctx;group.isolated||info("TODO: Support non-isolated groups."),group.knockout&&warn("Knockout groups not supported.");const currentTransform=getCurrentTransform(currentCtx);if(group.matrix&&currentCtx.transform(...group.matrix),!group.bbox)throw new Error("Bounding box is required.");let bounds=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox(group.bbox,getCurrentTransform(currentCtx),bounds);const canvasBounds=[0,0,currentCtx.canvas.width,currentCtx.canvas.height];bounds=Util.intersect(bounds,canvasBounds)||[0,0,0,0];const offsetX=Math.floor(bounds[0]),offsetY=Math.floor(bounds[1]),drawnWidth=Math.max(Math.ceil(bounds[2])-offsetX,1),drawnHeight=Math.max(Math.ceil(bounds[3])-offsetY,1);this.current.startNewPathAndClipBox([0,0,drawnWidth,drawnHeight]);let cacheId="groupAt"+this.groupLevel;group.smask&&(cacheId+="_smask_"+this.smaskCounter++%2);const scratchCanvas=this.cachedCanvases.getCanvas(cacheId,drawnWidth,drawnHeight),groupCtx=scratchCanvas.context;groupCtx.translate(-offsetX,-offsetY),groupCtx.transform(...currentTransform);let clip=new Path2D;const[x0,y0,x1,y1]=group.bbox;if(clip.rect(x0,y0,x1-x0,y1-y0),group.matrix){const path=new Path2D;path.addPath(clip,new DOMMatrix(group.matrix)),clip=path}groupCtx.clip(clip),group.smask?this.smaskStack.push({canvas:scratchCanvas.canvas,context:groupCtx,offsetX,offsetY,subtype:group.smask.subtype,backdrop:group.smask.backdrop,transferMap:group.smask.transferMap||null,startTransformInverse:null}):(currentCtx.setTransform(1,0,0,1,0,0),currentCtx.translate(offsetX,offsetY),currentCtx.save()),copyCtxState(currentCtx,groupCtx),this.ctx=groupCtx,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(currentCtx),this.groupLevel++}endGroup(group){if(!this.contentVisible)return;this.groupLevel--;const groupCtx=this.ctx,ctx=this.groupStack.pop();if(this.ctx=ctx,this.ctx.imageSmoothingEnabled=!1,group.smask)this.tempSMask=this.smaskStack.pop(),this.restore();else{this.ctx.restore();const currentMtx=getCurrentTransform(this.ctx);this.restore(),this.ctx.save(),this.ctx.setTransform(...currentMtx);const dirtyBox=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,groupCtx.canvas.width,groupCtx.canvas.height],currentMtx,dirtyBox),this.ctx.drawImage(groupCtx.canvas,0,0),this.ctx.restore(),this.compose(dirtyBox)}}beginAnnotation(id,rect,transform,matrix,hasOwnCanvas){if(this.#restoreInitialState(),resetCtxToDefault(this.ctx),this.ctx.save(),this.save(),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),rect){const width=rect[2]-rect[0],height=rect[3]-rect[1];if(hasOwnCanvas&&this.annotationCanvasMap){transform=transform.slice(),transform[4]-=rect[0],transform[5]-=rect[1],rect=rect.slice(),rect[0]=rect[1]=0,rect[2]=width,rect[3]=height,Util.singularValueDecompose2dScale(getCurrentTransform(this.ctx),XY);const{viewportScale}=this,canvasWidth=Math.ceil(width*this.outputScaleX*viewportScale),canvasHeight=Math.ceil(height*this.outputScaleY*viewportScale);this.annotationCanvas=this.canvasFactory.create(canvasWidth,canvasHeight);const{canvas,context}=this.annotationCanvas;this.annotationCanvasMap.set(id,canvas),this.annotationCanvas.savedCtx=this.ctx,this.ctx=context,this.ctx.save(),this.ctx.setTransform(XY[0],0,0,-XY[1],0,height*XY[1]),resetCtxToDefault(this.ctx)}else{resetCtxToDefault(this.ctx),this.endPath();const clip=new Path2D;clip.rect(rect[0],rect[1],width,height),this.ctx.clip(clip)}}this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(...transform),this.transform(...matrix)}endAnnotation(){this.annotationCanvas&&(this.ctx.restore(),this.#drawFilter(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(img){if(!this.contentVisible)return;const count=img.count;img=this.getObject(img.data,img),img.count=count;const ctx=this.ctx,mask=this._createMaskCanvas(img),maskCanvas=mask.canvas;ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.drawImage(maskCanvas,mask.offsetX,mask.offsetY),ctx.restore(),this.compose()}paintImageMaskXObjectRepeat(img,scaleX,skewX=0,skewY=0,scaleY,positions){if(!this.contentVisible)return;img=this.getObject(img.data,img);const ctx=this.ctx;ctx.save();const currentTransform=getCurrentTransform(ctx);ctx.transform(scaleX,skewX,skewY,scaleY,0,0);const mask=this._createMaskCanvas(img);ctx.setTransform(1,0,0,1,mask.offsetX-currentTransform[4],mask.offsetY-currentTransform[5]);for(let i=0,ii=positions.length;i<ii;i+=2){const trans=Util.transform(currentTransform,[scaleX,skewX,skewY,scaleY,positions[i],positions[i+1]]);ctx.drawImage(mask.canvas,trans[4],trans[5])}ctx.restore(),this.compose()}paintImageMaskXObjectGroup(images){if(!this.contentVisible)return;const ctx=this.ctx,fillColor=this.current.fillColor,isPatternFill=this.current.patternFill;for(const image of images){const{data,width,height,transform}=image,maskCanvas=this.cachedCanvases.getCanvas("maskCanvas",width,height),maskCtx=maskCanvas.context;maskCtx.save();const img=this.getObject(data,image);putBinaryImageMask(maskCtx,img),maskCtx.globalCompositeOperation="source-in",maskCtx.fillStyle=isPatternFill?fillColor.getPattern(maskCtx,this,getCurrentTransformInverse(ctx),PathType.FILL):fillColor,maskCtx.fillRect(0,0,width,height),maskCtx.restore(),ctx.save(),ctx.transform(...transform),ctx.scale(1,-1),drawImageAtIntegerCoords(ctx,maskCanvas.canvas,0,0,width,height,0,-1,1,1),ctx.restore()}this.compose()}paintImageXObject(objId){if(!this.contentVisible)return;const imgData=this.getObject(objId);if(!imgData){warn("Dependent image isn't ready yet");return}this.paintInlineImageXObject(imgData)}paintImageXObjectRepeat(objId,scaleX,scaleY,positions){if(!this.contentVisible)return;const imgData=this.getObject(objId);if(!imgData){warn("Dependent image isn't ready yet");return}const width=imgData.width,height=imgData.height,map=[];for(let i=0,ii=positions.length;i<ii;i+=2)map.push({transform:[scaleX,0,0,scaleY,positions[i],positions[i+1]],x:0,y:0,w:width,h:height});this.paintInlineImageXObjectGroup(imgData,map)}applyTransferMapsToCanvas(ctx){return this.current.transferMaps!=="none"&&(ctx.filter=this.current.transferMaps,ctx.drawImage(ctx.canvas,0,0),ctx.filter="none"),ctx.canvas}applyTransferMapsToBitmap(imgData){if(this.current.transferMaps==="none")return imgData.bitmap;const{bitmap,width,height}=imgData,tmpCanvas=this.cachedCanvases.getCanvas("inlineImage",width,height),tmpCtx=tmpCanvas.context;return tmpCtx.filter=this.current.transferMaps,tmpCtx.drawImage(bitmap,0,0),tmpCtx.filter="none",tmpCanvas.canvas}paintInlineImageXObject(imgData){if(!this.contentVisible)return;const width=imgData.width,height=imgData.height,ctx=this.ctx;this.save();const{filter}=ctx;filter!=="none"&&filter!==""&&(ctx.filter="none"),ctx.scale(1/width,-1/height);let imgToPaint;if(imgData.bitmap)imgToPaint=this.applyTransferMapsToBitmap(imgData);else if(typeof HTMLElement=="function"&&imgData instanceof HTMLElement||!imgData.data)imgToPaint=imgData;else{const tmpCtx=this.cachedCanvases.getCanvas("inlineImage",width,height).context;putBinaryImageData(tmpCtx,imgData),imgToPaint=this.applyTransferMapsToCanvas(tmpCtx)}const scaled=this._scaleImage(imgToPaint,getCurrentTransformInverse(ctx));ctx.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(ctx),imgData.interpolate),drawImageAtIntegerCoords(ctx,scaled.img,0,0,scaled.paintWidth,scaled.paintHeight,0,-height,width,height),this.compose(),this.restore()}paintInlineImageXObjectGroup(imgData,map){if(!this.contentVisible)return;const ctx=this.ctx;let imgToPaint;if(imgData.bitmap)imgToPaint=imgData.bitmap;else{const w=imgData.width,h=imgData.height,tmpCtx=this.cachedCanvases.getCanvas("inlineImage",w,h).context;putBinaryImageData(tmpCtx,imgData),imgToPaint=this.applyTransferMapsToCanvas(tmpCtx)}for(const entry of map)ctx.save(),ctx.transform(...entry.transform),ctx.scale(1,-1),drawImageAtIntegerCoords(ctx,imgToPaint,entry.x,entry.y,entry.w,entry.h,0,-1,1,1),ctx.restore();this.compose()}paintSolidColorImageMask(){this.contentVisible&&(this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(tag){}markPointProps(tag,properties){}beginMarkedContent(tag){this.markedContentStack.push({visible:!0})}beginMarkedContentProps(tag,properties){tag==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(properties)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(path,clipBox){const isEmpty=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(clipBox);const ctx=this.ctx;this.pendingClip&&(isEmpty||(this.pendingClip===EO_CLIP?ctx.clip(path,"evenodd"):ctx.clip(path)),this.pendingClip=null),this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const m=getCurrentTransform(this.ctx);if(m[1]===0&&m[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(m[0]),Math.abs(m[3]));else{const absDet=Math.abs(m[0]*m[3]-m[2]*m[1]),normX=Math.hypot(m[0],m[2]),normY=Math.hypot(m[1],m[3]);this._cachedGetSinglePixelWidth=Math.max(normX,normY)/absDet}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth}=this.current,{a,b,c,d}=this.ctx.getTransform();let scaleX,scaleY;if(b===0&&c===0){const normX=Math.abs(a),normY=Math.abs(d);if(normX===normY)if(lineWidth===0)scaleX=scaleY=1/normX;else{const scaledLineWidth=normX*lineWidth;scaleX=scaleY=scaledLineWidth<1?1/scaledLineWidth:1}else if(lineWidth===0)scaleX=1/normX,scaleY=1/normY;else{const scaledXLineWidth=normX*lineWidth,scaledYLineWidth=normY*lineWidth;scaleX=scaledXLineWidth<1?1/scaledXLineWidth:1,scaleY=scaledYLineWidth<1?1/scaledYLineWidth:1}}else{const absDet=Math.abs(a*d-b*c),normX=Math.hypot(a,b),normY=Math.hypot(c,d);if(lineWidth===0)scaleX=normY/absDet,scaleY=normX/absDet;else{const baseArea=lineWidth*absDet;scaleX=normY>baseArea?normY/baseArea:1,scaleY=normX>baseArea?normX/baseArea:1}}this._cachedScaleForStroking[0]=scaleX,this._cachedScaleForStroking[1]=scaleY}return this._cachedScaleForStroking}rescaleAndStroke(path,saveRestore){const{ctx,current:{lineWidth}}=this,[scaleX,scaleY]=this.getScaleForStroking();if(scaleX===scaleY){ctx.lineWidth=(lineWidth||1)*scaleX,ctx.stroke(path);return}const dashes=ctx.getLineDash();saveRestore&&ctx.save(),ctx.scale(scaleX,scaleY),SCALE_MATRIX.a=1/scaleX,SCALE_MATRIX.d=1/scaleY;const newPath=new Path2D;if(newPath.addPath(path,SCALE_MATRIX),dashes.length>0){const scale=Math.max(scaleX,scaleY);ctx.setLineDash(dashes.map(x=>x/scale)),ctx.lineDashOffset/=scale}ctx.lineWidth=lineWidth||1,ctx.stroke(newPath),saveRestore&&ctx.restore()}isContentVisible(){for(let i=this.markedContentStack.length-1;i>=0;i--)if(!this.markedContentStack[i].visible)return!1;return!0}}for(const op in OPS)CanvasGraphics.prototype[op]!==void 0&&(CanvasGraphics.prototype[OPS[op]]=CanvasGraphics.prototype[op]);class GlobalWorkerOptions{static#port=null;static#src="";static get workerPort(){return this.#port}static set workerPort(val){if(!(typeof Worker<"u"&&val instanceof Worker)&&val!==null)throw new Error("Invalid `workerPort` type.");this.#port=val}static get workerSrc(){return this.#src}static set workerSrc(val){if(typeof val!="string")throw new Error("Invalid `workerSrc` type.");this.#src=val}}class Metadata{#map;#data;constructor({parsedData,rawData}){this.#map=parsedData,this.#data=rawData}getRaw(){return this.#data}get(name){return this.#map.get(name)??null}[Symbol.iterator](){return this.#map.entries()}}const INTERNAL=Symbol("INTERNAL");class OptionalContentGroup{#isDisplay=!1;#isPrint=!1;#userSet=!1;#visible=!0;constructor(renderingIntent,{name,intent,usage,rbGroups}){this.#isDisplay=!!(renderingIntent&RenderingIntentFlag.DISPLAY),this.#isPrint=!!(renderingIntent&RenderingIntentFlag.PRINT),this.name=name,this.intent=intent,this.usage=usage,this.rbGroups=rbGroups}get visible(){if(this.#userSet)return this.#visible;if(!this.#visible)return!1;const{print,view}=this.usage;return this.#isDisplay?view?.viewState!=="OFF":this.#isPrint?print?.printState!=="OFF":!0}_setVisible(internal,visible,userSet=!1){internal!==INTERNAL&&unreachable("Internal method `_setVisible` called."),this.#userSet=userSet,this.#visible=visible}}class OptionalContentConfig{#cachedGetHash=null;#groups=new Map;#initialHash=null;#order=null;constructor(data,renderingIntent=RenderingIntentFlag.DISPLAY){if(this.renderingIntent=renderingIntent,this.name=null,this.creator=null,data!==null){this.name=data.name,this.creator=data.creator,this.#order=data.order;for(const group of data.groups)this.#groups.set(group.id,new OptionalContentGroup(renderingIntent,group));if(data.baseState==="OFF")for(const group of this.#groups.values())group._setVisible(INTERNAL,!1);for(const on of data.on)this.#groups.get(on)._setVisible(INTERNAL,!0);for(const off of data.off)this.#groups.get(off)._setVisible(INTERNAL,!1);this.#initialHash=this.getHash()}}#evaluateVisibilityExpression(array){const length=array.length;if(length<2)return!0;const operator=array[0];for(let i=1;i<length;i++){const element=array[i];let state;if(Array.isArray(element))state=this.#evaluateVisibilityExpression(element);else if(this.#groups.has(element))state=this.#groups.get(element).visible;else return warn(`Optional content group not found: ${element}`),!0;switch(operator){case"And":if(!state)return!1;break;case"Or":if(state)return!0;break;case"Not":return!state;default:return!0}}return operator==="And"}isVisible(group){if(this.#groups.size===0)return!0;if(!group)return info("Optional content group not defined."),!0;if(group.type==="OCG")return this.#groups.has(group.id)?this.#groups.get(group.id).visible:(warn(`Optional content group not found: ${group.id}`),!0);if(group.type==="OCMD"){if(group.expression)return this.#evaluateVisibilityExpression(group.expression);if(!group.policy||group.policy==="AnyOn"){for(const id of group.ids){if(!this.#groups.has(id))return warn(`Optional content group not found: ${id}`),!0;if(this.#groups.get(id).visible)return!0}return!1}else if(group.policy==="AllOn"){for(const id of group.ids){if(!this.#groups.has(id))return warn(`Optional content group not found: ${id}`),!0;if(!this.#groups.get(id).visible)return!1}return!0}else if(group.policy==="AnyOff"){for(const id of group.ids){if(!this.#groups.has(id))return warn(`Optional content group not found: ${id}`),!0;if(!this.#groups.get(id).visible)return!0}return!1}else if(group.policy==="AllOff"){for(const id of group.ids){if(!this.#groups.has(id))return warn(`Optional content group not found: ${id}`),!0;if(this.#groups.get(id).visible)return!1}return!0}return warn(`Unknown optional content policy ${group.policy}.`),!0}return warn(`Unknown group type ${group.type}.`),!0}setVisibility(id,visible=!0,preserveRB=!0){const group=this.#groups.get(id);if(!group){warn(`Optional content group not found: ${id}`);return}if(preserveRB&&visible&&group.rbGroups.length)for(const rbGroup of group.rbGroups)for(const otherId of rbGroup)otherId!==id&&this.#groups.get(otherId)?._setVisible(INTERNAL,!1,!0);group._setVisible(INTERNAL,!!visible,!0),this.#cachedGetHash=null}setOCGState({state,preserveRB}){let operator;for(const elem of state){switch(elem){case"ON":case"OFF":case"Toggle":operator=elem;continue}const group=this.#groups.get(elem);if(group)switch(operator){case"ON":this.setVisibility(elem,!0,preserveRB);break;case"OFF":this.setVisibility(elem,!1,preserveRB);break;case"Toggle":this.setVisibility(elem,!group.visible,preserveRB);break}}this.#cachedGetHash=null}get hasInitialVisibility(){return this.#initialHash===null||this.getHash()===this.#initialHash}getOrder(){return this.#groups.size?this.#order?this.#order.slice():[...this.#groups.keys()]:null}getGroup(id){return this.#groups.get(id)||null}getHash(){if(this.#cachedGetHash!==null)return this.#cachedGetHash;const hash=new MurmurHash3_64;for(const[id,group]of this.#groups)hash.update(`${id}:${group.visible}`);return this.#cachedGetHash=hash.hexdigest()}[Symbol.iterator](){return this.#groups.entries()}}class PDFDataTransportStream{constructor(pdfDataRangeTransport,{disableRange=!1,disableStream=!1}){assert(pdfDataRangeTransport,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length,initialData,progressiveDone,contentDispositionFilename}=pdfDataRangeTransport;if(this._queuedChunks=[],this._progressiveDone=progressiveDone,this._contentDispositionFilename=contentDispositionFilename,initialData?.length>0){const buffer=initialData instanceof Uint8Array&&initialData.byteLength===initialData.buffer.byteLength?initialData.buffer:new Uint8Array(initialData).buffer;this._queuedChunks.push(buffer)}this._pdfDataRangeTransport=pdfDataRangeTransport,this._isStreamingSupported=!disableStream,this._isRangeSupported=!disableRange,this._contentLength=length,this._fullRequestReader=null,this._rangeReaders=[],pdfDataRangeTransport.addRangeListener((begin,chunk)=>{this._onReceiveData({begin,chunk})}),pdfDataRangeTransport.addProgressListener((loaded,total)=>{this._onProgress({loaded,total})}),pdfDataRangeTransport.addProgressiveReadListener(chunk=>{this._onReceiveData({chunk})}),pdfDataRangeTransport.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),pdfDataRangeTransport.transportReady()}_onReceiveData({begin,chunk}){const buffer=chunk instanceof Uint8Array&&chunk.byteLength===chunk.buffer.byteLength?chunk.buffer:new Uint8Array(chunk).buffer;if(begin===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(buffer):this._queuedChunks.push(buffer);else{const found=this._rangeReaders.some(function(rangeReader){return rangeReader._begin!==begin?!1:(rangeReader._enqueue(buffer),!0)});assert(found,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(evt){evt.total===void 0?this._rangeReaders[0]?.onProgress?.({loaded:evt.loaded}):this._fullRequestReader?.onProgress?.({loaded:evt.loaded,total:evt.total})}_onProgressiveDone(){this._fullRequestReader?.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(reader){const i=this._rangeReaders.indexOf(reader);i>=0&&this._rangeReaders.splice(i,1)}getFullReader(){assert(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const queuedChunks=this._queuedChunks;return this._queuedChunks=null,new PDFDataTransportStreamReader(this,queuedChunks,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(begin,end){if(end<=this._progressiveDataLength)return null;const reader=new PDFDataTransportStreamRangeReader(this,begin,end);return this._pdfDataRangeTransport.requestDataRange(begin,end),this._rangeReaders.push(reader),reader}cancelAllRequests(reason){this._fullRequestReader?.cancel(reason);for(const reader of this._rangeReaders.slice(0))reader.cancel(reason);this._pdfDataRangeTransport.abort()}}class PDFDataTransportStreamReader{constructor(stream,queuedChunks,progressiveDone=!1,contentDispositionFilename=null){this._stream=stream,this._done=progressiveDone||!1,this._filename=isPdfFile(contentDispositionFilename)?contentDispositionFilename:null,this._queuedChunks=queuedChunks||[],this._loaded=0;for(const chunk of this._queuedChunks)this._loaded+=chunk.byteLength;this._requests=[],this._headersReady=Promise.resolve(),stream._fullRequestReader=this,this.onProgress=null}_enqueue(chunk){this._done||(this._requests.length>0?this._requests.shift().resolve({value:chunk,done:!1}):this._queuedChunks.push(chunk),this._loaded+=chunk.byteLength)}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const requestCapability=Promise.withResolvers();return this._requests.push(requestCapability),requestCapability.promise}cancel(reason){this._done=!0;for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||(this._done=!0)}}class PDFDataTransportStreamRangeReader{constructor(stream,begin,end){this._stream=stream,this._begin=begin,this._end=end,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(chunk){if(!this._done){if(this._requests.length===0)this._queuedChunk=chunk;else{this._requests.shift().resolve({value:chunk,done:!1});for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){const chunk=this._queuedChunk;return this._queuedChunk=null,{value:chunk,done:!1}}if(this._done)return{value:void 0,done:!0};const requestCapability=Promise.withResolvers();return this._requests.push(requestCapability),requestCapability.promise}cancel(reason){this._done=!0;for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}}function getFilenameFromContentDispositionHeader(contentDisposition){let needsEncodingFixup=!0,tmp=toParamRegExp("filename\\*","i").exec(contentDisposition);if(tmp){tmp=tmp[1];let filename=rfc2616unquote(tmp);return filename=unescape(filename),filename=rfc5987decode(filename),filename=rfc2047decode(filename),fixupEncoding(filename)}if(tmp=rfc2231getparam(contentDisposition),tmp){const filename=rfc2047decode(tmp);return fixupEncoding(filename)}if(tmp=toParamRegExp("filename","i").exec(contentDisposition),tmp){tmp=tmp[1];let filename=rfc2616unquote(tmp);return filename=rfc2047decode(filename),fixupEncoding(filename)}function toParamRegExp(attributePattern,flags){return new RegExp("(?:^|;)\\s*"+attributePattern+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',flags)}function textdecode(encoding,value){if(encoding){if(!/^[\x00-\xFF]+$/.test(value))return value;try{const decoder=new TextDecoder(encoding,{fatal:!0}),buffer=stringToBytes(value);value=decoder.decode(buffer),needsEncodingFixup=!1}catch{}}return value}function fixupEncoding(value){return needsEncodingFixup&&/[\x80-\xff]/.test(value)&&(value=textdecode("utf-8",value),needsEncodingFixup&&(value=textdecode("iso-8859-1",value))),value}function rfc2231getparam(contentDispositionStr){const matches=[];let match;const iter=toParamRegExp("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(match=iter.exec(contentDispositionStr))!==null;){let[,n,quot,part]=match;if(n=parseInt(n,10),n in matches){if(n===0)break;continue}matches[n]=[quot,part]}const parts=[];for(let n=0;n<matches.length&&n in matches;++n){let[quot,part]=matches[n];part=rfc2616unquote(part),quot&&(part=unescape(part),n===0&&(part=rfc5987decode(part))),parts.push(part)}return parts.join("")}function rfc2616unquote(value){if(value.startsWith('"')){const parts=value.slice(1).split('\\"');for(let i=0;i<parts.length;++i){const quotindex=parts[i].indexOf('"');quotindex!==-1&&(parts[i]=parts[i].slice(0,quotindex),parts.length=i+1),parts[i]=parts[i].replaceAll(/\\(.)/g,"$1")}value=parts.join('"')}return value}function rfc5987decode(extvalue){const encodingend=extvalue.indexOf("'");if(encodingend===-1)return extvalue;const encoding=extvalue.slice(0,encodingend),value=extvalue.slice(encodingend+1).replace(/^[^']*'/,"");return textdecode(encoding,value)}function rfc2047decode(value){return!value.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(value)?value:value.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(matches,charset,encoding,text){if(encoding==="q"||encoding==="Q")return text=text.replaceAll("_"," "),text=text.replaceAll(/=([0-9a-fA-F]{2})/g,function(match,hex){return String.fromCharCode(parseInt(hex,16))}),textdecode(charset,text);try{text=atob(text)}catch{}return textdecode(charset,text)})}return""}function createHeaders(isHttp,httpHeaders){const headers=new Headers;if(!isHttp||!httpHeaders||typeof httpHeaders!="object")return headers;for(const key in httpHeaders){const val=httpHeaders[key];val!==void 0&&headers.append(key,val)}return headers}function getResponseOrigin(url){return URL.parse(url)?.origin??null}function validateRangeRequestCapabilities({responseHeaders,isHttp,rangeChunkSize,disableRange}){const returnValues={allowRangeRequests:!1,suggestedLength:void 0},length=parseInt(responseHeaders.get("Content-Length"),10);return!Number.isInteger(length)||(returnValues.suggestedLength=length,length<=2*rangeChunkSize)||disableRange||!isHttp||responseHeaders.get("Accept-Ranges")!=="bytes"||(responseHeaders.get("Content-Encoding")||"identity")!=="identity"||(returnValues.allowRangeRequests=!0),returnValues}function extractFilenameFromHeader(responseHeaders){const contentDisposition=responseHeaders.get("Content-Disposition");if(contentDisposition){let filename=getFilenameFromContentDispositionHeader(contentDisposition);if(filename.includes("%"))try{filename=decodeURIComponent(filename)}catch{}if(isPdfFile(filename))return filename}return null}function createResponseError(status,url){return new ResponseException(`Unexpected server response (${status}) while retrieving PDF "${url}".`,status,status===404||status===0&&url.startsWith("file:"))}function validateResponseStatus(status){return status===200||status===206}function createFetchOptions(headers,withCredentials,abortController){return{method:"GET",headers,signal:abortController.signal,mode:"cors",credentials:withCredentials?"include":"same-origin",redirect:"follow"}}function getArrayBuffer(val){return val instanceof Uint8Array?val.buffer:val instanceof ArrayBuffer?val:(warn(`getArrayBuffer - unexpected data format: ${val}`),new Uint8Array(val).buffer)}class PDFFetchStream{_responseOrigin=null;constructor(source){this.source=source,this.isHttp=/^https?:/i.test(source.url),this.headers=createHeaders(this.isHttp,source.httpHeaders),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return assert(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new PDFFetchStreamReader(this),this._fullRequestReader}getRangeReader(begin,end){if(end<=this._progressiveDataLength)return null;const reader=new PDFFetchStreamRangeReader(this,begin,end);return this._rangeRequestReaders.push(reader),reader}cancelAllRequests(reason){this._fullRequestReader?.cancel(reason);for(const reader of this._rangeRequestReaders.slice(0))reader.cancel(reason)}}class PDFFetchStreamReader{constructor(stream){this._stream=stream,this._reader=null,this._loaded=0,this._filename=null;const source=stream.source;this._withCredentials=source.withCredentials||!1,this._contentLength=source.length,this._headersCapability=Promise.withResolvers(),this._disableRange=source.disableRange||!1,this._rangeChunkSize=source.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!source.disableStream,this._isRangeSupported=!source.disableRange;const headers=new Headers(stream.headers),url=source.url;fetch(url,createFetchOptions(headers,this._withCredentials,this._abortController)).then(response=>{if(stream._responseOrigin=getResponseOrigin(response.url),!validateResponseStatus(response.status))throw createResponseError(response.status,url);this._reader=response.body.getReader(),this._headersCapability.resolve();const responseHeaders=response.headers,{allowRangeRequests,suggestedLength}=validateRangeRequestCapabilities({responseHeaders,isHttp:stream.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=allowRangeRequests,this._contentLength=suggestedLength||this._contentLength,this._filename=extractFilenameFromHeader(responseHeaders),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new AbortException("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value,done}=await this._reader.read();return done?{value,done}:(this._loaded+=value.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:getArrayBuffer(value),done:!1})}cancel(reason){this._reader?.cancel(reason),this._abortController.abort()}}class PDFFetchStreamRangeReader{constructor(stream,begin,end){this._stream=stream,this._reader=null,this._loaded=0;const source=stream.source;this._withCredentials=source.withCredentials||!1,this._readCapability=Promise.withResolvers(),this._isStreamingSupported=!source.disableStream,this._abortController=new AbortController;const headers=new Headers(stream.headers);headers.append("Range",`bytes=${begin}-${end-1}`);const url=source.url;fetch(url,createFetchOptions(headers,this._withCredentials,this._abortController)).then(response=>{const responseOrigin=getResponseOrigin(response.url);if(responseOrigin!==stream._responseOrigin)throw new Error(`Expected range response-origin "${responseOrigin}" to match "${stream._responseOrigin}".`);if(!validateResponseStatus(response.status))throw createResponseError(response.status,url);this._readCapability.resolve(),this._reader=response.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value,done}=await this._reader.read();return done?{value,done}:(this._loaded+=value.byteLength,this.onProgress?.({loaded:this._loaded}),{value:getArrayBuffer(value),done:!1})}cancel(reason){this._reader?.cancel(reason),this._abortController.abort()}}const OK_RESPONSE=200,PARTIAL_CONTENT_RESPONSE=206;function network_getArrayBuffer(xhr){const data=xhr.response;return typeof data!="string"?data:stringToBytes(data).buffer}class NetworkManager{_responseOrigin=null;constructor({url,httpHeaders,withCredentials}){this.url=url,this.isHttp=/^https?:/i.test(url),this.headers=createHeaders(this.isHttp,httpHeaders),this.withCredentials=withCredentials||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}request(args){const xhr=new XMLHttpRequest,xhrId=this.currXhrId++,pendingRequest=this.pendingRequests[xhrId]={xhr};xhr.open("GET",this.url),xhr.withCredentials=this.withCredentials;for(const[key,val]of this.headers)xhr.setRequestHeader(key,val);return this.isHttp&&"begin"in args&&"end"in args?(xhr.setRequestHeader("Range",`bytes=${args.begin}-${args.end-1}`),pendingRequest.expectedStatus=PARTIAL_CONTENT_RESPONSE):pendingRequest.expectedStatus=OK_RESPONSE,xhr.responseType="arraybuffer",assert(args.onError,"Expected `onError` callback to be provided."),xhr.onerror=()=>{args.onError(xhr.status)},xhr.onreadystatechange=this.onStateChange.bind(this,xhrId),xhr.onprogress=this.onProgress.bind(this,xhrId),pendingRequest.onHeadersReceived=args.onHeadersReceived,pendingRequest.onDone=args.onDone,pendingRequest.onError=args.onError,pendingRequest.onProgress=args.onProgress,xhr.send(null),xhrId}onProgress(xhrId,evt){const pendingRequest=this.pendingRequests[xhrId];pendingRequest&&pendingRequest.onProgress?.(evt)}onStateChange(xhrId,evt){const pendingRequest=this.pendingRequests[xhrId];if(!pendingRequest)return;const xhr=pendingRequest.xhr;if(xhr.readyState>=2&&pendingRequest.onHeadersReceived&&(pendingRequest.onHeadersReceived(),delete pendingRequest.onHeadersReceived),xhr.readyState!==4||!(xhrId in this.pendingRequests))return;if(delete this.pendingRequests[xhrId],xhr.status===0&&this.isHttp){pendingRequest.onError(xhr.status);return}const xhrStatus=xhr.status||OK_RESPONSE;if(!(xhrStatus===OK_RESPONSE&&pendingRequest.expectedStatus===PARTIAL_CONTENT_RESPONSE)&&xhrStatus!==pendingRequest.expectedStatus){pendingRequest.onError(xhr.status);return}const chunk=network_getArrayBuffer(xhr);if(xhrStatus===PARTIAL_CONTENT_RESPONSE){const rangeHeader=xhr.getResponseHeader("Content-Range"),matches=/bytes (\d+)-(\d+)\/(\d+)/.exec(rangeHeader);matches?pendingRequest.onDone({begin:parseInt(matches[1],10),chunk}):(warn('Missing or invalid "Content-Range" header.'),pendingRequest.onError(0))}else chunk?pendingRequest.onDone({begin:0,chunk}):pendingRequest.onError(xhr.status)}getRequestXhr(xhrId){return this.pendingRequests[xhrId].xhr}isPendingRequest(xhrId){return xhrId in this.pendingRequests}abortRequest(xhrId){const xhr=this.pendingRequests[xhrId].xhr;delete this.pendingRequests[xhrId],xhr.abort()}}class PDFNetworkStream{constructor(source){this._source=source,this._manager=new NetworkManager(source),this._rangeChunkSize=source.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(reader){const i=this._rangeRequestReaders.indexOf(reader);i>=0&&this._rangeRequestReaders.splice(i,1)}getFullReader(){return assert(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new PDFNetworkStreamFullRequestReader(this._manager,this._source),this._fullRequestReader}getRangeReader(begin,end){const reader=new PDFNetworkStreamRangeRequestReader(this._manager,begin,end);return reader.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(reader),reader}cancelAllRequests(reason){this._fullRequestReader?.cancel(reason);for(const reader of this._rangeRequestReaders.slice(0))reader.cancel(reason)}}class PDFNetworkStreamFullRequestReader{constructor(manager,source){this._manager=manager,this._url=source.url,this._fullRequestId=manager.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._headersCapability=Promise.withResolvers(),this._disableRange=source.disableRange||!1,this._contentLength=source.length,this._rangeChunkSize=source.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){const fullRequestXhrId=this._fullRequestId,fullRequestXhr=this._manager.getRequestXhr(fullRequestXhrId);this._manager._responseOrigin=getResponseOrigin(fullRequestXhr.responseURL);const rawResponseHeaders=fullRequestXhr.getAllResponseHeaders(),responseHeaders=new Headers(rawResponseHeaders?rawResponseHeaders.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(x=>{const[key,...val]=x.split(": ");return[key,val.join(": ")]}):[]),{allowRangeRequests,suggestedLength}=validateRangeRequestCapabilities({responseHeaders,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});allowRangeRequests&&(this._isRangeSupported=!0),this._contentLength=suggestedLength||this._contentLength,this._filename=extractFilenameFromHeader(responseHeaders),this._isRangeSupported&&this._manager.abortRequest(fullRequestXhrId),this._headersCapability.resolve()}_onDone(data){if(data&&(this._requests.length>0?this._requests.shift().resolve({value:data.chunk,done:!1}):this._cachedChunks.push(data.chunk)),this._done=!0,!(this._cachedChunks.length>0)){for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0}}_onError(status){this._storedError=createResponseError(status,this._url),this._headersCapability.reject(this._storedError);for(const requestCapability of this._requests)requestCapability.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(evt){this.onProgress?.({loaded:evt.loaded,total:evt.lengthComputable?evt.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const requestCapability=Promise.withResolvers();return this._requests.push(requestCapability),requestCapability.promise}cancel(reason){this._done=!0,this._headersCapability.reject(reason);for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}}class PDFNetworkStreamRangeRequestReader{constructor(manager,begin,end){this._manager=manager,this._url=manager.url,this._requestId=manager.request({begin,end,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_onHeadersReceived(){const responseOrigin=getResponseOrigin(this._manager.getRequestXhr(this._requestId)?.responseURL);responseOrigin!==this._manager._responseOrigin&&(this._storedError=new Error(`Expected range response-origin "${responseOrigin}" to match "${this._manager._responseOrigin}".`),this._onError(0))}_close(){this.onClosed?.(this)}_onDone(data){const chunk=data.chunk;this._requests.length>0?this._requests.shift().resolve({value:chunk,done:!1}):this._queuedChunk=chunk,this._done=!0;for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(status){this._storedError??=createResponseError(status,this._url);for(const requestCapability of this._requests)requestCapability.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(evt){this.isStreamingSupported||this.onProgress?.({loaded:evt.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){const chunk=this._queuedChunk;return this._queuedChunk=null,{value:chunk,done:!1}}if(this._done)return{value:void 0,done:!0};const requestCapability=Promise.withResolvers();return this._requests.push(requestCapability),requestCapability.promise}cancel(reason){this._done=!0;for(const requestCapability of this._requests)requestCapability.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}}const urlRegex=/^[a-z][a-z0-9\-+.]+:/i;function parseUrlOrPath(sourceUrl){if(urlRegex.test(sourceUrl))return new URL(sourceUrl);const url=process.getBuiltinModule("url");return new URL(url.pathToFileURL(sourceUrl))}class PDFNodeStream{constructor(source){this.source=source,this.url=parseUrlOrPath(source.url),assert(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs."),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return assert(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=new PDFNodeStreamFsFullReader(this),this._fullRequestReader}getRangeReader(start,end){if(end<=this._progressiveDataLength)return null;const rangeReader=new PDFNodeStreamFsRangeReader(this,start,end);return this._rangeRequestReaders.push(rangeReader),rangeReader}cancelAllRequests(reason){this._fullRequestReader?.cancel(reason);for(const reader of this._rangeRequestReaders.slice(0))reader.cancel(reason)}}class PDFNodeStreamFsFullReader{constructor(stream){this._url=stream.url,this._done=!1,this._storedError=null,this.onProgress=null;const source=stream.source;this._contentLength=source.length,this._loaded=0,this._filename=null,this._disableRange=source.disableRange||!1,this._rangeChunkSize=source.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!source.disableStream,this._isRangeSupported=!source.disableRange,this._readableStream=null,this._readCapability=Promise.withResolvers(),this._headersCapability=Promise.withResolvers();const fs=process.getBuiltinModule("fs");fs.promises.lstat(this._url).then(stat=>{this._contentLength=stat.size,this._setReadableStream(fs.createReadStream(this._url)),this._headersCapability.resolve()},error=>{error.code==="ENOENT"&&(error=createResponseError(0,this._url.href)),this._storedError=error,this._headersCapability.reject(error)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const chunk=this._readableStream.read();return chunk===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=chunk.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:new Uint8Array(chunk).buffer,done:!1})}cancel(reason){if(!this._readableStream){this._error(reason);return}this._readableStream.destroy(reason)}_error(reason){this._storedError=reason,this._readCapability.resolve()}_setReadableStream(readableStream){this._readableStream=readableStream,readableStream.on("readable",()=>{this._readCapability.resolve()}),readableStream.on("end",()=>{readableStream.destroy(),this._done=!0,this._readCapability.resolve()}),readableStream.on("error",reason=>{this._error(reason)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new AbortException("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class PDFNodeStreamFsRangeReader{constructor(stream,start,end){this._url=stream.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=Promise.withResolvers();const source=stream.source;this._isStreamingSupported=!source.disableStream;const fs=process.getBuiltinModule("fs");this._setReadableStream(fs.createReadStream(this._url,{start,end:end-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const chunk=this._readableStream.read();return chunk===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=chunk.length,this.onProgress?.({loaded:this._loaded}),{value:new Uint8Array(chunk).buffer,done:!1})}cancel(reason){if(!this._readableStream){this._error(reason);return}this._readableStream.destroy(reason)}_error(reason){this._storedError=reason,this._readCapability.resolve()}_setReadableStream(readableStream){this._readableStream=readableStream,readableStream.on("readable",()=>{this._readCapability.resolve()}),readableStream.on("end",()=>{readableStream.destroy(),this._done=!0,this._readCapability.resolve()}),readableStream.on("error",reason=>{this._error(reason)}),this._storedError&&this._readableStream.destroy(this._storedError)}}const INITIAL_DATA=Symbol("INITIAL_DATA");class PDFObjects{#objs=Object.create(null);#ensureObj(objId){return this.#objs[objId]||={...Promise.withResolvers(),data:INITIAL_DATA}}get(objId,callback=null){if(callback){const obj2=this.#ensureObj(objId);return obj2.promise.then(()=>callback(obj2.data)),null}const obj=this.#objs[objId];if(!obj||obj.data===INITIAL_DATA)throw new Error(`Requesting object that isn't resolved yet ${objId}.`);return obj.data}has(objId){const obj=this.#objs[objId];return!!obj&&obj.data!==INITIAL_DATA}delete(objId){const obj=this.#objs[objId];return!obj||obj.data===INITIAL_DATA?!1:(delete this.#objs[objId],!0)}resolve(objId,data=null){const obj=this.#ensureObj(objId);obj.data=data,obj.resolve()}clear(){for(const objId in this.#objs){const{data}=this.#objs[objId];data?.bitmap?.close()}this.#objs=Object.create(null)}*[Symbol.iterator](){for(const objId in this.#objs){const{data}=this.#objs[objId];data!==INITIAL_DATA&&(yield[objId,data])}}}const MAX_TEXT_DIVS_TO_RENDER=1e5,DEFAULT_FONT_SIZE=30;class TextLayer{#capability=Promise.withResolvers();#container=null;#disableProcessItems=!1;#fontInspectorEnabled=!!globalThis.FontInspector?.enabled;#lang=null;#layoutTextParams=null;#pageHeight=0;#pageWidth=0;#reader=null;#rootContainer=null;#rotation=0;#scale=0;#styleCache=Object.create(null);#textContentItemsStr=[];#textContentSource=null;#textDivs=[];#textDivProperties=new WeakMap;#transform=null;static#ascentCache=new Map;static#canvasContexts=new Map;static#canvasCtxFonts=new WeakMap;static#minFontSize=null;static#pendingTextLayers=new Set;constructor({textContentSource,container,viewport}){if(textContentSource instanceof ReadableStream)this.#textContentSource=textContentSource;else if(typeof textContentSource=="object")this.#textContentSource=new ReadableStream({start(controller){controller.enqueue(textContentSource),controller.close()}});else throw new Error('No "textContentSource" parameter specified.');this.#container=this.#rootContainer=container,this.#scale=viewport.scale*OutputScale.pixelRatio,this.#rotation=viewport.rotation,this.#layoutTextParams={div:null,properties:null,ctx:null};const{pageWidth,pageHeight,pageX,pageY}=viewport.rawDims;this.#transform=[1,0,0,-1,-pageX,pageY+pageHeight],this.#pageWidth=pageWidth,this.#pageHeight=pageHeight,TextLayer.#ensureMinFontSizeComputed(),setLayerDimensions(container,viewport),this.#capability.promise.finally(()=>{TextLayer.#pendingTextLayers.delete(this),this.#layoutTextParams=null,this.#styleCache=null}).catch(()=>{})}static get fontFamilyMap(){const{isWindows,isFirefox}=util_FeatureTest.platform;return shadow(this,"fontFamilyMap",new Map([["sans-serif",`${isWindows&&isFirefox?"Calibri, ":""}sans-serif`],["monospace",`${isWindows&&isFirefox?"Lucida Console, ":""}monospace`]]))}render(){const pump=()=>{this.#reader.read().then(({value,done})=>{if(done){this.#capability.resolve();return}this.#lang??=value.lang,Object.assign(this.#styleCache,value.styles),this.#processItems(value.items),pump()},this.#capability.reject)};return this.#reader=this.#textContentSource.getReader(),TextLayer.#pendingTextLayers.add(this),pump(),this.#capability.promise}update({viewport,onBefore=null}){const scale=viewport.scale*OutputScale.pixelRatio,rotation=viewport.rotation;if(rotation!==this.#rotation&&(onBefore?.(),this.#rotation=rotation,setLayerDimensions(this.#rootContainer,{rotation})),scale!==this.#scale){onBefore?.(),this.#scale=scale;const params={div:null,properties:null,ctx:TextLayer.#getCtx(this.#lang)};for(const div of this.#textDivs)params.properties=this.#textDivProperties.get(div),params.div=div,this.#layout(params)}}cancel(){const abortEx=new AbortException("TextLayer task cancelled.");this.#reader?.cancel(abortEx).catch(()=>{}),this.#reader=null,this.#capability.reject(abortEx)}get textDivs(){return this.#textDivs}get textContentItemsStr(){return this.#textContentItemsStr}#processItems(items){if(this.#disableProcessItems)return;this.#layoutTextParams.ctx??=TextLayer.#getCtx(this.#lang);const textDivs=this.#textDivs,textContentItemsStr=this.#textContentItemsStr;for(const item of items){if(textDivs.length>MAX_TEXT_DIVS_TO_RENDER){warn("Ignoring additional textDivs for performance reasons."),this.#disableProcessItems=!0;return}if(item.str===void 0){if(item.type==="beginMarkedContentProps"||item.type==="beginMarkedContent"){const parent=this.#container;this.#container=document.createElement("span"),this.#container.classList.add("markedContent"),item.id!==null&&this.#container.setAttribute("id",`${item.id}`),parent.append(this.#container)}else item.type==="endMarkedContent"&&(this.#container=this.#container.parentNode);continue}textContentItemsStr.push(item.str),this.#appendText(item)}}#appendText(geom){const textDiv=document.createElement("span"),textDivProperties={angle:0,canvasWidth:0,hasText:geom.str!=="",hasEOL:geom.hasEOL,fontSize:0};this.#textDivs.push(textDiv);const tx=Util.transform(this.#transform,geom.transform);let angle=Math.atan2(tx[1],tx[0]);const style=this.#styleCache[geom.fontName];style.vertical&&(angle+=Math.PI/2);let fontFamily=this.#fontInspectorEnabled&&style.fontSubstitution||style.fontFamily;fontFamily=TextLayer.fontFamilyMap.get(fontFamily)||fontFamily;const fontHeight=Math.hypot(tx[2],tx[3]),fontAscent=fontHeight*TextLayer.#getAscent(fontFamily,style,this.#lang);let left,top;angle===0?(left=tx[4],top=tx[5]-fontAscent):(left=tx[4]+fontAscent*Math.sin(angle),top=tx[5]-fontAscent*Math.cos(angle));const scaleFactorStr="calc(var(--total-scale-factor) *",divStyle=textDiv.style;this.#container===this.#rootContainer?(divStyle.left=`${(100*left/this.#pageWidth).toFixed(2)}%`,divStyle.top=`${(100*top/this.#pageHeight).toFixed(2)}%`):(divStyle.left=`${scaleFactorStr}${left.toFixed(2)}px)`,divStyle.top=`${scaleFactorStr}${top.toFixed(2)}px)`),divStyle.fontSize=`${scaleFactorStr}${(TextLayer.#minFontSize*fontHeight).toFixed(2)}px)`,divStyle.fontFamily=fontFamily,textDivProperties.fontSize=fontHeight,textDiv.setAttribute("role","presentation"),textDiv.textContent=geom.str,textDiv.dir=geom.dir,this.#fontInspectorEnabled&&(textDiv.dataset.fontName=style.fontSubstitutionLoadedName||geom.fontName),angle!==0&&(textDivProperties.angle=angle*(180/Math.PI));let shouldScaleText=!1;if(geom.str.length>1)shouldScaleText=!0;else if(geom.str!==" "&&geom.transform[0]!==geom.transform[3]){const absScaleX=Math.abs(geom.transform[0]),absScaleY=Math.abs(geom.transform[3]);absScaleX!==absScaleY&&Math.max(absScaleX,absScaleY)/Math.min(absScaleX,absScaleY)>1.5&&(shouldScaleText=!0)}if(shouldScaleText&&(textDivProperties.canvasWidth=style.vertical?geom.height:geom.width),this.#textDivProperties.set(textDiv,textDivProperties),this.#layoutTextParams.div=textDiv,this.#layoutTextParams.properties=textDivProperties,this.#layout(this.#layoutTextParams),textDivProperties.hasText&&this.#container.append(textDiv),textDivProperties.hasEOL){const br=document.createElement("br");br.setAttribute("role","presentation"),this.#container.append(br)}}#layout(params){const{div,properties,ctx}=params,{style}=div;let transform="";if(TextLayer.#minFontSize>1&&(transform=`scale(${1/TextLayer.#minFontSize})`),properties.canvasWidth!==0&&properties.hasText){const{fontFamily}=style,{canvasWidth,fontSize}=properties;TextLayer.#ensureCtxFont(ctx,fontSize*this.#scale,fontFamily);const{width}=ctx.measureText(div.textContent);width>0&&(transform=`scaleX(${canvasWidth*this.#scale/width}) ${transform}`)}properties.angle!==0&&(transform=`rotate(${properties.angle}deg) ${transform}`),transform.length>0&&(style.transform=transform)}static cleanup(){if(!(this.#pendingTextLayers.size>0)){this.#ascentCache.clear();for(const{canvas}of this.#canvasContexts.values())canvas.remove();this.#canvasContexts.clear()}}static#getCtx(lang=null){let ctx=this.#canvasContexts.get(lang||="");if(!ctx){const canvas=document.createElement("canvas");canvas.className="hiddenCanvasElement",canvas.lang=lang,document.body.append(canvas),ctx=canvas.getContext("2d",{alpha:!1,willReadFrequently:!0}),this.#canvasContexts.set(lang,ctx),this.#canvasCtxFonts.set(ctx,{size:0,family:""})}return ctx}static#ensureCtxFont(ctx,size,family){const cached=this.#canvasCtxFonts.get(ctx);size===cached.size&&family===cached.family||(ctx.font=`${size}px ${family}`,cached.size=size,cached.family=family)}static#ensureMinFontSizeComputed(){if(this.#minFontSize!==null)return;const div=document.createElement("div");div.style.opacity=0,div.style.lineHeight=1,div.style.fontSize="1px",div.style.position="absolute",div.textContent="X",document.body.append(div),this.#minFontSize=div.getBoundingClientRect().height,div.remove()}static#getAscent(fontFamily,style,lang){const cachedAscent=this.#ascentCache.get(fontFamily);if(cachedAscent)return cachedAscent;const ctx=this.#getCtx(lang);ctx.canvas.width=ctx.canvas.height=DEFAULT_FONT_SIZE,this.#ensureCtxFont(ctx,DEFAULT_FONT_SIZE,fontFamily);const metrics=ctx.measureText(""),ascent=metrics.fontBoundingBoxAscent,descent=Math.abs(metrics.fontBoundingBoxDescent);ctx.canvas.width=ctx.canvas.height=0;let ratio=.8;return ascent?ratio=ascent/(ascent+descent):(util_FeatureTest.platform.isFirefox&&warn("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference in `about:config` to improve TextLayer rendering."),style.ascent?ratio=style.ascent:style.descent&&(ratio=1+style.descent)),this.#ascentCache.set(fontFamily,ratio),ratio}}class XfaText{static textContent(xfa){const items=[],output={items,styles:Object.create(null)};function walk(node){if(!node)return;let str=null;const name=node.name;if(name==="#text")str=node.value;else if(XfaText.shouldBuildText(name))node?.attributes?.textContent?str=node.attributes.textContent:node.value&&(str=node.value);else return;if(str!==null&&items.push({str}),!!node.children)for(const child of node.children)walk(child)}return walk(xfa),output}static shouldBuildText(name){return!(name==="textarea"||name==="input"||name==="option"||name==="select")}}const RENDERING_CANCELLED_TIMEOUT=100;function getDocument(src={}){typeof src=="string"||src instanceof URL?src={url:src}:(src instanceof ArrayBuffer||ArrayBuffer.isView(src))&&(src={data:src});const task=new PDFDocumentLoadingTask,{docId}=task,url=src.url?getUrlProp(src.url):null,data=src.data?getDataProp(src.data):null,httpHeaders=src.httpHeaders||null,withCredentials=src.withCredentials===!0,password=src.password??null,rangeTransport=src.range instanceof PDFDataRangeTransport?src.range:null,rangeChunkSize=Number.isInteger(src.rangeChunkSize)&&src.rangeChunkSize>0?src.rangeChunkSize:2**16;let worker=src.worker instanceof PDFWorker?src.worker:null;const verbosity2=src.verbosity,docBaseUrl=typeof src.docBaseUrl=="string"&&!isDataScheme(src.docBaseUrl)?src.docBaseUrl:null,cMapUrl=getFactoryUrlProp(src.cMapUrl),cMapPacked=src.cMapPacked!==!1,CMapReaderFactory=src.CMapReaderFactory||(isNodeJS?NodeCMapReaderFactory:DOMCMapReaderFactory),iccUrl=getFactoryUrlProp(src.iccUrl),standardFontDataUrl=getFactoryUrlProp(src.standardFontDataUrl),StandardFontDataFactory=src.StandardFontDataFactory||(isNodeJS?NodeStandardFontDataFactory:DOMStandardFontDataFactory),wasmUrl=getFactoryUrlProp(src.wasmUrl),WasmFactory=src.WasmFactory||(isNodeJS?NodeWasmFactory:DOMWasmFactory),ignoreErrors=src.stopAtErrors!==!0,maxImageSize=Number.isInteger(src.maxImageSize)&&src.maxImageSize>-1?src.maxImageSize:-1,isEvalSupported2=src.isEvalSupported!==!1,isOffscreenCanvasSupported=typeof src.isOffscreenCanvasSupported=="boolean"?src.isOffscreenCanvasSupported:!isNodeJS,isImageDecoderSupported=typeof src.isImageDecoderSupported=="boolean"?src.isImageDecoderSupported:!isNodeJS&&(util_FeatureTest.platform.isFirefox||!globalThis.chrome),canvasMaxAreaInBytes=Number.isInteger(src.canvasMaxAreaInBytes)?src.canvasMaxAreaInBytes:-1,disableFontFace=typeof src.disableFontFace=="boolean"?src.disableFontFace:isNodeJS,fontExtraProperties=src.fontExtraProperties===!0,enableXfa=src.enableXfa===!0,ownerDocument=src.ownerDocument||globalThis.document,disableRange=src.disableRange===!0,disableStream=src.disableStream===!0,disableAutoFetch=src.disableAutoFetch===!0,pdfBug=src.pdfBug===!0,CanvasFactory=src.CanvasFactory||(isNodeJS?NodeCanvasFactory:DOMCanvasFactory),FilterFactory=src.FilterFactory||(isNodeJS?NodeFilterFactory:DOMFilterFactory),enableHWA=src.enableHWA===!0,useWasm=src.useWasm!==!1,length=rangeTransport?rangeTransport.length:src.length??NaN,useSystemFonts=typeof src.useSystemFonts=="boolean"?src.useSystemFonts:!isNodeJS&&!disableFontFace,useWorkerFetch=typeof src.useWorkerFetch=="boolean"?src.useWorkerFetch:!!(CMapReaderFactory===DOMCMapReaderFactory&&StandardFontDataFactory===DOMStandardFontDataFactory&&WasmFactory===DOMWasmFactory&&cMapUrl&&standardFontDataUrl&&wasmUrl&&isValidFetchUrl(cMapUrl,document.baseURI)&&isValidFetchUrl(standardFontDataUrl,document.baseURI)&&isValidFetchUrl(wasmUrl,document.baseURI)),styleElement=null;setVerbosityLevel(verbosity2);const transportFactory={canvasFactory:new CanvasFactory({ownerDocument,enableHWA}),filterFactory:new FilterFactory({docId,ownerDocument}),cMapReaderFactory:useWorkerFetch?null:new CMapReaderFactory({baseUrl:cMapUrl,isCompressed:cMapPacked}),standardFontDataFactory:useWorkerFetch?null:new StandardFontDataFactory({baseUrl:standardFontDataUrl}),wasmFactory:useWorkerFetch?null:new WasmFactory({baseUrl:wasmUrl})};worker||(worker=PDFWorker.create({verbosity:verbosity2,port:GlobalWorkerOptions.workerPort}),task._worker=worker);const docParams={docId,apiVersion:"5.3.93",data,password,disableAutoFetch,rangeChunkSize,length,docBaseUrl,enableXfa,evaluatorOptions:{maxImageSize,disableFontFace,ignoreErrors,isEvalSupported:isEvalSupported2,isOffscreenCanvasSupported,isImageDecoderSupported,canvasMaxAreaInBytes,fontExtraProperties,useSystemFonts,useWasm,useWorkerFetch,cMapUrl,iccUrl,standardFontDataUrl,wasmUrl}},transportParams={ownerDocument,pdfBug,styleElement,loadingParams:{disableAutoFetch,enableXfa}};return worker.promise.then(function(){if(task.destroyed)throw new Error("Loading aborted");if(worker.destroyed)throw new Error("Worker was destroyed");const workerIdPromise=worker.messageHandler.sendWithPromise("GetDocRequest",docParams,data?[data.buffer]:null);let networkStream;if(rangeTransport)networkStream=new PDFDataTransportStream(rangeTransport,{disableRange,disableStream});else if(!data){if(!url)throw new Error("getDocument - no `url` parameter provided.");const NetworkStream=isValidFetchUrl(url)?PDFFetchStream:isNodeJS?PDFNodeStream:PDFNetworkStream;networkStream=new NetworkStream({url,length,httpHeaders,withCredentials,rangeChunkSize,disableRange,disableStream})}return workerIdPromise.then(workerId=>{if(task.destroyed)throw new Error("Loading aborted");if(worker.destroyed)throw new Error("Worker was destroyed");const messageHandler=new MessageHandler(docId,workerId,worker.port),transport=new WorkerTransport(messageHandler,task,networkStream,transportParams,transportFactory);task._transport=transport,messageHandler.send("Ready",null)})}).catch(task._capability.reject),task}class PDFDocumentLoadingTask{static#docId=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId=`d${PDFDocumentLoadingTask.#docId++}`;destroyed=!1;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(ex){throw this._worker?.port&&delete this._worker._pendingDestroy,ex}this._transport=null,this._worker?.destroy(),this._worker=null}async getData(){return this._transport.getData()}}class PDFDataRangeTransport{#capability=Promise.withResolvers();#progressiveDoneListeners=[];#progressiveReadListeners=[];#progressListeners=[];#rangeListeners=[];constructor(length,initialData,progressiveDone=!1,contentDispositionFilename=null){this.length=length,this.initialData=initialData,this.progressiveDone=progressiveDone,this.contentDispositionFilename=contentDispositionFilename}addRangeListener(listener){this.#rangeListeners.push(listener)}addProgressListener(listener){this.#progressListeners.push(listener)}addProgressiveReadListener(listener){this.#progressiveReadListeners.push(listener)}addProgressiveDoneListener(listener){this.#progressiveDoneListeners.push(listener)}onDataRange(begin,chunk){for(const listener of this.#rangeListeners)listener(begin,chunk)}onDataProgress(loaded,total){this.#capability.promise.then(()=>{for(const listener of this.#progressListeners)listener(loaded,total)})}onDataProgressiveRead(chunk){this.#capability.promise.then(()=>{for(const listener of this.#progressiveReadListeners)listener(chunk)})}onDataProgressiveDone(){this.#capability.promise.then(()=>{for(const listener of this.#progressiveDoneListeners)listener()})}transportReady(){this.#capability.resolve()}requestDataRange(begin,end){unreachable("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class PDFDocumentProxy{constructor(pdfInfo,transport){this._pdfInfo=pdfInfo,this._transport=transport}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(pageNumber){return this._transport.getPage(pageNumber)}getPageIndex(ref){return this._transport.getPageIndex(ref)}getDestinations(){return this._transport.getDestinations()}getDestination(id){return this._transport.getDestination(id)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent="display"}={}){const{renderingIntent}=this._transport.getRenderingIntent(intent);return this._transport.getOptionalContentConfig(renderingIntent)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(keepLoadedFonts=!1){return this._transport.startCleanup(keepLoadedFonts||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(ref){return this._transport.cachedPageNumber(ref)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class PDFPageProxy{#pendingCleanup=!1;constructor(pageIndex,pageInfo,transport,pdfBug=!1){this._pageIndex=pageIndex,this._pageInfo=pageInfo,this._transport=transport,this._stats=pdfBug?new StatTimer:null,this._pdfBug=pdfBug,this.commonObjs=transport.commonObjs,this.objs=new PDFObjects,this._intentStates=new Map,this.destroyed=!1}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale,rotation=this.rotate,offsetX=0,offsetY=0,dontFlip=!1}={}){return new PageViewport({viewBox:this.view,userUnit:this.userUnit,scale,rotation,offsetX,offsetY,dontFlip})}getAnnotations({intent="display"}={}){const{renderingIntent}=this._transport.getRenderingIntent(intent);return this._transport.getAnnotations(this._pageIndex,renderingIntent)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext,viewport,intent="display",annotationMode=AnnotationMode.ENABLE,transform=null,background=null,optionalContentConfigPromise=null,annotationCanvasMap=null,pageColors=null,printAnnotationStorage=null,isEditing=!1}){this._stats?.time("Overall");const intentArgs=this._transport.getRenderingIntent(intent,annotationMode,printAnnotationStorage,isEditing),{renderingIntent,cacheKey}=intentArgs;this.#pendingCleanup=!1,optionalContentConfigPromise||=this._transport.getOptionalContentConfig(renderingIntent);let intentState=this._intentStates.get(cacheKey);intentState||(intentState=Object.create(null),this._intentStates.set(cacheKey,intentState)),intentState.streamReaderCancelTimeout&&(clearTimeout(intentState.streamReaderCancelTimeout),intentState.streamReaderCancelTimeout=null);const intentPrint=!!(renderingIntent&RenderingIntentFlag.PRINT);intentState.displayReadyCapability||(intentState.displayReadyCapability=Promise.withResolvers(),intentState.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(intentArgs));const complete=error=>{intentState.renderTasks.delete(internalRenderTask),intentPrint&&(this.#pendingCleanup=!0),this.#tryCleanup(),error?(internalRenderTask.capability.reject(error),this._abortOperatorList({intentState,reason:error instanceof Error?error:new Error(error)})):internalRenderTask.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},internalRenderTask=new InternalRenderTask({callback:complete,params:{canvasContext,viewport,transform,background},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap,operatorList:intentState.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!intentPrint,pdfBug:this._pdfBug,pageColors});(intentState.renderTasks||=new Set).add(internalRenderTask);const renderTask=internalRenderTask.task;return Promise.all([intentState.displayReadyCapability.promise,optionalContentConfigPromise]).then(([transparency,optionalContentConfig])=>{if(this.destroyed){complete();return}if(this._stats?.time("Rendering"),!(optionalContentConfig.renderingIntent&renderingIntent))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");internalRenderTask.initializeGraphics({transparency,optionalContentConfig}),internalRenderTask.operatorListChanged()}).catch(complete),renderTask}getOperatorList({intent="display",annotationMode=AnnotationMode.ENABLE,printAnnotationStorage=null,isEditing=!1}={}){function operatorListChanged(){intentState.operatorList.lastChunk&&(intentState.opListReadCapability.resolve(intentState.operatorList),intentState.renderTasks.delete(opListTask))}const intentArgs=this._transport.getRenderingIntent(intent,annotationMode,printAnnotationStorage,isEditing,!0);let intentState=this._intentStates.get(intentArgs.cacheKey);intentState||(intentState=Object.create(null),this._intentStates.set(intentArgs.cacheKey,intentState));let opListTask;return intentState.opListReadCapability||(opListTask=Object.create(null),opListTask.operatorListChanged=operatorListChanged,intentState.opListReadCapability=Promise.withResolvers(),(intentState.renderTasks||=new Set).add(opListTask),intentState.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(intentArgs)),intentState.opListReadCapability.promise}streamTextContent({includeMarkedContent=!1,disableNormalization=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:includeMarkedContent===!0,disableNormalization:disableNormalization===!0},{highWaterMark:100,size(textContent){return textContent.items.length}})}getTextContent(params={}){if(this._transport._htmlForXfa)return this.getXfa().then(xfa=>XfaText.textContent(xfa));const readableStream=this.streamTextContent(params);return new Promise(function(resolve,reject){function pump(){reader.read().then(function({value,done}){if(done){resolve(textContent);return}textContent.lang??=value.lang,Object.assign(textContent.styles,value.styles),textContent.items.push(...value.items),pump()},reject)}const reader=readableStream.getReader(),textContent={items:[],styles:Object.create(null),lang:null};pump()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const waitOn=[];for(const intentState of this._intentStates.values())if(this._abortOperatorList({intentState,reason:new Error("Page was destroyed."),force:!0}),!intentState.opListReadCapability)for(const internalRenderTask of intentState.renderTasks)waitOn.push(internalRenderTask.completed),internalRenderTask.cancel();return this.objs.clear(),this.#pendingCleanup=!1,Promise.all(waitOn)}cleanup(resetStats=!1){this.#pendingCleanup=!0;const success=this.#tryCleanup();return resetStats&&success&&(this._stats&&=new StatTimer),success}#tryCleanup(){if(!this.#pendingCleanup||this.destroyed)return!1;for(const{renderTasks,operatorList}of this._intentStates.values())if(renderTasks.size>0||!operatorList.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#pendingCleanup=!1,!0}_startRenderPage(transparency,cacheKey){const intentState=this._intentStates.get(cacheKey);intentState&&(this._stats?.timeEnd("Page Request"),intentState.displayReadyCapability?.resolve(transparency))}_renderPageChunk(operatorListChunk,intentState){for(let i=0,ii=operatorListChunk.length;i<ii;i++)intentState.operatorList.fnArray.push(operatorListChunk.fnArray[i]),intentState.operatorList.argsArray.push(operatorListChunk.argsArray[i]);intentState.operatorList.lastChunk=operatorListChunk.lastChunk,intentState.operatorList.separateAnnots=operatorListChunk.separateAnnots;for(const internalRenderTask of intentState.renderTasks)internalRenderTask.operatorListChanged();operatorListChunk.lastChunk&&this.#tryCleanup()}_pumpOperatorList({renderingIntent,cacheKey,annotationStorageSerializable,modifiedIds}){const{map,transfer}=annotationStorageSerializable,reader=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:renderingIntent,cacheKey,annotationStorage:map,modifiedIds},transfer).getReader(),intentState=this._intentStates.get(cacheKey);intentState.streamReader=reader;const pump=()=>{reader.read().then(({value,done})=>{if(done){intentState.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(value,intentState),pump())},reason=>{if(intentState.streamReader=null,!this._transport.destroyed){if(intentState.operatorList){intentState.operatorList.lastChunk=!0;for(const internalRenderTask of intentState.renderTasks)internalRenderTask.operatorListChanged();this.#tryCleanup()}if(intentState.displayReadyCapability)intentState.displayReadyCapability.reject(reason);else if(intentState.opListReadCapability)intentState.opListReadCapability.reject(reason);else throw reason}})};pump()}_abortOperatorList({intentState,reason,force=!1}){if(intentState.streamReader){if(intentState.streamReaderCancelTimeout&&(clearTimeout(intentState.streamReaderCancelTimeout),intentState.streamReaderCancelTimeout=null),!force){if(intentState.renderTasks.size>0)return;if(reason instanceof RenderingCancelledException){let delay=RENDERING_CANCELLED_TIMEOUT;reason.extraDelay>0&&reason.extraDelay<1e3&&(delay+=reason.extraDelay),intentState.streamReaderCancelTimeout=setTimeout(()=>{intentState.streamReaderCancelTimeout=null,this._abortOperatorList({intentState,reason,force:!0})},delay);return}}if(intentState.streamReader.cancel(new AbortException(reason.message)).catch(()=>{}),intentState.streamReader=null,!this._transport.destroyed){for(const[curCacheKey,curIntentState]of this._intentStates)if(curIntentState===intentState){this._intentStates.delete(curCacheKey);break}this.cleanup()}}}get stats(){return this._stats}}class PDFWorker{#capability=Promise.withResolvers();#messageHandler=null;#port=null;#webWorker=null;static#fakeWorkerId=0;static#isWorkerDisabled=!1;static#workerPorts=new WeakMap;static{isNodeJS&&(this.#isWorkerDisabled=!0,GlobalWorkerOptions.workerSrc||="./pdf.worker.mjs"),this._isSameOrigin=(baseUrl,otherUrl)=>{const base=URL.parse(baseUrl);if(!base?.origin||base.origin==="null")return!1;const other=new URL(otherUrl,base);return base.origin===other.origin},this._createCDNWrapper=url=>{const wrapper=`await import("${url}");`;return URL.createObjectURL(new Blob([wrapper],{type:"text/javascript"}))},this.fromPort=params=>{if(deprecated("`PDFWorker.fromPort` - please use `PDFWorker.create` instead."),!params?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");return this.create(params)}}constructor({name=null,port=null,verbosity:verbosity2=getVerbosityLevel()}={}){if(this.name=name,this.destroyed=!1,this.verbosity=verbosity2,port){if(PDFWorker.#workerPorts.has(port))throw new Error("Cannot use more than one PDFWorker per port.");PDFWorker.#workerPorts.set(port,this),this.#initializeFromPort(port)}else this.#initialize()}get promise(){return this.#capability.promise}#resolve(){this.#capability.resolve(),this.#messageHandler.send("configure",{verbosity:this.verbosity})}get port(){return this.#port}get messageHandler(){return this.#messageHandler}#initializeFromPort(port){this.#port=port,this.#messageHandler=new MessageHandler("main","worker",port),this.#messageHandler.on("ready",()=>{}),this.#resolve()}#initialize(){if(PDFWorker.#isWorkerDisabled||PDFWorker.#mainThreadWorkerMessageHandler){this.#setupFakeWorker();return}let{workerSrc}=PDFWorker;try{PDFWorker._isSameOrigin(window.location,workerSrc)||(workerSrc=PDFWorker._createCDNWrapper(new URL(workerSrc,window.location).href));const worker=new Worker(workerSrc,{type:"module"}),messageHandler=new MessageHandler("main","worker",worker),terminateEarly=()=>{ac.abort(),messageHandler.destroy(),worker.terminate(),this.destroyed?this.#capability.reject(new Error("Worker was destroyed")):this.#setupFakeWorker()},ac=new AbortController;worker.addEventListener("error",()=>{this.#webWorker||terminateEarly()},{signal:ac.signal}),messageHandler.on("test",data=>{if(ac.abort(),this.destroyed||!data){terminateEarly();return}this.#messageHandler=messageHandler,this.#port=worker,this.#webWorker=worker,this.#resolve()}),messageHandler.on("ready",data=>{if(ac.abort(),this.destroyed){terminateEarly();return}try{sendTest()}catch{this.#setupFakeWorker()}});const sendTest=()=>{const testObj=new Uint8Array;messageHandler.send("test",testObj,[testObj.buffer])};sendTest();return}catch{info("The worker has been disabled.")}this.#setupFakeWorker()}#setupFakeWorker(){PDFWorker.#isWorkerDisabled||(warn("Setting up fake worker."),PDFWorker.#isWorkerDisabled=!0),PDFWorker._setupFakeWorkerGlobal.then(WorkerMessageHandler=>{if(this.destroyed){this.#capability.reject(new Error("Worker was destroyed"));return}const port=new LoopbackPort;this.#port=port;const id=`fake${PDFWorker.#fakeWorkerId++}`,workerHandler=new MessageHandler(id+"_worker",id,port);WorkerMessageHandler.setup(workerHandler,port),this.#messageHandler=new MessageHandler(id,id+"_worker",port),this.#resolve()}).catch(reason=>{this.#capability.reject(new Error(`Setting up fake worker failed: "${reason.message}".`))})}destroy(){this.destroyed=!0,this.#webWorker?.terminate(),this.#webWorker=null,PDFWorker.#workerPorts.delete(this.#port),this.#port=null,this.#messageHandler?.destroy(),this.#messageHandler=null}static create(params){const cachedPort=this.#workerPorts.get(params?.port);if(cachedPort){if(cachedPort._pendingDestroy)throw new Error("PDFWorker.create - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return cachedPort}return new PDFWorker(params)}static get workerSrc(){if(GlobalWorkerOptions.workerSrc)return GlobalWorkerOptions.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get#mainThreadWorkerMessageHandler(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){return shadow(this,"_setupFakeWorkerGlobal",(async()=>this.#mainThreadWorkerMessageHandler?this.#mainThreadWorkerMessageHandler:(await import(this.workerSrc)).WorkerMessageHandler)())}}class WorkerTransport{#methodPromises=new Map;#pageCache=new Map;#pagePromises=new Map;#pageRefCache=new Map;#passwordCapability=null;constructor(messageHandler,loadingTask,networkStream,params,factory){this.messageHandler=messageHandler,this.loadingTask=loadingTask,this.commonObjs=new PDFObjects,this.fontLoader=new FontLoader({ownerDocument:params.ownerDocument,styleElement:params.styleElement}),this.loadingParams=params.loadingParams,this._params=params,this.canvasFactory=factory.canvasFactory,this.filterFactory=factory.filterFactory,this.cMapReaderFactory=factory.cMapReaderFactory,this.standardFontDataFactory=factory.standardFontDataFactory,this.wasmFactory=factory.wasmFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=networkStream,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=Promise.withResolvers(),this.setupMessageHandler()}#cacheSimpleMethod(name,data=null){const cachedPromise=this.#methodPromises.get(name);if(cachedPromise)return cachedPromise;const promise=this.messageHandler.sendWithPromise(name,data);return this.#methodPromises.set(name,promise),promise}get annotationStorage(){return shadow(this,"annotationStorage",new AnnotationStorage)}getRenderingIntent(intent,annotationMode=AnnotationMode.ENABLE,printAnnotationStorage=null,isEditing=!1,isOpList=!1){let renderingIntent=RenderingIntentFlag.DISPLAY,annotationStorageSerializable=SerializableEmpty;switch(intent){case"any":renderingIntent=RenderingIntentFlag.ANY;break;case"display":break;case"print":renderingIntent=RenderingIntentFlag.PRINT;break;default:warn(`getRenderingIntent - invalid intent: ${intent}`)}const annotationStorage=renderingIntent&RenderingIntentFlag.PRINT&&printAnnotationStorage instanceof PrintAnnotationStorage?printAnnotationStorage:this.annotationStorage;switch(annotationMode){case AnnotationMode.DISABLE:renderingIntent+=RenderingIntentFlag.ANNOTATIONS_DISABLE;break;case AnnotationMode.ENABLE:break;case AnnotationMode.ENABLE_FORMS:renderingIntent+=RenderingIntentFlag.ANNOTATIONS_FORMS;break;case AnnotationMode.ENABLE_STORAGE:renderingIntent+=RenderingIntentFlag.ANNOTATIONS_STORAGE,annotationStorageSerializable=annotationStorage.serializable;break;default:warn(`getRenderingIntent - invalid annotationMode: ${annotationMode}`)}isEditing&&(renderingIntent+=RenderingIntentFlag.IS_EDITING),isOpList&&(renderingIntent+=RenderingIntentFlag.OPLIST);const{ids:modifiedIds,hash:modifiedIdsHash}=annotationStorage.modifiedIds,cacheKeyBuf=[renderingIntent,annotationStorageSerializable.hash,modifiedIdsHash];return{renderingIntent,cacheKey:cacheKeyBuf.join("_"),annotationStorageSerializable,modifiedIds}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),this.#passwordCapability?.reject(new Error("Worker was destroyed during onPassword callback"));const waitOn=[];for(const page of this.#pageCache.values())waitOn.push(page._destroy());this.#pageCache.clear(),this.#pagePromises.clear(),this.#pageRefCache.clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const terminated=this.messageHandler.sendWithPromise("Terminate",null);return waitOn.push(terminated),Promise.all(waitOn).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(),TextLayer.cleanup(),this._networkStream?.cancelAllRequests(new AbortException("Worker was terminated.")),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler,loadingTask}=this;messageHandler.on("GetReader",(data,sink)=>{assert(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=evt=>{this._lastProgress={loaded:evt.loaded,total:evt.total}},sink.onPull=()=>{this._fullReader.read().then(function({value,done}){if(done){sink.close();return}assert(value instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),sink.enqueue(new Uint8Array(value),1,[value])}).catch(reason=>{sink.error(reason)})},sink.onCancel=reason=>{this._fullReader.cancel(reason),sink.ready.catch(readyReason=>{if(!this.destroyed)throw readyReason})}}),messageHandler.on("ReaderHeadersReady",async data=>{await this._fullReader.headersReady;const{isStreamingSupported,isRangeSupported,contentLength}=this._fullReader;return(!isStreamingSupported||!isRangeSupported)&&(this._lastProgress&&loadingTask.onProgress?.(this._lastProgress),this._fullReader.onProgress=evt=>{loadingTask.onProgress?.({loaded:evt.loaded,total:evt.total})}),{isStreamingSupported,isRangeSupported,contentLength}}),messageHandler.on("GetRangeReader",(data,sink)=>{assert(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const rangeReader=this._networkStream.getRangeReader(data.begin,data.end);if(!rangeReader){sink.close();return}sink.onPull=()=>{rangeReader.read().then(function({value,done}){if(done){sink.close();return}assert(value instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),sink.enqueue(new Uint8Array(value),1,[value])}).catch(reason=>{sink.error(reason)})},sink.onCancel=reason=>{rangeReader.cancel(reason),sink.ready.catch(readyReason=>{if(!this.destroyed)throw readyReason})}}),messageHandler.on("GetDoc",({pdfInfo})=>{this._numPages=pdfInfo.numPages,this._htmlForXfa=pdfInfo.htmlForXfa,delete pdfInfo.htmlForXfa,loadingTask._capability.resolve(new PDFDocumentProxy(pdfInfo,this))}),messageHandler.on("DocException",ex=>{loadingTask._capability.reject(wrapReason(ex))}),messageHandler.on("PasswordRequest",ex=>{this.#passwordCapability=Promise.withResolvers();try{if(!loadingTask.onPassword)throw wrapReason(ex);const updatePassword=password=>{password instanceof Error?this.#passwordCapability.reject(password):this.#passwordCapability.resolve({password})};loadingTask.onPassword(updatePassword,ex.code)}catch(err){this.#passwordCapability.reject(err)}return this.#passwordCapability.promise}),messageHandler.on("DataLoaded",data=>{loadingTask.onProgress?.({loaded:data.length,total:data.length}),this.downloadInfoCapability.resolve(data)}),messageHandler.on("StartRenderPage",data=>{if(this.destroyed)return;this.#pageCache.get(data.pageIndex)._startRenderPage(data.transparency,data.cacheKey)}),messageHandler.on("commonobj",([id,type,exportedData])=>{if(this.destroyed||this.commonObjs.has(id))return null;switch(type){case"Font":if("error"in exportedData){const exportedError=exportedData.error;warn(`Error during font loading: ${exportedError}`),this.commonObjs.resolve(id,exportedError);break}const inspectFont=this._params.pdfBug&&globalThis.FontInspector?.enabled?(font2,url)=>globalThis.FontInspector.fontAdded(font2,url):null,font=new FontFaceObject(exportedData,inspectFont);this.fontLoader.bind(font).catch(()=>messageHandler.sendWithPromise("FontFallback",{id})).finally(()=>{!font.fontExtraProperties&&font.data&&(font.data=null),this.commonObjs.resolve(id,font)});break;case"CopyLocalImage":const{imageRef}=exportedData;assert(imageRef,"The imageRef must be defined.");for(const pageProxy of this.#pageCache.values())for(const[,data]of pageProxy.objs)if(data?.ref===imageRef)return data.dataLen?(this.commonObjs.resolve(id,structuredClone(data)),data.dataLen):null;break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(id,exportedData);break;default:throw new Error(`Got unknown common object type ${type}`)}return null}),messageHandler.on("obj",([id,pageIndex,type,imageData])=>{if(this.destroyed)return;const pageProxy=this.#pageCache.get(pageIndex);if(!pageProxy.objs.has(id)){if(pageProxy._intentStates.size===0){imageData?.bitmap?.close();return}switch(type){case"Image":case"Pattern":pageProxy.objs.resolve(id,imageData);break;default:throw new Error(`Got unknown object type ${type}`)}}}),messageHandler.on("DocProgress",data=>{this.destroyed||loadingTask.onProgress?.({loaded:data.loaded,total:data.total})}),messageHandler.on("FetchBinaryData",async data=>{if(this.destroyed)throw new Error("Worker was destroyed.");const factory=this[data.type];if(!factory)throw new Error(`${data.type} not initialized, see the \`useWorkerFetch\` parameter.`);return factory.fetch(data)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&warn("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map,transfer}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:map,filename:this._fullReader?.filename??null},transfer).finally(()=>{this.annotationStorage.resetModified()})}getPage(pageNumber){if(!Number.isInteger(pageNumber)||pageNumber<=0||pageNumber>this._numPages)return Promise.reject(new Error("Invalid page request."));const pageIndex=pageNumber-1,cachedPromise=this.#pagePromises.get(pageIndex);if(cachedPromise)return cachedPromise;const promise=this.messageHandler.sendWithPromise("GetPage",{pageIndex}).then(pageInfo=>{if(this.destroyed)throw new Error("Transport destroyed");pageInfo.refStr&&this.#pageRefCache.set(pageInfo.refStr,pageNumber);const page=new PDFPageProxy(pageIndex,pageInfo,this,this._params.pdfBug);return this.#pageCache.set(pageIndex,page),page});return this.#pagePromises.set(pageIndex,promise),promise}getPageIndex(ref){return isRefProxy(ref)?this.messageHandler.sendWithPromise("GetPageIndex",{num:ref.num,gen:ref.gen}):Promise.reject(new Error("Invalid pageIndex request."))}getAnnotations(pageIndex,intent){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex,intent})}getFieldObjects(){return this.#cacheSimpleMethod("GetFieldObjects")}hasJSActions(){return this.#cacheSimpleMethod("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(id){return typeof id!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return this.#cacheSimpleMethod("GetDocJSActions")}getPageJSActions(pageIndex){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex})}getStructTree(pageIndex){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(renderingIntent){return this.#cacheSimpleMethod("GetOptionalContentConfig").then(data=>new OptionalContentConfig(data,renderingIntent))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const name="GetMetadata",cachedPromise=this.#methodPromises.get(name);if(cachedPromise)return cachedPromise;const promise=this.messageHandler.sendWithPromise(name,null).then(results=>({info:results[0],metadata:results[1]?new Metadata(results[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));return this.#methodPromises.set(name,promise),promise}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(keepLoadedFonts=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(const page of this.#pageCache.values())if(!page.cleanup())throw new Error(`startCleanup: Page ${page.pageNumber} is currently rendering.`);this.commonObjs.clear(),keepLoadedFonts||this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(!0),TextLayer.cleanup()}}cachedPageNumber(ref){if(!isRefProxy(ref))return null;const refStr=ref.gen===0?`${ref.num}R`:`${ref.num}R${ref.gen}`;return this.#pageRefCache.get(refStr)??null}}class RenderTask{#internalRenderTask=null;onContinue=null;onError=null;constructor(internalRenderTask){this.#internalRenderTask=internalRenderTask}get promise(){return this.#internalRenderTask.capability.promise}cancel(extraDelay=0){this.#internalRenderTask.cancel(null,extraDelay)}get separateAnnots(){const{separateAnnots}=this.#internalRenderTask.operatorList;if(!separateAnnots)return!1;const{annotationCanvasMap}=this.#internalRenderTask;return separateAnnots.form||separateAnnots.canvas&&annotationCanvasMap?.size>0}}class InternalRenderTask{#rAF=null;static#canvasInUse=new WeakSet;constructor({callback,params,objs,commonObjs,annotationCanvasMap,operatorList,pageIndex,canvasFactory,filterFactory,useRequestAnimationFrame=!1,pdfBug=!1,pageColors=null}){this.callback=callback,this.params=params,this.objs=objs,this.commonObjs=commonObjs,this.annotationCanvasMap=annotationCanvasMap,this.operatorListIdx=null,this.operatorList=operatorList,this._pageIndex=pageIndex,this.canvasFactory=canvasFactory,this.filterFactory=filterFactory,this._pdfBug=pdfBug,this.pageColors=pageColors,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=useRequestAnimationFrame===!0&&typeof window<"u",this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new RenderTask(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=params.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency=!1,optionalContentConfig}){if(this.cancelled)return;if(this._canvas){if(InternalRenderTask.#canvasInUse.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");InternalRenderTask.#canvasInUse.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{canvasContext,viewport,transform,background}=this.params;this.gfx=new CanvasGraphics(canvasContext,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig},this.annotationCanvasMap,this.pageColors),this.gfx.beginDrawing({transform,viewport,transparency,background}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(error=null,extraDelay=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),this.#rAF&&(window.cancelAnimationFrame(this.#rAF),this.#rAF=null),InternalRenderTask.#canvasInUse.delete(this._canvas),error||=new RenderingCancelledException(`Rendering cancelled, page ${this._pageIndex+1}`,extraDelay),this.callback(error),this.task.onError?.(error)}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.stepper?.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?this.#rAF=window.requestAnimationFrame(()=>{this.#rAF=null,this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),InternalRenderTask.#canvasInUse.delete(this._canvas),this.callback())))}}const version="5.3.93",build="cbeef3233";function makeColorComp(n){return Math.floor(Math.max(0,Math.min(1,n))*255).toString(16).padStart(2,"0")}function scaleAndClamp(x){return Math.max(0,Math.min(255,255*x))}class ColorConverters{static CMYK_G([c,y,m,k]){return["G",1-Math.min(1,.3*c+.59*m+.11*y+k)]}static G_CMYK([g]){return["CMYK",0,0,0,1-g]}static G_RGB([g]){return["RGB",g,g,g]}static G_rgb([g]){return g=scaleAndClamp(g),[g,g,g]}static G_HTML([g]){const G=makeColorComp(g);return`#${G}${G}${G}`}static RGB_G([r,g,b]){return["G",.3*r+.59*g+.11*b]}static RGB_rgb(color){return color.map(scaleAndClamp)}static RGB_HTML(color){return`#${color.map(makeColorComp).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([c,y,m,k]){return["RGB",1-Math.min(1,c+k),1-Math.min(1,m+k),1-Math.min(1,y+k)]}static CMYK_rgb([c,y,m,k]){return[scaleAndClamp(1-Math.min(1,c+k)),scaleAndClamp(1-Math.min(1,m+k)),scaleAndClamp(1-Math.min(1,y+k))]}static CMYK_HTML(components){const rgb=this.CMYK_RGB(components).slice(1);return this.RGB_HTML(rgb)}static RGB_CMYK([r,g,b]){const c=1-r,m=1-g,y=1-b,k=Math.min(c,m,y);return["CMYK",c,m,y,k]}}class BaseSVGFactory{create(width,height,skipDimensions=!1){if(width<=0||height<=0)throw new Error("Invalid SVG dimensions");const svg=this._createSVG("svg:svg");return svg.setAttribute("version","1.1"),skipDimensions||(svg.setAttribute("width",`${width}px`),svg.setAttribute("height",`${height}px`)),svg.setAttribute("preserveAspectRatio","none"),svg.setAttribute("viewBox",`0 0 ${width} ${height}`),svg}createElement(type){if(typeof type!="string")throw new Error("Invalid SVG element type");return this._createSVG(type)}_createSVG(type){unreachable("Abstract method `_createSVG` called.")}}class DOMSVGFactory extends BaseSVGFactory{_createSVG(type){return document.createElementNS(SVG_NS,type)}}class XfaLayer{static setupStorage(html,id,element,storage,intent){const storedData=storage.getValue(id,{value:null});switch(element.name){case"textarea":if(storedData.value!==null&&(html.textContent=storedData.value),intent==="print")break;html.addEventListener("input",event=>{storage.setValue(id,{value:event.target.value})});break;case"input":if(element.attributes.type==="radio"||element.attributes.type==="checkbox"){if(storedData.value===element.attributes.xfaOn?html.setAttribute("checked",!0):storedData.value===element.attributes.xfaOff&&html.removeAttribute("checked"),intent==="print")break;html.addEventListener("change",event=>{storage.setValue(id,{value:event.target.checked?event.target.getAttribute("xfaOn"):event.target.getAttribute("xfaOff")})})}else{if(storedData.value!==null&&html.setAttribute("value",storedData.value),intent==="print")break;html.addEventListener("input",event=>{storage.setValue(id,{value:event.target.value})})}break;case"select":if(storedData.value!==null){html.setAttribute("value",storedData.value);for(const option of element.children)option.attributes.value===storedData.value?option.attributes.selected=!0:option.attributes.hasOwnProperty("selected")&&delete option.attributes.selected}html.addEventListener("input",event=>{const options=event.target.options,value=options.selectedIndex===-1?"":options[options.selectedIndex].value;storage.setValue(id,{value})});break}}static setAttributes({html,element,storage=null,intent,linkService}){const{attributes}=element,isHTMLAnchorElement=html instanceof HTMLAnchorElement;attributes.type==="radio"&&(attributes.name=`${attributes.name}-${intent}`);for(const[key,value]of Object.entries(attributes))if(value!=null)switch(key){case"class":value.length&&html.setAttribute(key,value.join(" "));break;case"dataId":break;case"id":html.setAttribute("data-element-id",value);break;case"style":Object.assign(html.style,value);break;case"textContent":html.textContent=value;break;default:(!isHTMLAnchorElement||key!=="href"&&key!=="newWindow")&&html.setAttribute(key,value)}isHTMLAnchorElement&&linkService.addLinkAttributes(html,attributes.href,attributes.newWindow),storage&&attributes.dataId&&this.setupStorage(html,attributes.dataId,element,storage)}static render(parameters){const storage=parameters.annotationStorage,linkService=parameters.linkService,root=parameters.xfaHtml,intent=parameters.intent||"display",rootHtml=document.createElement(root.name);root.attributes&&this.setAttributes({html:rootHtml,element:root,intent,linkService});const isNotForRichText=intent!=="richText",rootDiv=parameters.div;if(rootDiv.append(rootHtml),parameters.viewport){const transform=`matrix(${parameters.viewport.transform.join(",")})`;rootDiv.style.transform=transform}isNotForRichText&&rootDiv.setAttribute("class","xfaLayer xfaFont");const textDivs=[];if(root.children.length===0){if(root.value){const node=document.createTextNode(root.value);rootHtml.append(node),isNotForRichText&&XfaText.shouldBuildText(root.name)&&textDivs.push(node)}return{textDivs}}const stack=[[root,-1,rootHtml]];for(;stack.length>0;){const[parent,i,html]=stack.at(-1);if(i+1===parent.children.length){stack.pop();continue}const child=parent.children[++stack.at(-1)[1]];if(child===null)continue;const{name}=child;if(name==="#text"){const node=document.createTextNode(child.value);textDivs.push(node),html.append(node);continue}const childHtml=child?.attributes?.xmlns?document.createElementNS(child.attributes.xmlns,name):document.createElement(name);if(html.append(childHtml),child.attributes&&this.setAttributes({html:childHtml,element:child,storage,intent,linkService}),child.children?.length>0)stack.push([child,-1,childHtml]);else if(child.value){const node=document.createTextNode(child.value);isNotForRichText&&XfaText.shouldBuildText(name)&&textDivs.push(node),childHtml.append(node)}}for(const el of rootDiv.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))el.setAttribute("readOnly",!0);return{textDivs}}static update(parameters){const transform=`matrix(${parameters.viewport.transform.join(",")})`;parameters.div.style.transform=transform,parameters.div.hidden=!1}}const annotation_layer_DEFAULT_FONT_SIZE=9,GetElementsByNameSet=new WeakSet;class AnnotationElementFactory{static create(parameters){switch(parameters.data.annotationType){case AnnotationType.LINK:return new LinkAnnotationElement(parameters);case AnnotationType.TEXT:return new TextAnnotationElement(parameters);case AnnotationType.WIDGET:switch(parameters.data.fieldType){case"Tx":return new TextWidgetAnnotationElement(parameters);case"Btn":return parameters.data.radioButton?new RadioButtonWidgetAnnotationElement(parameters):parameters.data.checkBox?new CheckboxWidgetAnnotationElement(parameters):new PushButtonWidgetAnnotationElement(parameters);case"Ch":return new ChoiceWidgetAnnotationElement(parameters);case"Sig":return new SignatureWidgetAnnotationElement(parameters)}return new WidgetAnnotationElement(parameters);case AnnotationType.POPUP:return new PopupAnnotationElement(parameters);case AnnotationType.FREETEXT:return new FreeTextAnnotationElement(parameters);case AnnotationType.LINE:return new LineAnnotationElement(parameters);case AnnotationType.SQUARE:return new SquareAnnotationElement(parameters);case AnnotationType.CIRCLE:return new CircleAnnotationElement(parameters);case AnnotationType.POLYLINE:return new PolylineAnnotationElement(parameters);case AnnotationType.CARET:return new CaretAnnotationElement(parameters);case AnnotationType.INK:return new InkAnnotationElement(parameters);case AnnotationType.POLYGON:return new PolygonAnnotationElement(parameters);case AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(parameters);case AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(parameters);case AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(parameters);case AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(parameters);case AnnotationType.STAMP:return new StampAnnotationElement(parameters);case AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(parameters);default:return new AnnotationElement(parameters)}}}class AnnotationElement{#updates=null;#hasBorder=!1;#popupElement=null;constructor(parameters,{isRenderable=!1,ignoreBorder=!1,createQuadrilaterals=!1}={}){this.isRenderable=isRenderable,this.data=parameters.data,this.layer=parameters.layer,this.linkService=parameters.linkService,this.downloadManager=parameters.downloadManager,this.imageResourcesPath=parameters.imageResourcesPath,this.renderForms=parameters.renderForms,this.svgFactory=parameters.svgFactory,this.annotationStorage=parameters.annotationStorage,this.enableScripting=parameters.enableScripting,this.hasJSActions=parameters.hasJSActions,this._fieldObjects=parameters.fieldObjects,this.parent=parameters.parent,isRenderable&&(this.container=this._createContainer(ignoreBorder)),createQuadrilaterals&&this._createQuadrilaterals()}static _hasPopupData({contentsObj,richText}){return!!(contentsObj?.str||richText?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return AnnotationElement._hasPopupData(this.data)}updateEdited(params){if(!this.container)return;this.#updates||={rect:this.data.rect.slice(0)};const{rect}=params;rect&&this.#setRectEdited(rect),this.#popupElement?.popup.updateEdited(params)}resetEdited(){this.#updates&&(this.#setRectEdited(this.#updates.rect),this.#popupElement?.popup.resetEdited(),this.#updates=null)}#setRectEdited(rect){const{container:{style},data:{rect:currentRect,rotation},parent:{viewport:{rawDims:{pageWidth,pageHeight,pageX,pageY}}}}=this;currentRect?.splice(0,4,...rect),style.left=`${100*(rect[0]-pageX)/pageWidth}%`,style.top=`${100*(pageHeight-rect[3]+pageY)/pageHeight}%`,rotation===0?(style.width=`${100*(rect[2]-rect[0])/pageWidth}%`,style.height=`${100*(rect[3]-rect[1])/pageHeight}%`):this.setRotation(rotation)}_createContainer(ignoreBorder){const{data,parent:{page,viewport}}=this,container=document.createElement("section");container.setAttribute("data-annotation-id",data.id),this instanceof WidgetAnnotationElement||(container.tabIndex=0);const{style}=container;if(style.zIndex=this.parent.zIndex++,data.alternativeText&&(container.title=data.alternativeText),data.noRotate&&container.classList.add("norotate"),!data.rect||this instanceof PopupAnnotationElement){const{rotation:rotation2}=data;return!data.hasOwnCanvas&&rotation2!==0&&this.setRotation(rotation2,container),container}const{width,height}=this;if(!ignoreBorder&&data.borderStyle.width>0){style.borderWidth=`${data.borderStyle.width}px`;const horizontalRadius=data.borderStyle.horizontalCornerRadius,verticalRadius=data.borderStyle.verticalCornerRadius;if(horizontalRadius>0||verticalRadius>0){const radius=`calc(${horizontalRadius}px * var(--total-scale-factor)) / calc(${verticalRadius}px * var(--total-scale-factor))`;style.borderRadius=radius}else if(this instanceof RadioButtonWidgetAnnotationElement){const radius=`calc(${width}px * var(--total-scale-factor)) / calc(${height}px * var(--total-scale-factor))`;style.borderRadius=radius}switch(data.borderStyle.style){case AnnotationBorderStyleType.SOLID:style.borderStyle="solid";break;case AnnotationBorderStyleType.DASHED:style.borderStyle="dashed";break;case AnnotationBorderStyleType.BEVELED:warn("Unimplemented border style: beveled");break;case AnnotationBorderStyleType.INSET:warn("Unimplemented border style: inset");break;case AnnotationBorderStyleType.UNDERLINE:style.borderBottomStyle="solid";break}const borderColor=data.borderColor||null;borderColor?(this.#hasBorder=!0,style.borderColor=Util.makeHexColor(borderColor[0]|0,borderColor[1]|0,borderColor[2]|0)):style.borderWidth=0}const rect=Util.normalizeRect([data.rect[0],page.view[3]-data.rect[1]+page.view[1],data.rect[2],page.view[3]-data.rect[3]+page.view[1]]),{pageWidth,pageHeight,pageX,pageY}=viewport.rawDims;style.left=`${100*(rect[0]-pageX)/pageWidth}%`,style.top=`${100*(rect[1]-pageY)/pageHeight}%`;const{rotation}=data;return data.hasOwnCanvas||rotation===0?(style.width=`${100*width/pageWidth}%`,style.height=`${100*height/pageHeight}%`):this.setRotation(rotation,container),container}setRotation(angle,container=this.container){if(!this.data.rect)return;const{pageWidth,pageHeight}=this.parent.viewport.rawDims;let{width,height}=this;angle%180!==0&&([width,height]=[height,width]),container.style.width=`${100*width/pageWidth}%`,container.style.height=`${100*height/pageHeight}%`,container.setAttribute("data-main-rotation",(360-angle)%360)}get _commonActions(){const setColor=(jsName,styleName,event)=>{const color=event.detail[jsName],colorType=color[0],colorArray=color.slice(1);event.target.style[styleName]=ColorConverters[`${colorType}_HTML`](colorArray),this.annotationStorage.setValue(this.data.id,{[styleName]:ColorConverters[`${colorType}_rgb`](colorArray)})};return shadow(this,"_commonActions",{display:event=>{const{display}=event.detail,hidden=display%2===1;this.container.style.visibility=hidden?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:hidden,noPrint:display===1||display===2})},print:event=>{this.annotationStorage.setValue(this.data.id,{noPrint:!event.detail.print})},hidden:event=>{const{hidden}=event.detail;this.container.style.visibility=hidden?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:hidden,noView:hidden})},focus:event=>{setTimeout(()=>event.target.focus({preventScroll:!1}),0)},userName:event=>{event.target.title=event.detail.userName},readonly:event=>{event.target.disabled=event.detail.readonly},required:event=>{this._setRequired(event.target,event.detail.required)},bgColor:event=>{setColor("bgColor","backgroundColor",event)},fillColor:event=>{setColor("fillColor","backgroundColor",event)},fgColor:event=>{setColor("fgColor","color",event)},textColor:event=>{setColor("textColor","color",event)},borderColor:event=>{setColor("borderColor","borderColor",event)},strokeColor:event=>{setColor("strokeColor","borderColor",event)},rotation:event=>{const angle=event.detail.rotation;this.setRotation(angle),this.annotationStorage.setValue(this.data.id,{rotation:angle})}})}_dispatchEventFromSandbox(actions,jsEvent){const commonActions=this._commonActions;for(const name of Object.keys(jsEvent.detail))(actions[name]||commonActions[name])?.(jsEvent)}_setDefaultPropertiesFromJS(element){if(!this.enableScripting)return;const storedData=this.annotationStorage.getRawValue(this.data.id);if(!storedData)return;const commonActions=this._commonActions;for(const[actionName,detail]of Object.entries(storedData)){const action=commonActions[actionName];if(action){const eventProxy={detail:{[actionName]:detail},target:element};action(eventProxy),delete storedData[actionName]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints}=this.data;if(!quadPoints)return;const[rectBlX,rectBlY,rectTrX,rectTrY]=this.data.rect.map(x=>Math.fround(x));if(quadPoints.length===8){const[trX,trY,blX,blY]=quadPoints.subarray(2,6);if(rectTrX===trX&&rectTrY===trY&&rectBlX===blX&&rectBlY===blY)return}const{style}=this.container;let svgBuffer;if(this.#hasBorder){const{borderColor,borderWidth}=style;style.borderWidth=0,svgBuffer=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${borderColor}" stroke-width="${borderWidth}">`],this.container.classList.add("hasBorder")}const width=rectTrX-rectBlX,height=rectTrY-rectBlY,{svgFactory}=this,svg=svgFactory.createElement("svg");svg.classList.add("quadrilateralsContainer"),svg.setAttribute("width",0),svg.setAttribute("height",0),svg.role="none";const defs=svgFactory.createElement("defs");svg.append(defs);const clipPath=svgFactory.createElement("clipPath"),id=`clippath_${this.data.id}`;clipPath.setAttribute("id",id),clipPath.setAttribute("clipPathUnits","objectBoundingBox"),defs.append(clipPath);for(let i=2,ii=quadPoints.length;i<ii;i+=8){const trX=quadPoints[i],trY=quadPoints[i+1],blX=quadPoints[i+2],blY=quadPoints[i+3],rect=svgFactory.createElement("rect"),x=(blX-rectBlX)/width,y=(rectTrY-trY)/height,rectWidth=(trX-blX)/width,rectHeight=(trY-blY)/height;rect.setAttribute("x",x),rect.setAttribute("y",y),rect.setAttribute("width",rectWidth),rect.setAttribute("height",rectHeight),clipPath.append(rect),svgBuffer?.push(`<rect vector-effect="non-scaling-stroke" x="${x}" y="${y}" width="${rectWidth}" height="${rectHeight}"/>`)}this.#hasBorder&&(svgBuffer.push("</g></svg>')"),style.backgroundImage=svgBuffer.join("")),this.container.append(svg),this.container.style.clipPath=`url(#${id})`}_createPopup(){const{data}=this,popup=this.#popupElement=new PopupAnnotationElement({data:{color:data.color,titleObj:data.titleObj,modificationDate:data.modificationDate,contentsObj:data.contentsObj,richText:data.richText,parentRect:data.rect,borderStyle:0,id:`popup_${data.id}`,rotation:data.rotation,noRotate:!0},parent:this.parent,elements:[this]});this.parent.div.append(popup.render())}render(){unreachable("Abstract method `AnnotationElement.render` called")}_getElementsByName(name,skipId=null){const fields=[];if(this._fieldObjects){const fieldObj=this._fieldObjects[name];if(fieldObj)for(const{page,id,exportValues}of fieldObj){if(page===-1||id===skipId)continue;const exportValue=typeof exportValues=="string"?exportValues:null,domElement=document.querySelector(`[data-element-id="${id}"]`);if(domElement&&!GetElementsByNameSet.has(domElement)){warn(`_getElementsByName - element not allowed: ${id}`);continue}fields.push({id,exportValue,domElement})}return fields}for(const domElement of document.getElementsByName(name)){const{exportValue}=domElement,id=domElement.getAttribute("data-element-id");id!==skipId&&GetElementsByNameSet.has(domElement)&&fields.push({id,exportValue,domElement})}return fields}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const triggers=this.getElementsToTriggerPopup();if(Array.isArray(triggers))for(const element of triggers)element.classList.add("highlightArea");else triggers.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;const{annotationEditorType:mode,data:{id:editId}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode,editId,mustEnterInEditMode:!0})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}}class LinkAnnotationElement extends AnnotationElement{constructor(parameters,options=null){super(parameters,{isRenderable:!0,ignoreBorder:!!options?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=parameters.data.isTooltipOnly}render(){const{data,linkService}=this,link=document.createElement("a");link.setAttribute("data-element-id",data.id);let isBound=!1;return data.url?(linkService.addLinkAttributes(link,data.url,data.newWindow),isBound=!0):data.action?(this._bindNamedAction(link,data.action),isBound=!0):data.attachment?(this.#bindAttachment(link,data.attachment,data.attachmentDest),isBound=!0):data.setOCGState?(this.#bindSetOCGState(link,data.setOCGState),isBound=!0):data.dest?(this._bindLink(link,data.dest),isBound=!0):(data.actions&&(data.actions.Action||data.actions["Mouse Up"]||data.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(link,data),isBound=!0),data.resetForm?(this._bindResetFormAction(link,data.resetForm),isBound=!0):this.isTooltipOnly&&!isBound&&(this._bindLink(link,""),isBound=!0)),this.container.classList.add("linkAnnotation"),isBound&&this.container.append(link),this.container}#setInternalLink(){this.container.setAttribute("data-internal-link","")}_bindLink(link,destination){link.href=this.linkService.getDestinationHash(destination),link.onclick=()=>(destination&&this.linkService.goToDestination(destination),!1),(destination||destination==="")&&this.#setInternalLink()}_bindNamedAction(link,action){link.href=this.linkService.getAnchorUrl(""),link.onclick=()=>(this.linkService.executeNamedAction(action),!1),this.#setInternalLink()}#bindAttachment(link,attachment,dest=null){link.href=this.linkService.getAnchorUrl(""),attachment.description&&(link.title=attachment.description),link.onclick=()=>(this.downloadManager?.openOrDownloadData(attachment.content,attachment.filename,dest),!1),this.#setInternalLink()}#bindSetOCGState(link,action){link.href=this.linkService.getAnchorUrl(""),link.onclick=()=>(this.linkService.executeSetOCGState(action),!1),this.#setInternalLink()}_bindJSAction(link,data){link.href=this.linkService.getAnchorUrl("");const map=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const name of Object.keys(data.actions)){const jsName=map.get(name);jsName&&(link[jsName]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:data.id,name}}),!1))}link.onclick||(link.onclick=()=>!1),this.#setInternalLink()}_bindResetFormAction(link,resetForm){const otherClickAction=link.onclick;if(otherClickAction||(link.href=this.linkService.getAnchorUrl("")),this.#setInternalLink(),!this._fieldObjects){warn('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),otherClickAction||(link.onclick=()=>!1);return}link.onclick=()=>{otherClickAction?.();const{fields:resetFormFields,refs:resetFormRefs,include}=resetForm,allFields=[];if(resetFormFields.length!==0||resetFormRefs.length!==0){const fieldIds=new Set(resetFormRefs);for(const fieldName of resetFormFields){const fields=this._fieldObjects[fieldName]||[];for(const{id}of fields)fieldIds.add(id)}for(const fields of Object.values(this._fieldObjects))for(const field of fields)fieldIds.has(field.id)===include&&allFields.push(field)}else for(const fields of Object.values(this._fieldObjects))allFields.push(...fields);const storage=this.annotationStorage,allIds=[];for(const field of allFields){const{id}=field;switch(allIds.push(id),field.type){case"text":{const value=field.defaultValue||"";storage.setValue(id,{value});break}case"checkbox":case"radiobutton":{const value=field.defaultValue===field.exportValues;storage.setValue(id,{value});break}case"combobox":case"listbox":{const value=field.defaultValue||"";storage.setValue(id,{value});break}default:continue}const domElement=document.querySelector(`[data-element-id="${id}"]`);if(domElement){if(!GetElementsByNameSet.has(domElement)){warn(`_bindResetFormAction - element not allowed: ${id}`);continue}}else continue;domElement.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:allIds,name:"ResetForm"}}),!1}}}class TextAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const image=document.createElement("img");return image.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",image.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),image.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(image),this.container}}class WidgetAnnotationElement extends AnnotationElement{render(){return this.container}showElementAndHideCanvas(element){this.data.hasOwnCanvas&&(element.previousSibling?.nodeName==="CANVAS"&&(element.previousSibling.hidden=!0),element.hidden=!1)}_getKeyModifier(event){return util_FeatureTest.platform.isMac?event.metaKey:event.ctrlKey}_setEventListener(element,elementData,baseName,eventName,valueGetter){baseName.includes("mouse")?element.addEventListener(baseName,event=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:eventName,value:valueGetter(event),shift:event.shiftKey,modifier:this._getKeyModifier(event)}})}):element.addEventListener(baseName,event=>{if(baseName==="blur"){if(!elementData.focused||!event.relatedTarget)return;elementData.focused=!1}else if(baseName==="focus"){if(elementData.focused)return;elementData.focused=!0}valueGetter&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:eventName,value:valueGetter(event)}})})}_setEventListeners(element,elementData,names,getter){for(const[baseName,eventName]of names)(eventName==="Action"||this.data.actions?.[eventName])&&((eventName==="Focus"||eventName==="Blur")&&(elementData||={focused:!1}),this._setEventListener(element,elementData,baseName,eventName,getter),eventName==="Focus"&&!this.data.actions?.Blur?this._setEventListener(element,elementData,"blur","Blur",null):eventName==="Blur"&&!this.data.actions?.Focus&&this._setEventListener(element,elementData,"focus","Focus",null))}_setBackgroundColor(element){const color=this.data.backgroundColor||null;element.style.backgroundColor=color===null?"transparent":Util.makeHexColor(color[0],color[1],color[2])}_setTextStyle(element){const TEXT_ALIGNMENT=["left","center","right"],{fontColor}=this.data.defaultAppearanceData,fontSize=this.data.defaultAppearanceData.fontSize||annotation_layer_DEFAULT_FONT_SIZE,style=element.style;let computedFontSize;const BORDER_SIZE=2,roundToOneDecimal=x=>Math.round(10*x)/10;if(this.data.multiLine){const height=Math.abs(this.data.rect[3]-this.data.rect[1]-BORDER_SIZE),numberOfLines=Math.round(height/(LINE_FACTOR*fontSize))||1,lineHeight=height/numberOfLines;computedFontSize=Math.min(fontSize,roundToOneDecimal(lineHeight/LINE_FACTOR))}else{const height=Math.abs(this.data.rect[3]-this.data.rect[1]-BORDER_SIZE);computedFontSize=Math.min(fontSize,roundToOneDecimal(height/LINE_FACTOR))}style.fontSize=`calc(${computedFontSize}px * var(--total-scale-factor))`,style.color=Util.makeHexColor(fontColor[0],fontColor[1],fontColor[2]),this.data.textAlignment!==null&&(style.textAlign=TEXT_ALIGNMENT[this.data.textAlignment])}_setRequired(element,isRequired){isRequired?element.setAttribute("required",!0):element.removeAttribute("required"),element.setAttribute("aria-required",isRequired)}}class TextWidgetAnnotationElement extends WidgetAnnotationElement{constructor(parameters){const isRenderable=parameters.renderForms||parameters.data.hasOwnCanvas||!parameters.data.hasAppearance&&!!parameters.data.fieldValue;super(parameters,{isRenderable})}setPropertyOnSiblings(base,key,value,keyInStorage){const storage=this.annotationStorage;for(const element of this._getElementsByName(base.name,base.id))element.domElement&&(element.domElement[key]=value),storage.setValue(element.id,{[keyInStorage]:value})}render(){const storage=this.annotationStorage,id=this.data.id;this.container.classList.add("textWidgetAnnotation");let element=null;if(this.renderForms){const storedData=storage.getValue(id,{value:this.data.fieldValue});let textContent=storedData.value||"";const maxLen=storage.getValue(id,{charLimit:this.data.maxLen}).charLimit;maxLen&&textContent.length>maxLen&&(textContent=textContent.slice(0,maxLen));let fieldFormattedValues=storedData.formattedValue||this.data.textContent?.join(`
`)||null;fieldFormattedValues&&this.data.comb&&(fieldFormattedValues=fieldFormattedValues.replaceAll(/\s+/g,""));const elementData={userValue:textContent,formattedValue:fieldFormattedValues,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(element=document.createElement("textarea"),element.textContent=fieldFormattedValues??textContent,this.data.doNotScroll&&(element.style.overflowY="hidden")):(element=document.createElement("input"),element.type=this.data.password?"password":"text",element.setAttribute("value",fieldFormattedValues??textContent),this.data.doNotScroll&&(element.style.overflowX="hidden")),this.data.hasOwnCanvas&&(element.hidden=!0),GetElementsByNameSet.add(element),element.setAttribute("data-element-id",id),element.disabled=this.data.readOnly,element.name=this.data.fieldName,element.tabIndex=0;const format=this.data.dateFormat||this.data.timeFormat;format&&(element.title=format),this._setRequired(element,this.data.required),maxLen&&(element.maxLength=maxLen),element.addEventListener("input",event=>{storage.setValue(id,{value:event.target.value}),this.setPropertyOnSiblings(element,"value",event.target.value,"value"),elementData.formattedValue=null}),element.addEventListener("resetform",event=>{const defaultValue=this.data.defaultFieldValue??"";element.value=elementData.userValue=defaultValue,elementData.formattedValue=null});let blurListener=event=>{const{formattedValue}=elementData;formattedValue!=null&&(event.target.value=formattedValue),event.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){element.addEventListener("focus",event=>{if(elementData.focused)return;const{target}=event;elementData.userValue&&(target.value=elementData.userValue),elementData.lastCommittedValue=target.value,elementData.commitKey=1,this.data.actions?.Focus||(elementData.focused=!0)}),element.addEventListener("updatefromsandbox",jsEvent=>{this.showElementAndHideCanvas(jsEvent.target);const actions={value(event){elementData.userValue=event.detail.value??"",storage.setValue(id,{value:elementData.userValue.toString()}),event.target.value=elementData.userValue},formattedValue(event){const{formattedValue}=event.detail;elementData.formattedValue=formattedValue,formattedValue!=null&&event.target!==document.activeElement&&(event.target.value=formattedValue),storage.setValue(id,{formattedValue})},selRange(event){event.target.setSelectionRange(...event.detail.selRange)},charLimit:event=>{const{charLimit}=event.detail,{target}=event;if(charLimit===0){target.removeAttribute("maxLength");return}target.setAttribute("maxLength",charLimit);let value=elementData.userValue;!value||value.length<=charLimit||(value=value.slice(0,charLimit),target.value=elementData.userValue=value,storage.setValue(id,{value}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id,name:"Keystroke",value,willCommit:!0,commitKey:1,selStart:target.selectionStart,selEnd:target.selectionEnd}}))}};this._dispatchEventFromSandbox(actions,jsEvent)}),element.addEventListener("keydown",event=>{elementData.commitKey=1;let commitKey=-1;if(event.key==="Escape"?commitKey=0:event.key==="Enter"&&!this.data.multiLine?commitKey=2:event.key==="Tab"&&(elementData.commitKey=3),commitKey===-1)return;const{value}=event.target;elementData.lastCommittedValue!==value&&(elementData.lastCommittedValue=value,elementData.userValue=value,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id,name:"Keystroke",value,willCommit:!0,commitKey,selStart:event.target.selectionStart,selEnd:event.target.selectionEnd}}))});const _blurListener=blurListener;blurListener=null,element.addEventListener("blur",event=>{if(!elementData.focused||!event.relatedTarget)return;this.data.actions?.Blur||(elementData.focused=!1);const{value}=event.target;elementData.userValue=value,elementData.lastCommittedValue!==value&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id,name:"Keystroke",value,willCommit:!0,commitKey:elementData.commitKey,selStart:event.target.selectionStart,selEnd:event.target.selectionEnd}}),_blurListener(event)}),this.data.actions?.Keystroke&&element.addEventListener("beforeinput",event=>{elementData.lastCommittedValue=null;const{data,target}=event,{value,selectionStart,selectionEnd}=target;let selStart=selectionStart,selEnd=selectionEnd;switch(event.inputType){case"deleteWordBackward":{const match=value.substring(0,selectionStart).match(/\w*[^\w]*$/);match&&(selStart-=match[0].length);break}case"deleteWordForward":{const match=value.substring(selectionStart).match(/^[^\w]*\w*/);match&&(selEnd+=match[0].length);break}case"deleteContentBackward":selectionStart===selectionEnd&&(selStart-=1);break;case"deleteContentForward":selectionStart===selectionEnd&&(selEnd+=1);break}event.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id,name:"Keystroke",value,change:data||"",willCommit:!1,selStart,selEnd}})}),this._setEventListeners(element,elementData,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],event=>event.target.value)}if(blurListener&&element.addEventListener("blur",blurListener),this.data.comb){const combWidth=(this.data.rect[2]-this.data.rect[0])/maxLen;element.classList.add("comb"),element.style.letterSpacing=`calc(${combWidth}px * var(--total-scale-factor) - 1ch)`}}else element=document.createElement("div"),element.textContent=this.data.fieldValue,element.style.verticalAlign="middle",element.style.display="table-cell",this.data.hasOwnCanvas&&(element.hidden=!0);return this._setTextStyle(element),this._setBackgroundColor(element),this._setDefaultPropertiesFromJS(element),this.container.append(element),this.container}}class SignatureWidgetAnnotationElement extends WidgetAnnotationElement{constructor(parameters){super(parameters,{isRenderable:!!parameters.data.hasOwnCanvas})}}class CheckboxWidgetAnnotationElement extends WidgetAnnotationElement{constructor(parameters){super(parameters,{isRenderable:parameters.renderForms})}render(){const storage=this.annotationStorage,data=this.data,id=data.id;let value=storage.getValue(id,{value:data.exportValue===data.fieldValue}).value;typeof value=="string"&&(value=value!=="Off",storage.setValue(id,{value})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const element=document.createElement("input");return GetElementsByNameSet.add(element),element.setAttribute("data-element-id",id),element.disabled=data.readOnly,this._setRequired(element,this.data.required),element.type="checkbox",element.name=data.fieldName,value&&element.setAttribute("checked",!0),element.setAttribute("exportValue",data.exportValue),element.tabIndex=0,element.addEventListener("change",event=>{const{name,checked}=event.target;for(const checkbox of this._getElementsByName(name,id)){const curChecked=checked&&checkbox.exportValue===data.exportValue;checkbox.domElement&&(checkbox.domElement.checked=curChecked),storage.setValue(checkbox.id,{value:curChecked})}storage.setValue(id,{value:checked})}),element.addEventListener("resetform",event=>{const defaultValue=data.defaultFieldValue||"Off";event.target.checked=defaultValue===data.exportValue}),this.enableScripting&&this.hasJSActions&&(element.addEventListener("updatefromsandbox",jsEvent=>{const actions={value(event){event.target.checked=event.detail.value!=="Off",storage.setValue(id,{value:event.target.checked})}};this._dispatchEventFromSandbox(actions,jsEvent)}),this._setEventListeners(element,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],event=>event.target.checked)),this._setBackgroundColor(element),this._setDefaultPropertiesFromJS(element),this.container.append(element),this.container}}class RadioButtonWidgetAnnotationElement extends WidgetAnnotationElement{constructor(parameters){super(parameters,{isRenderable:parameters.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const storage=this.annotationStorage,data=this.data,id=data.id;let value=storage.getValue(id,{value:data.fieldValue===data.buttonValue}).value;if(typeof value=="string"&&(value=value!==data.buttonValue,storage.setValue(id,{value})),value)for(const radio of this._getElementsByName(data.fieldName,id))storage.setValue(radio.id,{value:!1});const element=document.createElement("input");if(GetElementsByNameSet.add(element),element.setAttribute("data-element-id",id),element.disabled=data.readOnly,this._setRequired(element,this.data.required),element.type="radio",element.name=data.fieldName,value&&element.setAttribute("checked",!0),element.tabIndex=0,element.addEventListener("change",event=>{const{name,checked}=event.target;for(const radio of this._getElementsByName(name,id))storage.setValue(radio.id,{value:!1});storage.setValue(id,{value:checked})}),element.addEventListener("resetform",event=>{const defaultValue=data.defaultFieldValue;event.target.checked=defaultValue!=null&&defaultValue===data.buttonValue}),this.enableScripting&&this.hasJSActions){const pdfButtonValue=data.buttonValue;element.addEventListener("updatefromsandbox",jsEvent=>{const actions={value:event=>{const checked=pdfButtonValue===event.detail.value;for(const radio of this._getElementsByName(event.target.name)){const curChecked=checked&&radio.id===id;radio.domElement&&(radio.domElement.checked=curChecked),storage.setValue(radio.id,{value:curChecked})}}};this._dispatchEventFromSandbox(actions,jsEvent)}),this._setEventListeners(element,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],event=>event.target.checked)}return this._setBackgroundColor(element),this._setDefaultPropertiesFromJS(element),this.container.append(element),this.container}}class PushButtonWidgetAnnotationElement extends LinkAnnotationElement{constructor(parameters){super(parameters,{ignoreBorder:parameters.data.hasAppearance})}render(){const container=super.render();container.classList.add("buttonWidgetAnnotation","pushButton");const linkElement=container.lastChild;return this.enableScripting&&this.hasJSActions&&linkElement&&(this._setDefaultPropertiesFromJS(linkElement),linkElement.addEventListener("updatefromsandbox",jsEvent=>{this._dispatchEventFromSandbox({},jsEvent)})),container}}class ChoiceWidgetAnnotationElement extends WidgetAnnotationElement{constructor(parameters){super(parameters,{isRenderable:parameters.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const storage=this.annotationStorage,id=this.data.id,storedData=storage.getValue(id,{value:this.data.fieldValue}),selectElement=document.createElement("select");GetElementsByNameSet.add(selectElement),selectElement.setAttribute("data-element-id",id),selectElement.disabled=this.data.readOnly,this._setRequired(selectElement,this.data.required),selectElement.name=this.data.fieldName,selectElement.tabIndex=0;let addAnEmptyEntry=this.data.combo&&this.data.options.length>0;this.data.combo||(selectElement.size=this.data.options.length,this.data.multiSelect&&(selectElement.multiple=!0)),selectElement.addEventListener("resetform",event=>{const defaultValue=this.data.defaultFieldValue;for(const option of selectElement.options)option.selected=option.value===defaultValue});for(const option of this.data.options){const optionElement=document.createElement("option");optionElement.textContent=option.displayValue,optionElement.value=option.exportValue,storedData.value.includes(option.exportValue)&&(optionElement.setAttribute("selected",!0),addAnEmptyEntry=!1),selectElement.append(optionElement)}let removeEmptyEntry=null;if(addAnEmptyEntry){const noneOptionElement=document.createElement("option");noneOptionElement.value=" ",noneOptionElement.setAttribute("hidden",!0),noneOptionElement.setAttribute("selected",!0),selectElement.prepend(noneOptionElement),removeEmptyEntry=()=>{noneOptionElement.remove(),selectElement.removeEventListener("input",removeEmptyEntry),removeEmptyEntry=null},selectElement.addEventListener("input",removeEmptyEntry)}const getValue=isExport=>{const name=isExport?"value":"textContent",{options,multiple}=selectElement;return multiple?Array.prototype.filter.call(options,option=>option.selected).map(option=>option[name]):options.selectedIndex===-1?null:options[options.selectedIndex][name]};let selectedValues=getValue(!1);const getItems=event=>{const options=event.target.options;return Array.prototype.map.call(options,option=>({displayValue:option.textContent,exportValue:option.value}))};return this.enableScripting&&this.hasJSActions?(selectElement.addEventListener("updatefromsandbox",jsEvent=>{const actions={value(event){removeEmptyEntry?.();const value=event.detail.value,values=new Set(Array.isArray(value)?value:[value]);for(const option of selectElement.options)option.selected=values.has(option.value);storage.setValue(id,{value:getValue(!0)}),selectedValues=getValue(!1)},multipleSelection(event){selectElement.multiple=!0},remove(event){const options=selectElement.options,index=event.detail.remove;options[index].selected=!1,selectElement.remove(index),options.length>0&&Array.prototype.findIndex.call(options,option=>option.selected)===-1&&(options[0].selected=!0),storage.setValue(id,{value:getValue(!0),items:getItems(event)}),selectedValues=getValue(!1)},clear(event){for(;selectElement.length!==0;)selectElement.remove(0);storage.setValue(id,{value:null,items:[]}),selectedValues=getValue(!1)},insert(event){const{index,displayValue,exportValue}=event.detail.insert,selectChild=selectElement.children[index],optionElement=document.createElement("option");optionElement.textContent=displayValue,optionElement.value=exportValue,selectChild?selectChild.before(optionElement):selectElement.append(optionElement),storage.setValue(id,{value:getValue(!0),items:getItems(event)}),selectedValues=getValue(!1)},items(event){const{items}=event.detail;for(;selectElement.length!==0;)selectElement.remove(0);for(const item of items){const{displayValue,exportValue}=item,optionElement=document.createElement("option");optionElement.textContent=displayValue,optionElement.value=exportValue,selectElement.append(optionElement)}selectElement.options.length>0&&(selectElement.options[0].selected=!0),storage.setValue(id,{value:getValue(!0),items:getItems(event)}),selectedValues=getValue(!1)},indices(event){const indices=new Set(event.detail.indices);for(const option of event.target.options)option.selected=indices.has(option.index);storage.setValue(id,{value:getValue(!0)}),selectedValues=getValue(!1)},editable(event){event.target.disabled=!event.detail.editable}};this._dispatchEventFromSandbox(actions,jsEvent)}),selectElement.addEventListener("input",event=>{const exportValue=getValue(!0),change=getValue(!1);storage.setValue(id,{value:exportValue}),event.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id,name:"Keystroke",value:selectedValues,change,changeEx:exportValue,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(selectElement,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],event=>event.target.value)):selectElement.addEventListener("input",function(event){storage.setValue(id,{value:getValue(!0)})}),this.data.combo&&this._setTextStyle(selectElement),this._setBackgroundColor(selectElement),this._setDefaultPropertiesFromJS(selectElement),this.container.append(selectElement),this.container}}class PopupAnnotationElement extends AnnotationElement{constructor(parameters){const{data,elements}=parameters;super(parameters,{isRenderable:AnnotationElement._hasPopupData(data)}),this.elements=elements,this.popup=null}render(){const{container}=this;container.classList.add("popupAnnotation"),container.role="comment";const popup=this.popup=new PopupElement({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open}),elementIds=[];for(const element of this.elements)element.popup=popup,element.container.ariaHasPopup="dialog",elementIds.push(element.data.id),element.addHighlightArea();return this.container.setAttribute("aria-controls",elementIds.map(id=>`${AnnotationPrefix}${id}`).join(",")),this.container}}class PopupElement{#boundKeyDown=this.#keyDown.bind(this);#boundHide=this.#hide.bind(this);#boundShow=this.#show.bind(this);#boundToggle=this.#toggle.bind(this);#color=null;#container=null;#contentsObj=null;#dateObj=null;#elements=null;#parent=null;#parentRect=null;#pinned=!1;#popup=null;#position=null;#rect=null;#richText=null;#titleObj=null;#updates=null;#wasVisible=!1;constructor({container,color,elements,titleObj,modificationDate,contentsObj,richText,parent,rect,parentRect,open}){this.#container=container,this.#titleObj=titleObj,this.#contentsObj=contentsObj,this.#richText=richText,this.#parent=parent,this.#color=color,this.#rect=rect,this.#parentRect=parentRect,this.#elements=elements,this.#dateObj=PDFDateString.toDateObject(modificationDate),this.trigger=elements.flatMap(e=>e.getElementsToTriggerPopup());for(const element of this.trigger)element.addEventListener("click",this.#boundToggle),element.addEventListener("mouseenter",this.#boundShow),element.addEventListener("mouseleave",this.#boundHide),element.classList.add("popupTriggerArea");for(const element of elements)element.container?.addEventListener("keydown",this.#boundKeyDown);this.#container.hidden=!0,open&&this.#toggle()}render(){if(this.#popup)return;const popup=this.#popup=document.createElement("div");if(popup.className="popup",this.#color){const baseColor=popup.style.outlineColor=Util.makeHexColor(...this.#color);popup.style.backgroundColor=`color-mix(in srgb, ${baseColor} 30%, white)`}const header=document.createElement("span");header.className="header";const title=document.createElement("h1");if(header.append(title),{dir:title.dir,str:title.textContent}=this.#titleObj,popup.append(header),this.#dateObj){const modificationDate=document.createElement("time");modificationDate.classList.add("popupDate"),modificationDate.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),modificationDate.setAttribute("data-l10n-args",JSON.stringify({dateObj:this.#dateObj.valueOf()})),modificationDate.dateTime=this.#dateObj.toISOString(),header.append(modificationDate)}const html=this.#html;if(html)XfaLayer.render({xfaHtml:html,intent:"richText",div:popup}),popup.lastChild.classList.add("richText","popupContent");else{const contents=this._formatContents(this.#contentsObj);popup.append(contents)}this.#container.append(popup)}get#html(){const richText=this.#richText,contentsObj=this.#contentsObj;return richText?.str&&(!contentsObj?.str||contentsObj.str===richText.str)&&this.#richText.html||null}get#fontSize(){return this.#html?.attributes?.style?.fontSize||0}get#fontColor(){return this.#html?.attributes?.style?.color||null}#makePopupContent(text){const popupLines=[],popupContent={str:text,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:popupLines}]}},lineAttributes={style:{color:this.#fontColor,fontSize:this.#fontSize?`calc(${this.#fontSize}px * var(--total-scale-factor))`:""}};for(const line of text.split(`
`))popupLines.push({name:"span",value:line,attributes:lineAttributes});return popupContent}_formatContents({str,dir}){const p=document.createElement("p");p.classList.add("popupContent"),p.dir=dir;const lines=str.split(/(?:\r\n?|\n)/);for(let i=0,ii=lines.length;i<ii;++i){const line=lines[i];p.append(document.createTextNode(line)),i<ii-1&&p.append(document.createElement("br"))}return p}#keyDown(event){event.altKey||event.shiftKey||event.ctrlKey||event.metaKey||(event.key==="Enter"||event.key==="Escape"&&this.#pinned)&&this.#toggle()}updateEdited({rect,popupContent}){this.#updates||={contentsObj:this.#contentsObj,richText:this.#richText},rect&&(this.#position=null),popupContent&&(this.#richText=this.#makePopupContent(popupContent),this.#contentsObj=null),this.#popup?.remove(),this.#popup=null}resetEdited(){this.#updates&&({contentsObj:this.#contentsObj,richText:this.#richText}=this.#updates,this.#updates=null,this.#popup?.remove(),this.#popup=null,this.#position=null)}#setPosition(){if(this.#position!==null)return;const{page:{view},viewport:{rawDims:{pageWidth,pageHeight,pageX,pageY}}}=this.#parent;let useParentRect=!!this.#parentRect,rect=useParentRect?this.#parentRect:this.#rect;for(const element of this.#elements)if(!rect||Util.intersect(element.data.rect,rect)!==null){rect=element.data.rect,useParentRect=!0;break}const normalizedRect=Util.normalizeRect([rect[0],view[3]-rect[1]+view[1],rect[2],view[3]-rect[3]+view[1]]),parentWidth=useParentRect?rect[2]-rect[0]+5:0,popupLeft=normalizedRect[0]+parentWidth,popupTop=normalizedRect[1];this.#position=[100*(popupLeft-pageX)/pageWidth,100*(popupTop-pageY)/pageHeight];const{style}=this.#container;style.left=`${this.#position[0]}%`,style.top=`${this.#position[1]}%`}#toggle(){this.#pinned=!this.#pinned,this.#pinned?(this.#show(),this.#container.addEventListener("click",this.#boundToggle),this.#container.addEventListener("keydown",this.#boundKeyDown)):(this.#hide(),this.#container.removeEventListener("click",this.#boundToggle),this.#container.removeEventListener("keydown",this.#boundKeyDown))}#show(){this.#popup||this.render(),this.isVisible?this.#pinned&&this.#container.classList.add("focused"):(this.#setPosition(),this.#container.hidden=!1,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)+1e3)}#hide(){this.#container.classList.remove("focused"),!(this.#pinned||!this.isVisible)&&(this.#container.hidden=!0,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)-1e3)}forceHide(){this.#wasVisible=this.isVisible,this.#wasVisible&&(this.#container.hidden=!0)}maybeShow(){this.#wasVisible&&(this.#popup||this.#show(),this.#wasVisible=!1,this.#container.hidden=!1)}get isVisible(){return this.#container.hidden===!1}}class FreeTextAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0}),this.textContent=parameters.data.textContent,this.textPosition=parameters.data.textPosition,this.annotationEditorType=AnnotationEditorType.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const content=document.createElement("div");content.classList.add("annotationTextContent"),content.setAttribute("role","comment");for(const line of this.textContent){const lineSpan=document.createElement("span");lineSpan.textContent=line,content.append(lineSpan)}this.container.append(content)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class LineAnnotationElement extends AnnotationElement{#line=null;constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("lineAnnotation");const{data,width,height}=this,svg=this.svgFactory.create(width,height,!0),line=this.#line=this.svgFactory.createElement("svg:line");return line.setAttribute("x1",data.rect[2]-data.lineCoordinates[0]),line.setAttribute("y1",data.rect[3]-data.lineCoordinates[1]),line.setAttribute("x2",data.rect[2]-data.lineCoordinates[2]),line.setAttribute("y2",data.rect[3]-data.lineCoordinates[3]),line.setAttribute("stroke-width",data.borderStyle.width||1),line.setAttribute("stroke","transparent"),line.setAttribute("fill","transparent"),svg.append(line),this.container.append(svg),!data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#line}addHighlightArea(){this.container.classList.add("highlightArea")}}class SquareAnnotationElement extends AnnotationElement{#square=null;constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("squareAnnotation");const{data,width,height}=this,svg=this.svgFactory.create(width,height,!0),borderWidth=data.borderStyle.width,square=this.#square=this.svgFactory.createElement("svg:rect");return square.setAttribute("x",borderWidth/2),square.setAttribute("y",borderWidth/2),square.setAttribute("width",width-borderWidth),square.setAttribute("height",height-borderWidth),square.setAttribute("stroke-width",borderWidth||1),square.setAttribute("stroke","transparent"),square.setAttribute("fill","transparent"),svg.append(square),this.container.append(svg),!data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#square}addHighlightArea(){this.container.classList.add("highlightArea")}}class CircleAnnotationElement extends AnnotationElement{#circle=null;constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("circleAnnotation");const{data,width,height}=this,svg=this.svgFactory.create(width,height,!0),borderWidth=data.borderStyle.width,circle=this.#circle=this.svgFactory.createElement("svg:ellipse");return circle.setAttribute("cx",width/2),circle.setAttribute("cy",height/2),circle.setAttribute("rx",width/2-borderWidth/2),circle.setAttribute("ry",height/2-borderWidth/2),circle.setAttribute("stroke-width",borderWidth||1),circle.setAttribute("stroke","transparent"),circle.setAttribute("fill","transparent"),svg.append(circle),this.container.append(svg),!data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#circle}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolylineAnnotationElement extends AnnotationElement{#polyline=null;constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect,vertices,borderStyle,popupRef},width,height}=this;if(!vertices)return this.container;const svg=this.svgFactory.create(width,height,!0);let points=[];for(let i=0,ii=vertices.length;i<ii;i+=2){const x=vertices[i]-rect[0],y=rect[3]-vertices[i+1];points.push(`${x},${y}`)}points=points.join(" ");const polyline=this.#polyline=this.svgFactory.createElement(this.svgElementName);return polyline.setAttribute("points",points),polyline.setAttribute("stroke-width",borderStyle.width||1),polyline.setAttribute("stroke","transparent"),polyline.setAttribute("fill","transparent"),svg.append(polyline),this.container.append(svg),!popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#polyline}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolygonAnnotationElement extends PolylineAnnotationElement{constructor(parameters){super(parameters),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class CaretAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}class InkAnnotationElement extends AnnotationElement{#polylinesGroupElement=null;#polylines=[];constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=this.data.it==="InkHighlight"?AnnotationEditorType.HIGHLIGHT:AnnotationEditorType.INK}#getTransform(rotation,rect){switch(rotation){case 90:return{transform:`rotate(90) translate(${-rect[0]},${rect[1]}) scale(1,-1)`,width:rect[3]-rect[1],height:rect[2]-rect[0]};case 180:return{transform:`rotate(180) translate(${-rect[2]},${rect[1]}) scale(1,-1)`,width:rect[2]-rect[0],height:rect[3]-rect[1]};case 270:return{transform:`rotate(270) translate(${-rect[2]},${rect[3]}) scale(1,-1)`,width:rect[3]-rect[1],height:rect[2]-rect[0]};default:return{transform:`translate(${-rect[0]},${rect[3]}) scale(1,-1)`,width:rect[2]-rect[0],height:rect[3]-rect[1]}}}render(){this.container.classList.add(this.containerClassName);const{data:{rect,rotation,inkLists,borderStyle,popupRef}}=this,{transform,width,height}=this.#getTransform(rotation,rect),svg=this.svgFactory.create(width,height,!0),g=this.#polylinesGroupElement=this.svgFactory.createElement("svg:g");svg.append(g),g.setAttribute("stroke-width",borderStyle.width||1),g.setAttribute("stroke-linecap","round"),g.setAttribute("stroke-linejoin","round"),g.setAttribute("stroke-miterlimit",10),g.setAttribute("stroke","transparent"),g.setAttribute("fill","transparent"),g.setAttribute("transform",transform);for(let i=0,ii=inkLists.length;i<ii;i++){const polyline=this.svgFactory.createElement(this.svgElementName);this.#polylines.push(polyline),polyline.setAttribute("points",inkLists[i].join(",")),g.append(polyline)}return!popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(svg),this._editOnDoubleClick(),this.container}updateEdited(params){super.updateEdited(params);const{thickness,points,rect}=params,g=this.#polylinesGroupElement;if(thickness>=0&&g.setAttribute("stroke-width",thickness||1),points)for(let i=0,ii=this.#polylines.length;i<ii;i++)this.#polylines[i].setAttribute("points",points[i].join(","));if(rect){const{transform,width,height}=this.#getTransform(this.data.rotation,rect);g.parentElement.setAttribute("viewBox",`0 0 ${width} ${height}`),g.setAttribute("transform",transform)}}getElementsToTriggerPopup(){return this.#polylines}addHighlightArea(){this.container.classList.add("highlightArea")}}class HighlightAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=AnnotationEditorType.HIGHLIGHT}render(){const{data:{overlaidText,popupRef}}=this;if(!popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),overlaidText){const mark=document.createElement("mark");mark.classList.add("overlaidText"),mark.textContent=overlaidText,this.container.append(mark)}return this.container}}class UnderlineAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText,popupRef}}=this;if(!popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),overlaidText){const underline=document.createElement("u");underline.classList.add("overlaidText"),underline.textContent=overlaidText,this.container.append(underline)}return this.container}}class SquigglyAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText,popupRef}}=this;if(!popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),overlaidText){const underline=document.createElement("u");underline.classList.add("overlaidText"),underline.textContent=overlaidText,this.container.append(underline)}return this.container}}class StrikeOutAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText,popupRef}}=this;if(!popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),overlaidText){const strikeout=document.createElement("s");strikeout.classList.add("overlaidText"),strikeout.textContent=overlaidText,this.container.append(strikeout)}return this.container}}class StampAnnotationElement extends AnnotationElement{constructor(parameters){super(parameters,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=AnnotationEditorType.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class FileAttachmentAnnotationElement extends AnnotationElement{#trigger=null;constructor(parameters){super(parameters,{isRenderable:!0});const{file}=this.data;this.filename=file.filename,this.content=file.content,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...file})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container,data}=this;let trigger;data.hasAppearance||data.fillAlpha===0?trigger=document.createElement("div"):(trigger=document.createElement("img"),trigger.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(data.name)?"paperclip":"pushpin"}.svg`,data.fillAlpha&&data.fillAlpha<1&&(trigger.style=`filter: opacity(${Math.round(data.fillAlpha*100)}%);`)),trigger.addEventListener("dblclick",this.#download.bind(this)),this.#trigger=trigger;const{isMac}=util_FeatureTest.platform;return container.addEventListener("keydown",evt=>{evt.key==="Enter"&&(isMac?evt.metaKey:evt.ctrlKey)&&this.#download()}),!data.popupRef&&this.hasPopupData?this._createPopup():trigger.classList.add("popupTriggerArea"),container.append(trigger),container}getElementsToTriggerPopup(){return this.#trigger}addHighlightArea(){this.container.classList.add("highlightArea")}#download(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class AnnotationLayer{#accessibilityManager=null;#annotationCanvasMap=null;#editableAnnotations=new Map;#structTreeLayer=null;constructor({div,accessibilityManager,annotationCanvasMap,annotationEditorUIManager,page,viewport,structTreeLayer}){this.div=div,this.#accessibilityManager=accessibilityManager,this.#annotationCanvasMap=annotationCanvasMap,this.#structTreeLayer=structTreeLayer||null,this.page=page,this.viewport=viewport,this.zIndex=0,this._annotationEditorUIManager=annotationEditorUIManager}hasEditableAnnotations(){return this.#editableAnnotations.size>0}async#appendElement(element,id,popupElements){const contentElement=element.firstChild||element,annotationId=contentElement.id=`${AnnotationPrefix}${id}`,ariaAttributes=await this.#structTreeLayer?.getAriaAttributes(annotationId);if(ariaAttributes)for(const[key,value]of ariaAttributes)contentElement.setAttribute(key,value);popupElements?popupElements.at(-1).container.after(element):(this.div.append(element),this.#accessibilityManager?.moveElementInDOM(this.div,element,contentElement,!1))}async render(params){const{annotations}=params,layer=this.div;setLayerDimensions(layer,this.viewport);const popupToElements=new Map,elementParams={data:null,layer,linkService:params.linkService,downloadManager:params.downloadManager,imageResourcesPath:params.imageResourcesPath||"",renderForms:params.renderForms!==!1,svgFactory:new DOMSVGFactory,annotationStorage:params.annotationStorage||new AnnotationStorage,enableScripting:params.enableScripting===!0,hasJSActions:params.hasJSActions,fieldObjects:params.fieldObjects,parent:this,elements:null};for(const data of annotations){if(data.noHTML)continue;const isPopupAnnotation=data.annotationType===AnnotationType.POPUP;if(isPopupAnnotation){const elements=popupToElements.get(data.id);if(!elements)continue;elementParams.elements=elements}else if(data.rect[2]===data.rect[0]||data.rect[3]===data.rect[1])continue;elementParams.data=data;const element=AnnotationElementFactory.create(elementParams);if(!element.isRenderable)continue;if(!isPopupAnnotation&&data.popupRef){const elements=popupToElements.get(data.popupRef);elements?elements.push(element):popupToElements.set(data.popupRef,[element])}const rendered=element.render();data.hidden&&(rendered.style.visibility="hidden"),await this.#appendElement(rendered,data.id,elementParams.elements),element._isEditable&&(this.#editableAnnotations.set(element.data.id,element),this._annotationEditorUIManager?.renderAnnotationElement(element))}this.#setAnnotationCanvasMap()}async addLinkAnnotations(annotations,linkService){const elementParams={data:null,layer:this.div,linkService,svgFactory:new DOMSVGFactory,parent:this};for(const data of annotations){data.borderStyle||=AnnotationLayer._defaultBorderStyle,elementParams.data=data;const element=AnnotationElementFactory.create(elementParams);if(!element.isRenderable)continue;const rendered=element.render();await this.#appendElement(rendered,data.id,null)}}update({viewport}){const layer=this.div;this.viewport=viewport,setLayerDimensions(layer,{rotation:viewport.rotation}),this.#setAnnotationCanvasMap(),layer.hidden=!1}#setAnnotationCanvasMap(){if(!this.#annotationCanvasMap)return;const layer=this.div;for(const[id,canvas]of this.#annotationCanvasMap){const element=layer.querySelector(`[data-annotation-id="${id}"]`);if(!element)continue;canvas.className="annotationContent";const{firstChild}=element;firstChild?firstChild.nodeName==="CANVAS"?firstChild.replaceWith(canvas):firstChild.classList.contains("annotationContent")?firstChild.after(canvas):firstChild.before(canvas):element.append(canvas);const editableAnnotation=this.#editableAnnotations.get(id);editableAnnotation&&(editableAnnotation._hasNoCanvas?(this._annotationEditorUIManager?.setMissingCanvas(id,element.id,canvas),editableAnnotation._hasNoCanvas=!1):editableAnnotation.canvas=canvas)}this.#annotationCanvasMap.clear()}getEditableAnnotations(){return Array.from(this.#editableAnnotations.values())}getEditableAnnotation(id){return this.#editableAnnotations.get(id)}static get _defaultBorderStyle(){return shadow(this,"_defaultBorderStyle",Object.freeze({width:1,rawWidth:1,style:AnnotationBorderStyleType.SOLID,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}}const EOL_PATTERN=/\r\n?|\n/g;class FreeTextEditor extends AnnotationEditor{#color;#content="";#editorDivId=`${this.id}-editor`;#editModeAC=null;#fontSize;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const proto=FreeTextEditor.prototype,arrowChecker=self=>self.isEmpty(),small=AnnotationEditorUIManager.TRANSLATE_SMALL,big=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],proto.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],proto.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],proto._translateEmpty,{args:[-small,0],checker:arrowChecker}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],proto._translateEmpty,{args:[-big,0],checker:arrowChecker}],[["ArrowRight","mac+ArrowRight"],proto._translateEmpty,{args:[small,0],checker:arrowChecker}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],proto._translateEmpty,{args:[big,0],checker:arrowChecker}],[["ArrowUp","mac+ArrowUp"],proto._translateEmpty,{args:[0,-small],checker:arrowChecker}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],proto._translateEmpty,{args:[0,-big],checker:arrowChecker}],[["ArrowDown","mac+ArrowDown"],proto._translateEmpty,{args:[0,small],checker:arrowChecker}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],proto._translateEmpty,{args:[0,big],checker:arrowChecker}]]))}static _type="freetext";static _editorType=AnnotationEditorType.FREETEXT;constructor(params){super({...params,name:"freeTextEditor"}),this.#color=params.color||FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor,this.#fontSize=params.fontSize||FreeTextEditor._defaultFontSize,this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-freetext-added-alert")}static initialize(l10n,uiManager){AnnotationEditor.initialize(l10n,uiManager);const style=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(style.getPropertyValue("--freetext-padding"))}static updateDefaultParams(type,value){switch(type){case AnnotationEditorParamsType.FREETEXT_SIZE:FreeTextEditor._defaultFontSize=value;break;case AnnotationEditorParamsType.FREETEXT_COLOR:FreeTextEditor._defaultColor=value;break}}updateParams(type,value){switch(type){case AnnotationEditorParamsType.FREETEXT_SIZE:this.#updateFontSize(value);break;case AnnotationEditorParamsType.FREETEXT_COLOR:this.#updateColor(value);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,FreeTextEditor._defaultFontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,this.#fontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,this.#color]]}#updateFontSize(fontSize){const setFontsize=size=>{this.editorDiv.style.fontSize=`calc(${size}px * var(--total-scale-factor))`,this.translate(0,-(size-this.#fontSize)*this.parentScale),this.#fontSize=size,this.#setEditorDimensions()},savedFontsize=this.#fontSize;this.addCommands({cmd:setFontsize.bind(this,fontSize),undo:setFontsize.bind(this,savedFontsize),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}#updateColor(color){const setColor=col=>{this.#color=this.editorDiv.style.color=col},savedColor=this.#color;this.addCommands({cmd:setColor.bind(this,color),undo:setColor.bind(this,savedColor),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(x,y){this._uiManager.translateSelectedEditors(x,y,!0)}getInitialTranslation(){const scale=this.parentScale;return[-FreeTextEditor._internalPadding*scale,-(FreeTextEditor._internalPadding+this.#fontSize)*scale]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(!super.enableEditMode())return!1;this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),this.#editModeAC=new AbortController;const signal=this._uiManager.combinedSignal(this.#editModeAC);return this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal}),!0}disableEditMode(){return super.disableEditMode()?(this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",this.#editorDivId),this._isDraggable=!0,this.#editModeAC?.abort(),this.#editModeAC=null,this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"),!0):!1}focusin(event){this._focusEventsAllowed&&(super.focusin(event),event.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(focus){this.width||(this.enableEditMode(),focus&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}#extractText(){const buffer=[];this.editorDiv.normalize();let prevChild=null;for(const child of this.editorDiv.childNodes)prevChild?.nodeType===Node.TEXT_NODE&&child.nodeName==="BR"||(buffer.push(FreeTextEditor.#getNodeContent(child)),prevChild=child);return buffer.join(`
`)}#setEditorDimensions(){const[parentWidth,parentHeight]=this.parentDimensions;let rect;if(this.isAttachedToDOM)rect=this.div.getBoundingClientRect();else{const{currentLayer,div}=this,savedDisplay=div.style.display,savedVisibility=div.classList.contains("hidden");div.classList.remove("hidden"),div.style.display="hidden",currentLayer.div.append(this.div),rect=div.getBoundingClientRect(),div.remove(),div.style.display=savedDisplay,div.classList.toggle("hidden",savedVisibility)}this.rotation%180===this.parentRotation%180?(this.width=rect.width/parentWidth,this.height=rect.height/parentHeight):(this.width=rect.height/parentWidth,this.height=rect.width/parentHeight),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const savedText=this.#content,newText=this.#content=this.#extractText().trimEnd();if(savedText===newText)return;const setText=text=>{if(this.#content=text,!text){this.remove();return}this.#setContent(),this._uiManager.rebuild(this),this.#setEditorDimensions()};this.addCommands({cmd:()=>{setText(newText)},undo:()=>{setText(savedText)},mustExec:!1}),this.#setEditorDimensions()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}keydown(event){event.target===this.div&&event.key==="Enter"&&(this.enterInEditMode(),event.preventDefault())}editorDivKeydown(event){FreeTextEditor._keyboardManager.exec(this,event)}editorDivFocus(event){this.isEditing=!0}editorDivBlur(event){this.isEditing=!1}editorDivInput(event){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}get canChangeContent(){return!0}render(){if(this.div)return this.div;let baseX,baseY;(this._isCopy||this.annotationElementId)&&(baseX=this.x,baseY=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",this.#editorDivId),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;const{style}=this.editorDiv;if(style.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,style.color=this.#color,this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),this._isCopy||this.annotationElementId){const[parentWidth,parentHeight]=this.parentDimensions;if(this.annotationElementId){const{position}=this._initialData;let[tx,ty]=this.getInitialTranslation();[tx,ty]=this.pageTranslationToScreen(tx,ty);const[pageWidth,pageHeight]=this.pageDimensions,[pageX,pageY]=this.pageTranslation;let posX,posY;switch(this.rotation){case 0:posX=baseX+(position[0]-pageX)/pageWidth,posY=baseY+this.height-(position[1]-pageY)/pageHeight;break;case 90:posX=baseX+(position[0]-pageX)/pageWidth,posY=baseY-(position[1]-pageY)/pageHeight,[tx,ty]=[ty,-tx];break;case 180:posX=baseX-this.width+(position[0]-pageX)/pageWidth,posY=baseY-(position[1]-pageY)/pageHeight,[tx,ty]=[-tx,-ty];break;case 270:posX=baseX+(position[0]-pageX-this.height*pageHeight)/pageWidth,posY=baseY+(position[1]-pageY-this.width*pageWidth)/pageHeight,[tx,ty]=[-ty,tx];break}this.setAt(posX*parentWidth,posY*parentHeight,tx,ty)}else this._moveAfterPaste(baseX,baseY);this.#setContent(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}static#getNodeContent(node){return(node.nodeType===Node.TEXT_NODE?node.nodeValue:node.innerText).replaceAll(EOL_PATTERN,"")}editorDivPaste(event){const clipboardData=event.clipboardData||window.clipboardData,{types}=clipboardData;if(types.length===1&&types[0]==="text/plain")return;event.preventDefault();const paste=FreeTextEditor.#deserializeContent(clipboardData.getData("text")||"").replaceAll(EOL_PATTERN,`
`);if(!paste)return;const selection=window.getSelection();if(!selection.rangeCount)return;this.editorDiv.normalize(),selection.deleteFromDocument();const range=selection.getRangeAt(0);if(!paste.includes(`
`)){range.insertNode(document.createTextNode(paste)),this.editorDiv.normalize(),selection.collapseToStart();return}const{startContainer,startOffset}=range,bufferBefore=[],bufferAfter=[];if(startContainer.nodeType===Node.TEXT_NODE){const parent=startContainer.parentElement;if(bufferAfter.push(startContainer.nodeValue.slice(startOffset).replaceAll(EOL_PATTERN,"")),parent!==this.editorDiv){let buffer=bufferBefore;for(const child of this.editorDiv.childNodes){if(child===parent){buffer=bufferAfter;continue}buffer.push(FreeTextEditor.#getNodeContent(child))}}bufferBefore.push(startContainer.nodeValue.slice(0,startOffset).replaceAll(EOL_PATTERN,""))}else if(startContainer===this.editorDiv){let buffer=bufferBefore,i=0;for(const child of this.editorDiv.childNodes)i++===startOffset&&(buffer=bufferAfter),buffer.push(FreeTextEditor.#getNodeContent(child))}this.#content=`${bufferBefore.join(`
`)}${paste}${bufferAfter.join(`
`)}`,this.#setContent();const newRange=new Range;let beforeLength=Math.sumPrecise(bufferBefore.map(line=>line.length));for(const{firstChild}of this.editorDiv.childNodes)if(firstChild.nodeType===Node.TEXT_NODE){const length=firstChild.nodeValue.length;if(beforeLength<=length){newRange.setStart(firstChild,beforeLength),newRange.setEnd(firstChild,beforeLength);break}beforeLength-=length}selection.removeAllRanges(),selection.addRange(newRange)}#setContent(){if(this.editorDiv.replaceChildren(),!!this.#content)for(const line of this.#content.split(`
`)){const div=document.createElement("div");div.append(line?document.createTextNode(line):document.createElement("br")),this.editorDiv.append(div)}}#serializeContent(){return this.#content.replaceAll(" "," ")}static#deserializeContent(content){return content.replaceAll(" "," ")}get contentDiv(){return this.editorDiv}static async deserialize(data,parent,uiManager){let initialData=null;if(data instanceof FreeTextAnnotationElement){const{data:{defaultAppearanceData:{fontSize,fontColor},rect,rotation,id,popupRef},textContent,textPosition,parent:{page:{pageNumber}}}=data;if(!textContent||textContent.length===0)return null;initialData=data={annotationType:AnnotationEditorType.FREETEXT,color:Array.from(fontColor),fontSize,value:textContent.join(`
`),position:textPosition,pageIndex:pageNumber-1,rect:rect.slice(0),rotation,annotationElementId:id,id,deleted:!1,popupRef}}const editor=await super.deserialize(data,parent,uiManager);return editor.#fontSize=data.fontSize,editor.#color=Util.makeHexColor(...data.color),editor.#content=FreeTextEditor.#deserializeContent(data.value),editor._initialData=initialData,editor}serialize(isForCopying=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const padding=FreeTextEditor._internalPadding*this.parentScale,rect=this.getRect(padding,padding),color=AnnotationEditor._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.#color),serialized={annotationType:AnnotationEditorType.FREETEXT,color,fontSize:this.#fontSize,value:this.#serializeContent(),pageIndex:this.pageIndex,rect,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return isForCopying?(serialized.isCopy=!0,serialized):this.annotationElementId&&!this.#hasElementChanged(serialized)?null:(serialized.id=this.annotationElementId,serialized)}#hasElementChanged(serialized){const{value,fontSize,color,pageIndex}=this._initialData;return this._hasBeenMoved||serialized.value!==value||serialized.fontSize!==fontSize||serialized.color.some((c,i)=>c!==color[i])||serialized.pageIndex!==pageIndex}renderAnnotationElement(annotation){const content=super.renderAnnotationElement(annotation);if(this.deleted)return content;const{style}=content;style.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,style.color=this.#color,content.replaceChildren();for(const line of this.#content.split(`
`)){const div=document.createElement("div");div.append(line?document.createTextNode(line):document.createElement("br")),content.append(div)}const padding=FreeTextEditor._internalPadding*this.parentScale;return annotation.updateEdited({rect:this.getRect(padding,padding),popupContent:this.#content}),content}resetAnnotationElement(annotation){super.resetAnnotationElement(annotation),annotation.resetEdited()}}class Outline{static PRECISION=1e-4;toSVGPath(){unreachable("Abstract method `toSVGPath` must be implemented.")}get box(){unreachable("Abstract getter `box` must be implemented.")}serialize(_bbox,_rotation){unreachable("Abstract method `serialize` must be implemented.")}static _rescale(src,tx,ty,sx,sy,dest){dest||=new Float32Array(src.length);for(let i=0,ii=src.length;i<ii;i+=2)dest[i]=tx+src[i]*sx,dest[i+1]=ty+src[i+1]*sy;return dest}static _rescaleAndSwap(src,tx,ty,sx,sy,dest){dest||=new Float32Array(src.length);for(let i=0,ii=src.length;i<ii;i+=2)dest[i]=tx+src[i+1]*sx,dest[i+1]=ty+src[i]*sy;return dest}static _translate(src,tx,ty,dest){dest||=new Float32Array(src.length);for(let i=0,ii=src.length;i<ii;i+=2)dest[i]=tx+src[i],dest[i+1]=ty+src[i+1];return dest}static svgRound(x){return Math.round(x*1e4)}static _normalizePoint(x,y,parentWidth,parentHeight,rotation){switch(rotation){case 90:return[1-y/parentWidth,x/parentHeight];case 180:return[1-x/parentWidth,1-y/parentHeight];case 270:return[y/parentWidth,1-x/parentHeight];default:return[x/parentWidth,y/parentHeight]}}static _normalizePagePoint(x,y,rotation){switch(rotation){case 90:return[1-y,x];case 180:return[1-x,1-y];case 270:return[y,1-x];default:return[x,y]}}static createBezierPoints(x1,y1,x2,y2,x3,y3){return[(x1+5*x2)/6,(y1+5*y2)/6,(5*x2+x3)/6,(5*y2+y3)/6,(x2+x3)/2,(y2+y3)/2]}}class FreeDrawOutliner{#box;#bottom=[];#innerMargin;#isLTR;#top=[];#last=new Float32Array(18);#lastX;#lastY;#min;#min_dist;#scaleFactor;#thickness;#points=[];static#MIN_DIST=8;static#MIN_DIFF=2;static#MIN=FreeDrawOutliner.#MIN_DIST+FreeDrawOutliner.#MIN_DIFF;constructor({x,y},box,scaleFactor,thickness,isLTR,innerMargin=0){this.#box=box,this.#thickness=thickness*scaleFactor,this.#isLTR=isLTR,this.#last.set([NaN,NaN,NaN,NaN,x,y],6),this.#innerMargin=innerMargin,this.#min_dist=FreeDrawOutliner.#MIN_DIST*scaleFactor,this.#min=FreeDrawOutliner.#MIN*scaleFactor,this.#scaleFactor=scaleFactor,this.#points.push(x,y)}isEmpty(){return isNaN(this.#last[8])}#getLastCoords(){const lastTop=this.#last.subarray(4,6),lastBottom=this.#last.subarray(16,18),[x,y,width,height]=this.#box;return[(this.#lastX+(lastTop[0]-lastBottom[0])/2-x)/width,(this.#lastY+(lastTop[1]-lastBottom[1])/2-y)/height,(this.#lastX+(lastBottom[0]-lastTop[0])/2-x)/width,(this.#lastY+(lastBottom[1]-lastTop[1])/2-y)/height]}add({x,y}){this.#lastX=x,this.#lastY=y;const[layerX,layerY,layerWidth,layerHeight]=this.#box;let[x1,y1,x2,y2]=this.#last.subarray(8,12);const diffX=x-x2,diffY=y-y2,d=Math.hypot(diffX,diffY);if(d<this.#min)return!1;const diffD=d-this.#min_dist,K=diffD/d,shiftX=K*diffX,shiftY=K*diffY;let x0=x1,y0=y1;x1=x2,y1=y2,x2+=shiftX,y2+=shiftY,this.#points?.push(x,y);const nX=-shiftY/diffD,nY=shiftX/diffD,thX=nX*this.#thickness,thY=nY*this.#thickness;return this.#last.set(this.#last.subarray(2,8),0),this.#last.set([x2+thX,y2+thY],4),this.#last.set(this.#last.subarray(14,18),12),this.#last.set([x2-thX,y2-thY],16),isNaN(this.#last[6])?(this.#top.length===0&&(this.#last.set([x1+thX,y1+thY],2),this.#top.push(NaN,NaN,NaN,NaN,(x1+thX-layerX)/layerWidth,(y1+thY-layerY)/layerHeight),this.#last.set([x1-thX,y1-thY],14),this.#bottom.push(NaN,NaN,NaN,NaN,(x1-thX-layerX)/layerWidth,(y1-thY-layerY)/layerHeight)),this.#last.set([x0,y0,x1,y1,x2,y2],6),!this.isEmpty()):(this.#last.set([x0,y0,x1,y1,x2,y2],6),Math.abs(Math.atan2(y0-y1,x0-x1)-Math.atan2(shiftY,shiftX))<Math.PI/2?([x1,y1,x2,y2]=this.#last.subarray(2,6),this.#top.push(NaN,NaN,NaN,NaN,((x1+x2)/2-layerX)/layerWidth,((y1+y2)/2-layerY)/layerHeight),[x1,y1,x0,y0]=this.#last.subarray(14,18),this.#bottom.push(NaN,NaN,NaN,NaN,((x0+x1)/2-layerX)/layerWidth,((y0+y1)/2-layerY)/layerHeight),!0):([x0,y0,x1,y1,x2,y2]=this.#last.subarray(0,6),this.#top.push(((x0+5*x1)/6-layerX)/layerWidth,((y0+5*y1)/6-layerY)/layerHeight,((5*x1+x2)/6-layerX)/layerWidth,((5*y1+y2)/6-layerY)/layerHeight,((x1+x2)/2-layerX)/layerWidth,((y1+y2)/2-layerY)/layerHeight),[x2,y2,x1,y1,x0,y0]=this.#last.subarray(12,18),this.#bottom.push(((x0+5*x1)/6-layerX)/layerWidth,((y0+5*y1)/6-layerY)/layerHeight,((5*x1+x2)/6-layerX)/layerWidth,((5*y1+y2)/6-layerY)/layerHeight,((x1+x2)/2-layerX)/layerWidth,((y1+y2)/2-layerY)/layerHeight),!0))}toSVGPath(){if(this.isEmpty())return"";const top=this.#top,bottom=this.#bottom;if(isNaN(this.#last[6])&&!this.isEmpty())return this.#toSVGPathTwoPoints();const buffer=[];buffer.push(`M${top[4]} ${top[5]}`);for(let i=6;i<top.length;i+=6)isNaN(top[i])?buffer.push(`L${top[i+4]} ${top[i+5]}`):buffer.push(`C${top[i]} ${top[i+1]} ${top[i+2]} ${top[i+3]} ${top[i+4]} ${top[i+5]}`);this.#toSVGPathEnd(buffer);for(let i=bottom.length-6;i>=6;i-=6)isNaN(bottom[i])?buffer.push(`L${bottom[i+4]} ${bottom[i+5]}`):buffer.push(`C${bottom[i]} ${bottom[i+1]} ${bottom[i+2]} ${bottom[i+3]} ${bottom[i+4]} ${bottom[i+5]}`);return this.#toSVGPathStart(buffer),buffer.join(" ")}#toSVGPathTwoPoints(){const[x,y,width,height]=this.#box,[lastTopX,lastTopY,lastBottomX,lastBottomY]=this.#getLastCoords();return`M${(this.#last[2]-x)/width} ${(this.#last[3]-y)/height} L${(this.#last[4]-x)/width} ${(this.#last[5]-y)/height} L${lastTopX} ${lastTopY} L${lastBottomX} ${lastBottomY} L${(this.#last[16]-x)/width} ${(this.#last[17]-y)/height} L${(this.#last[14]-x)/width} ${(this.#last[15]-y)/height} Z`}#toSVGPathStart(buffer){const bottom=this.#bottom;buffer.push(`L${bottom[4]} ${bottom[5]} Z`)}#toSVGPathEnd(buffer){const[x,y,width,height]=this.#box,lastTop=this.#last.subarray(4,6),lastBottom=this.#last.subarray(16,18),[lastTopX,lastTopY,lastBottomX,lastBottomY]=this.#getLastCoords();buffer.push(`L${(lastTop[0]-x)/width} ${(lastTop[1]-y)/height} L${lastTopX} ${lastTopY} L${lastBottomX} ${lastBottomY} L${(lastBottom[0]-x)/width} ${(lastBottom[1]-y)/height}`)}newFreeDrawOutline(outline,points,box,scaleFactor,innerMargin,isLTR){return new FreeDrawOutline(outline,points,box,scaleFactor,innerMargin,isLTR)}getOutlines(){const top=this.#top,bottom=this.#bottom,last=this.#last,[layerX,layerY,layerWidth,layerHeight]=this.#box,points=new Float32Array((this.#points?.length??0)+2);for(let i=0,ii=points.length-2;i<ii;i+=2)points[i]=(this.#points[i]-layerX)/layerWidth,points[i+1]=(this.#points[i+1]-layerY)/layerHeight;if(points[points.length-2]=(this.#lastX-layerX)/layerWidth,points[points.length-1]=(this.#lastY-layerY)/layerHeight,isNaN(last[6])&&!this.isEmpty())return this.#getOutlineTwoPoints(points);const outline=new Float32Array(this.#top.length+24+this.#bottom.length);let N=top.length;for(let i=0;i<N;i+=2){if(isNaN(top[i])){outline[i]=outline[i+1]=NaN;continue}outline[i]=top[i],outline[i+1]=top[i+1]}N=this.#getOutlineEnd(outline,N);for(let i=bottom.length-6;i>=6;i-=6)for(let j=0;j<6;j+=2){if(isNaN(bottom[i+j])){outline[N]=outline[N+1]=NaN,N+=2;continue}outline[N]=bottom[i+j],outline[N+1]=bottom[i+j+1],N+=2}return this.#getOutlineStart(outline,N),this.newFreeDrawOutline(outline,points,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineTwoPoints(points){const last=this.#last,[layerX,layerY,layerWidth,layerHeight]=this.#box,[lastTopX,lastTopY,lastBottomX,lastBottomY]=this.#getLastCoords(),outline=new Float32Array(36);return outline.set([NaN,NaN,NaN,NaN,(last[2]-layerX)/layerWidth,(last[3]-layerY)/layerHeight,NaN,NaN,NaN,NaN,(last[4]-layerX)/layerWidth,(last[5]-layerY)/layerHeight,NaN,NaN,NaN,NaN,lastTopX,lastTopY,NaN,NaN,NaN,NaN,lastBottomX,lastBottomY,NaN,NaN,NaN,NaN,(last[16]-layerX)/layerWidth,(last[17]-layerY)/layerHeight,NaN,NaN,NaN,NaN,(last[14]-layerX)/layerWidth,(last[15]-layerY)/layerHeight],0),this.newFreeDrawOutline(outline,points,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineStart(outline,pos){const bottom=this.#bottom;return outline.set([NaN,NaN,NaN,NaN,bottom[4],bottom[5]],pos),pos+=6}#getOutlineEnd(outline,pos){const lastTop=this.#last.subarray(4,6),lastBottom=this.#last.subarray(16,18),[layerX,layerY,layerWidth,layerHeight]=this.#box,[lastTopX,lastTopY,lastBottomX,lastBottomY]=this.#getLastCoords();return outline.set([NaN,NaN,NaN,NaN,(lastTop[0]-layerX)/layerWidth,(lastTop[1]-layerY)/layerHeight,NaN,NaN,NaN,NaN,lastTopX,lastTopY,NaN,NaN,NaN,NaN,lastBottomX,lastBottomY,NaN,NaN,NaN,NaN,(lastBottom[0]-layerX)/layerWidth,(lastBottom[1]-layerY)/layerHeight],pos),pos+=24}}class FreeDrawOutline extends Outline{#box;#bbox=new Float32Array(4);#innerMargin;#isLTR;#points;#scaleFactor;#outline;constructor(outline,points,box,scaleFactor,innerMargin,isLTR){super(),this.#outline=outline,this.#points=points,this.#box=box,this.#scaleFactor=scaleFactor,this.#innerMargin=innerMargin,this.#isLTR=isLTR,this.lastPoint=[NaN,NaN],this.#computeMinMax(isLTR);const[x,y,width,height]=this.#bbox;for(let i=0,ii=outline.length;i<ii;i+=2)outline[i]=(outline[i]-x)/width,outline[i+1]=(outline[i+1]-y)/height;for(let i=0,ii=points.length;i<ii;i+=2)points[i]=(points[i]-x)/width,points[i+1]=(points[i+1]-y)/height}toSVGPath(){const buffer=[`M${this.#outline[4]} ${this.#outline[5]}`];for(let i=6,ii=this.#outline.length;i<ii;i+=6){if(isNaN(this.#outline[i])){buffer.push(`L${this.#outline[i+4]} ${this.#outline[i+5]}`);continue}buffer.push(`C${this.#outline[i]} ${this.#outline[i+1]} ${this.#outline[i+2]} ${this.#outline[i+3]} ${this.#outline[i+4]} ${this.#outline[i+5]}`)}return buffer.push("Z"),buffer.join(" ")}serialize([blX,blY,trX,trY],rotation){const width=trX-blX,height=trY-blY;let outline,points;switch(rotation){case 0:outline=Outline._rescale(this.#outline,blX,trY,width,-height),points=Outline._rescale(this.#points,blX,trY,width,-height);break;case 90:outline=Outline._rescaleAndSwap(this.#outline,blX,blY,width,height),points=Outline._rescaleAndSwap(this.#points,blX,blY,width,height);break;case 180:outline=Outline._rescale(this.#outline,trX,blY,-width,height),points=Outline._rescale(this.#points,trX,blY,-width,height);break;case 270:outline=Outline._rescaleAndSwap(this.#outline,trX,trY,-width,-height),points=Outline._rescaleAndSwap(this.#points,trX,trY,-width,-height);break}return{outline:Array.from(outline),points:[Array.from(points)]}}#computeMinMax(isLTR){const outline=this.#outline;let lastX=outline[4],lastY=outline[5];const minMax=[lastX,lastY,lastX,lastY];let lastPointX=lastX,lastPointY=lastY;const ltrCallback=isLTR?Math.max:Math.min;for(let i=6,ii=outline.length;i<ii;i+=6){const x=outline[i+4],y=outline[i+5];if(isNaN(outline[i]))Util.pointBoundingBox(x,y,minMax),lastPointY<y?(lastPointX=x,lastPointY=y):lastPointY===y&&(lastPointX=ltrCallback(lastPointX,x));else{const bbox2=[1/0,1/0,-1/0,-1/0];Util.bezierBoundingBox(lastX,lastY,...outline.slice(i,i+6),bbox2),Util.rectBoundingBox(...bbox2,minMax),lastPointY<bbox2[3]?(lastPointX=bbox2[2],lastPointY=bbox2[3]):lastPointY===bbox2[3]&&(lastPointX=ltrCallback(lastPointX,bbox2[2]))}lastX=x,lastY=y}const bbox=this.#bbox;bbox[0]=minMax[0]-this.#innerMargin,bbox[1]=minMax[1]-this.#innerMargin,bbox[2]=minMax[2]-minMax[0]+2*this.#innerMargin,bbox[3]=minMax[3]-minMax[1]+2*this.#innerMargin,this.lastPoint=[lastPointX,lastPointY]}get box(){return this.#bbox}newOutliner(point,box,scaleFactor,thickness,isLTR,innerMargin=0){return new FreeDrawOutliner(point,box,scaleFactor,thickness,isLTR,innerMargin)}getNewOutline(thickness,innerMargin){const[x,y,width,height]=this.#bbox,[layerX,layerY,layerWidth,layerHeight]=this.#box,sx=width*layerWidth,sy=height*layerHeight,tx=x*layerWidth+layerX,ty=y*layerHeight+layerY,outliner=this.newOutliner({x:this.#points[0]*sx+tx,y:this.#points[1]*sy+ty},this.#box,this.#scaleFactor,thickness,this.#isLTR,innerMargin??this.#innerMargin);for(let i=2;i<this.#points.length;i+=2)outliner.add({x:this.#points[i]*sx+tx,y:this.#points[i+1]*sy+ty});return outliner.getOutlines()}}class HighlightOutliner{#box;#lastPoint;#verticalEdges=[];#intervals=[];constructor(boxes,borderWidth=0,innerMargin=0,isLTR=!0){const minMax=[1/0,1/0,-1/0,-1/0],EPSILON=10**-4;for(const{x,y,width,height}of boxes){const x1=Math.floor((x-borderWidth)/EPSILON)*EPSILON,x2=Math.ceil((x+width+borderWidth)/EPSILON)*EPSILON,y1=Math.floor((y-borderWidth)/EPSILON)*EPSILON,y2=Math.ceil((y+height+borderWidth)/EPSILON)*EPSILON,left=[x1,y1,y2,!0],right=[x2,y1,y2,!1];this.#verticalEdges.push(left,right),Util.rectBoundingBox(x1,y1,x2,y2,minMax)}const bboxWidth=minMax[2]-minMax[0]+2*innerMargin,bboxHeight=minMax[3]-minMax[1]+2*innerMargin,shiftedMinX=minMax[0]-innerMargin,shiftedMinY=minMax[1]-innerMargin,lastEdge=this.#verticalEdges.at(isLTR?-1:-2),lastPoint=[lastEdge[0],lastEdge[2]];for(const edge of this.#verticalEdges){const[x,y1,y2]=edge;edge[0]=(x-shiftedMinX)/bboxWidth,edge[1]=(y1-shiftedMinY)/bboxHeight,edge[2]=(y2-shiftedMinY)/bboxHeight}this.#box=new Float32Array([shiftedMinX,shiftedMinY,bboxWidth,bboxHeight]),this.#lastPoint=lastPoint}getOutlines(){this.#verticalEdges.sort((a,b)=>a[0]-b[0]||a[1]-b[1]||a[2]-b[2]);const outlineVerticalEdges=[];for(const edge of this.#verticalEdges)edge[3]?(outlineVerticalEdges.push(...this.#breakEdge(edge)),this.#insert(edge)):(this.#remove(edge),outlineVerticalEdges.push(...this.#breakEdge(edge)));return this.#getOutlines(outlineVerticalEdges)}#getOutlines(outlineVerticalEdges){const edges=[],allEdges=new Set;for(const edge of outlineVerticalEdges){const[x,y1,y2]=edge;edges.push([x,y1,edge],[x,y2,edge])}edges.sort((a,b)=>a[1]-b[1]||a[0]-b[0]);for(let i=0,ii=edges.length;i<ii;i+=2){const edge1=edges[i][2],edge2=edges[i+1][2];edge1.push(edge2),edge2.push(edge1),allEdges.add(edge1),allEdges.add(edge2)}const outlines=[];let outline;for(;allEdges.size>0;){const edge=allEdges.values().next().value;let[x,y1,y2,edge1,edge2]=edge;allEdges.delete(edge);let lastPointX=x,lastPointY=y1;for(outline=[x,y2],outlines.push(outline);;){let e;if(allEdges.has(edge1))e=edge1;else if(allEdges.has(edge2))e=edge2;else break;allEdges.delete(e),[x,y1,y2,edge1,edge2]=e,lastPointX!==x&&(outline.push(lastPointX,lastPointY,x,lastPointY===y1?y1:y2),lastPointX=x),lastPointY=lastPointY===y1?y2:y1}outline.push(lastPointX,lastPointY)}return new HighlightOutline(outlines,this.#box,this.#lastPoint)}#binarySearch(y){const array=this.#intervals;let start=0,end=array.length-1;for(;start<=end;){const middle=start+end>>1,y1=array[middle][0];if(y1===y)return middle;y1<y?start=middle+1:end=middle-1}return end+1}#insert([,y1,y2]){const index=this.#binarySearch(y1);this.#intervals.splice(index,0,[y1,y2])}#remove([,y1,y2]){const index=this.#binarySearch(y1);for(let i=index;i<this.#intervals.length;i++){const[start,end]=this.#intervals[i];if(start!==y1)break;if(start===y1&&end===y2){this.#intervals.splice(i,1);return}}for(let i=index-1;i>=0;i--){const[start,end]=this.#intervals[i];if(start!==y1)break;if(start===y1&&end===y2){this.#intervals.splice(i,1);return}}}#breakEdge(edge){const[x,y1,y2]=edge,results=[[x,y1,y2]],index=this.#binarySearch(y2);for(let i=0;i<index;i++){const[start,end]=this.#intervals[i];for(let j=0,jj=results.length;j<jj;j++){const[,y3,y4]=results[j];if(!(end<=y3||y4<=start)){if(y3>=start){if(y4>end)results[j][1]=end;else{if(jj===1)return[];results.splice(j,1),j--,jj--}continue}results[j][2]=start,y4>end&&results.push([x,end,y4])}}}return results}}class HighlightOutline extends Outline{#box;#outlines;constructor(outlines,box,lastPoint){super(),this.#outlines=outlines,this.#box=box,this.lastPoint=lastPoint}toSVGPath(){const buffer=[];for(const polygon of this.#outlines){let[prevX,prevY]=polygon;buffer.push(`M${prevX} ${prevY}`);for(let i=2;i<polygon.length;i+=2){const x=polygon[i],y=polygon[i+1];x===prevX?(buffer.push(`V${y}`),prevY=y):y===prevY&&(buffer.push(`H${x}`),prevX=x)}buffer.push("Z")}return buffer.join(" ")}serialize([blX,blY,trX,trY],_rotation){const outlines=[],width=trX-blX,height=trY-blY;for(const outline of this.#outlines){const points=new Array(outline.length);for(let i=0;i<outline.length;i+=2)points[i]=blX+outline[i]*width,points[i+1]=trY-outline[i+1]*height;outlines.push(points)}return outlines}get box(){return this.#box}get classNamesForOutlining(){return["highlightOutline"]}}class FreeHighlightOutliner extends FreeDrawOutliner{newFreeDrawOutline(outline,points,box,scaleFactor,innerMargin,isLTR){return new FreeHighlightOutline(outline,points,box,scaleFactor,innerMargin,isLTR)}}class FreeHighlightOutline extends FreeDrawOutline{newOutliner(point,box,scaleFactor,thickness,isLTR,innerMargin=0){return new FreeHighlightOutliner(point,box,scaleFactor,thickness,isLTR,innerMargin)}}class ColorPicker{#button=null;#buttonSwatch=null;#defaultColor;#dropdown=null;#dropdownWasFromKeyboard=!1;#isMainColorPicker=!1;#editor=null;#eventBus;#openDropdownAC=null;#uiManager=null;#type;static#l10nColor=null;static get _keyboardManager(){return shadow(this,"_keyboardManager",new KeyboardManager([[["Escape","mac+Escape"],ColorPicker.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],ColorPicker.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],ColorPicker.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],ColorPicker.prototype._moveToPrevious],[["Home","mac+Home"],ColorPicker.prototype._moveToBeginning],[["End","mac+End"],ColorPicker.prototype._moveToEnd]]))}constructor({editor=null,uiManager=null}){editor?(this.#isMainColorPicker=!1,this.#type=AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.#editor=editor):(this.#isMainColorPicker=!0,this.#type=AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR),this.#uiManager=editor?._uiManager||uiManager,this.#eventBus=this.#uiManager._eventBus,this.#defaultColor=editor?.color?.toUpperCase()||this.#uiManager?.highlightColors.values().next().value||"#FFFF98",ColorPicker.#l10nColor||=Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"})}renderButton(){const button=this.#button=document.createElement("button");button.className="colorPicker",button.tabIndex="0",button.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),button.ariaHasPopup="true",this.#editor&&(button.ariaControls=`${this.#editor.id}_colorpicker_dropdown`);const signal=this.#uiManager._signal;button.addEventListener("click",this.#openDropdown.bind(this),{signal}),button.addEventListener("keydown",this.#keyDown.bind(this),{signal});const swatch=this.#buttonSwatch=document.createElement("span");return swatch.className="swatch",swatch.ariaHidden="true",swatch.style.backgroundColor=this.#defaultColor,button.append(swatch),button}renderMainDropdown(){const dropdown=this.#dropdown=this.#getDropdownRoot();return dropdown.ariaOrientation="horizontal",dropdown.ariaLabelledBy="highlightColorPickerLabel",dropdown}#getDropdownRoot(){const div=document.createElement("div"),signal=this.#uiManager._signal;div.addEventListener("contextmenu",noContextMenu,{signal}),div.className="dropdown",div.role="listbox",div.ariaMultiSelectable="false",div.ariaOrientation="vertical",div.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown"),this.#editor&&(div.id=`${this.#editor.id}_colorpicker_dropdown`);for(const[name,color]of this.#uiManager.highlightColors){const button=document.createElement("button");button.tabIndex="0",button.role="option",button.setAttribute("data-color",color),button.title=name,button.setAttribute("data-l10n-id",ColorPicker.#l10nColor[name]);const swatch=document.createElement("span");button.append(swatch),swatch.className="swatch",swatch.style.backgroundColor=color,button.ariaSelected=color===this.#defaultColor,button.addEventListener("click",this.#colorSelect.bind(this,color),{signal}),div.append(button)}return div.addEventListener("keydown",this.#keyDown.bind(this),{signal}),div}#colorSelect(color,event){event.stopPropagation(),this.#eventBus.dispatch("switchannotationeditorparams",{source:this,type:this.#type,value:color})}_colorSelectFromKeyboard(event){if(event.target===this.#button){this.#openDropdown(event);return}const color=event.target.getAttribute("data-color");color&&this.#colorSelect(color,event)}_moveToNext(event){if(!this.#isDropdownVisible){this.#openDropdown(event);return}if(event.target===this.#button){this.#dropdown.firstChild?.focus();return}event.target.nextSibling?.focus()}_moveToPrevious(event){if(event.target===this.#dropdown?.firstChild||event.target===this.#button){this.#isDropdownVisible&&this._hideDropdownFromKeyboard();return}this.#isDropdownVisible||this.#openDropdown(event),event.target.previousSibling?.focus()}_moveToBeginning(event){if(!this.#isDropdownVisible){this.#openDropdown(event);return}this.#dropdown.firstChild?.focus()}_moveToEnd(event){if(!this.#isDropdownVisible){this.#openDropdown(event);return}this.#dropdown.lastChild?.focus()}#keyDown(event){ColorPicker._keyboardManager.exec(this,event)}#openDropdown(event){if(this.#isDropdownVisible){this.hideDropdown();return}if(this.#dropdownWasFromKeyboard=event.detail===0,this.#openDropdownAC||(this.#openDropdownAC=new AbortController,window.addEventListener("pointerdown",this.#pointerDown.bind(this),{signal:this.#uiManager.combinedSignal(this.#openDropdownAC)})),this.#button.ariaExpanded="true",this.#dropdown){this.#dropdown.classList.remove("hidden");return}const root=this.#dropdown=this.#getDropdownRoot();this.#button.append(root)}#pointerDown(event){this.#dropdown?.contains(event.target)||this.hideDropdown()}hideDropdown(){this.#dropdown?.classList.add("hidden"),this.#button.ariaExpanded="false",this.#openDropdownAC?.abort(),this.#openDropdownAC=null}get#isDropdownVisible(){return this.#dropdown&&!this.#dropdown.classList.contains("hidden")}_hideDropdownFromKeyboard(){if(!this.#isMainColorPicker){if(!this.#isDropdownVisible){this.#editor?.unselect();return}this.hideDropdown(),this.#button.focus({preventScroll:!0,focusVisible:this.#dropdownWasFromKeyboard})}}updateColor(color){if(this.#buttonSwatch&&(this.#buttonSwatch.style.backgroundColor=color),!this.#dropdown)return;const i=this.#uiManager.highlightColors.values();for(const child of this.#dropdown.children)child.ariaSelected=i.next().value===color.toUpperCase()}destroy(){this.#button?.remove(),this.#button=null,this.#buttonSwatch=null,this.#dropdown?.remove(),this.#dropdown=null}}class HighlightEditor extends AnnotationEditor{#anchorNode=null;#anchorOffset=0;#boxes;#clipPathId=null;#colorPicker=null;#focusOutlines=null;#focusNode=null;#focusOffset=0;#highlightDiv=null;#highlightOutlines=null;#id=null;#isFreeHighlight=!1;#lastPoint=null;#opacity;#outlineId=null;#text="";#thickness;#methodOfCreation="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type="highlight";static _editorType=AnnotationEditorType.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const proto=HighlightEditor.prototype;return shadow(this,"_keyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],proto._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],proto._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],proto._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],proto._moveCaret,{args:[3]}]]))}constructor(params){super({...params,name:"highlightEditor"}),this.color=params.color||HighlightEditor._defaultColor,this.#thickness=params.thickness||HighlightEditor._defaultThickness,this.#opacity=params.opacity||HighlightEditor._defaultOpacity,this.#boxes=params.boxes||null,this.#methodOfCreation=params.methodOfCreation||"",this.#text=params.text||"",this._isDraggable=!1,this.defaultL10nId="pdfjs-editor-highlight-editor",params.highlightId>-1?(this.#isFreeHighlight=!0,this.#createFreeOutlines(params),this.#addToDrawLayer()):this.#boxes&&(this.#anchorNode=params.anchorNode,this.#anchorOffset=params.anchorOffset,this.#focusNode=params.focusNode,this.#focusOffset=params.focusOffset,this.#createOutlines(),this.#addToDrawLayer(),this.rotate(this.rotation)),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-highlight-added-alert")}get telemetryInitialData(){return{action:"added",type:this.#isFreeHighlight?"free_highlight":"highlight",color:this._uiManager.highlightColorNames.get(this.color),thickness:this.#thickness,methodOfCreation:this.#methodOfCreation}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.highlightColorNames.get(this.color)}}static computeTelemetryFinalData(data){return{numberOfColors:data.get("color").size}}#createOutlines(){const outliner=new HighlightOutliner(this.#boxes,.001);this.#highlightOutlines=outliner.getOutlines(),[this.x,this.y,this.width,this.height]=this.#highlightOutlines.box;const outlinerForOutline=new HighlightOutliner(this.#boxes,.0025,.001,this._uiManager.direction==="ltr");this.#focusOutlines=outlinerForOutline.getOutlines();const{lastPoint}=this.#focusOutlines;this.#lastPoint=[(lastPoint[0]-this.x)/this.width,(lastPoint[1]-this.y)/this.height]}#createFreeOutlines({highlightOutlines,highlightId,clipPathId}){this.#highlightOutlines=highlightOutlines;const extraThickness=1.5;if(this.#focusOutlines=highlightOutlines.getNewOutline(this.#thickness/2+extraThickness,.0025),highlightId>=0)this.#id=highlightId,this.#clipPathId=clipPathId,this.parent.drawLayer.finalizeDraw(highlightId,{bbox:highlightOutlines.box,path:{d:highlightOutlines.toSVGPath()}}),this.#outlineId=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},!0);else if(this.parent){const angle=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#id,{bbox:HighlightEditor.#rotateBbox(this.#highlightOutlines.box,(angle-this.rotation+360)%360),path:{d:highlightOutlines.toSVGPath()}}),this.parent.drawLayer.updateProperties(this.#outlineId,{bbox:HighlightEditor.#rotateBbox(this.#focusOutlines.box,angle),path:{d:this.#focusOutlines.toSVGPath()}})}const[x,y,width,height]=highlightOutlines.box;switch(this.rotation){case 0:this.x=x,this.y=y,this.width=width,this.height=height;break;case 90:{const[pageWidth,pageHeight]=this.parentDimensions;this.x=y,this.y=1-x,this.width=width*pageHeight/pageWidth,this.height=height*pageWidth/pageHeight;break}case 180:this.x=1-x,this.y=1-y,this.width=width,this.height=height;break;case 270:{const[pageWidth,pageHeight]=this.parentDimensions;this.x=1-y,this.y=x,this.width=width*pageHeight/pageWidth,this.height=height*pageWidth/pageHeight;break}}const{lastPoint}=this.#focusOutlines;this.#lastPoint=[(lastPoint[0]-x)/width,(lastPoint[1]-y)/height]}static initialize(l10n,uiManager){AnnotationEditor.initialize(l10n,uiManager),HighlightEditor._defaultColor||=uiManager.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(type,value){switch(type){case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:HighlightEditor._defaultColor=value;break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:HighlightEditor._defaultThickness=value;break}}translateInPage(x,y){}get toolbarPosition(){return this.#lastPoint}updateParams(type,value){switch(type){case AnnotationEditorParamsType.HIGHLIGHT_COLOR:this.#updateColor(value);break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:this.#updateThickness(value);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR,HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,HighlightEditor._defaultThickness]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.color||HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,this.#thickness||HighlightEditor._defaultThickness],[AnnotationEditorParamsType.HIGHLIGHT_FREE,this.#isFreeHighlight]]}#updateColor(color){const setColorAndOpacity=(col,opa)=>{this.color=col,this.#opacity=opa,this.parent?.drawLayer.updateProperties(this.#id,{root:{fill:col,"fill-opacity":opa}}),this.#colorPicker?.updateColor(col)},savedColor=this.color,savedOpacity=this.#opacity;this.addCommands({cmd:setColorAndOpacity.bind(this,color,HighlightEditor._defaultOpacity),undo:setColorAndOpacity.bind(this,savedColor,savedOpacity),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.highlightColorNames.get(color)},!0)}#updateThickness(thickness){const savedThickness=this.#thickness,setThickness=th=>{this.#thickness=th,this.#changeThickness(th)};this.addCommands({cmd:setThickness.bind(this,thickness),undo:setThickness.bind(this,savedThickness),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness},!0)}get toolbarButtons(){return this._uiManager.highlightColors?[["colorPicker",this.#colorPicker=new ColorPicker({editor:this})]]:super.toolbarButtons}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(this.#getRotation())}getBaseTranslation(){return[0,0]}getRect(tx,ty){return super.getRect(tx,ty,this.#getRotation())}onceAdded(focus){this.annotationElementId||this.parent.addUndoableEditor(this),focus&&this.div.focus()}remove(){this.#cleanDrawLayer(),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#addToDrawLayer(),this.isAttachedToDOM||this.parent.add(this)))}setParent(parent){let mustBeSelected=!1;this.parent&&!parent?this.#cleanDrawLayer():parent&&(this.#addToDrawLayer(parent),mustBeSelected=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(parent),this.show(this._isVisible),mustBeSelected&&this.select()}#changeThickness(thickness){if(!this.#isFreeHighlight)return;this.#createFreeOutlines({highlightOutlines:this.#highlightOutlines.getNewOutline(thickness/2)}),this.fixAndSetPosition();const[parentWidth,parentHeight]=this.parentDimensions;this.setDims(this.width*parentWidth,this.height*parentHeight)}#cleanDrawLayer(){this.#id===null||!this.parent||(this.parent.drawLayer.remove(this.#id),this.#id=null,this.parent.drawLayer.remove(this.#outlineId),this.#outlineId=null)}#addToDrawLayer(parent=this.parent){this.#id===null&&({id:this.#id,clipPathId:this.#clipPathId}=parent.drawLayer.draw({bbox:this.#highlightOutlines.box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":this.#opacity},rootClass:{highlight:!0,free:this.#isFreeHighlight},path:{d:this.#highlightOutlines.toSVGPath()}},!1,!0),this.#outlineId=parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:this.#isFreeHighlight},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},this.#isFreeHighlight),this.#highlightDiv&&(this.#highlightDiv.style.clipPath=this.#clipPathId))}static#rotateBbox([x,y,width,height],angle){switch(angle){case 90:return[1-y-height,x,height,width];case 180:return[1-x-width,1-y-height,width,height];case 270:return[y,1-x-width,height,width]}return[x,y,width,height]}rotate(angle){const{drawLayer}=this.parent;let box;this.#isFreeHighlight?(angle=(angle-this.rotation+360)%360,box=HighlightEditor.#rotateBbox(this.#highlightOutlines.box,angle)):box=HighlightEditor.#rotateBbox([this.x,this.y,this.width,this.height],angle),drawLayer.updateProperties(this.#id,{bbox:box,root:{"data-main-rotation":angle}}),drawLayer.updateProperties(this.#outlineId,{bbox:HighlightEditor.#rotateBbox(this.#focusOutlines.box,angle),root:{"data-main-rotation":angle}})}render(){if(this.div)return this.div;const div=super.render();this.#text&&(div.setAttribute("aria-label",this.#text),div.setAttribute("role","mark")),this.#isFreeHighlight?div.classList.add("free"):this.div.addEventListener("keydown",this.#keydown.bind(this),{signal:this._uiManager._signal});const highlightDiv=this.#highlightDiv=document.createElement("div");div.append(highlightDiv),highlightDiv.setAttribute("aria-hidden","true"),highlightDiv.className="internal",highlightDiv.style.clipPath=this.#clipPathId;const[parentWidth,parentHeight]=this.parentDimensions;return this.setDims(this.width*parentWidth,this.height*parentHeight),bindEvents(this,this.#highlightDiv,["pointerover","pointerleave"]),this.enableEditing(),div}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1}})}#keydown(event){HighlightEditor._keyboardManager.exec(this,event)}_moveCaret(direction){switch(this.parent.unselect(this),direction){case 0:case 2:this.#setCaret(!0);break;case 1:case 3:this.#setCaret(!1);break}}#setCaret(start){if(!this.#anchorNode)return;const selection=window.getSelection();start?selection.setPosition(this.#anchorNode,this.#anchorOffset):selection.setPosition(this.#focusNode,this.#focusOffset)}select(){super.select(),this.#outlineId&&this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1,selected:!0}})}unselect(){super.unselect(),this.#outlineId&&(this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{selected:!1}}),this.#isFreeHighlight||this.#setCaret(!1))}get _mustFixPosition(){return!this.#isFreeHighlight}show(visible=this._isVisible){super.show(visible),this.parent&&(this.parent.drawLayer.updateProperties(this.#id,{rootClass:{hidden:!visible}}),this.parent.drawLayer.updateProperties(this.#outlineId,{rootClass:{hidden:!visible}}))}#getRotation(){return this.#isFreeHighlight?this.rotation:0}#serializeBoxes(){if(this.#isFreeHighlight)return null;const[pageWidth,pageHeight]=this.pageDimensions,[pageX,pageY]=this.pageTranslation,boxes=this.#boxes,quadPoints=new Float32Array(boxes.length*8);let i=0;for(const{x,y,width,height}of boxes){const sx=x*pageWidth+pageX,sy=(1-y)*pageHeight+pageY;quadPoints[i]=quadPoints[i+4]=sx,quadPoints[i+1]=quadPoints[i+3]=sy,quadPoints[i+2]=quadPoints[i+6]=sx+width*pageWidth,quadPoints[i+5]=quadPoints[i+7]=sy-height*pageHeight,i+=8}return quadPoints}#serializeOutlines(rect){return this.#highlightOutlines.serialize(rect,this.#getRotation())}static startHighlighting(parent,isLTR,{target:textLayer,x,y}){const{x:layerX,y:layerY,width:parentWidth,height:parentHeight}=textLayer.getBoundingClientRect(),ac=new AbortController,signal=parent.combinedSignal(ac),pointerUpCallback=e=>{ac.abort(),this.#endHighlight(parent,e)};window.addEventListener("blur",pointerUpCallback,{signal}),window.addEventListener("pointerup",pointerUpCallback,{signal}),window.addEventListener("pointerdown",stopEvent,{capture:!0,passive:!1,signal}),window.addEventListener("contextmenu",noContextMenu,{signal}),textLayer.addEventListener("pointermove",this.#highlightMove.bind(this,parent),{signal}),this._freeHighlight=new FreeHighlightOutliner({x,y},[layerX,layerY,parentWidth,parentHeight],parent.scale,this._defaultThickness/2,isLTR,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=parent.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static#highlightMove(parent,event){this._freeHighlight.add(event)&&parent.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}static#endHighlight(parent,event){this._freeHighlight.isEmpty()?parent.drawLayer.remove(this._freeHighlightId):parent.createAndAddNewEditor(event,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""}static async deserialize(data,parent,uiManager){let initialData=null;if(data instanceof HighlightAnnotationElement){const{data:{quadPoints:quadPoints2,rect,rotation,id,color:color2,opacity:opacity2,popupRef},parent:{page:{pageNumber}}}=data;initialData=data={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(color2),opacity:opacity2,quadPoints:quadPoints2,boxes:null,pageIndex:pageNumber-1,rect:rect.slice(0),rotation,annotationElementId:id,id,deleted:!1,popupRef}}else if(data instanceof InkAnnotationElement){const{data:{inkLists:inkLists2,rect,rotation,id,color:color2,borderStyle:{rawWidth:thickness},popupRef},parent:{page:{pageNumber}}}=data;initialData=data={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(color2),thickness,inkLists:inkLists2,boxes:null,pageIndex:pageNumber-1,rect:rect.slice(0),rotation,annotationElementId:id,id,deleted:!1,popupRef}}const{color,quadPoints,inkLists,opacity}=data,editor=await super.deserialize(data,parent,uiManager);editor.color=Util.makeHexColor(...color),editor.#opacity=opacity||1,inkLists&&(editor.#thickness=data.thickness),editor._initialData=initialData;const[pageWidth,pageHeight]=editor.pageDimensions,[pageX,pageY]=editor.pageTranslation;if(quadPoints){const boxes=editor.#boxes=[];for(let i=0;i<quadPoints.length;i+=8)boxes.push({x:(quadPoints[i]-pageX)/pageWidth,y:1-(quadPoints[i+1]-pageY)/pageHeight,width:(quadPoints[i+2]-quadPoints[i])/pageWidth,height:(quadPoints[i+1]-quadPoints[i+5])/pageHeight});editor.#createOutlines(),editor.#addToDrawLayer(),editor.rotate(editor.rotation)}else if(inkLists){editor.#isFreeHighlight=!0;const points=inkLists[0],point={x:points[0]-pageX,y:pageHeight-(points[1]-pageY)},outliner=new FreeHighlightOutliner(point,[0,0,pageWidth,pageHeight],1,editor.#thickness/2,!0,.001);for(let i=0,ii=points.length;i<ii;i+=2)point.x=points[i]-pageX,point.y=pageHeight-(points[i+1]-pageY),outliner.add(point);const{id,clipPathId}=parent.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:editor.color,"fill-opacity":editor._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:outliner.toSVGPath()}},!0,!0);editor.#createFreeOutlines({highlightOutlines:outliner.getOutlines(),highlightId:id,clipPathId}),editor.#addToDrawLayer(),editor.rotate(editor.parentRotation)}return editor}serialize(isForCopying=!1){if(this.isEmpty()||isForCopying)return null;if(this.deleted)return this.serializeDeleted();const rect=this.getRect(0,0),color=AnnotationEditor._colorManager.convert(this.color),serialized={annotationType:AnnotationEditorType.HIGHLIGHT,color,opacity:this.#opacity,thickness:this.#thickness,quadPoints:this.#serializeBoxes(),outlines:this.#serializeOutlines(rect),pageIndex:this.pageIndex,rect,rotation:this.#getRotation(),structTreeParentId:this._structTreeParentId};return this.annotationElementId&&!this.#hasElementChanged(serialized)?null:(serialized.id=this.annotationElementId,serialized)}#hasElementChanged(serialized){const{color}=this._initialData;return serialized.color.some((c,i)=>c!==color[i])}renderAnnotationElement(annotation){return annotation.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}}class DrawingOptions{#svgProperties=Object.create(null);updateProperty(name,value){this[name]=value,this.updateSVGProperty(name,value)}updateProperties(properties){if(properties)for(const[name,value]of Object.entries(properties))name.startsWith("_")||this.updateProperty(name,value)}updateSVGProperty(name,value){this.#svgProperties[name]=value}toSVGProperties(){const root=this.#svgProperties;return this.#svgProperties=Object.create(null),{root}}reset(){this.#svgProperties=Object.create(null)}updateAll(options=this){this.updateProperties(options)}clone(){unreachable("Not implemented")}}class DrawingEditor extends AnnotationEditor{#drawOutlines=null;#mustBeCommitted;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#currentDraw=null;static#currentDrawingAC=null;static#currentDrawingOptions=null;static#currentPointerId=NaN;static#currentPointerType=null;static#currentPointerIds=null;static#currentMoveTimestamp=NaN;static _INNER_MARGIN=3;constructor(params){super(params),this.#mustBeCommitted=params.mustBeCommitted||!1,this._addOutlines(params)}_addOutlines(params){params.drawOutlines&&(this.#createDrawOutlines(params),this.#addToDrawLayer())}#createDrawOutlines({drawOutlines,drawId,drawingOptions}){this.#drawOutlines=drawOutlines,this._drawingOptions||=drawingOptions,this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-${this.editorType}-added-alert`),drawId>=0?(this._drawId=drawId,this.parent.drawLayer.finalizeDraw(drawId,drawOutlines.defaultProperties)):this._drawId=this.#createDrawing(drawOutlines,this.parent),this.#updateBbox(drawOutlines.box)}#createDrawing(drawOutlines,parent){const{id}=parent.drawLayer.draw(DrawingEditor._mergeSVGProperties(this._drawingOptions.toSVGProperties(),drawOutlines.defaultSVGProperties),!1,!1);return id}static _mergeSVGProperties(p1,p2){const p1Keys=new Set(Object.keys(p1));for(const[key,value]of Object.entries(p2))p1Keys.has(key)?Object.assign(p1[key],value):p1[key]=value;return p1}static getDefaultDrawingOptions(_options){unreachable("Not implemented")}static get typesMap(){unreachable("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(type,value){const propertyName=this.typesMap.get(type);propertyName&&this._defaultDrawingOptions.updateProperty(propertyName,value),this._currentParent&&(DrawingEditor.#currentDraw.updateProperty(propertyName,value),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(type,value){const propertyName=this.constructor.typesMap.get(type);propertyName&&this._updateProperty(type,propertyName,value)}static get defaultPropertiesToUpdate(){const properties=[],options=this._defaultDrawingOptions;for(const[type,name]of this.typesMap)properties.push([type,options[name]]);return properties}get propertiesToUpdate(){const properties=[],{_drawingOptions}=this;for(const[type,name]of this.constructor.typesMap)properties.push([type,_drawingOptions[name]]);return properties}_updateProperty(type,name,value){const options=this._drawingOptions,savedValue=options[name],setter=val=>{options.updateProperty(name,val);const bbox=this.#drawOutlines.updateProperty(name,val);bbox&&this.#updateBbox(bbox),this.parent?.drawLayer.updateProperties(this._drawId,options.toSVGProperties())};this.addCommands({cmd:setter.bind(this,value),undo:setter.bind(this,savedValue),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathResizingSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathResizedSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onTranslating(_x,_y){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#rotateBox()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathTranslatedSVGProperties(this.#convertToDrawSpace(),this.parentDimensions),{bbox:this.#rotateBox()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(focus){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,this.#mustBeCommitted&&(this.#mustBeCommitted=!1,this.commit(),this.parent.setSelected(this),focus&&this.isOnScreen&&this.div.focus())}remove(){this.#cleanDrawLayer(),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#addToDrawLayer(),this.#updateBbox(this.#drawOutlines.box),this.isAttachedToDOM||this.parent.add(this)))}setParent(parent){let mustBeSelected=!1;this.parent&&!parent?(this._uiManager.removeShouldRescale(this),this.#cleanDrawLayer()):parent&&(this._uiManager.addShouldRescale(this),this.#addToDrawLayer(parent),mustBeSelected=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(parent),mustBeSelected&&this.select()}#cleanDrawLayer(){this._drawId===null||!this.parent||(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())}#addToDrawLayer(parent=this.parent){if(!(this._drawId!==null&&this.parent===parent)){if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,parent.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=this.#createDrawing(this.#drawOutlines,parent)}}#convertToParentSpace([x,y,width,height]){const{parentDimensions:[pW,pH],rotation}=this;switch(rotation){case 90:return[y,1-x,width*(pH/pW),height*(pW/pH)];case 180:return[1-x,1-y,width,height];case 270:return[1-y,x,width*(pH/pW),height*(pW/pH)];default:return[x,y,width,height]}}#convertToDrawSpace(){const{x,y,width,height,parentDimensions:[pW,pH],rotation}=this;switch(rotation){case 90:return[1-y,x,width*(pW/pH),height*(pH/pW)];case 180:return[1-x,1-y,width,height];case 270:return[y,1-x,width*(pW/pH),height*(pH/pW)];default:return[x,y,width,height]}}#updateBbox(bbox){if([this.x,this.y,this.width,this.height]=this.#convertToParentSpace(bbox),this.div){this.fixAndSetPosition();const[parentWidth,parentHeight]=this.parentDimensions;this.setDims(this.width*parentWidth,this.height*parentHeight)}this._onResized()}#rotateBox(){const{x,y,width,height,rotation,parentRotation,parentDimensions:[pW,pH]}=this;switch((rotation*4+parentRotation)/90){case 1:return[1-y-height,x,height,width];case 2:return[1-x-width,1-y-height,width,height];case 3:return[y,1-x-width,height,width];case 4:return[x,y-width*(pW/pH),height*(pH/pW),width*(pW/pH)];case 5:return[1-y,x,width*(pW/pH),height*(pH/pW)];case 6:return[1-x-height*(pH/pW),1-y,height*(pH/pW),width*(pW/pH)];case 7:return[y-width*(pW/pH),1-x-height*(pH/pW),width*(pW/pH),height*(pH/pW)];case 8:return[x-width,y-height,width,height];case 9:return[1-y,x-width,height,width];case 10:return[1-x,1-y,width,height];case 11:return[y-height,1-x,height,width];case 12:return[x-height*(pH/pW),y,height*(pH/pW),width*(pW/pH)];case 13:return[1-y-width*(pW/pH),x-height*(pH/pW),width*(pW/pH),height*(pH/pW)];case 14:return[1-x,1-y-width*(pW/pH),height*(pH/pW),width*(pW/pH)];case 15:return[y,1-x,width*(pW/pH),height*(pH/pW)];default:return[x,y,width,height]}}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties({bbox:this.#rotateBox()},this.#drawOutlines.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&this.#updateBbox(this.#drawOutlines.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let baseX,baseY;this._isCopy&&(baseX=this.x,baseY=this.y);const div=super.render();div.classList.add("draw");const drawDiv=document.createElement("div");div.append(drawDiv),drawDiv.setAttribute("aria-hidden","true"),drawDiv.className="internal";const[parentWidth,parentHeight]=this.parentDimensions;return this.setDims(this.width*parentWidth,this.height*parentHeight),this._uiManager.addShouldRescale(this),this.disableEditing(),this._isCopy&&this._moveAfterPaste(baseX,baseY),div}static createDrawerInstance(_x,_y,_parentWidth,_parentHeight,_rotation){unreachable("Not implemented")}static startDrawing(parent,uiManager,_isLTR,event){const{target,offsetX:x,offsetY:y,pointerId,pointerType}=event;if(DrawingEditor.#currentPointerType&&DrawingEditor.#currentPointerType!==pointerType)return;const{viewport:{rotation}}=parent,{width:parentWidth,height:parentHeight}=target.getBoundingClientRect(),ac=DrawingEditor.#currentDrawingAC=new AbortController,signal=parent.combinedSignal(ac);if(DrawingEditor.#currentPointerId||=pointerId,DrawingEditor.#currentPointerType??=pointerType,window.addEventListener("pointerup",e=>{DrawingEditor.#currentPointerId===e.pointerId?this._endDraw(e):DrawingEditor.#currentPointerIds?.delete(e.pointerId)},{signal}),window.addEventListener("pointercancel",e=>{DrawingEditor.#currentPointerId===e.pointerId?this._currentParent.endDrawingSession():DrawingEditor.#currentPointerIds?.delete(e.pointerId)},{signal}),window.addEventListener("pointerdown",e=>{DrawingEditor.#currentPointerType===e.pointerType&&((DrawingEditor.#currentPointerIds||=new Set).add(e.pointerId),DrawingEditor.#currentDraw.isCancellable()&&(DrawingEditor.#currentDraw.removeLastElement(),DrawingEditor.#currentDraw.isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal}),window.addEventListener("contextmenu",noContextMenu,{signal}),target.addEventListener("pointermove",this._drawMove.bind(this),{signal}),target.addEventListener("touchmove",e=>{e.timeStamp===DrawingEditor.#currentMoveTimestamp&&stopEvent(e)},{signal}),parent.toggleDrawing(),uiManager._editorUndoBar?.hide(),DrawingEditor.#currentDraw){parent.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.startNew(x,y,parentWidth,parentHeight,rotation));return}uiManager.updateUIForDefaultProperties(this),DrawingEditor.#currentDraw=this.createDrawerInstance(x,y,parentWidth,parentHeight,rotation),DrawingEditor.#currentDrawingOptions=this.getDefaultDrawingOptions(),this._currentParent=parent,{id:this._currentDrawId}=parent.drawLayer.draw(this._mergeSVGProperties(DrawingEditor.#currentDrawingOptions.toSVGProperties(),DrawingEditor.#currentDraw.defaultSVGProperties),!0,!1)}static _drawMove(event){if(DrawingEditor.#currentMoveTimestamp=-1,!DrawingEditor.#currentDraw)return;const{offsetX,offsetY,pointerId}=event;if(DrawingEditor.#currentPointerId===pointerId){if(DrawingEditor.#currentPointerIds?.size>=1){this._endDraw(event);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.add(offsetX,offsetY)),DrawingEditor.#currentMoveTimestamp=event.timeStamp,stopEvent(event)}}static _cleanup(all){all&&(this._currentDrawId=-1,this._currentParent=null,DrawingEditor.#currentDraw=null,DrawingEditor.#currentDrawingOptions=null,DrawingEditor.#currentPointerType=null,DrawingEditor.#currentMoveTimestamp=NaN),DrawingEditor.#currentDrawingAC&&(DrawingEditor.#currentDrawingAC.abort(),DrawingEditor.#currentDrawingAC=null,DrawingEditor.#currentPointerId=NaN,DrawingEditor.#currentPointerIds=null)}static _endDraw(event){const parent=this._currentParent;if(parent){if(parent.toggleDrawing(!0),this._cleanup(!1),event?.target===parent.div&&parent.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.end(event.offsetX,event.offsetY)),this.supportMultipleDrawings){const draw=DrawingEditor.#currentDraw,drawId=this._currentDrawId,lastElement=draw.getLastElement();parent.addCommands({cmd:()=>{parent.drawLayer.updateProperties(drawId,draw.setLastElement(lastElement))},undo:()=>{parent.drawLayer.updateProperties(drawId,draw.removeLastElement())},mustExec:!1,type:AnnotationEditorParamsType.DRAW_STEP});return}this.endDrawing(!1)}}static endDrawing(isAborted){const parent=this._currentParent;if(!parent)return null;if(parent.toggleDrawing(!0),parent.cleanUndoStack(AnnotationEditorParamsType.DRAW_STEP),!DrawingEditor.#currentDraw.isEmpty()){const{pageDimensions:[pageWidth,pageHeight],scale}=parent,editor=parent.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:DrawingEditor.#currentDraw.getOutlines(pageWidth*scale,pageHeight*scale,scale,this._INNER_MARGIN),drawingOptions:DrawingEditor.#currentDrawingOptions,mustBeCommitted:!isAborted});return this._cleanup(!0),editor}return parent.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(_data){}static deserializeDraw(_pageX,_pageY,_pageWidth,_pageHeight,_innerWidth,_data){unreachable("Not implemented")}static async deserialize(data,parent,uiManager){const{rawDims:{pageWidth,pageHeight,pageX,pageY}}=parent.viewport,drawOutlines=this.deserializeDraw(pageX,pageY,pageWidth,pageHeight,this._INNER_MARGIN,data),editor=await super.deserialize(data,parent,uiManager);return editor.createDrawingOptions(data),editor.#createDrawOutlines({drawOutlines}),editor.#addToDrawLayer(),editor.onScaleChanging(),editor.rotate(),editor}serializeDraw(isForCopying){const[pageX,pageY]=this.pageTranslation,[pageWidth,pageHeight]=this.pageDimensions;return this.#drawOutlines.serialize([pageX,pageY,pageWidth,pageHeight],isForCopying)}renderAnnotationElement(annotation){return annotation.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}}class InkDrawOutliner{#last=new Float64Array(6);#line;#lines;#rotation;#thickness;#points;#lastSVGPath="";#lastIndex=0;#outlines=new InkDrawOutline;#parentWidth;#parentHeight;constructor(x,y,parentWidth,parentHeight,rotation,thickness){this.#parentWidth=parentWidth,this.#parentHeight=parentHeight,this.#rotation=rotation,this.#thickness=thickness,[x,y]=this.#normalizePoint(x,y);const line=this.#line=[NaN,NaN,NaN,NaN,x,y];this.#points=[x,y],this.#lines=[{line,points:this.#points}],this.#last.set(line,0)}updateProperty(name,value){name==="stroke-width"&&(this.#thickness=value)}#normalizePoint(x,y){return Outline._normalizePoint(x,y,this.#parentWidth,this.#parentHeight,this.#rotation)}isEmpty(){return!this.#lines||this.#lines.length===0}isCancellable(){return this.#points.length<=10}add(x,y){[x,y]=this.#normalizePoint(x,y);const[x1,y1,x2,y2]=this.#last.subarray(2,6),diffX=x-x2,diffY=y-y2;return Math.hypot(this.#parentWidth*diffX,this.#parentHeight*diffY)<=2?null:(this.#points.push(x,y),isNaN(x1)?(this.#last.set([x2,y2,x,y],2),this.#line.push(NaN,NaN,NaN,NaN,x,y),{path:{d:this.toSVGPath()}}):(isNaN(this.#last[0])&&this.#line.splice(6,6),this.#last.set([x1,y1,x2,y2,x,y],0),this.#line.push(...Outline.createBezierPoints(x1,y1,x2,y2,x,y)),{path:{d:this.toSVGPath()}}))}end(x,y){const change=this.add(x,y);return change||(this.#points.length===2?{path:{d:this.toSVGPath()}}:null)}startNew(x,y,parentWidth,parentHeight,rotation){this.#parentWidth=parentWidth,this.#parentHeight=parentHeight,this.#rotation=rotation,[x,y]=this.#normalizePoint(x,y);const line=this.#line=[NaN,NaN,NaN,NaN,x,y];this.#points=[x,y];const last=this.#lines.at(-1);return last&&(last.line=new Float32Array(last.line),last.points=new Float32Array(last.points)),this.#lines.push({line,points:this.#points}),this.#last.set(line,0),this.#lastIndex=0,this.toSVGPath(),null}getLastElement(){return this.#lines.at(-1)}setLastElement(element){return this.#lines?(this.#lines.push(element),this.#line=element.line,this.#points=element.points,this.#lastIndex=0,{path:{d:this.toSVGPath()}}):this.#outlines.setLastElement(element)}removeLastElement(){if(!this.#lines)return this.#outlines.removeLastElement();this.#lines.pop(),this.#lastSVGPath="";for(let i=0,ii=this.#lines.length;i<ii;i++){const{line,points}=this.#lines[i];this.#line=line,this.#points=points,this.#lastIndex=0,this.toSVGPath()}return{path:{d:this.#lastSVGPath}}}toSVGPath(){const firstX=Outline.svgRound(this.#line[4]),firstY=Outline.svgRound(this.#line[5]);if(this.#points.length===2)return this.#lastSVGPath=`${this.#lastSVGPath} M ${firstX} ${firstY} Z`,this.#lastSVGPath;if(this.#points.length<=6){const i=this.#lastSVGPath.lastIndexOf("M");this.#lastSVGPath=`${this.#lastSVGPath.slice(0,i)} M ${firstX} ${firstY}`,this.#lastIndex=6}if(this.#points.length===4){const secondX=Outline.svgRound(this.#line[10]),secondY=Outline.svgRound(this.#line[11]);return this.#lastSVGPath=`${this.#lastSVGPath} L ${secondX} ${secondY}`,this.#lastIndex=12,this.#lastSVGPath}const buffer=[];this.#lastIndex===0&&(buffer.push(`M ${firstX} ${firstY}`),this.#lastIndex=6);for(let i=this.#lastIndex,ii=this.#line.length;i<ii;i+=6){const[c1x,c1y,c2x,c2y,x,y]=this.#line.slice(i,i+6).map(Outline.svgRound);buffer.push(`C${c1x} ${c1y} ${c2x} ${c2y} ${x} ${y}`)}return this.#lastSVGPath+=buffer.join(" "),this.#lastIndex=this.#line.length,this.#lastSVGPath}getOutlines(parentWidth,parentHeight,scale,innerMargin){const last=this.#lines.at(-1);return last.line=new Float32Array(last.line),last.points=new Float32Array(last.points),this.#outlines.build(this.#lines,parentWidth,parentHeight,scale,this.#rotation,this.#thickness,innerMargin),this.#last=null,this.#line=null,this.#lines=null,this.#lastSVGPath=null,this.#outlines}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}}class InkDrawOutline extends Outline{#bbox;#currentRotation=0;#innerMargin;#lines;#parentWidth;#parentHeight;#parentScale;#rotation;#thickness;build(lines,parentWidth,parentHeight,parentScale,rotation,thickness,innerMargin){this.#parentWidth=parentWidth,this.#parentHeight=parentHeight,this.#parentScale=parentScale,this.#rotation=rotation,this.#thickness=thickness,this.#innerMargin=innerMargin??0,this.#lines=lines,this.#computeBbox()}get thickness(){return this.#thickness}setLastElement(element){return this.#lines.push(element),{path:{d:this.toSVGPath()}}}removeLastElement(){return this.#lines.pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){const buffer=[];for(const{line}of this.#lines){if(buffer.push(`M${Outline.svgRound(line[4])} ${Outline.svgRound(line[5])}`),line.length===6){buffer.push("Z");continue}if(line.length===12&&isNaN(line[6])){buffer.push(`L${Outline.svgRound(line[10])} ${Outline.svgRound(line[11])}`);continue}for(let i=6,ii=line.length;i<ii;i+=6){const[c1x,c1y,c2x,c2y,x,y]=line.subarray(i,i+6).map(Outline.svgRound);buffer.push(`C${c1x} ${c1y} ${c2x} ${c2y} ${x} ${y}`)}}return buffer.join("")}serialize([pageX,pageY,pageWidth,pageHeight],isForCopying){const serializedLines=[],serializedPoints=[],[x,y,width,height]=this.#getBBoxWithNoMargin();let tx,ty,sx,sy,x1,y1,x2,y2,rescaleFn;switch(this.#rotation){case 0:rescaleFn=Outline._rescale,tx=pageX,ty=pageY+pageHeight,sx=pageWidth,sy=-pageHeight,x1=pageX+x*pageWidth,y1=pageY+(1-y-height)*pageHeight,x2=pageX+(x+width)*pageWidth,y2=pageY+(1-y)*pageHeight;break;case 90:rescaleFn=Outline._rescaleAndSwap,tx=pageX,ty=pageY,sx=pageWidth,sy=pageHeight,x1=pageX+y*pageWidth,y1=pageY+x*pageHeight,x2=pageX+(y+height)*pageWidth,y2=pageY+(x+width)*pageHeight;break;case 180:rescaleFn=Outline._rescale,tx=pageX+pageWidth,ty=pageY,sx=-pageWidth,sy=pageHeight,x1=pageX+(1-x-width)*pageWidth,y1=pageY+y*pageHeight,x2=pageX+(1-x)*pageWidth,y2=pageY+(y+height)*pageHeight;break;case 270:rescaleFn=Outline._rescaleAndSwap,tx=pageX+pageWidth,ty=pageY+pageHeight,sx=-pageWidth,sy=-pageHeight,x1=pageX+(1-y-height)*pageWidth,y1=pageY+(1-x-width)*pageHeight,x2=pageX+(1-y)*pageWidth,y2=pageY+(1-x)*pageHeight;break}for(const{line,points}of this.#lines)serializedLines.push(rescaleFn(line,tx,ty,sx,sy,isForCopying?new Array(line.length):null)),serializedPoints.push(rescaleFn(points,tx,ty,sx,sy,isForCopying?new Array(points.length):null));return{lines:serializedLines,points:serializedPoints,rect:[x1,y1,x2,y2]}}static deserialize(pageX,pageY,pageWidth,pageHeight,innerMargin,{paths:{lines,points},rotation,thickness}){const newLines=[];let tx,ty,sx,sy,rescaleFn;switch(rotation){case 0:rescaleFn=Outline._rescale,tx=-pageX/pageWidth,ty=pageY/pageHeight+1,sx=1/pageWidth,sy=-1/pageHeight;break;case 90:rescaleFn=Outline._rescaleAndSwap,tx=-pageY/pageHeight,ty=-pageX/pageWidth,sx=1/pageHeight,sy=1/pageWidth;break;case 180:rescaleFn=Outline._rescale,tx=pageX/pageWidth+1,ty=-pageY/pageHeight,sx=-1/pageWidth,sy=1/pageHeight;break;case 270:rescaleFn=Outline._rescaleAndSwap,tx=pageY/pageHeight+1,ty=pageX/pageWidth+1,sx=-1/pageHeight,sy=-1/pageWidth;break}if(!lines){lines=[];for(const point of points){const len=point.length;if(len===2){lines.push(new Float32Array([NaN,NaN,NaN,NaN,point[0],point[1]]));continue}if(len===4){lines.push(new Float32Array([NaN,NaN,NaN,NaN,point[0],point[1],NaN,NaN,NaN,NaN,point[2],point[3]]));continue}const line=new Float32Array(3*(len-2));lines.push(line);let[x1,y1,x2,y2]=point.subarray(0,4);line.set([NaN,NaN,NaN,NaN,x1,y1],0);for(let i=4;i<len;i+=2){const x=point[i],y=point[i+1];line.set(Outline.createBezierPoints(x1,y1,x2,y2,x,y),(i-2)*3),[x1,y1,x2,y2]=[x2,y2,x,y]}}}for(let i=0,ii=lines.length;i<ii;i++)newLines.push({line:rescaleFn(lines[i].map(x=>x??NaN),tx,ty,sx,sy),points:rescaleFn(points[i].map(x=>x??NaN),tx,ty,sx,sy)});const outlines=new this.prototype.constructor;return outlines.build(newLines,pageWidth,pageHeight,1,rotation,thickness,innerMargin),outlines}#getMarginComponents(thickness=this.#thickness){const margin=this.#innerMargin+thickness/2*this.#parentScale;return this.#rotation%180===0?[margin/this.#parentWidth,margin/this.#parentHeight]:[margin/this.#parentHeight,margin/this.#parentWidth]}#getBBoxWithNoMargin(){const[x,y,width,height]=this.#bbox,[marginX,marginY]=this.#getMarginComponents(0);return[x+marginX,y+marginY,width-2*marginX,height-2*marginY]}#computeBbox(){const bbox=this.#bbox=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const{line}of this.#lines){if(line.length<=12){for(let i=4,ii=line.length;i<ii;i+=6)Util.pointBoundingBox(line[i],line[i+1],bbox);continue}let lastX=line[4],lastY=line[5];for(let i=6,ii=line.length;i<ii;i+=6){const[c1x,c1y,c2x,c2y,x,y]=line.subarray(i,i+6);Util.bezierBoundingBox(lastX,lastY,c1x,c1y,c2x,c2y,x,y,bbox),lastX=x,lastY=y}}const[marginX,marginY]=this.#getMarginComponents();bbox[0]=MathClamp(bbox[0]-marginX,0,1),bbox[1]=MathClamp(bbox[1]-marginY,0,1),bbox[2]=MathClamp(bbox[2]+marginX,0,1),bbox[3]=MathClamp(bbox[3]+marginY,0,1),bbox[2]-=bbox[0],bbox[3]-=bbox[1]}get box(){return this.#bbox}updateProperty(name,value){return name==="stroke-width"?this.#updateThickness(value):null}#updateThickness(thickness){const[oldMarginX,oldMarginY]=this.#getMarginComponents();this.#thickness=thickness;const[newMarginX,newMarginY]=this.#getMarginComponents(),[diffMarginX,diffMarginY]=[newMarginX-oldMarginX,newMarginY-oldMarginY],bbox=this.#bbox;return bbox[0]-=diffMarginX,bbox[1]-=diffMarginY,bbox[2]+=2*diffMarginX,bbox[3]+=2*diffMarginY,bbox}updateParentDimensions([width,height],scale){const[oldMarginX,oldMarginY]=this.#getMarginComponents();this.#parentWidth=width,this.#parentHeight=height,this.#parentScale=scale;const[newMarginX,newMarginY]=this.#getMarginComponents(),diffMarginX=newMarginX-oldMarginX,diffMarginY=newMarginY-oldMarginY,bbox=this.#bbox;return bbox[0]-=diffMarginX,bbox[1]-=diffMarginY,bbox[2]+=2*diffMarginX,bbox[3]+=2*diffMarginY,bbox}updateRotation(rotation){return this.#currentRotation=rotation,{path:{transform:this.rotationTransform}}}get viewBox(){return this.#bbox.map(Outline.svgRound).join(" ")}get defaultProperties(){const[x,y]=this.#bbox;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(x)} ${Outline.svgRound(y)}`}}}get rotationTransform(){const[,,width,height]=this.#bbox;let a=0,b=0,c=0,d=0,e=0,f=0;switch(this.#currentRotation){case 90:b=height/width,c=-width/height,e=width;break;case 180:a=-1,d=-1,e=width,f=height;break;case 270:b=-height/width,c=width/height,f=height;break;default:return""}return`matrix(${a} ${b} ${c} ${d} ${Outline.svgRound(e)} ${Outline.svgRound(f)})`}getPathResizingSVGProperties([newX,newY,newWidth,newHeight]){const[marginX,marginY]=this.#getMarginComponents(),[x,y,width,height]=this.#bbox;if(Math.abs(width-marginX)<=Outline.PRECISION||Math.abs(height-marginY)<=Outline.PRECISION){const tx=newX+newWidth/2-(x+width/2),ty=newY+newHeight/2-(y+height/2);return{path:{"transform-origin":`${Outline.svgRound(newX)} ${Outline.svgRound(newY)}`,transform:`${this.rotationTransform} translate(${tx} ${ty})`}}}const s1x=(newWidth-2*marginX)/(width-2*marginX),s1y=(newHeight-2*marginY)/(height-2*marginY),s2x=width/newWidth,s2y=height/newHeight;return{path:{"transform-origin":`${Outline.svgRound(x)} ${Outline.svgRound(y)}`,transform:`${this.rotationTransform} scale(${s2x} ${s2y}) translate(${Outline.svgRound(marginX)} ${Outline.svgRound(marginY)}) scale(${s1x} ${s1y}) translate(${Outline.svgRound(-marginX)} ${Outline.svgRound(-marginY)})`}}}getPathResizedSVGProperties([newX,newY,newWidth,newHeight]){const[marginX,marginY]=this.#getMarginComponents(),bbox=this.#bbox,[x,y,width,height]=bbox;if(bbox[0]=newX,bbox[1]=newY,bbox[2]=newWidth,bbox[3]=newHeight,Math.abs(width-marginX)<=Outline.PRECISION||Math.abs(height-marginY)<=Outline.PRECISION){const tx2=newX+newWidth/2-(x+width/2),ty2=newY+newHeight/2-(y+height/2);for(const{line,points}of this.#lines)Outline._translate(line,tx2,ty2,line),Outline._translate(points,tx2,ty2,points);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(newX)} ${Outline.svgRound(newY)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const s1x=(newWidth-2*marginX)/(width-2*marginX),s1y=(newHeight-2*marginY)/(height-2*marginY),tx=-s1x*(x+marginX)+newX+marginX,ty=-s1y*(y+marginY)+newY+marginY;if(s1x!==1||s1y!==1||tx!==0||ty!==0)for(const{line,points}of this.#lines)Outline._rescale(line,tx,ty,s1x,s1y,line),Outline._rescale(points,tx,ty,s1x,s1y,points);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(newX)} ${Outline.svgRound(newY)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([newX,newY],parentDimensions){const[newParentWidth,newParentHeight]=parentDimensions,bbox=this.#bbox,tx=newX-bbox[0],ty=newY-bbox[1];if(this.#parentWidth===newParentWidth&&this.#parentHeight===newParentHeight)for(const{line,points}of this.#lines)Outline._translate(line,tx,ty,line),Outline._translate(points,tx,ty,points);else{const sx=this.#parentWidth/newParentWidth,sy=this.#parentHeight/newParentHeight;this.#parentWidth=newParentWidth,this.#parentHeight=newParentHeight;for(const{line,points}of this.#lines)Outline._rescale(line,tx,ty,sx,sy,line),Outline._rescale(points,tx,ty,sx,sy,points);bbox[2]*=sx,bbox[3]*=sy}return bbox[0]=newX,bbox[1]=newY,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(newX)} ${Outline.svgRound(newY)}`}}}get defaultSVGProperties(){const bbox=this.#bbox;return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(bbox[0])} ${Outline.svgRound(bbox[1])}`,transform:this.rotationTransform||null},bbox}}}class InkDrawingOptions extends DrawingOptions{constructor(viewerParameters){super(),this._viewParameters=viewerParameters,super.updateProperties({fill:"none",stroke:AnnotationEditor._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(name,value){name==="stroke-width"&&(value??=this["stroke-width"],value*=this._viewParameters.realScale),super.updateSVGProperty(name,value)}clone(){const clone=new InkDrawingOptions(this._viewParameters);return clone.updateAll(this),clone}}class InkEditor extends DrawingEditor{static _type="ink";static _editorType=AnnotationEditorType.INK;static _defaultDrawingOptions=null;constructor(params){super({...params,name:"inkEditor"}),this._willKeepAspectRatio=!0,this.defaultL10nId="pdfjs-editor-ink-editor"}static initialize(l10n,uiManager){AnnotationEditor.initialize(l10n,uiManager),this._defaultDrawingOptions=new InkDrawingOptions(uiManager.viewParameters)}static getDefaultDrawingOptions(options){const clone=this._defaultDrawingOptions.clone();return clone.updateProperties(options),clone}static get supportMultipleDrawings(){return!0}static get typesMap(){return shadow(this,"typesMap",new Map([[AnnotationEditorParamsType.INK_THICKNESS,"stroke-width"],[AnnotationEditorParamsType.INK_COLOR,"stroke"],[AnnotationEditorParamsType.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(x,y,parentWidth,parentHeight,rotation){return new InkDrawOutliner(x,y,parentWidth,parentHeight,rotation,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(pageX,pageY,pageWidth,pageHeight,innerMargin,data){return InkDrawOutline.deserialize(pageX,pageY,pageWidth,pageHeight,innerMargin,data)}static async deserialize(data,parent,uiManager){let initialData=null;if(data instanceof InkAnnotationElement){const{data:{inkLists,rect,rotation,id,color,opacity,borderStyle:{rawWidth:thickness},popupRef},parent:{page:{pageNumber}}}=data;initialData=data={annotationType:AnnotationEditorType.INK,color:Array.from(color),thickness,opacity,paths:{points:inkLists},boxes:null,pageIndex:pageNumber-1,rect:rect.slice(0),rotation,annotationElementId:id,id,deleted:!1,popupRef}}const editor=await super.deserialize(data,parent,uiManager);return editor._initialData=initialData,editor}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();const{_drawId,_drawingOptions,parent}=this;_drawingOptions.updateSVGProperty("stroke-width"),parent.drawLayer.updateProperties(_drawId,_drawingOptions.toSVGProperties())}static onScaleChangingWhenDrawing(){const parent=this._currentParent;parent&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),parent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color,thickness,opacity}){this._drawingOptions=InkEditor.getDefaultDrawingOptions({stroke:Util.makeHexColor(...color),"stroke-width":thickness,"stroke-opacity":opacity})}serialize(isForCopying=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const{lines,points,rect}=this.serializeDraw(isForCopying),{_drawingOptions:{stroke,"stroke-opacity":opacity,"stroke-width":thickness}}=this,serialized={annotationType:AnnotationEditorType.INK,color:AnnotationEditor._colorManager.convert(stroke),opacity,thickness,paths:{lines,points},pageIndex:this.pageIndex,rect,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return isForCopying?(serialized.isCopy=!0,serialized):this.annotationElementId&&!this.#hasElementChanged(serialized)?null:(serialized.id=this.annotationElementId,serialized)}#hasElementChanged(serialized){const{color,thickness,opacity,pageIndex}=this._initialData;return this._hasBeenMoved||this._hasBeenResized||serialized.color.some((c,i)=>c!==color[i])||serialized.thickness!==thickness||serialized.opacity!==opacity||serialized.pageIndex!==pageIndex}renderAnnotationElement(annotation){const{points,rect}=this.serializeDraw(!1);return annotation.updateEdited({rect,thickness:this._drawingOptions["stroke-width"],points}),null}}class ContourDrawOutline extends InkDrawOutline{toSVGPath(){let path=super.toSVGPath();return path.endsWith("Z")||(path+="Z"),path}}const BASE_HEADER_LENGTH=8,POINTS_PROPERTIES_NUMBER=3;class SignatureExtractor{static#PARAMETERS={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#neighborIndexToId(i0,j0,i,j){return i-=i0,j-=j0,i===0?j>0?0:4:i===1?j+6:2-j}static#neighborIdToIndex=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#clockwiseNonZero(buf,width,i0,j0,i,j,offset){const id=this.#neighborIndexToId(i0,j0,i,j);for(let k=0;k<8;k++){const kk=(-k+id-offset+16)%8,shiftI=this.#neighborIdToIndex[2*kk],shiftJ=this.#neighborIdToIndex[2*kk+1];if(buf[(i0+shiftI)*width+(j0+shiftJ)]!==0)return kk}return-1}static#counterClockwiseNonZero(buf,width,i0,j0,i,j,offset){const id=this.#neighborIndexToId(i0,j0,i,j);for(let k=0;k<8;k++){const kk=(k+id+offset+16)%8,shiftI=this.#neighborIdToIndex[2*kk],shiftJ=this.#neighborIdToIndex[2*kk+1];if(buf[(i0+shiftI)*width+(j0+shiftJ)]!==0)return kk}return-1}static#findContours(buf,width,height,threshold){const N=buf.length,types=new Int32Array(N);for(let i=0;i<N;i++)types[i]=buf[i]<=threshold?1:0;for(let i=1;i<height-1;i++)types[i*width]=types[i*width+width-1]=0;for(let i=0;i<width;i++)types[i]=types[width*height-1-i]=0;let nbd=1,lnbd;const contours=[];for(let i=1;i<height-1;i++){lnbd=1;for(let j=1;j<width-1;j++){const ij=i*width+j,pix=types[ij];if(pix===0)continue;let i2=i,j2=j;if(pix===1&&types[ij-1]===0)nbd+=1,j2-=1;else if(pix>=1&&types[ij+1]===0)nbd+=1,j2+=1,pix>1&&(lnbd=pix);else{pix!==1&&(lnbd=Math.abs(pix));continue}const points=[j,i],isHole=j2===j+1,contour={isHole,points,id:nbd,parent:0};contours.push(contour);let contour0;for(const c of contours)if(c.id===lnbd){contour0=c;break}contour0?contour0.isHole?contour.parent=isHole?contour0.parent:lnbd:contour.parent=isHole?lnbd:contour0.parent:contour.parent=isHole?lnbd:0;const k=this.#clockwiseNonZero(types,width,i,j,i2,j2,0);if(k===-1){types[ij]=-nbd,types[ij]!==1&&(lnbd=Math.abs(types[ij]));continue}let shiftI=this.#neighborIdToIndex[2*k],shiftJ=this.#neighborIdToIndex[2*k+1];const i1=i+shiftI,j1=j+shiftJ;i2=i1,j2=j1;let i3=i,j3=j;for(;;){const kk=this.#counterClockwiseNonZero(types,width,i3,j3,i2,j2,1);shiftI=this.#neighborIdToIndex[2*kk],shiftJ=this.#neighborIdToIndex[2*kk+1];const i4=i3+shiftI,j4=j3+shiftJ;points.push(j4,i4);const ij3=i3*width+j3;if(types[ij3+1]===0?types[ij3]=-nbd:types[ij3]===1&&(types[ij3]=nbd),i4===i&&j4===j&&i3===i1&&j3===j1){types[ij]!==1&&(lnbd=Math.abs(types[ij]));break}else i2=i3,j2=j3,i3=i4,j3=j4}}}return contours}static#douglasPeuckerHelper(points,start,end,output){if(end-start<=4){for(let i=start;i<end-2;i+=2)output.push(points[i],points[i+1]);return}const ax=points[start],ay=points[start+1],abx=points[end-4]-ax,aby=points[end-3]-ay,dist=Math.hypot(abx,aby),nabx=abx/dist,naby=aby/dist,aa=nabx*ay-naby*ax,m=aby/abx,invS=1/dist,phi=Math.atan(m),cosPhi=Math.cos(phi),sinPhi=Math.sin(phi),tmax=invS*(Math.abs(cosPhi)+Math.abs(sinPhi)),poly=invS*(1-tmax+tmax**2),partialPhi=Math.max(Math.atan(Math.abs(sinPhi+cosPhi)*poly),Math.atan(Math.abs(sinPhi-cosPhi)*poly));let dmax=0,index=start;for(let i=start+2;i<end-2;i+=2){const d=Math.abs(aa-nabx*points[i+1]+naby*points[i]);d>dmax&&(index=i,dmax=d)}dmax>(dist*partialPhi)**2?(this.#douglasPeuckerHelper(points,start,index+2,output),this.#douglasPeuckerHelper(points,index,end,output)):output.push(ax,ay)}static#douglasPeucker(points){const output=[],len=points.length;return this.#douglasPeuckerHelper(points,0,len,output),output.push(points[len-2],points[len-1]),output.length<=4?null:output}static#bilateralFilter(buf,width,height,sigmaS,sigmaR,kernelSize){const kernel=new Float32Array(kernelSize**2),sigmaS2=-2*sigmaS**2,halfSize=kernelSize>>1;for(let i=0;i<kernelSize;i++){const x=(i-halfSize)**2;for(let j=0;j<kernelSize;j++)kernel[i*kernelSize+j]=Math.exp((x+(j-halfSize)**2)/sigmaS2)}const rangeValues=new Float32Array(256),sigmaR2=-2*sigmaR**2;for(let i=0;i<256;i++)rangeValues[i]=Math.exp(i**2/sigmaR2);const N=buf.length,out=new Uint8Array(N),histogram=new Uint32Array(256);for(let i=0;i<height;i++)for(let j=0;j<width;j++){const ij=i*width+j,center=buf[ij];let sum=0,norm=0;for(let k=0;k<kernelSize;k++){const y=i+k-halfSize;if(!(y<0||y>=height))for(let l=0;l<kernelSize;l++){const x=j+l-halfSize;if(x<0||x>=width)continue;const neighbour=buf[y*width+x],w=kernel[k*kernelSize+l]*rangeValues[Math.abs(neighbour-center)];sum+=neighbour*w,norm+=w}}const pix=out[ij]=Math.round(sum/norm);histogram[pix]++}return[out,histogram]}static#getHistogram(buf){const histogram=new Uint32Array(256);for(const g of buf)histogram[g]++;return histogram}static#toUint8(buf){const N=buf.length,out=new Uint8ClampedArray(N>>2);let max=-1/0,min=1/0;for(let i=0,ii=out.length;i<ii;i++){if(buf[(i<<2)+3]===0){max=out[i]=255;continue}const pix=out[i]=buf[i<<2];pix>max&&(max=pix),pix<min&&(min=pix)}const ratio=255/(max-min);for(let i=0;i<N;i++)out[i]=(out[i]-min)*ratio;return out}static#guessThreshold(histogram){let i,M=-1/0,L=-1/0;const min=histogram.findIndex(v=>v!==0);let pos=min,spos=min;for(i=min;i<256;i++){const v=histogram[i];v>M&&(i-pos>L&&(L=i-pos,spos=i-1),M=v,pos=i)}for(i=spos-1;i>=0&&!(histogram[i]>histogram[i+1]);i--);return i}static#getGrayPixels(bitmap){const originalBitmap=bitmap,{width,height}=bitmap,{maxDim}=this.#PARAMETERS;let newWidth=width,newHeight=height;if(width>maxDim||height>maxDim){let prevWidth=width,prevHeight=height,steps=Math.log2(Math.max(width,height)/maxDim);const isteps=Math.floor(steps);steps=steps===isteps?isteps-1:isteps;for(let i=0;i<steps;i++){newWidth=Math.ceil(prevWidth/2),newHeight=Math.ceil(prevHeight/2);const offscreen2=new OffscreenCanvas(newWidth,newHeight);offscreen2.getContext("2d").drawImage(bitmap,0,0,prevWidth,prevHeight,0,0,newWidth,newHeight),prevWidth=newWidth,prevHeight=newHeight,bitmap!==originalBitmap&&bitmap.close(),bitmap=offscreen2.transferToImageBitmap()}const ratio=Math.min(maxDim/newWidth,maxDim/newHeight);newWidth=Math.round(newWidth*ratio),newHeight=Math.round(newHeight*ratio)}const ctx=new OffscreenCanvas(newWidth,newHeight).getContext("2d",{willReadFrequently:!0});ctx.filter="grayscale(1)",ctx.drawImage(bitmap,0,0,bitmap.width,bitmap.height,0,0,newWidth,newHeight);const grayImage=ctx.getImageData(0,0,newWidth,newHeight).data;return[this.#toUint8(grayImage),newWidth,newHeight]}static extractContoursFromText(text,{fontFamily,fontStyle,fontWeight},pageWidth,pageHeight,rotation,innerMargin){let canvas=new OffscreenCanvas(1,1),ctx=canvas.getContext("2d",{alpha:!1});const fontSize=200,font=ctx.font=`${fontStyle} ${fontWeight} ${fontSize}px ${fontFamily}`,{actualBoundingBoxLeft,actualBoundingBoxRight,actualBoundingBoxAscent,actualBoundingBoxDescent,fontBoundingBoxAscent,fontBoundingBoxDescent,width}=ctx.measureText(text),SCALE=1.5,canvasWidth=Math.ceil(Math.max(Math.abs(actualBoundingBoxLeft)+Math.abs(actualBoundingBoxRight)||0,width)*SCALE),canvasHeight=Math.ceil(Math.max(Math.abs(actualBoundingBoxAscent)+Math.abs(actualBoundingBoxDescent)||fontSize,Math.abs(fontBoundingBoxAscent)+Math.abs(fontBoundingBoxDescent)||fontSize)*SCALE);canvas=new OffscreenCanvas(canvasWidth,canvasHeight),ctx=canvas.getContext("2d",{alpha:!0,willReadFrequently:!0}),ctx.font=font,ctx.filter="grayscale(1)",ctx.fillStyle="white",ctx.fillRect(0,0,canvasWidth,canvasHeight),ctx.fillStyle="black",ctx.fillText(text,canvasWidth*(SCALE-1)/2,canvasHeight*(3-SCALE)/2);const uint8Buf=this.#toUint8(ctx.getImageData(0,0,canvasWidth,canvasHeight).data),histogram=this.#getHistogram(uint8Buf),threshold=this.#guessThreshold(histogram),contourList=this.#findContours(uint8Buf,canvasWidth,canvasHeight,threshold);return this.processDrawnLines({lines:{curves:contourList,width:canvasWidth,height:canvasHeight},pageWidth,pageHeight,rotation,innerMargin,mustSmooth:!0,areContours:!0})}static process(bitmap,pageWidth,pageHeight,rotation,innerMargin){const[uint8Buf,width,height]=this.#getGrayPixels(bitmap),[buffer,histogram]=this.#bilateralFilter(uint8Buf,width,height,Math.hypot(width,height)*this.#PARAMETERS.sigmaSFactor,this.#PARAMETERS.sigmaR,this.#PARAMETERS.kernelSize),threshold=this.#guessThreshold(histogram),contourList=this.#findContours(buffer,width,height,threshold);return this.processDrawnLines({lines:{curves:contourList,width,height},pageWidth,pageHeight,rotation,innerMargin,mustSmooth:!0,areContours:!0})}static processDrawnLines({lines,pageWidth,pageHeight,rotation,innerMargin,mustSmooth,areContours}){rotation%180!==0&&([pageWidth,pageHeight]=[pageHeight,pageWidth]);const{curves,width,height}=lines,thickness=lines.thickness??0,linesAndPoints=[],ratio=Math.min(pageWidth/width,pageHeight/height),xScale=ratio/pageWidth,yScale=ratio/pageHeight,newCurves=[];for(const{points}of curves){const reducedPoints=mustSmooth?this.#douglasPeucker(points):points;if(!reducedPoints)continue;newCurves.push(reducedPoints);const len=reducedPoints.length,newPoints=new Float32Array(len),line=new Float32Array(3*(len===2?2:len-2));if(linesAndPoints.push({line,points:newPoints}),len===2){newPoints[0]=reducedPoints[0]*xScale,newPoints[1]=reducedPoints[1]*yScale,line.set([NaN,NaN,NaN,NaN,newPoints[0],newPoints[1]],0);continue}let[x1,y1,x2,y2]=reducedPoints;x1*=xScale,y1*=yScale,x2*=xScale,y2*=yScale,newPoints.set([x1,y1,x2,y2],0),line.set([NaN,NaN,NaN,NaN,x1,y1],0);for(let i=4;i<len;i+=2){const x=newPoints[i]=reducedPoints[i]*xScale,y=newPoints[i+1]=reducedPoints[i+1]*yScale;line.set(Outline.createBezierPoints(x1,y1,x2,y2,x,y),(i-2)*3),[x1,y1,x2,y2]=[x2,y2,x,y]}}if(linesAndPoints.length===0)return null;const outline=areContours?new ContourDrawOutline:new InkDrawOutline;return outline.build(linesAndPoints,pageWidth,pageHeight,1,rotation,areContours?0:thickness,innerMargin),{outline,newCurves,areContours,thickness,width,height}}static async compressSignature({outlines,areContours,thickness,width,height}){let minDiff=1/0,maxDiff=-1/0,outlinesLength=0;for(const points of outlines){outlinesLength+=points.length;for(let i=2,ii=points.length;i<ii;i++){const dx=points[i]-points[i-2];minDiff=Math.min(minDiff,dx),maxDiff=Math.max(maxDiff,dx)}}let bufferType;minDiff>=-128&&maxDiff<=127?bufferType=Int8Array:minDiff>=-32768&&maxDiff<=32767?bufferType=Int16Array:bufferType=Int32Array;const len=outlines.length,headerLength=BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*len,header=new Uint32Array(headerLength);let offset=0;header[offset++]=headerLength*Uint32Array.BYTES_PER_ELEMENT+(outlinesLength-2*len)*bufferType.BYTES_PER_ELEMENT,header[offset++]=0,header[offset++]=width,header[offset++]=height,header[offset++]=areContours?0:1,header[offset++]=Math.max(0,Math.floor(thickness??0)),header[offset++]=len,header[offset++]=bufferType.BYTES_PER_ELEMENT;for(const points of outlines)header[offset++]=points.length-2,header[offset++]=points[0],header[offset++]=points[1];const cs=new CompressionStream("deflate-raw"),writer=cs.writable.getWriter();await writer.ready,writer.write(header);const BufferCtor=bufferType.prototype.constructor;for(const points of outlines){const diffs=new BufferCtor(points.length-2);for(let i=2,ii=points.length;i<ii;i++)diffs[i-2]=points[i]-points[i-2];writer.write(diffs)}writer.close();const buf=await new Response(cs.readable).arrayBuffer(),bytes=new Uint8Array(buf);return toBase64Util(bytes)}static async decompressSignature(signatureData){try{const bytes=fromBase64Util(signatureData),{readable,writable}=new DecompressionStream("deflate-raw"),writer=writable.getWriter();await writer.ready,writer.write(bytes).then(async()=>{await writer.ready,await writer.close()}).catch(()=>{});let data=null,offset=0;for await(const chunk of readable)data||=new Uint8Array(new Uint32Array(chunk.buffer,0,4)[0]),data.set(chunk,offset),offset+=chunk.length;const header=new Uint32Array(data.buffer,0,data.length>>2),version2=header[1];if(version2!==0)throw new Error(`Invalid version: ${version2}`);const width=header[2],height=header[3],areContours=header[4]===0,thickness=header[5],numberOfDrawings=header[6],bufferType=header[7],outlines=[],diffsOffset=(BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*numberOfDrawings)*Uint32Array.BYTES_PER_ELEMENT;let diffs;switch(bufferType){case Int8Array.BYTES_PER_ELEMENT:diffs=new Int8Array(data.buffer,diffsOffset);break;case Int16Array.BYTES_PER_ELEMENT:diffs=new Int16Array(data.buffer,diffsOffset);break;case Int32Array.BYTES_PER_ELEMENT:diffs=new Int32Array(data.buffer,diffsOffset);break}offset=0;for(let i=0;i<numberOfDrawings;i++){const len=header[POINTS_PROPERTIES_NUMBER*i+BASE_HEADER_LENGTH],points=new Float32Array(len+2);outlines.push(points);for(let j=0;j<POINTS_PROPERTIES_NUMBER-1;j++)points[j]=header[POINTS_PROPERTIES_NUMBER*i+BASE_HEADER_LENGTH+j+1];for(let j=0;j<len;j++)points[j+2]=points[j]+diffs[offset++]}return{areContours,thickness,outlines,width,height}}catch(e){return warn(`decompressSignature: ${e}`),null}}}class SignatureOptions extends DrawingOptions{constructor(){super(),super.updateProperties({fill:AnnotationEditor._defaultLineColor,"stroke-width":0})}clone(){const clone=new SignatureOptions;return clone.updateAll(this),clone}}class DrawnSignatureOptions extends InkDrawingOptions{constructor(viewerParameters){super(viewerParameters),super.updateProperties({stroke:AnnotationEditor._defaultLineColor,"stroke-width":1})}clone(){const clone=new DrawnSignatureOptions(this._viewParameters);return clone.updateAll(this),clone}}class SignatureEditor extends DrawingEditor{#isExtracted=!1;#description=null;#signatureData=null;#signatureUUID=null;static _type="signature";static _editorType=AnnotationEditorType.SIGNATURE;static _defaultDrawingOptions=null;constructor(params){super({...params,mustBeCommitted:!0,name:"signatureEditor"}),this._willKeepAspectRatio=!0,this.#signatureData=params.signatureData||null,this.#description=null,this.defaultL10nId="pdfjs-editor-signature-editor1"}static initialize(l10n,uiManager){AnnotationEditor.initialize(l10n,uiManager),this._defaultDrawingOptions=new SignatureOptions,this._defaultDrawnSignatureOptions=new DrawnSignatureOptions(uiManager.viewParameters)}static getDefaultDrawingOptions(options){const clone=this._defaultDrawingOptions.clone();return clone.updateProperties(options),clone}static get supportMultipleDrawings(){return!1}static get typesMap(){return shadow(this,"typesMap",new Map)}static get isDrawer(){return!1}get telemetryFinalData(){return{type:"signature",hasDescription:!!this.#description}}static computeTelemetryFinalData(data){const hasDescriptionStats=data.get("hasDescription");return{hasAltText:hasDescriptionStats.get(!0)??0,hasNoAltText:hasDescriptionStats.get(!1)??0}}get isResizable(){return!0}onScaleChanging(){this._drawId!==null&&super.onScaleChanging()}render(){if(this.div)return this.div;let baseX,baseY;const{_isCopy}=this;if(_isCopy&&(this._isCopy=!1,baseX=this.x,baseY=this.y),super.render(),this._drawId===null)if(this.#signatureData){const{lines,mustSmooth,areContours,description,uuid,heightInPage}=this.#signatureData,{rawDims:{pageWidth,pageHeight},rotation}=this.parent.viewport,outline=SignatureExtractor.processDrawnLines({lines,pageWidth,pageHeight,rotation,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth,areContours});this.addSignature(outline,heightInPage,description,uuid)}else this.div.setAttribute("data-l10n-args",JSON.stringify({description:""})),this.div.hidden=!0,this._uiManager.getSignature(this);return _isCopy&&(this._isCopy=!0,this._moveAfterPaste(baseX,baseY)),this.div}setUuid(uuid){this.#signatureUUID=uuid,this.addEditToolbar()}getUuid(){return this.#signatureUUID}get description(){return this.#description}set description(description){this.#description=description,super.addEditToolbar().then(toolbar=>{toolbar?.updateEditSignatureButton(description)})}getSignaturePreview(){const{newCurves,areContours,thickness,width,height}=this.#signatureData,maxDim=Math.max(width,height),outlineData=SignatureExtractor.processDrawnLines({lines:{curves:newCurves.map(points=>({points})),thickness,width,height},pageWidth:maxDim,pageHeight:maxDim,rotation:0,innerMargin:0,mustSmooth:!1,areContours});return{areContours,outline:outlineData.outline}}get toolbarButtons(){return this._uiManager.signatureManager?[["editSignature",this._uiManager.signatureManager]]:super.toolbarButtons}addSignature(data,heightInPage,description,uuid){const{x:savedX,y:savedY}=this,{outline}=this.#signatureData=data;this.#isExtracted=outline instanceof ContourDrawOutline,this.description=description,this.div.setAttribute("data-l10n-args",JSON.stringify({description}));let drawingOptions;this.#isExtracted?drawingOptions=SignatureEditor.getDefaultDrawingOptions():(drawingOptions=SignatureEditor._defaultDrawnSignatureOptions.clone(),drawingOptions.updateProperties({"stroke-width":outline.thickness})),this._addOutlines({drawOutlines:outline,drawingOptions});const[parentWidth,parentHeight]=this.parentDimensions,[,pageHeight]=this.pageDimensions;let newHeight=heightInPage/pageHeight;newHeight=newHeight>=1?.5:newHeight,this.width*=newHeight/this.height,this.width>=1&&(newHeight*=.9/this.width,this.width=.9),this.height=newHeight,this.setDims(parentWidth*this.width,parentHeight*this.height),this.x=savedX,this.y=savedY,this.center(),this._onResized(),this.onScaleChanging(),this.rotate(),this._uiManager.addToAnnotationStorage(this),this.setUuid(uuid),this._reportTelemetry({action:"pdfjs.signature.inserted",data:{hasBeenSaved:!!uuid,hasDescription:!!description}}),this.div.hidden=!1}getFromImage(bitmap){const{rawDims:{pageWidth,pageHeight},rotation}=this.parent.viewport;return SignatureExtractor.process(bitmap,pageWidth,pageHeight,rotation,SignatureEditor._INNER_MARGIN)}getFromText(text,fontInfo){const{rawDims:{pageWidth,pageHeight},rotation}=this.parent.viewport;return SignatureExtractor.extractContoursFromText(text,fontInfo,pageWidth,pageHeight,rotation,SignatureEditor._INNER_MARGIN)}getDrawnSignature(curves){const{rawDims:{pageWidth,pageHeight},rotation}=this.parent.viewport;return SignatureExtractor.processDrawnLines({lines:curves,pageWidth,pageHeight,rotation,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth:!1,areContours:!1})}createDrawingOptions({areContours,thickness}){areContours?this._drawingOptions=SignatureEditor.getDefaultDrawingOptions():(this._drawingOptions=SignatureEditor._defaultDrawnSignatureOptions.clone(),this._drawingOptions.updateProperties({"stroke-width":thickness}))}serialize(isForCopying=!1){if(this.isEmpty())return null;const{lines,points,rect}=this.serializeDraw(isForCopying),{_drawingOptions:{"stroke-width":thickness}}=this,serialized={annotationType:AnnotationEditorType.SIGNATURE,isSignature:!0,areContours:this.#isExtracted,color:[0,0,0],thickness:this.#isExtracted?0:thickness,pageIndex:this.pageIndex,rect,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return isForCopying?(serialized.paths={lines,points},serialized.uuid=this.#signatureUUID,serialized.isCopy=!0):serialized.lines=lines,this.#description&&(serialized.accessibilityData={type:"Figure",alt:this.#description}),serialized}static deserializeDraw(pageX,pageY,pageWidth,pageHeight,innerMargin,data){return data.areContours?ContourDrawOutline.deserialize(pageX,pageY,pageWidth,pageHeight,innerMargin,data):InkDrawOutline.deserialize(pageX,pageY,pageWidth,pageHeight,innerMargin,data)}static async deserialize(data,parent,uiManager){const editor=await super.deserialize(data,parent,uiManager);return editor.#isExtracted=data.areContours,editor.#description=data.accessibilityData?.alt||"",editor.#signatureUUID=data.uuid,editor}}class StampEditor extends AnnotationEditor{#bitmap=null;#bitmapId=null;#bitmapPromise=null;#bitmapUrl=null;#bitmapFile=null;#bitmapFileName="";#canvas=null;#missingCanvas=!1;#resizeTimeoutId=null;#isSvg=!1;#hasBeenAddedInUndoStack=!1;static _type="stamp";static _editorType=AnnotationEditorType.STAMP;constructor(params){super({...params,name:"stampEditor"}),this.#bitmapUrl=params.bitmapUrl,this.#bitmapFile=params.bitmapFile,this.defaultL10nId="pdfjs-editor-stamp-editor"}static initialize(l10n,uiManager){AnnotationEditor.initialize(l10n,uiManager)}static isHandlingMimeForPasting(mime){return SupportedImageMimeTypes.includes(mime)}static paste(item,parent){parent.pasteEditor({mode:AnnotationEditorType.STAMP},{bitmapFile:item.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(data){const hasAltTextStats=data.get("hasAltText");return{hasAltText:hasAltTextStats.get(!0)??0,hasNoAltText:hasAltTextStats.get(!1)??0}}#getBitmapFetched(data,fromId=!1){if(!data){this.remove();return}this.#bitmap=data.bitmap,fromId||(this.#bitmapId=data.id,this.#isSvg=data.isSvg),data.file&&(this.#bitmapFileName=data.file.name),this.#createCanvas()}#getBitmapDone(){if(this.#bitmapPromise=null,this._uiManager.enableWaiting(!1),!!this.#canvas){if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this.addEditToolbar().then(()=>{this._editToolbar.hide(),this._uiManager.editAltText(this,!0)});return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}}async mlGuessAltText(imageData=null,updateAltTextData=!0){if(this.hasAltTextData())return null;const{mlManager}=this._uiManager;if(!mlManager)throw new Error("No ML.");if(!await mlManager.isEnabledFor("altText"))throw new Error("ML isn't enabled for alt text.");const{data,width,height}=imageData||this.copyCanvas(null,null,!0).imageData,response=await mlManager.guess({name:"altText",request:{data,width,height,channels:data.length/(width*height)}});if(!response)throw new Error("No response from the AI service.");if(response.error)throw new Error("Error from the AI service.");if(response.cancel)return null;if(!response.output)throw new Error("No valid response from the AI service.");const altText=response.output;return await this.setGuessedAltText(altText),updateAltTextData&&!this.hasAltTextData()&&(this.altTextData={alt:altText,decorative:!1}),altText}#getBitmap(){if(this.#bitmapId){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(this.#bitmapId).then(data=>this.#getBitmapFetched(data,!0)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapUrl){const url=this.#bitmapUrl;this.#bitmapUrl=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromUrl(url).then(data=>this.#getBitmapFetched(data)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapFile){const file=this.#bitmapFile;this.#bitmapFile=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromFile(file).then(data=>this.#getBitmapFetched(data)).finally(()=>this.#getBitmapDone());return}const input=document.createElement("input");input.type="file",input.accept=SupportedImageMimeTypes.join(",");const signal=this._uiManager._signal;this.#bitmapPromise=new Promise(resolve=>{input.addEventListener("change",async()=>{if(!input.files||input.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);const data=await this._uiManager.imageManager.getFromFile(input.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),this.#getBitmapFetched(data)}resolve()},{signal}),input.addEventListener("cancel",()=>{this.remove(),resolve()},{signal})}).finally(()=>this.#getBitmapDone()),input.click()}remove(){this.#bitmapId&&(this.#bitmap=null,this._uiManager.imageManager.deleteId(this.#bitmapId),this.#canvas?.remove(),this.#canvas=null,this.#resizeTimeoutId&&(clearTimeout(this.#resizeTimeoutId),this.#resizeTimeoutId=null)),super.remove()}rebuild(){if(!this.parent){this.#bitmapId&&this.#getBitmap();return}super.rebuild(),this.div!==null&&(this.#bitmapId&&this.#canvas===null&&this.#getBitmap(),this.isAttachedToDOM||this.parent.add(this))}onceAdded(focus){this._isDraggable=!0,focus&&this.div.focus()}isEmpty(){return!(this.#bitmapPromise||this.#bitmap||this.#bitmapUrl||this.#bitmapFile||this.#bitmapId||this.#missingCanvas)}get toolbarButtons(){return[["altText",this.createAltText()]]}get isResizable(){return!0}render(){if(this.div)return this.div;let baseX,baseY;return this._isCopy&&(baseX=this.x,baseY=this.y),super.render(),this.div.hidden=!0,this.createAltText(),this.#missingCanvas||(this.#bitmap?this.#createCanvas():this.#getBitmap()),this._isCopy&&this._moveAfterPaste(baseX,baseY),this._uiManager.addShouldRescale(this),this.div}setCanvas(annotationElementId,canvas){const{id:bitmapId,bitmap}=this._uiManager.imageManager.getFromCanvas(annotationElementId,canvas);canvas.remove(),bitmapId&&this._uiManager.imageManager.isValidId(bitmapId)&&(this.#bitmapId=bitmapId,bitmap&&(this.#bitmap=bitmap),this.#missingCanvas=!1,this.#createCanvas())}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;this.#resizeTimeoutId!==null&&clearTimeout(this.#resizeTimeoutId);const TIME_TO_WAIT=200;this.#resizeTimeoutId=setTimeout(()=>{this.#resizeTimeoutId=null,this.#drawBitmap()},TIME_TO_WAIT)}#createCanvas(){const{div}=this;let{width,height}=this.#bitmap;const[pageWidth,pageHeight]=this.pageDimensions,MAX_RATIO=.75;if(this.width)width=this.width*pageWidth,height=this.height*pageHeight;else if(width>MAX_RATIO*pageWidth||height>MAX_RATIO*pageHeight){const factor=Math.min(MAX_RATIO*pageWidth/width,MAX_RATIO*pageHeight/height);width*=factor,height*=factor}const[parentWidth,parentHeight]=this.parentDimensions;this.setDims(width*parentWidth/pageWidth,height*parentHeight/pageHeight),this._uiManager.enableWaiting(!1);const canvas=this.#canvas=document.createElement("canvas");canvas.setAttribute("role","img"),this.addContainer(canvas),this.width=width/pageWidth,this.height=height/pageHeight,this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(div.hidden=!1),this.#drawBitmap(),this.#hasBeenAddedInUndoStack||(this.parent.addUndoableEditor(this),this.#hasBeenAddedInUndoStack=!0),this._reportTelemetry({action:"inserted_image"}),this.#bitmapFileName&&this.div.setAttribute("aria-description",this.#bitmapFileName),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-stamp-added-alert")}copyCanvas(maxDataDimension,maxPreviewDimension,createImageData=!1){maxDataDimension||(maxDataDimension=224);const{width:bitmapWidth,height:bitmapHeight}=this.#bitmap,outputScale=new OutputScale;let bitmap=this.#bitmap,width=bitmapWidth,height=bitmapHeight,canvas=null;if(maxPreviewDimension){if(bitmapWidth>maxPreviewDimension||bitmapHeight>maxPreviewDimension){const ratio=Math.min(maxPreviewDimension/bitmapWidth,maxPreviewDimension/bitmapHeight);width=Math.floor(bitmapWidth*ratio),height=Math.floor(bitmapHeight*ratio)}canvas=document.createElement("canvas");const scaledWidth=canvas.width=Math.ceil(width*outputScale.sx),scaledHeight=canvas.height=Math.ceil(height*outputScale.sy);this.#isSvg||(bitmap=this.#scaleBitmap(scaledWidth,scaledHeight));const ctx=canvas.getContext("2d");ctx.filter=this._uiManager.hcmFilter;let white="white",black="#cfcfd8";this._uiManager.hcmFilter!=="none"?black="black":window.matchMedia?.("(prefers-color-scheme: dark)").matches&&(white="#8f8f9d",black="#42414d");const boxDim=15,boxDimWidth=boxDim*outputScale.sx,boxDimHeight=boxDim*outputScale.sy,pattern=new OffscreenCanvas(boxDimWidth*2,boxDimHeight*2),patternCtx=pattern.getContext("2d");patternCtx.fillStyle=white,patternCtx.fillRect(0,0,boxDimWidth*2,boxDimHeight*2),patternCtx.fillStyle=black,patternCtx.fillRect(0,0,boxDimWidth,boxDimHeight),patternCtx.fillRect(boxDimWidth,boxDimHeight,boxDimWidth,boxDimHeight),ctx.fillStyle=ctx.createPattern(pattern,"repeat"),ctx.fillRect(0,0,scaledWidth,scaledHeight),ctx.drawImage(bitmap,0,0,bitmap.width,bitmap.height,0,0,scaledWidth,scaledHeight)}let imageData=null;if(createImageData){let dataWidth,dataHeight;if(outputScale.symmetric&&bitmap.width<maxDataDimension&&bitmap.height<maxDataDimension)dataWidth=bitmap.width,dataHeight=bitmap.height;else if(bitmap=this.#bitmap,bitmapWidth>maxDataDimension||bitmapHeight>maxDataDimension){const ratio=Math.min(maxDataDimension/bitmapWidth,maxDataDimension/bitmapHeight);dataWidth=Math.floor(bitmapWidth*ratio),dataHeight=Math.floor(bitmapHeight*ratio),this.#isSvg||(bitmap=this.#scaleBitmap(dataWidth,dataHeight))}const offscreenCtx=new OffscreenCanvas(dataWidth,dataHeight).getContext("2d",{willReadFrequently:!0});offscreenCtx.drawImage(bitmap,0,0,bitmap.width,bitmap.height,0,0,dataWidth,dataHeight),imageData={width:dataWidth,height:dataHeight,data:offscreenCtx.getImageData(0,0,dataWidth,dataHeight).data}}return{canvas,width,height,imageData}}#scaleBitmap(width,height){const{width:bitmapWidth,height:bitmapHeight}=this.#bitmap;let newWidth=bitmapWidth,newHeight=bitmapHeight,bitmap=this.#bitmap;for(;newWidth>2*width||newHeight>2*height;){const prevWidth=newWidth,prevHeight=newHeight;newWidth>2*width&&(newWidth=newWidth>=16384?Math.floor(newWidth/2)-1:Math.ceil(newWidth/2)),newHeight>2*height&&(newHeight=newHeight>=16384?Math.floor(newHeight/2)-1:Math.ceil(newHeight/2));const offscreen=new OffscreenCanvas(newWidth,newHeight);offscreen.getContext("2d").drawImage(bitmap,0,0,prevWidth,prevHeight,0,0,newWidth,newHeight),bitmap=offscreen.transferToImageBitmap()}return bitmap}#drawBitmap(){const[parentWidth,parentHeight]=this.parentDimensions,{width,height}=this,outputScale=new OutputScale,scaledWidth=Math.ceil(width*parentWidth*outputScale.sx),scaledHeight=Math.ceil(height*parentHeight*outputScale.sy),canvas=this.#canvas;if(!canvas||canvas.width===scaledWidth&&canvas.height===scaledHeight)return;canvas.width=scaledWidth,canvas.height=scaledHeight;const bitmap=this.#isSvg?this.#bitmap:this.#scaleBitmap(scaledWidth,scaledHeight),ctx=canvas.getContext("2d");ctx.filter=this._uiManager.hcmFilter,ctx.drawImage(bitmap,0,0,bitmap.width,bitmap.height,0,0,scaledWidth,scaledHeight)}#serializeBitmap(toUrl){if(toUrl){if(this.#isSvg){const url=this._uiManager.imageManager.getSvgUrl(this.#bitmapId);if(url)return url}const canvas=document.createElement("canvas");return{width:canvas.width,height:canvas.height}=this.#bitmap,canvas.getContext("2d").drawImage(this.#bitmap,0,0),canvas.toDataURL()}if(this.#isSvg){const[pageWidth,pageHeight]=this.pageDimensions,width=Math.round(this.width*pageWidth*PixelsPerInch.PDF_TO_CSS_UNITS),height=Math.round(this.height*pageHeight*PixelsPerInch.PDF_TO_CSS_UNITS),offscreen=new OffscreenCanvas(width,height);return offscreen.getContext("2d").drawImage(this.#bitmap,0,0,this.#bitmap.width,this.#bitmap.height,0,0,width,height),offscreen.transferToImageBitmap()}return structuredClone(this.#bitmap)}static async deserialize(data,parent,uiManager){let initialData=null,missingCanvas=!1;if(data instanceof StampAnnotationElement){const{data:{rect:rect2,rotation,id,structParent,popupRef},container,parent:{page:{pageNumber}},canvas}=data;let bitmapId2,bitmap2;canvas?(delete data.canvas,{id:bitmapId2,bitmap:bitmap2}=uiManager.imageManager.getFromCanvas(container.id,canvas),canvas.remove()):(missingCanvas=!0,data._hasNoCanvas=!0);const altText=(await parent._structTree.getAriaAttributes(`${AnnotationPrefix}${id}`))?.get("aria-label")||"";initialData=data={annotationType:AnnotationEditorType.STAMP,bitmapId:bitmapId2,bitmap:bitmap2,pageIndex:pageNumber-1,rect:rect2.slice(0),rotation,annotationElementId:id,id,deleted:!1,accessibilityData:{decorative:!1,altText},isSvg:!1,structParent,popupRef}}const editor=await super.deserialize(data,parent,uiManager),{rect,bitmap,bitmapUrl,bitmapId,isSvg,accessibilityData}=data;missingCanvas?(uiManager.addMissingCanvas(data.id,editor),editor.#missingCanvas=!0):bitmapId&&uiManager.imageManager.isValidId(bitmapId)?(editor.#bitmapId=bitmapId,bitmap&&(editor.#bitmap=bitmap)):editor.#bitmapUrl=bitmapUrl,editor.#isSvg=isSvg;const[parentWidth,parentHeight]=editor.pageDimensions;return editor.width=(rect[2]-rect[0])/parentWidth,editor.height=(rect[3]-rect[1])/parentHeight,accessibilityData&&(editor.altTextData=accessibilityData),editor._initialData=initialData,editor.#hasBeenAddedInUndoStack=!!initialData,editor}serialize(isForCopying=!1,context=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const serialized={annotationType:AnnotationEditorType.STAMP,bitmapId:this.#bitmapId,pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:this.#isSvg,structTreeParentId:this._structTreeParentId};if(isForCopying)return serialized.bitmapUrl=this.#serializeBitmap(!0),serialized.accessibilityData=this.serializeAltText(!0),serialized.isCopy=!0,serialized;const{decorative,altText}=this.serializeAltText(!1);if(!decorative&&altText&&(serialized.accessibilityData={type:"Figure",alt:altText}),this.annotationElementId){const changes=this.#hasElementChanged(serialized);if(changes.isSame)return null;changes.isSameAltText?delete serialized.accessibilityData:serialized.accessibilityData.structParent=this._initialData.structParent??-1}if(serialized.id=this.annotationElementId,context===null)return serialized;context.stamps||=new Map;const area=this.#isSvg?(serialized.rect[2]-serialized.rect[0])*(serialized.rect[3]-serialized.rect[1]):null;if(!context.stamps.has(this.#bitmapId))context.stamps.set(this.#bitmapId,{area,serialized}),serialized.bitmap=this.#serializeBitmap(!1);else if(this.#isSvg){const prevData=context.stamps.get(this.#bitmapId);area>prevData.area&&(prevData.area=area,prevData.serialized.bitmap.close(),prevData.serialized.bitmap=this.#serializeBitmap(!1))}return serialized}#hasElementChanged(serialized){const{pageIndex,accessibilityData:{altText}}=this._initialData,isSamePageIndex=serialized.pageIndex===pageIndex,isSameAltText=(serialized.accessibilityData?.alt||"")===altText;return{isSame:!this._hasBeenMoved&&!this._hasBeenResized&&isSamePageIndex&&isSameAltText,isSameAltText}}renderAnnotationElement(annotation){return annotation.updateEdited({rect:this.getRect(0,0)}),null}}class AnnotationEditorLayer{#accessibilityManager;#allowClick=!1;#annotationLayer=null;#clickAC=null;#editorFocusTimeoutId=null;#editors=new Map;#hadPointerDown=!1;#isDisabling=!1;#isEnabling=!1;#drawingAC=null;#focusedElement=null;#textLayer=null;#textSelectionAC=null;#textLayerDblClickAC=null;#lastPointerDownTimestamp=-1;#uiManager;static _initialized=!1;static#editorTypes=new Map([FreeTextEditor,InkEditor,StampEditor,HighlightEditor,SignatureEditor].map(type=>[type._editorType,type]));constructor({uiManager,pageIndex,div,structTreeLayer,accessibilityManager,annotationLayer,drawLayer,textLayer,viewport,l10n}){const editorTypes=[...AnnotationEditorLayer.#editorTypes.values()];if(!AnnotationEditorLayer._initialized){AnnotationEditorLayer._initialized=!0;for(const editorType of editorTypes)editorType.initialize(l10n,uiManager)}uiManager.registerEditorTypes(editorTypes),this.#uiManager=uiManager,this.pageIndex=pageIndex,this.div=div,this.#accessibilityManager=accessibilityManager,this.#annotationLayer=annotationLayer,this.viewport=viewport,this.#textLayer=textLayer,this.drawLayer=drawLayer,this._structTree=structTreeLayer,this.#uiManager.addLayer(this)}get isEmpty(){return this.#editors.size===0}get isInvisible(){return this.isEmpty&&this.#uiManager.getMode()===AnnotationEditorType.NONE}updateToolbar(options){this.#uiManager.updateToolbar(options)}updateMode(mode=this.#uiManager.getMode()){switch(this.#cleanup(),mode){case AnnotationEditorType.NONE:this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case AnnotationEditorType.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case AnnotationEditorType.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);const{classList}=this.div;for(const editorType of AnnotationEditorLayer.#editorTypes.values())classList.toggle(`${editorType._type}Editing`,mode===editorType._editorType);this.div.hidden=!1}hasTextLayer(textLayer){return textLayer===this.#textLayer?.div}setEditingState(isEditing){this.#uiManager.setEditingState(isEditing)}addCommands(params){this.#uiManager.addCommands(params)}cleanUndoStack(type){this.#uiManager.cleanUndoStack(type)}toggleDrawing(enabled=!1){this.div.classList.toggle("drawing",!enabled)}togglePointerEvents(enabled=!1){this.div.classList.toggle("disabled",!enabled)}toggleAnnotationLayerPointerEvents(enabled=!1){this.#annotationLayer?.div.classList.toggle("disabled",!enabled)}async enable(){this.#isEnabling=!0,this.div.tabIndex=0,this.togglePointerEvents(!0),this.#textLayerDblClickAC?.abort(),this.#textLayerDblClickAC=null;const annotationElementIds=new Set;for(const editor of this.#editors.values())editor.enableEditing(),editor.show(!0),editor.annotationElementId&&(this.#uiManager.removeChangedExistingAnnotation(editor),annotationElementIds.add(editor.annotationElementId));if(!this.#annotationLayer){this.#isEnabling=!1;return}const editables=this.#annotationLayer.getEditableAnnotations();for(const editable of editables){if(editable.hide(),this.#uiManager.isDeletedAnnotationElement(editable.data.id)||annotationElementIds.has(editable.data.id))continue;const editor=await this.deserialize(editable);editor&&(this.addOrRebuild(editor),editor.enableEditing())}this.#isEnabling=!1}disable(){if(this.#isDisabling=!0,this.div.tabIndex=-1,this.togglePointerEvents(!1),this.#textLayer&&!this.#textLayerDblClickAC){this.#textLayerDblClickAC=new AbortController;const signal=this.#uiManager.combinedSignal(this.#textLayerDblClickAC);this.#textLayer.div.addEventListener("pointerdown",e=>{const{clientX,clientY,timeStamp}=e,lastPointerDownTimestamp=this.#lastPointerDownTimestamp;if(timeStamp-lastPointerDownTimestamp>500){this.#lastPointerDownTimestamp=timeStamp;return}this.#lastPointerDownTimestamp=-1;const{classList:classList2}=this.div;classList2.toggle("getElements",!0);const elements=document.elementsFromPoint(clientX,clientY);if(classList2.toggle("getElements",!1),!this.div.contains(elements[0]))return;let id;const regex=new RegExp(`^${AnnotationEditorPrefix}[0-9]+$`);for(const element of elements)if(regex.test(element.id)){id=element.id;break}if(!id)return;const editor=this.#editors.get(id);editor?.annotationElementId===null&&(e.stopPropagation(),e.preventDefault(),editor.dblclick())},{signal,capture:!0})}const changedAnnotations=new Map,resetAnnotations=new Map;for(const editor of this.#editors.values())if(editor.disableEditing(),!!editor.annotationElementId){if(editor.serialize()!==null){changedAnnotations.set(editor.annotationElementId,editor);continue}else resetAnnotations.set(editor.annotationElementId,editor);this.getEditableAnnotation(editor.annotationElementId)?.show(),editor.remove()}if(this.#annotationLayer){const editables=this.#annotationLayer.getEditableAnnotations();for(const editable of editables){const{id}=editable.data;if(this.#uiManager.isDeletedAnnotationElement(id))continue;let editor=resetAnnotations.get(id);if(editor){editor.resetAnnotationElement(editable),editor.show(!1),editable.show();continue}editor=changedAnnotations.get(id),editor&&(this.#uiManager.addChangedExistingAnnotation(editor),editor.renderAnnotationElement(editable)&&editor.show(!1)),editable.show()}}this.#cleanup(),this.isEmpty&&(this.div.hidden=!0);const{classList}=this.div;for(const editorType of AnnotationEditorLayer.#editorTypes.values())classList.remove(`${editorType._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),this.#isDisabling=!1}getEditableAnnotation(id){return this.#annotationLayer?.getEditableAnnotation(id)||null}setActiveEditor(editor){this.#uiManager.getActive()!==editor&&this.#uiManager.setActiveEditor(editor)}enableTextSelection(){if(this.div.tabIndex=-1,this.#textLayer?.div&&!this.#textSelectionAC){this.#textSelectionAC=new AbortController;const signal=this.#uiManager.combinedSignal(this.#textSelectionAC);this.#textLayer.div.addEventListener("pointerdown",this.#textLayerPointerDown.bind(this),{signal}),this.#textLayer.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0,this.#textLayer?.div&&this.#textSelectionAC&&(this.#textSelectionAC.abort(),this.#textSelectionAC=null,this.#textLayer.div.classList.remove("highlighting"))}#textLayerPointerDown(event){this.#uiManager.unselectAll();const{target}=event;if(target===this.#textLayer.div||(target.getAttribute("role")==="img"||target.classList.contains("endOfContent"))&&this.#textLayer.div.contains(target)){const{isMac}=util_FeatureTest.platform;if(event.button!==0||event.ctrlKey&&isMac)return;this.#uiManager.showAllEditors("highlight",!0,!0),this.#textLayer.div.classList.add("free"),this.toggleDrawing(),HighlightEditor.startHighlighting(this,this.#uiManager.direction==="ltr",{target:this.#textLayer.div,x:event.x,y:event.y}),this.#textLayer.div.addEventListener("pointerup",()=>{this.#textLayer.div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:this.#uiManager._signal}),event.preventDefault()}}enableClick(){if(this.#clickAC)return;this.#clickAC=new AbortController;const signal=this.#uiManager.combinedSignal(this.#clickAC);this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal});const pointerup=this.pointerup.bind(this);this.div.addEventListener("pointerup",pointerup,{signal}),this.div.addEventListener("pointercancel",pointerup,{signal})}disableClick(){this.#clickAC?.abort(),this.#clickAC=null}attach(editor){this.#editors.set(editor.id,editor);const{annotationElementId}=editor;annotationElementId&&this.#uiManager.isDeletedAnnotationElement(annotationElementId)&&this.#uiManager.removeDeletedAnnotationElement(editor)}detach(editor){this.#editors.delete(editor.id),this.#accessibilityManager?.removePointerInTextLayer(editor.contentDiv),!this.#isDisabling&&editor.annotationElementId&&this.#uiManager.addDeletedAnnotationElement(editor)}remove(editor){this.detach(editor),this.#uiManager.removeEditor(editor),editor.div.remove(),editor.isAttachedToDOM=!1}changeParent(editor){editor.parent!==this&&(editor.parent&&editor.annotationElementId&&(this.#uiManager.addDeletedAnnotationElement(editor.annotationElementId),AnnotationEditor.deleteAnnotationElement(editor),editor.annotationElementId=null),this.attach(editor),editor.parent?.detach(editor),editor.setParent(this),editor.div&&editor.isAttachedToDOM&&(editor.div.remove(),this.div.append(editor.div)))}add(editor){if(!(editor.parent===this&&editor.isAttachedToDOM)){if(this.changeParent(editor),this.#uiManager.addEditor(editor),this.attach(editor),!editor.isAttachedToDOM){const div=editor.render();this.div.append(div),editor.isAttachedToDOM=!0}editor.fixAndSetPosition(),editor.onceAdded(!this.#isEnabling),this.#uiManager.addToAnnotationStorage(editor),editor._reportTelemetry(editor.telemetryInitialData)}}moveEditorInDOM(editor){if(!editor.isAttachedToDOM)return;const{activeElement}=document;editor.div.contains(activeElement)&&!this.#editorFocusTimeoutId&&(editor._focusEventsAllowed=!1,this.#editorFocusTimeoutId=setTimeout(()=>{this.#editorFocusTimeoutId=null,editor.div.contains(document.activeElement)?editor._focusEventsAllowed=!0:(editor.div.addEventListener("focusin",()=>{editor._focusEventsAllowed=!0},{once:!0,signal:this.#uiManager._signal}),activeElement.focus())},0)),editor._structTreeParentId=this.#accessibilityManager?.moveElementInDOM(this.div,editor.div,editor.contentDiv,!0)}addOrRebuild(editor){editor.needsToBeRebuilt()?(editor.parent||=this,editor.rebuild(),editor.show()):this.add(editor)}addUndoableEditor(editor){const cmd=()=>editor._uiManager.rebuild(editor),undo=()=>{editor.remove()};this.addCommands({cmd,undo,mustExec:!1})}getNextId(){return this.#uiManager.getId()}get#currentEditorType(){return AnnotationEditorLayer.#editorTypes.get(this.#uiManager.getMode())}combinedSignal(ac){return this.#uiManager.combinedSignal(ac)}#createNewEditor(params){const editorType=this.#currentEditorType;return editorType?new editorType.prototype.constructor(params):null}canCreateNewEmptyEditor(){return this.#currentEditorType?.canCreateNewEmptyEditor()}async pasteEditor(options,params){this.updateToolbar(options),await this.#uiManager.updateMode(options.mode);const{offsetX,offsetY}=this.#getCenterPoint(),id=this.getNextId(),editor=this.#createNewEditor({parent:this,id,x:offsetX,y:offsetY,uiManager:this.#uiManager,isCentered:!0,...params});editor&&this.add(editor)}async deserialize(data){return await AnnotationEditorLayer.#editorTypes.get(data.annotationType??data.annotationEditorType)?.deserialize(data,this,this.#uiManager)||null}createAndAddNewEditor(event,isCentered,data={}){const id=this.getNextId(),editor=this.#createNewEditor({parent:this,id,x:event.offsetX,y:event.offsetY,uiManager:this.#uiManager,isCentered,...data});return editor&&this.add(editor),editor}#getCenterPoint(){const{x,y,width,height}=this.div.getBoundingClientRect(),tlX=Math.max(0,x),tlY=Math.max(0,y),brX=Math.min(window.innerWidth,x+width),brY=Math.min(window.innerHeight,y+height),centerX=(tlX+brX)/2-x,centerY=(tlY+brY)/2-y,[offsetX,offsetY]=this.viewport.rotation%180===0?[centerX,centerY]:[centerY,centerX];return{offsetX,offsetY}}addNewEditor(data={}){this.createAndAddNewEditor(this.#getCenterPoint(),!0,data)}setSelected(editor){this.#uiManager.setSelected(editor)}toggleSelected(editor){this.#uiManager.toggleSelected(editor)}unselect(editor){this.#uiManager.unselect(editor)}pointerup(event){const{isMac}=util_FeatureTest.platform;if(event.button!==0||event.ctrlKey&&isMac||event.target!==this.div||!this.#hadPointerDown||(this.#hadPointerDown=!1,this.#currentEditorType?.isDrawer&&this.#currentEditorType.supportMultipleDrawings))return;if(!this.#allowClick){this.#allowClick=!0;return}const currentMode=this.#uiManager.getMode();if(currentMode===AnnotationEditorType.STAMP||currentMode===AnnotationEditorType.SIGNATURE){this.#uiManager.unselectAll();return}this.createAndAddNewEditor(event,!1)}pointerdown(event){if(this.#uiManager.getMode()===AnnotationEditorType.HIGHLIGHT&&this.enableTextSelection(),this.#hadPointerDown){this.#hadPointerDown=!1;return}const{isMac}=util_FeatureTest.platform;if(event.button!==0||event.ctrlKey&&isMac||event.target!==this.div)return;if(this.#hadPointerDown=!0,this.#currentEditorType?.isDrawer){this.startDrawingSession(event);return}const editor=this.#uiManager.getActive();this.#allowClick=!editor||editor.isEmpty()}startDrawingSession(event){if(this.div.focus({preventScroll:!0}),this.#drawingAC){this.#currentEditorType.startDrawing(this,this.#uiManager,!1,event);return}this.#uiManager.setCurrentDrawingSession(this),this.#drawingAC=new AbortController;const signal=this.#uiManager.combinedSignal(this.#drawingAC);this.div.addEventListener("blur",({relatedTarget})=>{relatedTarget&&!this.div.contains(relatedTarget)&&(this.#focusedElement=null,this.commitOrRemove())},{signal}),this.#currentEditorType.startDrawing(this,this.#uiManager,!1,event)}pause(on){if(on){const{activeElement}=document;this.div.contains(activeElement)&&(this.#focusedElement=activeElement);return}this.#focusedElement&&setTimeout(()=>{this.#focusedElement?.focus(),this.#focusedElement=null},0)}endDrawingSession(isAborted=!1){return this.#drawingAC?(this.#uiManager.setCurrentDrawingSession(null),this.#drawingAC.abort(),this.#drawingAC=null,this.#focusedElement=null,this.#currentEditorType.endDrawing(isAborted)):null}findNewParent(editor,x,y){const layer=this.#uiManager.findParent(x,y);return layer===null||layer===this?!1:(layer.changeParent(editor),!0)}commitOrRemove(){return this.#drawingAC?(this.endDrawingSession(),!0):!1}onScaleChanging(){this.#drawingAC&&this.#currentEditorType.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),this.#uiManager.getActive()?.parent===this&&(this.#uiManager.commitOrRemove(),this.#uiManager.setActiveEditor(null)),this.#editorFocusTimeoutId&&(clearTimeout(this.#editorFocusTimeoutId),this.#editorFocusTimeoutId=null);for(const editor of this.#editors.values())this.#accessibilityManager?.removePointerInTextLayer(editor.contentDiv),editor.setParent(null),editor.isAttachedToDOM=!1,editor.div.remove();this.div=null,this.#editors.clear(),this.#uiManager.removeLayer(this)}#cleanup(){for(const editor of this.#editors.values())editor.isEmpty()&&editor.remove()}render({viewport}){this.viewport=viewport,setLayerDimensions(this.div,viewport);for(const editor of this.#uiManager.getEditors(this.pageIndex))this.add(editor),editor.rebuild();this.updateMode()}update({viewport}){this.#uiManager.commitOrRemove(),this.#cleanup();const oldRotation=this.viewport.rotation,rotation=viewport.rotation;if(this.viewport=viewport,setLayerDimensions(this.div,{rotation}),oldRotation!==rotation)for(const editor of this.#editors.values())editor.rotate(rotation)}get pageDimensions(){const{pageWidth,pageHeight}=this.viewport.rawDims;return[pageWidth,pageHeight]}get scale(){return this.#uiManager.viewParameters.realScale}}class DrawLayer{#parent=null;#mapping=new Map;#toUpdate=new Map;static#id=0;constructor({pageIndex}){this.pageIndex=pageIndex}setParent(parent){if(!this.#parent){this.#parent=parent;return}if(this.#parent!==parent){if(this.#mapping.size>0)for(const root of this.#mapping.values())root.remove(),parent.append(root);this.#parent=parent}}static get _svgFactory(){return shadow(this,"_svgFactory",new DOMSVGFactory)}static#setBox(element,[x,y,width,height]){const{style}=element;style.top=`${100*y}%`,style.left=`${100*x}%`,style.width=`${100*width}%`,style.height=`${100*height}%`}#createSVG(){const svg=DrawLayer._svgFactory.create(1,1,!0);return this.#parent.append(svg),svg.setAttribute("aria-hidden",!0),svg}#createClipPath(defs,pathId){const clipPath=DrawLayer._svgFactory.createElement("clipPath");defs.append(clipPath);const clipPathId=`clip_${pathId}`;clipPath.setAttribute("id",clipPathId),clipPath.setAttribute("clipPathUnits","objectBoundingBox");const clipPathUse=DrawLayer._svgFactory.createElement("use");return clipPath.append(clipPathUse),clipPathUse.setAttribute("href",`#${pathId}`),clipPathUse.classList.add("clip"),clipPathId}#updateProperties(element,properties){for(const[key,value]of Object.entries(properties))value===null?element.removeAttribute(key):element.setAttribute(key,value)}draw(properties,isPathUpdatable=!1,hasClip=!1){const id=DrawLayer.#id++,root=this.#createSVG(),defs=DrawLayer._svgFactory.createElement("defs");root.append(defs);const path=DrawLayer._svgFactory.createElement("path");defs.append(path);const pathId=`path_p${this.pageIndex}_${id}`;path.setAttribute("id",pathId),path.setAttribute("vector-effect","non-scaling-stroke"),isPathUpdatable&&this.#toUpdate.set(id,path);const clipPathId=hasClip?this.#createClipPath(defs,pathId):null,use=DrawLayer._svgFactory.createElement("use");return root.append(use),use.setAttribute("href",`#${pathId}`),this.updateProperties(root,properties),this.#mapping.set(id,root),{id,clipPathId:`url(#${clipPathId})`}}drawOutline(properties,mustRemoveSelfIntersections){const id=DrawLayer.#id++,root=this.#createSVG(),defs=DrawLayer._svgFactory.createElement("defs");root.append(defs);const path=DrawLayer._svgFactory.createElement("path");defs.append(path);const pathId=`path_p${this.pageIndex}_${id}`;path.setAttribute("id",pathId),path.setAttribute("vector-effect","non-scaling-stroke");let maskId;if(mustRemoveSelfIntersections){const mask=DrawLayer._svgFactory.createElement("mask");defs.append(mask),maskId=`mask_p${this.pageIndex}_${id}`,mask.setAttribute("id",maskId),mask.setAttribute("maskUnits","objectBoundingBox");const rect=DrawLayer._svgFactory.createElement("rect");mask.append(rect),rect.setAttribute("width","1"),rect.setAttribute("height","1"),rect.setAttribute("fill","white");const use=DrawLayer._svgFactory.createElement("use");mask.append(use),use.setAttribute("href",`#${pathId}`),use.setAttribute("stroke","none"),use.setAttribute("fill","black"),use.setAttribute("fill-rule","nonzero"),use.classList.add("mask")}const use1=DrawLayer._svgFactory.createElement("use");root.append(use1),use1.setAttribute("href",`#${pathId}`),maskId&&use1.setAttribute("mask",`url(#${maskId})`);const use2=use1.cloneNode();return root.append(use2),use1.classList.add("mainOutline"),use2.classList.add("secondaryOutline"),this.updateProperties(root,properties),this.#mapping.set(id,root),id}finalizeDraw(id,properties){this.#toUpdate.delete(id),this.updateProperties(id,properties)}updateProperties(elementOrId,properties){if(!properties)return;const{root,bbox,rootClass,path}=properties,element=typeof elementOrId=="number"?this.#mapping.get(elementOrId):elementOrId;if(element){if(root&&this.#updateProperties(element,root),bbox&&DrawLayer.#setBox(element,bbox),rootClass){const{classList}=element;for(const[className,value]of Object.entries(rootClass))classList.toggle(className,value)}if(path){const pathElement=element.firstChild.firstChild;this.#updateProperties(pathElement,path)}}}updateParent(id,layer){if(layer===this)return;const root=this.#mapping.get(id);root&&(layer.#parent.append(root),this.#mapping.delete(id),layer.#mapping.set(id,root))}remove(id){this.#toUpdate.delete(id),this.#parent!==null&&(this.#mapping.get(id).remove(),this.#mapping.delete(id))}destroy(){this.#parent=null;for(const root of this.#mapping.values())root.remove();this.#mapping.clear(),this.#toUpdate.clear()}}globalThis._pdfjsTestingUtils={HighlightOutliner};globalThis.pdfjsLib={AbortException,AnnotationEditorLayer,AnnotationEditorParamsType,AnnotationEditorType,AnnotationEditorUIManager,AnnotationLayer,AnnotationMode,AnnotationType,build,ColorPicker,createValidAbsoluteUrl,DOMSVGFactory,DrawLayer,FeatureTest:util_FeatureTest,fetchData,getDocument,getFilenameFromUrl,getPdfFilenameFromUrl,getUuid,getXfaPageViewport,GlobalWorkerOptions,ImageKind:util_ImageKind,InvalidPDFException,isDataScheme,isPdfFile,isValidExplicitDest,MathClamp,noContextMenu,normalizeUnicode,OPS,OutputScale,PasswordResponses,PDFDataRangeTransport,PDFDateString,PDFWorker,PermissionFlag,PixelsPerInch,RenderingCancelledException,ResponseException,setLayerDimensions,shadow,SignatureExtractor,stopEvent,SupportedImageMimeTypes,TextLayer,TouchManager,updateUrlHash,Util,VerbosityLevel,version,XfaLayer};export{getDocument as g};
